<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Monitorando tamanho de diretórios com Zabbix" /><meta name="author" content="Helvio Junior (m4v3r1ck)" /><meta property="og:locale" content="en_US" /><meta name="description" content="Este post mostra como listar todos os subdiretórios dentro de um diretório e monitorar o tamanho destes. Para isso será necessário a utilização de um aplicativo (escrito por mim) que tem 2 funções: 1 - Listar todos os subdiretórios dentro de um diretório; 2 - Calcular o espaço em disco utilizado por estes diretórios. Este aplicativo chama-se ZabbixDirSize.exe e está disponível aqui (ZabbixDirSize), inclusive com código fonte. Configurando o agente Edite o arquivo de configuração do agente e adicione as linhas abaixo: [sourcecode language=&quot;text&quot;] UnsafeUserParameters=1 UserParameter=ds.subdirs[*],C:\Zabbix\ZabbixDirSize.exe --sub-dirs &quot;$1&quot; &quot;$2&quot; &quot;$3&quot; &quot;$4&quot; &quot;$5&quot; UserParameter=ds.subdirs.size[*],C:\Zabbix\ZabbixDirSize.exe --size &quot;$1&quot; [/sourcecode] Nas linhas acima criamos 2 chaves ds.subdirs e ds.subdirs.size, a primeira lista todos os diretórios dentro de um diretório específico e a segunda retorna o tamanho utilizado por um diretório. A chave ds.subdirs está passando até 5 diretórios (pai) para o executável. Caso deseje mais diretórios basta incluir as variaveis no final da linha ($6, $7, etc...) Edite o caminho do executável ZabbixDirSize.exe conforme o seu ambiente. Para que este executável funcione corretamente é necessário estar instalado na maquina o .NET 2.0 ou superior. Criando o Host no Zabbix, configuração a localização automática de subdiretórios dentro de um diretório específico e criando os itens de captura e gráficos. Crie o host dentro do Zabbix Clique no item Discovery rules Clique no item Create discovery rules Configure a regra de descoberta conforme a imagem abaixo, inserindo a chave ds.subdirs[] colocando entre colchetes o nome do diretório em que deseja listar todos os subdiretórios. Clique no botão Save. Neste parâmetro pode ser passado mais de um diretório pai, bastando dentro dos colchetes colocar os diretórios separados por virgula, ficando desta forma: ds.subdirs[d:\dir1,c:\Dir3,d:\dir3] Após salvo será aberto a tela conforma a imagem abaixo. Clique em Item prototypes. Clique no botão Create item prototype Configure o item conforme tela abaixo, observando os seguintes items, depois clique em Save Name: Used space on $1 Type: Zabbix agent Key: ds.subdirs.size[{#DIRPATH}] Type information: Numeric (unsigned) Data Type: Decimal Units: B Update interval: 21600 New application: Directory Depois clique em Graph prototype e clique em Create graph prototype. Configure conforme os itens abaixo Name: Used space on {#DIRPATH} Width: 600 Height: 340 Depois clique em Add prototype, selecione o item Used space on {#DIRPATH}. Altere o Draw Style para Dashed Line e clique em Save Solução de problemas Recentemente tivemos alguns reportes de erro no processo de busca e contagem do tamanho, sendo sim fiz algumas alterações na aplicação para melhorar a estratégia de busca bem como de identificação de erros. Caso encontre algum erro na aplicação basta executa-la conforme o comando abaixo, deste modo será gerado um arquivo de log no mesmo local do executável, conendo o log de processamento e possíveis mensagens de erro. [sourcecode language=&quot;text&quot;] C:\Zabbix\ZabbixDirSize.exe --sub-dirs --debug c:\diretorio_desejado C:\Zabbix\ZabbixDirSize.exe --size --debug c:\diretorio_desejado [/sourcecode] Timeout em diretórios grandes Recebi um feedback bem legal de algumas pessoas que estão usando o aplicativo, de timeout em diretórios grandes. Como solução para este problema implementei uma execução em background onde o aplicativo faz um fork e fica executando até que faça a leitura de todo o diretório para calcular o tamanho. Por segurança o aplicativo controla os seus objetos filhos para evitar que se abra mais de um fork para o mesmo diretório. Após este objeto filho finalizar a leitura do diretório, ele armazena o tamanho em um arquivo texto, para que o aplicativo pai possa realizar a leitura deste valor para o Zabbix. Para habilitar essa função basta adicionar o parâmetro --bg na linha de comando do aplicativo conforme exemplo abaixo. Esta opção só é válida juntamente com a opção --size. [sourcecode language=&quot;text&quot;] UserParameter=ds.subdirs.size[*],C:\Zabbix\ZabbixDirSize.exe --size --bg &quot;$1&quot; [/sourcecode]" /><meta property="og:description" content="Este post mostra como listar todos os subdiretórios dentro de um diretório e monitorar o tamanho destes. Para isso será necessário a utilização de um aplicativo (escrito por mim) que tem 2 funções: 1 - Listar todos os subdiretórios dentro de um diretório; 2 - Calcular o espaço em disco utilizado por estes diretórios. Este aplicativo chama-se ZabbixDirSize.exe e está disponível aqui (ZabbixDirSize), inclusive com código fonte. Configurando o agente Edite o arquivo de configuração do agente e adicione as linhas abaixo: [sourcecode language=&quot;text&quot;] UnsafeUserParameters=1 UserParameter=ds.subdirs[*],C:\Zabbix\ZabbixDirSize.exe --sub-dirs &quot;$1&quot; &quot;$2&quot; &quot;$3&quot; &quot;$4&quot; &quot;$5&quot; UserParameter=ds.subdirs.size[*],C:\Zabbix\ZabbixDirSize.exe --size &quot;$1&quot; [/sourcecode] Nas linhas acima criamos 2 chaves ds.subdirs e ds.subdirs.size, a primeira lista todos os diretórios dentro de um diretório específico e a segunda retorna o tamanho utilizado por um diretório. A chave ds.subdirs está passando até 5 diretórios (pai) para o executável. Caso deseje mais diretórios basta incluir as variaveis no final da linha ($6, $7, etc...) Edite o caminho do executável ZabbixDirSize.exe conforme o seu ambiente. Para que este executável funcione corretamente é necessário estar instalado na maquina o .NET 2.0 ou superior. Criando o Host no Zabbix, configuração a localização automática de subdiretórios dentro de um diretório específico e criando os itens de captura e gráficos. Crie o host dentro do Zabbix Clique no item Discovery rules Clique no item Create discovery rules Configure a regra de descoberta conforme a imagem abaixo, inserindo a chave ds.subdirs[] colocando entre colchetes o nome do diretório em que deseja listar todos os subdiretórios. Clique no botão Save. Neste parâmetro pode ser passado mais de um diretório pai, bastando dentro dos colchetes colocar os diretórios separados por virgula, ficando desta forma: ds.subdirs[d:\dir1,c:\Dir3,d:\dir3] Após salvo será aberto a tela conforma a imagem abaixo. Clique em Item prototypes. Clique no botão Create item prototype Configure o item conforme tela abaixo, observando os seguintes items, depois clique em Save Name: Used space on $1 Type: Zabbix agent Key: ds.subdirs.size[{#DIRPATH}] Type information: Numeric (unsigned) Data Type: Decimal Units: B Update interval: 21600 New application: Directory Depois clique em Graph prototype e clique em Create graph prototype. Configure conforme os itens abaixo Name: Used space on {#DIRPATH} Width: 600 Height: 340 Depois clique em Add prototype, selecione o item Used space on {#DIRPATH}. Altere o Draw Style para Dashed Line e clique em Save Solução de problemas Recentemente tivemos alguns reportes de erro no processo de busca e contagem do tamanho, sendo sim fiz algumas alterações na aplicação para melhorar a estratégia de busca bem como de identificação de erros. Caso encontre algum erro na aplicação basta executa-la conforme o comando abaixo, deste modo será gerado um arquivo de log no mesmo local do executável, conendo o log de processamento e possíveis mensagens de erro. [sourcecode language=&quot;text&quot;] C:\Zabbix\ZabbixDirSize.exe --sub-dirs --debug c:\diretorio_desejado C:\Zabbix\ZabbixDirSize.exe --size --debug c:\diretorio_desejado [/sourcecode] Timeout em diretórios grandes Recebi um feedback bem legal de algumas pessoas que estão usando o aplicativo, de timeout em diretórios grandes. Como solução para este problema implementei uma execução em background onde o aplicativo faz um fork e fica executando até que faça a leitura de todo o diretório para calcular o tamanho. Por segurança o aplicativo controla os seus objetos filhos para evitar que se abra mais de um fork para o mesmo diretório. Após este objeto filho finalizar a leitura do diretório, ele armazena o tamanho em um arquivo texto, para que o aplicativo pai possa realizar a leitura deste valor para o Zabbix. Para habilitar essa função basta adicionar o parâmetro --bg na linha de comando do aplicativo conforme exemplo abaixo. Esta opção só é válida juntamente com a opção --size. [sourcecode language=&quot;text&quot;] UserParameter=ds.subdirs.size[*],C:\Zabbix\ZabbixDirSize.exe --size --bg &quot;$1&quot; [/sourcecode]" /><link rel="canonical" href="https://www.helviojunior.com.br/it/monitoramento/monitorando-tamanho-de-diretorios-com-zabbix/" /><meta property="og:url" content="https://www.helviojunior.com.br/it/monitoramento/monitorando-tamanho-de-diretorios-com-zabbix/" /><meta property="og:site_name" content="Helvio Junior" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2013-07-01T18:26:43-03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Monitorando tamanho de diretórios com Zabbix" /><meta name="twitter:site" content="@helvioju" /><meta name="twitter:creator" content="@Helvio Junior (m4v3r1ck)" /><meta name="google-site-verification" content="JR4IIP9jfvOwxn2ybV_Qn0SrtDPlTrKomdPWgBuP55k"" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Helvio Junior (m4v3r1ck)"},"dateModified":"2023-08-17T00:19:29-03:00","datePublished":"2013-07-01T18:26:43-03:00","description":"Este post mostra como listar todos os subdiretórios dentro de um diretório e monitorar o tamanho destes. Para isso será necessário a utilização de um aplicativo (escrito por mim) que tem 2 funções: 1 - Listar todos os subdiretórios dentro de um diretório; 2 - Calcular o espaço em disco utilizado por estes diretórios. Este aplicativo chama-se ZabbixDirSize.exe e está disponível aqui (ZabbixDirSize), inclusive com código fonte. Configurando o agente Edite o arquivo de configuração do agente e adicione as linhas abaixo: [sourcecode language=&quot;text&quot;] UnsafeUserParameters=1 UserParameter=ds.subdirs[*],C:\\Zabbix\\ZabbixDirSize.exe --sub-dirs &quot;$1&quot; &quot;$2&quot; &quot;$3&quot; &quot;$4&quot; &quot;$5&quot; UserParameter=ds.subdirs.size[*],C:\\Zabbix\\ZabbixDirSize.exe --size &quot;$1&quot; [/sourcecode] Nas linhas acima criamos 2 chaves ds.subdirs e ds.subdirs.size, a primeira lista todos os diretórios dentro de um diretório específico e a segunda retorna o tamanho utilizado por um diretório. A chave ds.subdirs está passando até 5 diretórios (pai) para o executável. Caso deseje mais diretórios basta incluir as variaveis no final da linha ($6, $7, etc...) Edite o caminho do executável ZabbixDirSize.exe conforme o seu ambiente. Para que este executável funcione corretamente é necessário estar instalado na maquina o .NET 2.0 ou superior. Criando o Host no Zabbix, configuração a localização automática de subdiretórios dentro de um diretório específico e criando os itens de captura e gráficos. Crie o host dentro do Zabbix Clique no item Discovery rules Clique no item Create discovery rules Configure a regra de descoberta conforme a imagem abaixo, inserindo a chave ds.subdirs[] colocando entre colchetes o nome do diretório em que deseja listar todos os subdiretórios. Clique no botão Save. Neste parâmetro pode ser passado mais de um diretório pai, bastando dentro dos colchetes colocar os diretórios separados por virgula, ficando desta forma: ds.subdirs[d:\\dir1,c:\\Dir3,d:\\dir3] Após salvo será aberto a tela conforma a imagem abaixo. Clique em Item prototypes. Clique no botão Create item prototype Configure o item conforme tela abaixo, observando os seguintes items, depois clique em Save Name: Used space on $1 Type: Zabbix agent Key: ds.subdirs.size[{#DIRPATH}] Type information: Numeric (unsigned) Data Type: Decimal Units: B Update interval: 21600 New application: Directory Depois clique em Graph prototype e clique em Create graph prototype. Configure conforme os itens abaixo Name: Used space on {#DIRPATH} Width: 600 Height: 340 Depois clique em Add prototype, selecione o item Used space on {#DIRPATH}. Altere o Draw Style para Dashed Line e clique em Save Solução de problemas Recentemente tivemos alguns reportes de erro no processo de busca e contagem do tamanho, sendo sim fiz algumas alterações na aplicação para melhorar a estratégia de busca bem como de identificação de erros. Caso encontre algum erro na aplicação basta executa-la conforme o comando abaixo, deste modo será gerado um arquivo de log no mesmo local do executável, conendo o log de processamento e possíveis mensagens de erro. [sourcecode language=&quot;text&quot;] C:\\Zabbix\\ZabbixDirSize.exe --sub-dirs --debug c:\\diretorio_desejado C:\\Zabbix\\ZabbixDirSize.exe --size --debug c:\\diretorio_desejado [/sourcecode] Timeout em diretórios grandes Recebi um feedback bem legal de algumas pessoas que estão usando o aplicativo, de timeout em diretórios grandes. Como solução para este problema implementei uma execução em background onde o aplicativo faz um fork e fica executando até que faça a leitura de todo o diretório para calcular o tamanho. Por segurança o aplicativo controla os seus objetos filhos para evitar que se abra mais de um fork para o mesmo diretório. Após este objeto filho finalizar a leitura do diretório, ele armazena o tamanho em um arquivo texto, para que o aplicativo pai possa realizar a leitura deste valor para o Zabbix. Para habilitar essa função basta adicionar o parâmetro --bg na linha de comando do aplicativo conforme exemplo abaixo. Esta opção só é válida juntamente com a opção --size. [sourcecode language=&quot;text&quot;] UserParameter=ds.subdirs.size[*],C:\\Zabbix\\ZabbixDirSize.exe --size --bg &quot;$1&quot; [/sourcecode]","headline":"Monitorando tamanho de diretórios com Zabbix","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.helviojunior.com.br/it/monitoramento/monitorando-tamanho-de-diretorios-com-zabbix/"},"url":"https://www.helviojunior.com.br/it/monitoramento/monitorando-tamanho-de-diretorios-com-zabbix/"}</script><title>Monitorando tamanho de diretórios com Zabbix | Helvio Junior</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Helvio Junior"><meta name="application-name" content="Helvio Junior"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/m4v3r1ck.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Helvio Junior</a></div><div class="site-subtitle font-italic">Cyber security researcher, speaker, low level and binary exploitation entusiast. <br /><br />"I’m just a child who has never grown up. I still keep asking these 'how' & 'why' questions. Occasionally, I find an answer. Stephen Hawking"</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://www.linkedin.com/in/helviojunior" aria-label="linkedin" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.youtube.com/@Sec4US" aria-label="youtube" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-youtube"></i> </a> <a href="https://github.com/helviojunior" aria-label="github" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['helvio.junior','sec4us.com.br'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/it"> It </a> </span> <span> <a href="/monitoramento"> Monitoramento </a> </span> <span>Monitorando tamanho de diretórios com Zabbix</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Monitorando tamanho de diretórios com Zabbix</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Helvio Junior (m4v3r1ck) </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Jul 1, 2013, 6:26 PM -0300" prep="on" > Jul 1, 2013 <i class="unloaded">2013-07-01T18:26:43-03:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 17, 2023, 12:19 AM -0300" prefix="Updated " > Aug 17, 2023 <i class="unloaded">2023-08-17T00:19:29-03:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="595 words">3 min</span></div></div><div class="post-content"><p>Este post mostra como listar todos os subdiretórios dentro de um diretório e monitorar o tamanho destes.</p><p>Para isso será necessário a utilização de um aplicativo (escrito por mim) que tem 2 funções: 1 - Listar todos os subdiretórios dentro de um diretório; 2 - Calcular o espaço em disco utilizado por estes diretórios. Este aplicativo chama-se ZabbixDirSize.exe e está disponível aqui (<a href="/assets/2013/07/ZabbixDirSize.zip">ZabbixDirSize</a>), inclusive com código fonte.</p><p></p><p><strong>Configurando o agente</strong></p><p>Edite o arquivo de configuração do agente e adicione as linhas abaixo:</p><p>[sourcecode language="text"]<br /> UnsafeUserParameters=1<br /> UserParameter=ds.subdirs[*],C:\Zabbix\ZabbixDirSize.exe --sub-dirs &quot;$1&quot; &quot;$2&quot; &quot;$3&quot; &quot;$4&quot; &quot;$5&quot;<br /> UserParameter=ds.subdirs.size[*],C:\Zabbix\ZabbixDirSize.exe --size &quot;$1&quot;<br /> [/sourcecode]</p><p>Nas linhas acima criamos 2 chaves <strong>ds.subdirs</strong> e <strong>ds.subdirs.size</strong>, a primeira lista todos os diretórios dentro de um diretório específico e a segunda retorna o tamanho utilizado por um diretório.</p><p>A chave <strong>ds.subdirs</strong> está passando até 5 diretórios (pai) para o executável. Caso deseje mais diretórios basta incluir as variaveis no final da linha ($6, $7, etc...)</p><p>Edite o caminho do executável <strong>ZabbixDirSize.exe</strong> conforme o seu ambiente. Para que este executável funcione corretamente é necessário estar instalado na maquina o .NET 2.0 ou superior.</p><p>Criando o Host no Zabbix, configuração a localização automática de subdiretórios dentro de um diretório específico e criando os itens de captura e gráficos.</p><p>Crie o host dentro do Zabbix</p><p><a href="/assets/2013/07/001.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 535 295'%3E%3C/svg%3E" class="lazyload wp-image-678 alignnone" alt="Inserindo Host" data-src="/assets/2013/07/001.png" width="535" height="295" data-proofer-ignore></a></p><p>Clique no item <strong>Discovery rules</strong></p><p><a href="/assets/2013/07/002.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 608 150'%3E%3C/svg%3E" class="lazyload wp-image-679 alignnone" alt="002" data-src="/assets/2013/07/002.png" width="608" height="150" data-proofer-ignore></a></p><p>Clique no item <strong>Create discovery rules</strong></p><p><a href="/assets/2013/07/003.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 619 221'%3E%3C/svg%3E" class="lazyload wp-image-680 alignnone" alt="003" data-src="/assets/2013/07/003.png" width="619" height="221" data-proofer-ignore></a></p><p>Configure a regra de descoberta conforme a imagem abaixo, inserindo a chave <strong>ds.subdirs[]</strong> colocando entre colchetes o nome do diretório em que deseja listar todos os subdiretórios. Clique no botão <strong>Save.</strong></p><p>Neste parâmetro pode ser passado mais de um diretório pai, bastando dentro dos colchetes colocar os diretórios separados por virgula, ficando desta forma: <strong>ds.subdirs[d:\dir1,c:\Dir3,d:\dir3]</strong></p><p><a href="/assets/2013/07/004.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 608 194'%3E%3C/svg%3E" alt="004" data-src="/assets/2013/07/004.png" width="608" height="194" class="lazyload" data-proofer-ignore></a></p><p>Após salvo será aberto a tela conforma a imagem abaixo. Clique em<strong> Item prototypes</strong>.</p><p><a href="/assets/2013/07/005.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 618 43'%3E%3C/svg%3E" class="lazyload wp-image-682 alignnone" alt="005" data-src="/assets/2013/07/005.png" width="618" height="43" data-proofer-ignore></a></p><p>Clique no botão <strong>Create item prototype</strong></p><p><a href="/assets/2013/07/006.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 617 233'%3E%3C/svg%3E" class="lazyload wp-image-683 alignnone" alt="006" data-src="/assets/2013/07/006.png" width="617" height="233" data-proofer-ignore></a></p><p>Configure o item conforme tela abaixo, observando os seguintes items, depois clique em <strong>Save</strong></p><ul><li><span style="line-height: 13px;">Name: Used space on $1</span><li>Type: Zabbix agent<li>Key: ds.subdirs.size[{#DIRPATH}]<li>Type information: Numeric (unsigned)<li>Data Type: Decimal<li>Units: B<li>Update interval: 21600<li>New application: Directory</ul><p><a href="/assets/2013/07/007.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 606 582'%3E%3C/svg%3E" class="lazyload wp-image-684 alignnone" alt="007" data-src="/assets/2013/07/007.png" width="606" height="582" data-proofer-ignore></a></p><p>Depois clique em <strong>Graph prototype</strong> e clique em <strong>Create graph prototype. </strong>Configure conforme os itens abaixo</p><ul><li><span style="line-height: 13px;">Name: Used space on {#DIRPATH}</span><li>Width: 600<li>Height: 340</ul><p><a href="/assets/2013/07/009.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 617 390'%3E%3C/svg%3E" class="lazyload wp-image-686 alignnone" alt="009" data-src="/assets/2013/07/009.png" width="617" height="390" data-proofer-ignore></a></p><p>Depois clique em <strong>Add prototype, s</strong>elecione o item<strong> Used space on {#DIRPATH}</strong>.</p><p><a href="/assets/2013/07/010.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 480 64'%3E%3C/svg%3E" class="lazyload wp-image-687 alignnone" alt="010" data-src="/assets/2013/07/010.png" width="480" height="64" data-proofer-ignore></a></p><p>Altere o <strong>Draw Style</strong> para <strong>Dashed Line</strong> e clique em <strong>Save</strong></p><p><a href="/assets/2013/07/011.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 617 390'%3E%3C/svg%3E" class="lazyload wp-image-688 alignnone" alt="011" data-src="/assets/2013/07/011.png" width="617" height="390" data-proofer-ignore></a></p><p><strong>Solução de problemas</strong></p><p>Recentemente tivemos alguns reportes de erro no processo de busca e contagem do tamanho, sendo sim fiz algumas alterações na aplicação para melhorar a estratégia de busca bem como de identificação de erros.</p><p>Caso encontre algum erro na aplicação basta executa-la conforme o comando abaixo, deste modo será gerado um arquivo de log no mesmo local do executável, conendo o log de processamento e possíveis mensagens de erro.</p><p>[sourcecode language="text"]<br /> C:\Zabbix\ZabbixDirSize.exe --sub-dirs --debug c:\diretorio_desejado<br /> C:\Zabbix\ZabbixDirSize.exe --size --debug c:\diretorio_desejado<br /> [/sourcecode]</p><p><strong>Timeout em diretórios grandes</strong></p><p>Recebi um feedback bem legal de algumas pessoas que estão usando o aplicativo, de timeout em diretórios grandes. Como solução para este problema implementei uma execução em background onde o aplicativo faz um fork e fica executando até que faça a leitura de todo o diretório para calcular o tamanho. Por segurança o aplicativo controla os seus objetos filhos para evitar que se abra mais de um fork para o mesmo diretório. Após este objeto filho finalizar a leitura do diretório, ele armazena o tamanho em um arquivo texto, para que o aplicativo pai possa realizar a leitura deste valor para o Zabbix.</p><p>Para habilitar essa função basta adicionar o parâmetro --bg na linha de comando do aplicativo conforme exemplo abaixo. Esta opção só é válida juntamente com a opção --size.</p><p>[sourcecode language="text"]<br /> UserParameter=ds.subdirs.size[*],C:\Zabbix\ZabbixDirSize.exe --size --bg &quot;$1&quot;<br /> [/sourcecode]</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/monitoramento/'>Monitoramento</a>, <a href='/categories/zabbix/'>Zabbix</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Monitorando tamanho de diretórios com Zabbix - Helvio Junior&url=https://www.helviojunior.com.br/it/monitoramento/monitorando-tamanho-de-diretorios-com-zabbix/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Monitorando tamanho de diretórios com Zabbix - Helvio Junior&u=https://www.helviojunior.com.br/it/monitoramento/monitorando-tamanho-de-diretorios-com-zabbix/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Monitorando tamanho de diretórios com Zabbix - Helvio Junior&url=https://www.helviojunior.com.br/it/monitoramento/monitorando-tamanho-de-diretorios-com-zabbix/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.helviojunior.com.br/it/monitoramento/monitorando-tamanho-de-diretorios-com-zabbix/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/security/osint/localizando-ips-que-respondem-para-uma-url/">Localizando IPs que respondem para uma URL</a><li><a href="/security/osint/locating-url-ips-bypass-waf/">Locating IPs that respond to a URL</a><li><a href="/security/edr/instalando-elasticsearch-edr/">Instalando Elasticsearch EDR</a><li><a href="/it/instalando-openvpn-com-autenticacao-em-mysql/">Instalando OpenVPN com autenticação em MySQL</a><li><a href="/it/osce-osed-e-ecxd-certificacoes-de-desenvolvimento-de-exploits/">OSCE, OSED e eCXD: Certificações de desenvolvimento de Exploits</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/offensive-security/">Offensive Security</a> <a class="post-tag" href="/tags/pentest/">Pentest</a> <a class="post-tag" href="/tags/autoridade-certificadora/">autoridade certificadora</a> <a class="post-tag" href="/tags/ca/">ca</a> <a class="post-tag" href="/tags/certificate-authority/">certificate authority</a> <a class="post-tag" href="/tags/openssl/">openssl</a> <a class="post-tag" href="/tags/osce3/">OSCE3</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/osed/">OSED</a> <a class="post-tag" href="/tags/osee/">OSEE</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/it/devel/enviando-alerta-do-zabbix-via-gtalk/"><div class="card-body"> <span class="timeago small" > May 23, 2013 <i class="unloaded">2013-05-23T12:30:02-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Enviando alerta do Zabbix via Gtalk</h3><div class="text-muted small"><p> Este post tem o objetivo de demonstrar como criar um script para que o Zabbix possa enviar os alertas via Gtalk. Instalação dos pre-requisitos [sourcecode language="shell"]apt-get install python p...</p></div></div></a></div><div class="card"> <a href="/it/raspberry-pi-autologin-auto-start-uma-aplicacao-e-dessabilitar-screen-blanking/"><div class="card-body"> <span class="timeago small" > May 29, 2013 <i class="unloaded">2013-05-29T16:54:17-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Raspberry Pi, AutoLogin, Auto start uma aplicação e dessabilitar Screen blanking</h3><div class="text-muted small"><p> Este post demonstra como configurar o Raspberry (quando em modo de tela gráfica - x-session) para iniciar automaticamente uma aplicação e prevenir que entre em modo de espera, proteção de tela ou d...</p></div></div></a></div><div class="card"> <a href="/it/resgatando-ip-valido-do-agente-zabbix/"><div class="card-body"> <span class="timeago small" > Jul 20, 2013 <i class="unloaded">2013-07-20T10:47:17-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Resgatando IP válido do agente zabbix</h3><div class="text-muted small"><p> Em uma das construtivas discuções do grupo Zabbix Brasil (Blog | Yahoo), foi levantado a necessidade de obter o IP válido dos agentes ou dos proxies em caso de ambiente com IP dinâmico. Uma das sol...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/it/backup-com-dd-dd-backup-without-empty-space/" class="btn btn-outline-primary" prompt="Older"><p>Backup com dd (dd backup without empty space)</p></a> <a href="/it/como-implantar-o-vnc-usando-diretiva-de-grupo-gpo/" class="btn btn-outline-primary" prompt="Newer"><p>Como implantar o VNC usando Diretiva de Grupo (GPO)</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Monitorando tamanho de diretórios com Zabbix'; this.page.url = 'https://www.helviojunior.com.br/it/monitoramento/monitorando-tamanho-de-diretorios-com-zabbix/'; this.page.identifier = '/it/monitoramento/monitorando-tamanho-de-diretorios-com-zabbix/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/helviojunior">Helvio junior (aka M4v3r1ck)</a>. <span data-toggle="tooltip" data-placement="top" title="Some rights reserved.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/offensive-security/">Offensive Security</a> <a class="post-tag" href="/tags/pentest/">Pentest</a> <a class="post-tag" href="/tags/autoridade-certificadora/">autoridade certificadora</a> <a class="post-tag" href="/tags/ca/">ca</a> <a class="post-tag" href="/tags/certificate-authority/">certificate authority</a> <a class="post-tag" href="/tags/openssl/">openssl</a> <a class="post-tag" href="/tags/osce3/">OSCE3</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/osed/">OSED</a> <a class="post-tag" href="/tags/osee/">OSEE</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.helviojunior.com.br{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
