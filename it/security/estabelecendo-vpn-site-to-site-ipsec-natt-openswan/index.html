<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Estabelecendo VPN Site-to-site IPSEC com OpenSwan" /><meta name="author" content="Helvio Junior (m4v3r1ck)" /><meta property="og:locale" content="en_US" /><meta name="description" content="﻿Neste post veremos passo a passo como configurar o OpenSwan para estabelecer uma VPN Site-to-site (entre 2 redes)  utilizando segredo compartilhado ou certificado digital. No decorrer do post explicarei as diferenças quando um dos firewall está atrás de um equipamento realizando NAT-T. A motivação da escrita deste post se deu na necessidade de realizar essa VPN em meu ambiente somado ao fato que não encontrei na internet nenhum tutorial que trouxesse de forma simples, completa e bem comentada cada um dos parâmetros para o correto funcionamento do OpenSwan no ambiente proposto. Achei sim, diversos tutoriais, que me ajudaram muito, mas somente informações fragmentadas e muitas vezes confusas, sendo assim resolvi agregar todas em um único post. Espero que ajude. Ambiente Antes de iniciar a configuração propriamente dita do OpenSwan e dos equipamentos é necessário entender bem todo o nosso ambiente. Antes de mais nada é importante frisar que os IPs validos e inválidos deste ambiente são fictícios e escolhidos aleatoriamente, não representando qualquer ambiente real meu ou de cliente. Para os dois servidores de VPN foi utilizado o Ubuntu 12.0.4, e o OpenSwan do repositório do ubuntu. Esta imagem abaixo demonstra detalhadamente todo o nosso ambiente. Nela podemos observar que há 2 servidores de VPN, um na matriz e um na filial, e que o servidor da filial está atrás de um Roteador que está fazendo NAT. Este é um ambiente bem comum quando a filial está utilizando uma internet de baixo custo onde a operadora fornece o modem (como por exemplo ADSL) e este modem é quem recebe o IP válido e distribui uma rede inválida (comumente 192.168.x.x) para as maquinas internas. Configuração de rede dos servidores de VPN Segue abaixo a configuração de rede de cada um dos servidores VPN [caption id=&quot;attachment_1074&quot; align=&quot;alignnone&quot; width=&quot;405&quot;] Configuração de rede do servidor de VPN da Matriz[/caption] [caption id=&quot;attachment_1075&quot; align=&quot;alignnone&quot; width=&quot;405&quot;] Configuração de rede do servidor de VPN da Filial[/caption] Instalando OpenSwan O processo de instalação do OpenSwan é o mesmo para os dois equipamentos, desta forma execute os passos abaixo nos 2. Instalando o OpenSwan e OpenSSL [sourcecode language=&quot;shell&quot;]add-apt-repository ppa:openswan/ppa apt-get update apt-get install openssl openswan [/sourcecode] Neste processo será questionado se deseja criar um certificado digital para este servidor. Pode selecionar a opção &lt;NO&gt; Edite o arquivo /etc/ipsec.conf (em ambos equipamentos) para que ele fique com o seguinte conteúdo: [sourcecode language=&quot;shell&quot;]version 2.0 config setup dumpdir=/var/run/pluto/ nat_traversal=yes virtual_private=%v4:10.0.0.0/8 oe=off protostack=netkey conn %default authby=rsasig leftrsasigkey=%cert rightrsasigkey=%cert keyingtries=1 keylife=20m ikelifetime=240m include /etc/ipsec.d/*.conf [/sourcecode] Edite o arquivo /etc/ipsec.secrets para que ele fique com o seguinte conteúdo: [sourcecode language=&quot;shell&quot;]include /var/lib/openswan/ipsec.secrets.inc include /etc/ipsec.d/*.secret [/sourcecode] Edite o arquivo /etc/sysctl.conf e altere ou insira a seguinte linha. Esta configuração tem por objetivo permitir que o kernel do linux faça roteamento dos pacotes de rede. [sourcecode language=&quot;shell&quot;]net.ipv4.ip_forward = 1 [/sourcecode] E depois execute o seguinte comando para aplicar essa configuração: [sourcecode language=&quot;shell&quot;]sysctl -p [/sourcecode] Pronto as configurações gerais estão prontas, agora vamos para as configurações individuais de cada servidor de VPN. Um pouco sobre segredo compartilhado versus certificado digital Quando estamos configurando uma VPN com IPSEC há diversos fatores que podem influenciar e gerar problema no estabelecimento da conexão, desta forma sempre iniciamos a configuração de forma simples, e depois vamos incrementando opções e segurança. Seguindo esta lógica primeiro iremos configurar e estabelecer o tunnel VPN utilizando segredo compartilhado, para depois que o tunnel tiver OK possamos trocar para certificado digital. Mas porque isso? Porque com certificado digital há diversos outros fatores que podem gerar problema como data de validade do certificado, common name, tipo do certificado, autoridade certificadora entre outros, então a forma mais simples de isolar os problemas é primeiro estabelecer o tunnel usando segredo compartilhado. Por característica do protocolo IPSEC, para estabelecer um tunnel com segrede compartilhado é necessário saber o IP interno e externo de todos os envolvidos, não podendo ser nenhum dos 2 lados dinâmico, desta forma se em eu ambiente você utiliza uma internet com IP dinâmico, para estes primeiros passos descubra qual é o IP atualmente atribuido, faça a configuração com ele que nos próximos passos (depois de mudar o tunnel para usar certificado digital) iremos alterar para não precisar informar este IP na configuração. VPN Server Matriz Nesta sessão veremos todas as configurações que devem serem realizadas no servidor de VPN da matriz. Crie um arquivo nomeado /etc/ipsec.d/vpn1.conf e insira o seguinte conteúdo: [sourcecode language=&quot;shell&quot;]conn vpn1 # Nome da Conexão VPN type= tunnel authby= secret #Tipo de autenticação # Left security, (dados da Matriz) left= 200.165.10.50 # IP real/físico do servidor na matriz leftsubnet= 10.0.0.0/24 # Rede interna na Matriz para qual será estabelecido a VPN leftnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz # Right security, (dados da Filial) right= 201.80.24.7 # IP Externo (após o NAT) que o servidor sairá para conexão com a matriz rightsubnet= 10.0.1.0/24 # Rede interna da filial para qual será estabelecido a VPN rightnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz # Tipo de criptografia usada keyexchange=ike # IPSEC Fase 1 # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos # Formato de preenchimento &#39;cipher-hash;modpgroup, cipher-hash;modpgroup, ...&#39; # -&gt; Não é obrigatório o preenchimento do modpgroup # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5 # modpgroup disponíveis: modp1024, modp1536 e modp2048 ike= 3des-md5, 3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5 # IPSEC Fase 2 # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96 phase2alg = 3des-md5-96 # Antigo parametro &#39;esp&#39; que está obsoleto # Outras configurações pfs= no auto= start [/sourcecode] Agora crie o arquivo nomeado /etc/ipsec.d/vpn1.secret com o seguinte conteúdo [sourcecode language=&quot;shell&quot;]201.80.24.7 200.165.10.50: PSK &quot;123456&quot; [/sourcecode] Agora reinicie o serviço do ipsec com o seguinte comando [sourcecode language=&quot;shell&quot;]ipsec setup restart [/sourcecode] Caso deseje reiniciar somente um tunnel utilize os comandos abaixo [sourcecode language=&quot;shell&quot;]ipsec auto --down vpn1 ipsec auto --up vpn1 [/sourcecode] VPN Server Filial Nesta sessão veremos todas as configurações que devem serem realizadas no servidor de VPN da filial. Crie um arquivo nomeado /etc/ipsec.d/vpn1.conf e insira o seguinte conteúdo: [sourcecode language=&quot;shell&quot;]conn vpn1 # Nome da Conexão VPN type= tunnel authby= secret #Tipo de autenticação # Left security, (dados da Filial) left= 192.168.0.10 # IP real/físico do servidor na filial leftid= 201.80.24.7 # IP Externo (após o NAT) que o servidor sairá para conexão com a matriz leftsubnet= 10.0.1.0/24 # Rede interna na filial para qual será estabelecido a VPN leftnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial # Right security, (dados da Matriz) right= 200.165.10.50 # IP externo do servidor na matriz rightsubnet= 10.0.0.0/24 # Rede interna da matriz para qual será estabelecido a VPN rightnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial # Tipo de criptografia usada keyexchange=ike # IPSEC Fase 1 # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos # Formato de preenchimento &#39;cipher-hash;modpgroup, cipher-hash;modpgroup, ...&#39; # -&gt; Não é obrigatório o preenchimento do modpgroup # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5 # modpgroup disponíveis: modp1024, modp1536 e modp2048 ike= 3des-md5, 3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5 # IPSEC Fase 2 # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96 phase2alg = 3des-md5-96 # Antigo parametro &#39;esp&#39; que está obsoleto # Outras configurações pfs= no auto= start [/sourcecode] Agora crie o arquivo nomeado /etc/ipsec.d/vpn1.secret com o seguinte conteúdo [sourcecode language=&quot;shell&quot;]200.165.10.50 201.80.24.7: PSK &quot;123456&quot; [/sourcecode] Agora reinicie o serviço do ipsec com o seguinte comando [sourcecode language=&quot;shell&quot;]ipsec setup restart [/sourcecode] Caso deseje reiniciar somente um tunnel utilize os comandos abaixo [sourcecode language=&quot;shell&quot;]ipsec auto --down vpn1 ipsec auto --up vpn1 [/sourcecode] &nbsp; Verificando status e erros de configuração Após iniciar a configuração alguns passos podem ser feito para checar a configuração e correto carregamento da mesma, bem como erros no estabelecimento do tunnel. Verifique no arquivo de log /var/log/auth.log se estes 2 logs foram gerados, eles indicam que o arquivo de chaves da VPN foi carregado e que a vpn1 foi carregada e será iniciado o processo para estabelecer o tunnel [sourcecode language=&quot;shell&quot;]loading secrets from &quot;/etc/ipsec.d/vpn1.secret&quot; &quot;vpn1&quot; #1: initiating Main Mode [/sourcecode] E um dos logs mais legal de se ver é o que estabeleceu a SA, ou seja o tunnel está OK [sourcecode language=&quot;shell&quot;]&quot;vpn1&quot; #4: STATE_QUICK_I2: sent QI2, IPsec SA established tunnel mode {ESP=&gt;0xb71ffca5 [/sourcecode] Outro comando bem útil é o comando para verificar o status do ipsec [sourcecode language=&quot;shell&quot;]/usr/sbin/ipsec auto --status [/sourcecode] Este comando irá retornar uma saída parecida com essa. [sourcecode language=&quot;shell&quot;]000 using kernel interface: netkey 000 interface lo/lo ::1 000 interface lo/lo 127.0.0.1 000 interface lo/lo 127.0.0.1 000 interface eth0/eth0 10.0.0.1 000 interface eth0/eth0 10.0.0.1 000 interface eth1/eth1 200.165.10.50 000 interface eth1/eth1 200.165.10.50 000 %myid = (none) 000 debug none 000 000 virtual_private (%priv): 000 - allowed 1 subnet: 10.0.0.0/8 000 - disallowed 0 subnets: 000 WARNING: Disallowed subnets in virtual_private= is empty. If you have 000 private address space in internal use, it should be excluded! 000 000 algorithm ESP encrypt: id=2, name=ESP_DES, ivlen=8, keysizemin=64, keysizemax=64 000 algorithm ESP encrypt: id=3, name=ESP_3DES, ivlen=8, keysizemin=192, keysizemax=192 000 algorithm ESP encrypt: id=6, name=ESP_CAST, ivlen=8, keysizemin=40, keysizemax=128 000 algorithm ESP encrypt: id=7, name=ESP_BLOWFISH, ivlen=8, keysizemin=40, keysizemax=448 000 algorithm ESP encrypt: id=11, name=ESP_NULL, ivlen=0, keysizemin=0, keysizemax=0 000 algorithm ESP encrypt: id=12, name=ESP_AES, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=13, name=ESP_AES_CTR, ivlen=8, keysizemin=160, keysizemax=288 000 algorithm ESP encrypt: id=14, name=ESP_AES_CCM_A, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=15, name=ESP_AES_CCM_B, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=16, name=ESP_AES_CCM_C, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=18, name=ESP_AES_GCM_A, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=19, name=ESP_AES_GCM_B, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=20, name=ESP_AES_GCM_C, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=22, name=ESP_CAMELLIA, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=252, name=ESP_SERPENT, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=253, name=ESP_TWOFISH, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP auth attr: id=1, name=AUTH_ALGORITHM_HMAC_MD5, keysizemin=128, keysizemax=128 000 algorithm ESP auth attr: id=2, name=AUTH_ALGORITHM_HMAC_SHA1, keysizemin=160, keysizemax=160 000 algorithm ESP auth attr: id=5, name=AUTH_ALGORITHM_HMAC_SHA2_256, keysizemin=256, keysizemax=256 000 algorithm ESP auth attr: id=6, name=AUTH_ALGORITHM_HMAC_SHA2_384, keysizemin=384, keysizemax=384 000 algorithm ESP auth attr: id=7, name=AUTH_ALGORITHM_HMAC_SHA2_512, keysizemin=512, keysizemax=512 000 algorithm ESP auth attr: id=8, name=AUTH_ALGORITHM_HMAC_RIPEMD, keysizemin=160, keysizemax=160 000 algorithm ESP auth attr: id=9, name=AUTH_ALGORITHM_AES_CBC, keysizemin=128, keysizemax=128 000 algorithm ESP auth attr: id=251, name=AUTH_ALGORITHM_NULL_KAME, keysizemin=0, keysizemax=0 000 000 algorithm IKE encrypt: id=0, name=(null), blocksize=16, keydeflen=131 000 algorithm IKE encrypt: id=5, name=OAKLEY_3DES_CBC, blocksize=8, keydeflen=192 000 algorithm IKE encrypt: id=7, name=OAKLEY_AES_CBC, blocksize=16, keydeflen=128 000 algorithm IKE hash: id=1, name=OAKLEY_MD5, hashsize=16 000 algorithm IKE hash: id=2, name=OAKLEY_SHA1, hashsize=20 000 algorithm IKE hash: id=4, name=OAKLEY_SHA2_256, hashsize=32 000 algorithm IKE hash: id=6, name=OAKLEY_SHA2_512, hashsize=64 000 algorithm IKE dh group: id=2, name=OAKLEY_GROUP_MODP1024, bits=1024 000 algorithm IKE dh group: id=5, name=OAKLEY_GROUP_MODP1536, bits=1536 000 algorithm IKE dh group: id=14, name=OAKLEY_GROUP_MODP2048, bits=2048 000 algorithm IKE dh group: id=15, name=OAKLEY_GROUP_MODP3072, bits=3072 000 algorithm IKE dh group: id=16, name=OAKLEY_GROUP_MODP4096, bits=4096 000 algorithm IKE dh group: id=17, name=OAKLEY_GROUP_MODP6144, bits=6144 000 algorithm IKE dh group: id=18, name=OAKLEY_GROUP_MODP8192, bits=8192 000 algorithm IKE dh group: id=22, name=OAKLEY_GROUP_DH22, bits=1024 000 algorithm IKE dh group: id=23, name=OAKLEY_GROUP_DH23, bits=2048 000 algorithm IKE dh group: id=24, name=OAKLEY_GROUP_DH24, bits=2048 000 000 stats db_ops: {curr_cnt, total_cnt, maxsz} :context={0,2,64} trans={0,2,3072} attrs={0,2,2048} 000 000 &quot;vpn1&quot;: 10.0.0.0/24===200.165.10.50---200.165.10.1...200.165.10.1---201.80.24.7===10.0.1.0/24; erouted; eroute owner: #4 000 &quot;vpn1&quot;: myip=unset; hisip=unset; 000 &quot;vpn1&quot;: ike_life: 14400s; ipsec_life: 1200s; rekey_margin: 540s; rekey_fuzz: 100%; keyingtries: 1 000 &quot;vpn1&quot;: policy: PSK+ENCRYPT+TUNNEL+UP+IKEv2ALLOW+SAREFTRACK; prio: 24,24; interface: eth1; 000 &quot;vpn1&quot;: newest ISAKMP SA: #1; newest IPsec SA: #4; 000 &quot;vpn1&quot;: IKE algorithm newest: AES_CBC_128-SHA1-MODP2048 000 &quot;vpn1&quot;: ESP algorithms wanted: 3DES(3)_000-MD5(1)_096; flags=-strict 000 &quot;vpn1&quot;: ESP algorithms loaded: 3DES(3)_192-MD5(1)_096 000 &quot;vpn1&quot;: ESP algorithm newest: 3DES_000-HMAC_MD5; pfsgroup=&lt;N/A&gt; 000 000 #3: &quot;vpn1&quot;:4500 STATE_QUICK_R2 (IPsec SA established); EVENT_SA_REPLACE in 727s; isakmp#2; idle; import:not set 000 #3: &quot;vpn1&quot; esp.a0dfaa1a@201.80.24.7 esp.bf6f0287@200.165.10.50 tun.0@201.80.24.7 tun.0@200.165.10.50 ref=0 refhim=4294901761 000 #2: &quot;vpn1&quot;:4500 STATE_MAIN_R3 (sent MR3, ISAKMP SA established); EVENT_SA_REPLACE in 13926s; lastdpd=-1s(seq in:0 out:0); idle; import:not set 000 #4: &quot;vpn1&quot;:4500 STATE_QUICK_I2 (sent QI2, IPsec SA established); EVENT_SA_REPLACE in 453s; newest IPSEC; eroute owner; isakmp#1; idle; import:admin initiate 000 #4: &quot;vpn1&quot; esp.b71ffca5@201.80.24.7 esp.25fdf05f@200.165.10.50 tun.0@201.80.24.7 tun.0@200.165.10.50 ref=0 refhim=4294901761 000 #1: &quot;vpn1&quot;:4500 STATE_MAIN_I4 (ISAKMP SA established); EVENT_SA_REPLACE in 13163s; newest ISAKMP; lastdpd=-1s(seq in:0 out:0); idle; import:admin initiate 000 [/sourcecode] Neste retorno há diversas informações, mas as mais importantes estão no final, onde mostram as SAs estabelecidas, ou seja, os tunneis IPSEC estabelecidos. Pronto, a primeira fase da configuração está ok e nosso tunnel VPN estabelecido. Agora iniciaremos o processo para configuração utilizando certificado digital. Gerando certificados digitais Antes de realizarmos a configuração do OpenSwan para utilizar os certificados digitais é necessário ter ou gerar os certificados. Como o objetivo deste post é ser o mais completo possível, realizaremos todo o processo de geração da autoridade certificadora e assinatura/geração dos certificados. Se você não entende muito bem como funciona esse negócio de autoridade certificadora, cadeia de certificação segue alguns posts para você dar uma olhada antes de continuar: Certificação digital Instalando CA Root com OpenSSL Instalando CA Root com Windows Verificando de um certificado é válido para atuar como CA Agora sim podemos continuar com a geração dos certificados. Neste post veremos 2 formas de gerar estes certificados, a primeira e a mais simples utilizando um aplicativo windows que criei para gerar os certificados e a segunda e mais complexa utilizando os comandos OpenSSL (que funcionam em windows e linux) Gerando certificados com o aplicativo BuildCert Conforme ja comentado este aplicativo foi desenvolvido por mim especificamente para geração de certificados digitais para utilização em sistemas de VPN IPSEC, muitos dos aplicativos que realizam VPN IPSEC pedem configurações específicas nos certificados que são bem chatas de fazer através do openssl via linha de comando. Este aplicativo basicamente utiliza as próprias bibliotecas do OpenSSL para gerar os certificados. Este aplicativo cria desde a CA até os certificados individuais de cada servidor de VPN. Todos compatíveis com qualquer sistema de autoridade de certificação. Outra funcionalidade interessante deste aplicativo é que pode ser utilizado com a sua autoridade de certificadora atual (caso ja tenha uma instalada). Utilizando a CA atual para assinar o certificado Para realizar este processo utilizando a sua CA atual será necessário ter o arquivo .pfx ou .p12 da sua CA. Caso sua CA seja windows e você não saiba como realizar este procedimento no post Instalando CA Root com Windows eu ensino como realiza-lo. Gerando certificado Realize o download do aplicativo BuildCert (clicando aqui) e descompacte em qualquer lugar em seu PC. O Aplicativo terá a seguinte estrutura de arquivos, por mais que pareça que há duplicados todos são necessários. Modo de utilização [sourcecode language=&quot;shell&quot;]BuildCert.exe [common_name_ca] [common_name_cert] [password_ca] [password_cert] [/sourcecode] Ao ser iniciado o aplicativo irá buscar dentro do diretório certs o arquivo com o common mane da CA + a extensão pfx ex.: ca.meudominio.pfx, caso o arquivo exista o aplicativo irá abri-lo com a senha definida e utiliza-lo para assinar os certificados gerados, caso contrário o aplicativo irá criar este pfx e utiliza-lo para assinar os certificados gerados. Vamos para a pratica, execute os comandos abaixo para gerar uma CA com nome cavpn.tutorial e os certificados matriz.tutorial e filial.tutorial. Ambos com a senha 123456 [sourcecode language=&quot;shell&quot;]BuildCert.exe cavpn.tutorial matriz.tutorial 123456 123456 BuildCert.exe cavpn.tutorial filial.tutorial 123456 123456 [/sourcecode] Após a execução dos comandos 3 arquivos por certificado serão criados: .cer: arquivo do certificado digital X509 .key: chave privada do certificado .pfx: arquivo PKCS#12 contendo o certificado X509 + a chave privada Segue os prints dos certificados [caption id=&quot;attachment_1112&quot; align=&quot;alignnone&quot; width=&quot;251&quot;] Certificado da CA (Autoassinado)[/caption] [caption id=&quot;attachment_1113&quot; align=&quot;alignnone&quot; width=&quot;251&quot;] Certificado da matriz assinado pela CA[/caption] [caption id=&quot;attachment_1114&quot; align=&quot;alignnone&quot; width=&quot;251&quot;] Certificado da filial assinado pela CA[/caption] Pronto, os certificados foram gerados e estão prontos para serem utilizados no OpenSwan Gerando certificados com o OpenSSL Outro modo de gerar os certificados é utilizando diretamente o OpenSSL. Se você ja gerou os certificados através dos passos anteriores (aplicativo BuildCert) pode pular estes passos e ir direto para configuração dos tunneis. Gerando certificado Antes de tudo vamos preparar o ambiente para o OpenSSL, realize uma cópia do arquivo de configuração padrão do OpenSSL para o seu ambiente [sourcecode language=&quot;shell&quot;]cp cp /etc/ssl/openssl.cnf /etc/ipsec.d/ [/sourcecode] Edite o arquivo de configuração alterando as seguintes linhas [sourcecode language=&quot;shell&quot;][ CA_default ] dir = /etc/ipsec.d certificate = $dir/cacerts/cavpn.tutorial.cer private_key = $dir/private/cavpn.tutorial.key [/sourcecode] E por fim vamos criar arquivos e diretórios necessários para o correto funcionamento do OpenSSL [sourcecode language=&quot;shell&quot;]mkdir newcerts touch index.txt echo &quot;00&quot; &gt; serial [/sourcecode] Agora vamos criar a nossa CA através do comando abaixo [sourcecode language=&quot;shell&quot;]cd /etc/ipsec.d openssl req -x509 -days 3650 -config /etc/ipsec.d/openssl.cnf -newkey rsa:2048 -keyout private/cavpn.tutorial.key -out cacerts/cavpn.tutorial.cer [/sourcecode] Na execução deste comando diversas informações serão solicitadas, porém 2 delas são importantes, 1 - Senha da CA, essa senha será solicitada para assinar os certificados da matriz e da filial; 2 - CommonName, ou seja o nome da CA. Preencha estes dados conforme desejado ou seguindo o exemplo abaixo Gere a requisição e assine o certificado da matriz [sourcecode language=&quot;shell&quot;]openssl req -config /etc/ipsec.d/openssl.cnf -newkey rsa:1024 -keyout private/matriz.tutorial.key -out certs/matriz.tutorial.req openssl ca -in certs/matriz.tutorial.req -config /etc/ipsec.d/openssl.cnf -days 730 -out certs/matriz.tutorial.cer -notext openssl rsa -in private/matriz.tutorial.key -out private/matriz.tutorial.key [/sourcecode] Diversas informações serão solicitadas porém a mais importante é o CommonName que precisa ser o matriz.tutorial para que os próximos scripts funcionem corretamente Gere a requisição e assine o certificado da filial [sourcecode language=&quot;shell&quot;]openssl req -config /etc/ipsec.d/openssl.cnf -newkey rsa:1024 -keyout private/filial.tutorial.key -out certs/filial.tutorial.req openssl ca -in certs/filial.tutorial.req -config /etc/ipsec.d/openssl.cnf -days 730 -out certs/filial.tutorial.cer -notext openssl rsa -in private/filial.tutorial.key -out private/filial.tutorial.key [/sourcecode] Diversas informações serão solicitadas porém a mais importante é o CommonName que precisa ser o filial.tutorial para que os próximos scripts funcionem corretamente Pronto, os certificados estão gerados e pronto para serem utilizados. Configurando os tunneis ipsec para utilizar os certificados digitais Agora que temos todos os certificados a mão podemos iniciar a configuração do OpenSwan para estabelecer a VPN utilizando os certificados digitais, estes passos são individuais para cada servidor. VPN Server Matriz Copie os arquivos necessários para os seus respectivos locais de utilização conforme indicado na tabela abaixo: /etc/ipsec.d/cacerts/cavpn.tutorial.cer /etc/ipsec.d/certs/filial.tutorial.cer /etc/ipsec.d/certs/matriz.tutorial.cer /etc/ipsec.d/private/matriz.tutorial.key Edite o arquivo /etc/ipsec.d/vpn1.conf para que o mesmo fique com o seguinte conteúdo [sourcecode language=&quot;shell&quot;]conn vpn1 # Nome da Conexão VPN type= tunnel authby= rsasig #Tipo de autenticação # Left security, (dados da Matriz) left= 200.165.10.50 # IP real/físico do servidor na matriz leftid=@matriz.tutorial # CommonName do certificado leftrsasigkey=%cert leftcert=matriz.tutorial.cer # Nome do arquivo do certificado leftsubnet= 10.0.0.0/24 # Rede interna na Matriz para qual será estabelecido a VPN leftnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz # Right security, (dados da Filial) right= %any # Está tag indica que a conexão pode vir de qualquer IP rightid= @filial.tutorial # CommonName do certificado rightrsasigkey=%cert rightcert=filial.tutorial.cer # Nome do arquivo do certificado rightca=%same rightsubnet= 10.0.1.0/24 # Rede interna da filial para qual será estabelecido a VPN rightnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz # Tipo de criptografia usada keyexchange=ike # IPSEC Fase 1 # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos # Formato de preenchimento &#39;cipher-hash;modpgroup, cipher-hash;modpgroup, ...&#39; # -&gt; Não é obrigatório o preenchimento do modpgroup # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5 # modpgroup disponíveis: modp1024, modp1536 e modp2048 ike= 3des-md5,3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5 ikelifetime=28800s # IPSEC Fase 2 # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96 phase2=esp phase2alg=3des-md5-96 # Antigo parametro &#39;esp&#39; que está obsoleto keylife=28800s # Outras configurações pfs= no auto= start [/sourcecode] Além das alterações dos certificados digitais há uma alteração no parâmetro right que antes detinha o IP externo do servidor de VPN da filial e agora detém a tag %any, que possibilita que o IP externo do servidor de VPN da Filial possa trocar de IP sem a necessidade de alterar a configuração. Edite o arquivo /etc/ipsec.d/vpn1.secret, remova a linha atual e adicione a seguinte linha [sourcecode language=&quot;shell&quot;]: RSA matriz.tutorial.key &quot;123456&quot; [/sourcecode] Reinicie o serviço do ipsec e verifique no arquivo de log /var/log/auth.log se as linhas abaixo foram exibidas, elas indicam que a chave foi lida com sucesso. [sourcecode language=&quot;shell&quot;]loading secrets from &quot;/etc/ipsec.d/vpn1.secret&quot; loaded private key file &#39;/etc/ipsec.d/private/matriz.tutorial.key&#39; (1675 bytes) loaded private key for keyid: PPK_RSA:AwEAAfL4J &quot;vpn1&quot; #1: initiating Main Mode [/sourcecode] VPN Server Filial Copie os arquivos necessários para os seus respectivos locais de utilização conforme indicado na tabela abaixo: /etc/ipsec.d/cacerts/cavpn.tutorial.cer /etc/ipsec.d/certs/filial.tutorial.cer /etc/ipsec.d/certs/matriz.tutorial.cer /etc/ipsec.d/private/filial.tutorial.key Edite o arquivo /etc/ipsec.d/vpn1.conf para que o mesmo fique com o seguinte conteúdo [sourcecode language=&quot;shell&quot;]conn vpn1 # Nome da Conexão VPN type= tunnel authby= rsasig #Tipo de autenticação # Left security, (dados da Filial) left= 192.168.0.10 # IP real/físico do servidor na filial leftid=@filial.tutorial # CommonName do certificado leftrsasigkey=%cert leftcert=filial.tutorial.cer # Nome do arquivo do certificado leftsubnet= 10.0.1.0/24 # Rede interna na filial para qual será estabelecido a VPN leftnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial # Right security, (dados da Matriz) right= 200.165.10.50 # IP externo do servidor na matriz rightid= @matriz.tutorial # CommonName do certificado rightrsasigkey=%cert rightcert=matriz.tutorial.cer # Nome do arquivo do certificado rightca=%same rightsubnet= 10.0.0.0/24 # Rede interna da matriz para qual será estabelecido a VPN rightnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial # Tipo de criptografia usada keyexchange=ike # IPSEC Fase 1 # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos # Formato de preenchimento &#39;cipher-hash;modpgroup, cipher-hash;modpgroup, ...&#39; # -&gt; Não é obrigatório o preenchimento do modpgroup # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5 # modpgroup disponíveis: modp1024, modp1536 e modp2048 ike= 3des-md5,3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5 ikelifetime=28800s # IPSEC Fase 2 # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96 phase2=esp phase2alg=3des-md5-96 # Antigo parametro &#39;esp&#39; que está obsoleto keylife=28800s # Outras configurações pfs= no auto= start [/sourcecode] Edite o arquivo /etc/ipsec.d/vpn1.secret, remova a linha atual e adicione a seguinte linha [sourcecode language=&quot;shell&quot;]: RSA filial.tutorial.key &quot;123456&quot; [/sourcecode] Reinicie o serviço do ipsec e verifique no arquivo de log /var/log/auth.log se as linhas abaixo foram exibidas, elas indicam que a chave foi lida com sucesso. [sourcecode language=&quot;shell&quot;]loading secrets from &quot;/etc/ipsec.d/vpn1.secret&quot; loaded private key file &#39;/etc/ipsec.d/private/filial.tutorial.key&#39; (1679 bytes) loaded private key for keyid: PPK_RSA:AwEAAdWyO [/sourcecode] Troubleshooting Caso seja necessário ter um numero maior de informações e log basta adicionar as linhas de log no arquivo /etc/ipsec.conf conforme abaixo [sourcecode language=&quot;shell&quot;]version 2.0 config setup ... plutodebug=all plutostderrlog=/var/log/openswan.log [/sourcecode] Considerações finais Neste post vimos como realizar todo o procedimento utilizando como servidor de VPN dois equipamentos com o OpensSwan, porém o procedimento é exatamente o mesmo para ambientes onde um dos equipamentos não é OpenSwan, como por exemplo, Cisco, Microsoft TMG, Aker, pfSense, Dlink entre outros. Como continuidade irei demonstrar como substituir o equipamento da matriz por outros sistemas. Assim que tiver um tempo elaborarei estes outros tutoriais e posto aqui no site. Caso você quera compartilhar a sua experiência substituindo uma das pontas por outro equipamento, me envie o passo a passo com prints, comandos e arquivos de configuração que posto no site com os seus créditos." /><meta property="og:description" content="﻿Neste post veremos passo a passo como configurar o OpenSwan para estabelecer uma VPN Site-to-site (entre 2 redes)  utilizando segredo compartilhado ou certificado digital. No decorrer do post explicarei as diferenças quando um dos firewall está atrás de um equipamento realizando NAT-T. A motivação da escrita deste post se deu na necessidade de realizar essa VPN em meu ambiente somado ao fato que não encontrei na internet nenhum tutorial que trouxesse de forma simples, completa e bem comentada cada um dos parâmetros para o correto funcionamento do OpenSwan no ambiente proposto. Achei sim, diversos tutoriais, que me ajudaram muito, mas somente informações fragmentadas e muitas vezes confusas, sendo assim resolvi agregar todas em um único post. Espero que ajude. Ambiente Antes de iniciar a configuração propriamente dita do OpenSwan e dos equipamentos é necessário entender bem todo o nosso ambiente. Antes de mais nada é importante frisar que os IPs validos e inválidos deste ambiente são fictícios e escolhidos aleatoriamente, não representando qualquer ambiente real meu ou de cliente. Para os dois servidores de VPN foi utilizado o Ubuntu 12.0.4, e o OpenSwan do repositório do ubuntu. Esta imagem abaixo demonstra detalhadamente todo o nosso ambiente. Nela podemos observar que há 2 servidores de VPN, um na matriz e um na filial, e que o servidor da filial está atrás de um Roteador que está fazendo NAT. Este é um ambiente bem comum quando a filial está utilizando uma internet de baixo custo onde a operadora fornece o modem (como por exemplo ADSL) e este modem é quem recebe o IP válido e distribui uma rede inválida (comumente 192.168.x.x) para as maquinas internas. Configuração de rede dos servidores de VPN Segue abaixo a configuração de rede de cada um dos servidores VPN [caption id=&quot;attachment_1074&quot; align=&quot;alignnone&quot; width=&quot;405&quot;] Configuração de rede do servidor de VPN da Matriz[/caption] [caption id=&quot;attachment_1075&quot; align=&quot;alignnone&quot; width=&quot;405&quot;] Configuração de rede do servidor de VPN da Filial[/caption] Instalando OpenSwan O processo de instalação do OpenSwan é o mesmo para os dois equipamentos, desta forma execute os passos abaixo nos 2. Instalando o OpenSwan e OpenSSL [sourcecode language=&quot;shell&quot;]add-apt-repository ppa:openswan/ppa apt-get update apt-get install openssl openswan [/sourcecode] Neste processo será questionado se deseja criar um certificado digital para este servidor. Pode selecionar a opção &lt;NO&gt; Edite o arquivo /etc/ipsec.conf (em ambos equipamentos) para que ele fique com o seguinte conteúdo: [sourcecode language=&quot;shell&quot;]version 2.0 config setup dumpdir=/var/run/pluto/ nat_traversal=yes virtual_private=%v4:10.0.0.0/8 oe=off protostack=netkey conn %default authby=rsasig leftrsasigkey=%cert rightrsasigkey=%cert keyingtries=1 keylife=20m ikelifetime=240m include /etc/ipsec.d/*.conf [/sourcecode] Edite o arquivo /etc/ipsec.secrets para que ele fique com o seguinte conteúdo: [sourcecode language=&quot;shell&quot;]include /var/lib/openswan/ipsec.secrets.inc include /etc/ipsec.d/*.secret [/sourcecode] Edite o arquivo /etc/sysctl.conf e altere ou insira a seguinte linha. Esta configuração tem por objetivo permitir que o kernel do linux faça roteamento dos pacotes de rede. [sourcecode language=&quot;shell&quot;]net.ipv4.ip_forward = 1 [/sourcecode] E depois execute o seguinte comando para aplicar essa configuração: [sourcecode language=&quot;shell&quot;]sysctl -p [/sourcecode] Pronto as configurações gerais estão prontas, agora vamos para as configurações individuais de cada servidor de VPN. Um pouco sobre segredo compartilhado versus certificado digital Quando estamos configurando uma VPN com IPSEC há diversos fatores que podem influenciar e gerar problema no estabelecimento da conexão, desta forma sempre iniciamos a configuração de forma simples, e depois vamos incrementando opções e segurança. Seguindo esta lógica primeiro iremos configurar e estabelecer o tunnel VPN utilizando segredo compartilhado, para depois que o tunnel tiver OK possamos trocar para certificado digital. Mas porque isso? Porque com certificado digital há diversos outros fatores que podem gerar problema como data de validade do certificado, common name, tipo do certificado, autoridade certificadora entre outros, então a forma mais simples de isolar os problemas é primeiro estabelecer o tunnel usando segredo compartilhado. Por característica do protocolo IPSEC, para estabelecer um tunnel com segrede compartilhado é necessário saber o IP interno e externo de todos os envolvidos, não podendo ser nenhum dos 2 lados dinâmico, desta forma se em eu ambiente você utiliza uma internet com IP dinâmico, para estes primeiros passos descubra qual é o IP atualmente atribuido, faça a configuração com ele que nos próximos passos (depois de mudar o tunnel para usar certificado digital) iremos alterar para não precisar informar este IP na configuração. VPN Server Matriz Nesta sessão veremos todas as configurações que devem serem realizadas no servidor de VPN da matriz. Crie um arquivo nomeado /etc/ipsec.d/vpn1.conf e insira o seguinte conteúdo: [sourcecode language=&quot;shell&quot;]conn vpn1 # Nome da Conexão VPN type= tunnel authby= secret #Tipo de autenticação # Left security, (dados da Matriz) left= 200.165.10.50 # IP real/físico do servidor na matriz leftsubnet= 10.0.0.0/24 # Rede interna na Matriz para qual será estabelecido a VPN leftnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz # Right security, (dados da Filial) right= 201.80.24.7 # IP Externo (após o NAT) que o servidor sairá para conexão com a matriz rightsubnet= 10.0.1.0/24 # Rede interna da filial para qual será estabelecido a VPN rightnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz # Tipo de criptografia usada keyexchange=ike # IPSEC Fase 1 # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos # Formato de preenchimento &#39;cipher-hash;modpgroup, cipher-hash;modpgroup, ...&#39; # -&gt; Não é obrigatório o preenchimento do modpgroup # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5 # modpgroup disponíveis: modp1024, modp1536 e modp2048 ike= 3des-md5, 3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5 # IPSEC Fase 2 # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96 phase2alg = 3des-md5-96 # Antigo parametro &#39;esp&#39; que está obsoleto # Outras configurações pfs= no auto= start [/sourcecode] Agora crie o arquivo nomeado /etc/ipsec.d/vpn1.secret com o seguinte conteúdo [sourcecode language=&quot;shell&quot;]201.80.24.7 200.165.10.50: PSK &quot;123456&quot; [/sourcecode] Agora reinicie o serviço do ipsec com o seguinte comando [sourcecode language=&quot;shell&quot;]ipsec setup restart [/sourcecode] Caso deseje reiniciar somente um tunnel utilize os comandos abaixo [sourcecode language=&quot;shell&quot;]ipsec auto --down vpn1 ipsec auto --up vpn1 [/sourcecode] VPN Server Filial Nesta sessão veremos todas as configurações que devem serem realizadas no servidor de VPN da filial. Crie um arquivo nomeado /etc/ipsec.d/vpn1.conf e insira o seguinte conteúdo: [sourcecode language=&quot;shell&quot;]conn vpn1 # Nome da Conexão VPN type= tunnel authby= secret #Tipo de autenticação # Left security, (dados da Filial) left= 192.168.0.10 # IP real/físico do servidor na filial leftid= 201.80.24.7 # IP Externo (após o NAT) que o servidor sairá para conexão com a matriz leftsubnet= 10.0.1.0/24 # Rede interna na filial para qual será estabelecido a VPN leftnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial # Right security, (dados da Matriz) right= 200.165.10.50 # IP externo do servidor na matriz rightsubnet= 10.0.0.0/24 # Rede interna da matriz para qual será estabelecido a VPN rightnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial # Tipo de criptografia usada keyexchange=ike # IPSEC Fase 1 # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos # Formato de preenchimento &#39;cipher-hash;modpgroup, cipher-hash;modpgroup, ...&#39; # -&gt; Não é obrigatório o preenchimento do modpgroup # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5 # modpgroup disponíveis: modp1024, modp1536 e modp2048 ike= 3des-md5, 3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5 # IPSEC Fase 2 # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96 phase2alg = 3des-md5-96 # Antigo parametro &#39;esp&#39; que está obsoleto # Outras configurações pfs= no auto= start [/sourcecode] Agora crie o arquivo nomeado /etc/ipsec.d/vpn1.secret com o seguinte conteúdo [sourcecode language=&quot;shell&quot;]200.165.10.50 201.80.24.7: PSK &quot;123456&quot; [/sourcecode] Agora reinicie o serviço do ipsec com o seguinte comando [sourcecode language=&quot;shell&quot;]ipsec setup restart [/sourcecode] Caso deseje reiniciar somente um tunnel utilize os comandos abaixo [sourcecode language=&quot;shell&quot;]ipsec auto --down vpn1 ipsec auto --up vpn1 [/sourcecode] &nbsp; Verificando status e erros de configuração Após iniciar a configuração alguns passos podem ser feito para checar a configuração e correto carregamento da mesma, bem como erros no estabelecimento do tunnel. Verifique no arquivo de log /var/log/auth.log se estes 2 logs foram gerados, eles indicam que o arquivo de chaves da VPN foi carregado e que a vpn1 foi carregada e será iniciado o processo para estabelecer o tunnel [sourcecode language=&quot;shell&quot;]loading secrets from &quot;/etc/ipsec.d/vpn1.secret&quot; &quot;vpn1&quot; #1: initiating Main Mode [/sourcecode] E um dos logs mais legal de se ver é o que estabeleceu a SA, ou seja o tunnel está OK [sourcecode language=&quot;shell&quot;]&quot;vpn1&quot; #4: STATE_QUICK_I2: sent QI2, IPsec SA established tunnel mode {ESP=&gt;0xb71ffca5 [/sourcecode] Outro comando bem útil é o comando para verificar o status do ipsec [sourcecode language=&quot;shell&quot;]/usr/sbin/ipsec auto --status [/sourcecode] Este comando irá retornar uma saída parecida com essa. [sourcecode language=&quot;shell&quot;]000 using kernel interface: netkey 000 interface lo/lo ::1 000 interface lo/lo 127.0.0.1 000 interface lo/lo 127.0.0.1 000 interface eth0/eth0 10.0.0.1 000 interface eth0/eth0 10.0.0.1 000 interface eth1/eth1 200.165.10.50 000 interface eth1/eth1 200.165.10.50 000 %myid = (none) 000 debug none 000 000 virtual_private (%priv): 000 - allowed 1 subnet: 10.0.0.0/8 000 - disallowed 0 subnets: 000 WARNING: Disallowed subnets in virtual_private= is empty. If you have 000 private address space in internal use, it should be excluded! 000 000 algorithm ESP encrypt: id=2, name=ESP_DES, ivlen=8, keysizemin=64, keysizemax=64 000 algorithm ESP encrypt: id=3, name=ESP_3DES, ivlen=8, keysizemin=192, keysizemax=192 000 algorithm ESP encrypt: id=6, name=ESP_CAST, ivlen=8, keysizemin=40, keysizemax=128 000 algorithm ESP encrypt: id=7, name=ESP_BLOWFISH, ivlen=8, keysizemin=40, keysizemax=448 000 algorithm ESP encrypt: id=11, name=ESP_NULL, ivlen=0, keysizemin=0, keysizemax=0 000 algorithm ESP encrypt: id=12, name=ESP_AES, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=13, name=ESP_AES_CTR, ivlen=8, keysizemin=160, keysizemax=288 000 algorithm ESP encrypt: id=14, name=ESP_AES_CCM_A, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=15, name=ESP_AES_CCM_B, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=16, name=ESP_AES_CCM_C, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=18, name=ESP_AES_GCM_A, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=19, name=ESP_AES_GCM_B, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=20, name=ESP_AES_GCM_C, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=22, name=ESP_CAMELLIA, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=252, name=ESP_SERPENT, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=253, name=ESP_TWOFISH, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP auth attr: id=1, name=AUTH_ALGORITHM_HMAC_MD5, keysizemin=128, keysizemax=128 000 algorithm ESP auth attr: id=2, name=AUTH_ALGORITHM_HMAC_SHA1, keysizemin=160, keysizemax=160 000 algorithm ESP auth attr: id=5, name=AUTH_ALGORITHM_HMAC_SHA2_256, keysizemin=256, keysizemax=256 000 algorithm ESP auth attr: id=6, name=AUTH_ALGORITHM_HMAC_SHA2_384, keysizemin=384, keysizemax=384 000 algorithm ESP auth attr: id=7, name=AUTH_ALGORITHM_HMAC_SHA2_512, keysizemin=512, keysizemax=512 000 algorithm ESP auth attr: id=8, name=AUTH_ALGORITHM_HMAC_RIPEMD, keysizemin=160, keysizemax=160 000 algorithm ESP auth attr: id=9, name=AUTH_ALGORITHM_AES_CBC, keysizemin=128, keysizemax=128 000 algorithm ESP auth attr: id=251, name=AUTH_ALGORITHM_NULL_KAME, keysizemin=0, keysizemax=0 000 000 algorithm IKE encrypt: id=0, name=(null), blocksize=16, keydeflen=131 000 algorithm IKE encrypt: id=5, name=OAKLEY_3DES_CBC, blocksize=8, keydeflen=192 000 algorithm IKE encrypt: id=7, name=OAKLEY_AES_CBC, blocksize=16, keydeflen=128 000 algorithm IKE hash: id=1, name=OAKLEY_MD5, hashsize=16 000 algorithm IKE hash: id=2, name=OAKLEY_SHA1, hashsize=20 000 algorithm IKE hash: id=4, name=OAKLEY_SHA2_256, hashsize=32 000 algorithm IKE hash: id=6, name=OAKLEY_SHA2_512, hashsize=64 000 algorithm IKE dh group: id=2, name=OAKLEY_GROUP_MODP1024, bits=1024 000 algorithm IKE dh group: id=5, name=OAKLEY_GROUP_MODP1536, bits=1536 000 algorithm IKE dh group: id=14, name=OAKLEY_GROUP_MODP2048, bits=2048 000 algorithm IKE dh group: id=15, name=OAKLEY_GROUP_MODP3072, bits=3072 000 algorithm IKE dh group: id=16, name=OAKLEY_GROUP_MODP4096, bits=4096 000 algorithm IKE dh group: id=17, name=OAKLEY_GROUP_MODP6144, bits=6144 000 algorithm IKE dh group: id=18, name=OAKLEY_GROUP_MODP8192, bits=8192 000 algorithm IKE dh group: id=22, name=OAKLEY_GROUP_DH22, bits=1024 000 algorithm IKE dh group: id=23, name=OAKLEY_GROUP_DH23, bits=2048 000 algorithm IKE dh group: id=24, name=OAKLEY_GROUP_DH24, bits=2048 000 000 stats db_ops: {curr_cnt, total_cnt, maxsz} :context={0,2,64} trans={0,2,3072} attrs={0,2,2048} 000 000 &quot;vpn1&quot;: 10.0.0.0/24===200.165.10.50---200.165.10.1...200.165.10.1---201.80.24.7===10.0.1.0/24; erouted; eroute owner: #4 000 &quot;vpn1&quot;: myip=unset; hisip=unset; 000 &quot;vpn1&quot;: ike_life: 14400s; ipsec_life: 1200s; rekey_margin: 540s; rekey_fuzz: 100%; keyingtries: 1 000 &quot;vpn1&quot;: policy: PSK+ENCRYPT+TUNNEL+UP+IKEv2ALLOW+SAREFTRACK; prio: 24,24; interface: eth1; 000 &quot;vpn1&quot;: newest ISAKMP SA: #1; newest IPsec SA: #4; 000 &quot;vpn1&quot;: IKE algorithm newest: AES_CBC_128-SHA1-MODP2048 000 &quot;vpn1&quot;: ESP algorithms wanted: 3DES(3)_000-MD5(1)_096; flags=-strict 000 &quot;vpn1&quot;: ESP algorithms loaded: 3DES(3)_192-MD5(1)_096 000 &quot;vpn1&quot;: ESP algorithm newest: 3DES_000-HMAC_MD5; pfsgroup=&lt;N/A&gt; 000 000 #3: &quot;vpn1&quot;:4500 STATE_QUICK_R2 (IPsec SA established); EVENT_SA_REPLACE in 727s; isakmp#2; idle; import:not set 000 #3: &quot;vpn1&quot; esp.a0dfaa1a@201.80.24.7 esp.bf6f0287@200.165.10.50 tun.0@201.80.24.7 tun.0@200.165.10.50 ref=0 refhim=4294901761 000 #2: &quot;vpn1&quot;:4500 STATE_MAIN_R3 (sent MR3, ISAKMP SA established); EVENT_SA_REPLACE in 13926s; lastdpd=-1s(seq in:0 out:0); idle; import:not set 000 #4: &quot;vpn1&quot;:4500 STATE_QUICK_I2 (sent QI2, IPsec SA established); EVENT_SA_REPLACE in 453s; newest IPSEC; eroute owner; isakmp#1; idle; import:admin initiate 000 #4: &quot;vpn1&quot; esp.b71ffca5@201.80.24.7 esp.25fdf05f@200.165.10.50 tun.0@201.80.24.7 tun.0@200.165.10.50 ref=0 refhim=4294901761 000 #1: &quot;vpn1&quot;:4500 STATE_MAIN_I4 (ISAKMP SA established); EVENT_SA_REPLACE in 13163s; newest ISAKMP; lastdpd=-1s(seq in:0 out:0); idle; import:admin initiate 000 [/sourcecode] Neste retorno há diversas informações, mas as mais importantes estão no final, onde mostram as SAs estabelecidas, ou seja, os tunneis IPSEC estabelecidos. Pronto, a primeira fase da configuração está ok e nosso tunnel VPN estabelecido. Agora iniciaremos o processo para configuração utilizando certificado digital. Gerando certificados digitais Antes de realizarmos a configuração do OpenSwan para utilizar os certificados digitais é necessário ter ou gerar os certificados. Como o objetivo deste post é ser o mais completo possível, realizaremos todo o processo de geração da autoridade certificadora e assinatura/geração dos certificados. Se você não entende muito bem como funciona esse negócio de autoridade certificadora, cadeia de certificação segue alguns posts para você dar uma olhada antes de continuar: Certificação digital Instalando CA Root com OpenSSL Instalando CA Root com Windows Verificando de um certificado é válido para atuar como CA Agora sim podemos continuar com a geração dos certificados. Neste post veremos 2 formas de gerar estes certificados, a primeira e a mais simples utilizando um aplicativo windows que criei para gerar os certificados e a segunda e mais complexa utilizando os comandos OpenSSL (que funcionam em windows e linux) Gerando certificados com o aplicativo BuildCert Conforme ja comentado este aplicativo foi desenvolvido por mim especificamente para geração de certificados digitais para utilização em sistemas de VPN IPSEC, muitos dos aplicativos que realizam VPN IPSEC pedem configurações específicas nos certificados que são bem chatas de fazer através do openssl via linha de comando. Este aplicativo basicamente utiliza as próprias bibliotecas do OpenSSL para gerar os certificados. Este aplicativo cria desde a CA até os certificados individuais de cada servidor de VPN. Todos compatíveis com qualquer sistema de autoridade de certificação. Outra funcionalidade interessante deste aplicativo é que pode ser utilizado com a sua autoridade de certificadora atual (caso ja tenha uma instalada). Utilizando a CA atual para assinar o certificado Para realizar este processo utilizando a sua CA atual será necessário ter o arquivo .pfx ou .p12 da sua CA. Caso sua CA seja windows e você não saiba como realizar este procedimento no post Instalando CA Root com Windows eu ensino como realiza-lo. Gerando certificado Realize o download do aplicativo BuildCert (clicando aqui) e descompacte em qualquer lugar em seu PC. O Aplicativo terá a seguinte estrutura de arquivos, por mais que pareça que há duplicados todos são necessários. Modo de utilização [sourcecode language=&quot;shell&quot;]BuildCert.exe [common_name_ca] [common_name_cert] [password_ca] [password_cert] [/sourcecode] Ao ser iniciado o aplicativo irá buscar dentro do diretório certs o arquivo com o common mane da CA + a extensão pfx ex.: ca.meudominio.pfx, caso o arquivo exista o aplicativo irá abri-lo com a senha definida e utiliza-lo para assinar os certificados gerados, caso contrário o aplicativo irá criar este pfx e utiliza-lo para assinar os certificados gerados. Vamos para a pratica, execute os comandos abaixo para gerar uma CA com nome cavpn.tutorial e os certificados matriz.tutorial e filial.tutorial. Ambos com a senha 123456 [sourcecode language=&quot;shell&quot;]BuildCert.exe cavpn.tutorial matriz.tutorial 123456 123456 BuildCert.exe cavpn.tutorial filial.tutorial 123456 123456 [/sourcecode] Após a execução dos comandos 3 arquivos por certificado serão criados: .cer: arquivo do certificado digital X509 .key: chave privada do certificado .pfx: arquivo PKCS#12 contendo o certificado X509 + a chave privada Segue os prints dos certificados [caption id=&quot;attachment_1112&quot; align=&quot;alignnone&quot; width=&quot;251&quot;] Certificado da CA (Autoassinado)[/caption] [caption id=&quot;attachment_1113&quot; align=&quot;alignnone&quot; width=&quot;251&quot;] Certificado da matriz assinado pela CA[/caption] [caption id=&quot;attachment_1114&quot; align=&quot;alignnone&quot; width=&quot;251&quot;] Certificado da filial assinado pela CA[/caption] Pronto, os certificados foram gerados e estão prontos para serem utilizados no OpenSwan Gerando certificados com o OpenSSL Outro modo de gerar os certificados é utilizando diretamente o OpenSSL. Se você ja gerou os certificados através dos passos anteriores (aplicativo BuildCert) pode pular estes passos e ir direto para configuração dos tunneis. Gerando certificado Antes de tudo vamos preparar o ambiente para o OpenSSL, realize uma cópia do arquivo de configuração padrão do OpenSSL para o seu ambiente [sourcecode language=&quot;shell&quot;]cp cp /etc/ssl/openssl.cnf /etc/ipsec.d/ [/sourcecode] Edite o arquivo de configuração alterando as seguintes linhas [sourcecode language=&quot;shell&quot;][ CA_default ] dir = /etc/ipsec.d certificate = $dir/cacerts/cavpn.tutorial.cer private_key = $dir/private/cavpn.tutorial.key [/sourcecode] E por fim vamos criar arquivos e diretórios necessários para o correto funcionamento do OpenSSL [sourcecode language=&quot;shell&quot;]mkdir newcerts touch index.txt echo &quot;00&quot; &gt; serial [/sourcecode] Agora vamos criar a nossa CA através do comando abaixo [sourcecode language=&quot;shell&quot;]cd /etc/ipsec.d openssl req -x509 -days 3650 -config /etc/ipsec.d/openssl.cnf -newkey rsa:2048 -keyout private/cavpn.tutorial.key -out cacerts/cavpn.tutorial.cer [/sourcecode] Na execução deste comando diversas informações serão solicitadas, porém 2 delas são importantes, 1 - Senha da CA, essa senha será solicitada para assinar os certificados da matriz e da filial; 2 - CommonName, ou seja o nome da CA. Preencha estes dados conforme desejado ou seguindo o exemplo abaixo Gere a requisição e assine o certificado da matriz [sourcecode language=&quot;shell&quot;]openssl req -config /etc/ipsec.d/openssl.cnf -newkey rsa:1024 -keyout private/matriz.tutorial.key -out certs/matriz.tutorial.req openssl ca -in certs/matriz.tutorial.req -config /etc/ipsec.d/openssl.cnf -days 730 -out certs/matriz.tutorial.cer -notext openssl rsa -in private/matriz.tutorial.key -out private/matriz.tutorial.key [/sourcecode] Diversas informações serão solicitadas porém a mais importante é o CommonName que precisa ser o matriz.tutorial para que os próximos scripts funcionem corretamente Gere a requisição e assine o certificado da filial [sourcecode language=&quot;shell&quot;]openssl req -config /etc/ipsec.d/openssl.cnf -newkey rsa:1024 -keyout private/filial.tutorial.key -out certs/filial.tutorial.req openssl ca -in certs/filial.tutorial.req -config /etc/ipsec.d/openssl.cnf -days 730 -out certs/filial.tutorial.cer -notext openssl rsa -in private/filial.tutorial.key -out private/filial.tutorial.key [/sourcecode] Diversas informações serão solicitadas porém a mais importante é o CommonName que precisa ser o filial.tutorial para que os próximos scripts funcionem corretamente Pronto, os certificados estão gerados e pronto para serem utilizados. Configurando os tunneis ipsec para utilizar os certificados digitais Agora que temos todos os certificados a mão podemos iniciar a configuração do OpenSwan para estabelecer a VPN utilizando os certificados digitais, estes passos são individuais para cada servidor. VPN Server Matriz Copie os arquivos necessários para os seus respectivos locais de utilização conforme indicado na tabela abaixo: /etc/ipsec.d/cacerts/cavpn.tutorial.cer /etc/ipsec.d/certs/filial.tutorial.cer /etc/ipsec.d/certs/matriz.tutorial.cer /etc/ipsec.d/private/matriz.tutorial.key Edite o arquivo /etc/ipsec.d/vpn1.conf para que o mesmo fique com o seguinte conteúdo [sourcecode language=&quot;shell&quot;]conn vpn1 # Nome da Conexão VPN type= tunnel authby= rsasig #Tipo de autenticação # Left security, (dados da Matriz) left= 200.165.10.50 # IP real/físico do servidor na matriz leftid=@matriz.tutorial # CommonName do certificado leftrsasigkey=%cert leftcert=matriz.tutorial.cer # Nome do arquivo do certificado leftsubnet= 10.0.0.0/24 # Rede interna na Matriz para qual será estabelecido a VPN leftnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz # Right security, (dados da Filial) right= %any # Está tag indica que a conexão pode vir de qualquer IP rightid= @filial.tutorial # CommonName do certificado rightrsasigkey=%cert rightcert=filial.tutorial.cer # Nome do arquivo do certificado rightca=%same rightsubnet= 10.0.1.0/24 # Rede interna da filial para qual será estabelecido a VPN rightnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz # Tipo de criptografia usada keyexchange=ike # IPSEC Fase 1 # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos # Formato de preenchimento &#39;cipher-hash;modpgroup, cipher-hash;modpgroup, ...&#39; # -&gt; Não é obrigatório o preenchimento do modpgroup # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5 # modpgroup disponíveis: modp1024, modp1536 e modp2048 ike= 3des-md5,3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5 ikelifetime=28800s # IPSEC Fase 2 # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96 phase2=esp phase2alg=3des-md5-96 # Antigo parametro &#39;esp&#39; que está obsoleto keylife=28800s # Outras configurações pfs= no auto= start [/sourcecode] Além das alterações dos certificados digitais há uma alteração no parâmetro right que antes detinha o IP externo do servidor de VPN da filial e agora detém a tag %any, que possibilita que o IP externo do servidor de VPN da Filial possa trocar de IP sem a necessidade de alterar a configuração. Edite o arquivo /etc/ipsec.d/vpn1.secret, remova a linha atual e adicione a seguinte linha [sourcecode language=&quot;shell&quot;]: RSA matriz.tutorial.key &quot;123456&quot; [/sourcecode] Reinicie o serviço do ipsec e verifique no arquivo de log /var/log/auth.log se as linhas abaixo foram exibidas, elas indicam que a chave foi lida com sucesso. [sourcecode language=&quot;shell&quot;]loading secrets from &quot;/etc/ipsec.d/vpn1.secret&quot; loaded private key file &#39;/etc/ipsec.d/private/matriz.tutorial.key&#39; (1675 bytes) loaded private key for keyid: PPK_RSA:AwEAAfL4J &quot;vpn1&quot; #1: initiating Main Mode [/sourcecode] VPN Server Filial Copie os arquivos necessários para os seus respectivos locais de utilização conforme indicado na tabela abaixo: /etc/ipsec.d/cacerts/cavpn.tutorial.cer /etc/ipsec.d/certs/filial.tutorial.cer /etc/ipsec.d/certs/matriz.tutorial.cer /etc/ipsec.d/private/filial.tutorial.key Edite o arquivo /etc/ipsec.d/vpn1.conf para que o mesmo fique com o seguinte conteúdo [sourcecode language=&quot;shell&quot;]conn vpn1 # Nome da Conexão VPN type= tunnel authby= rsasig #Tipo de autenticação # Left security, (dados da Filial) left= 192.168.0.10 # IP real/físico do servidor na filial leftid=@filial.tutorial # CommonName do certificado leftrsasigkey=%cert leftcert=filial.tutorial.cer # Nome do arquivo do certificado leftsubnet= 10.0.1.0/24 # Rede interna na filial para qual será estabelecido a VPN leftnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial # Right security, (dados da Matriz) right= 200.165.10.50 # IP externo do servidor na matriz rightid= @matriz.tutorial # CommonName do certificado rightrsasigkey=%cert rightcert=matriz.tutorial.cer # Nome do arquivo do certificado rightca=%same rightsubnet= 10.0.0.0/24 # Rede interna da matriz para qual será estabelecido a VPN rightnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial # Tipo de criptografia usada keyexchange=ike # IPSEC Fase 1 # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos # Formato de preenchimento &#39;cipher-hash;modpgroup, cipher-hash;modpgroup, ...&#39; # -&gt; Não é obrigatório o preenchimento do modpgroup # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5 # modpgroup disponíveis: modp1024, modp1536 e modp2048 ike= 3des-md5,3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5 ikelifetime=28800s # IPSEC Fase 2 # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96 phase2=esp phase2alg=3des-md5-96 # Antigo parametro &#39;esp&#39; que está obsoleto keylife=28800s # Outras configurações pfs= no auto= start [/sourcecode] Edite o arquivo /etc/ipsec.d/vpn1.secret, remova a linha atual e adicione a seguinte linha [sourcecode language=&quot;shell&quot;]: RSA filial.tutorial.key &quot;123456&quot; [/sourcecode] Reinicie o serviço do ipsec e verifique no arquivo de log /var/log/auth.log se as linhas abaixo foram exibidas, elas indicam que a chave foi lida com sucesso. [sourcecode language=&quot;shell&quot;]loading secrets from &quot;/etc/ipsec.d/vpn1.secret&quot; loaded private key file &#39;/etc/ipsec.d/private/filial.tutorial.key&#39; (1679 bytes) loaded private key for keyid: PPK_RSA:AwEAAdWyO [/sourcecode] Troubleshooting Caso seja necessário ter um numero maior de informações e log basta adicionar as linhas de log no arquivo /etc/ipsec.conf conforme abaixo [sourcecode language=&quot;shell&quot;]version 2.0 config setup ... plutodebug=all plutostderrlog=/var/log/openswan.log [/sourcecode] Considerações finais Neste post vimos como realizar todo o procedimento utilizando como servidor de VPN dois equipamentos com o OpensSwan, porém o procedimento é exatamente o mesmo para ambientes onde um dos equipamentos não é OpenSwan, como por exemplo, Cisco, Microsoft TMG, Aker, pfSense, Dlink entre outros. Como continuidade irei demonstrar como substituir o equipamento da matriz por outros sistemas. Assim que tiver um tempo elaborarei estes outros tutoriais e posto aqui no site. Caso você quera compartilhar a sua experiência substituindo uma das pontas por outro equipamento, me envie o passo a passo com prints, comandos e arquivos de configuração que posto no site com os seus créditos." /><link rel="canonical" href="https://www.helviojunior.com.br/it/security/estabelecendo-vpn-site-to-site-ipsec-natt-openswan/" /><meta property="og:url" content="https://www.helviojunior.com.br/it/security/estabelecendo-vpn-site-to-site-ipsec-natt-openswan/" /><meta property="og:site_name" content="Helvio Junior" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2014-10-29T23:54:57-02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Estabelecendo VPN Site-to-site IPSEC com OpenSwan" /><meta name="twitter:site" content="@helvioju" /><meta name="twitter:creator" content="@Helvio Junior (m4v3r1ck)" /><meta name="google-site-verification" content="JR4IIP9jfvOwxn2ybV_Qn0SrtDPlTrKomdPWgBuP55k"" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Helvio Junior (m4v3r1ck)"},"dateModified":"2023-08-17T00:19:29-03:00","datePublished":"2014-10-29T23:54:57-02:00","description":"﻿Neste post veremos passo a passo como configurar o OpenSwan para estabelecer uma VPN Site-to-site (entre 2 redes)  utilizando segredo compartilhado ou certificado digital. No decorrer do post explicarei as diferenças quando um dos firewall está atrás de um equipamento realizando NAT-T. A motivação da escrita deste post se deu na necessidade de realizar essa VPN em meu ambiente somado ao fato que não encontrei na internet nenhum tutorial que trouxesse de forma simples, completa e bem comentada cada um dos parâmetros para o correto funcionamento do OpenSwan no ambiente proposto. Achei sim, diversos tutoriais, que me ajudaram muito, mas somente informações fragmentadas e muitas vezes confusas, sendo assim resolvi agregar todas em um único post. Espero que ajude. Ambiente Antes de iniciar a configuração propriamente dita do OpenSwan e dos equipamentos é necessário entender bem todo o nosso ambiente. Antes de mais nada é importante frisar que os IPs validos e inválidos deste ambiente são fictícios e escolhidos aleatoriamente, não representando qualquer ambiente real meu ou de cliente. Para os dois servidores de VPN foi utilizado o Ubuntu 12.0.4, e o OpenSwan do repositório do ubuntu. Esta imagem abaixo demonstra detalhadamente todo o nosso ambiente. Nela podemos observar que há 2 servidores de VPN, um na matriz e um na filial, e que o servidor da filial está atrás de um Roteador que está fazendo NAT. Este é um ambiente bem comum quando a filial está utilizando uma internet de baixo custo onde a operadora fornece o modem (como por exemplo ADSL) e este modem é quem recebe o IP válido e distribui uma rede inválida (comumente 192.168.x.x) para as maquinas internas. Configuração de rede dos servidores de VPN Segue abaixo a configuração de rede de cada um dos servidores VPN [caption id=&quot;attachment_1074&quot; align=&quot;alignnone&quot; width=&quot;405&quot;] Configuração de rede do servidor de VPN da Matriz[/caption] [caption id=&quot;attachment_1075&quot; align=&quot;alignnone&quot; width=&quot;405&quot;] Configuração de rede do servidor de VPN da Filial[/caption] Instalando OpenSwan O processo de instalação do OpenSwan é o mesmo para os dois equipamentos, desta forma execute os passos abaixo nos 2. Instalando o OpenSwan e OpenSSL [sourcecode language=&quot;shell&quot;]add-apt-repository ppa:openswan/ppa apt-get update apt-get install openssl openswan [/sourcecode] Neste processo será questionado se deseja criar um certificado digital para este servidor. Pode selecionar a opção &lt;NO&gt; Edite o arquivo /etc/ipsec.conf (em ambos equipamentos) para que ele fique com o seguinte conteúdo: [sourcecode language=&quot;shell&quot;]version 2.0 config setup dumpdir=/var/run/pluto/ nat_traversal=yes virtual_private=%v4:10.0.0.0/8 oe=off protostack=netkey conn %default authby=rsasig leftrsasigkey=%cert rightrsasigkey=%cert keyingtries=1 keylife=20m ikelifetime=240m include /etc/ipsec.d/*.conf [/sourcecode] Edite o arquivo /etc/ipsec.secrets para que ele fique com o seguinte conteúdo: [sourcecode language=&quot;shell&quot;]include /var/lib/openswan/ipsec.secrets.inc include /etc/ipsec.d/*.secret [/sourcecode] Edite o arquivo /etc/sysctl.conf e altere ou insira a seguinte linha. Esta configuração tem por objetivo permitir que o kernel do linux faça roteamento dos pacotes de rede. [sourcecode language=&quot;shell&quot;]net.ipv4.ip_forward = 1 [/sourcecode] E depois execute o seguinte comando para aplicar essa configuração: [sourcecode language=&quot;shell&quot;]sysctl -p [/sourcecode] Pronto as configurações gerais estão prontas, agora vamos para as configurações individuais de cada servidor de VPN. Um pouco sobre segredo compartilhado versus certificado digital Quando estamos configurando uma VPN com IPSEC há diversos fatores que podem influenciar e gerar problema no estabelecimento da conexão, desta forma sempre iniciamos a configuração de forma simples, e depois vamos incrementando opções e segurança. Seguindo esta lógica primeiro iremos configurar e estabelecer o tunnel VPN utilizando segredo compartilhado, para depois que o tunnel tiver OK possamos trocar para certificado digital. Mas porque isso? Porque com certificado digital há diversos outros fatores que podem gerar problema como data de validade do certificado, common name, tipo do certificado, autoridade certificadora entre outros, então a forma mais simples de isolar os problemas é primeiro estabelecer o tunnel usando segredo compartilhado. Por característica do protocolo IPSEC, para estabelecer um tunnel com segrede compartilhado é necessário saber o IP interno e externo de todos os envolvidos, não podendo ser nenhum dos 2 lados dinâmico, desta forma se em eu ambiente você utiliza uma internet com IP dinâmico, para estes primeiros passos descubra qual é o IP atualmente atribuido, faça a configuração com ele que nos próximos passos (depois de mudar o tunnel para usar certificado digital) iremos alterar para não precisar informar este IP na configuração. VPN Server Matriz Nesta sessão veremos todas as configurações que devem serem realizadas no servidor de VPN da matriz. Crie um arquivo nomeado /etc/ipsec.d/vpn1.conf e insira o seguinte conteúdo: [sourcecode language=&quot;shell&quot;]conn vpn1 # Nome da Conexão VPN type= tunnel authby= secret #Tipo de autenticação # Left security, (dados da Matriz) left= 200.165.10.50 # IP real/físico do servidor na matriz leftsubnet= 10.0.0.0/24 # Rede interna na Matriz para qual será estabelecido a VPN leftnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz # Right security, (dados da Filial) right= 201.80.24.7 # IP Externo (após o NAT) que o servidor sairá para conexão com a matriz rightsubnet= 10.0.1.0/24 # Rede interna da filial para qual será estabelecido a VPN rightnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz # Tipo de criptografia usada keyexchange=ike # IPSEC Fase 1 # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos # Formato de preenchimento &#39;cipher-hash;modpgroup, cipher-hash;modpgroup, ...&#39; # -&gt; Não é obrigatório o preenchimento do modpgroup # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5 # modpgroup disponíveis: modp1024, modp1536 e modp2048 ike= 3des-md5, 3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5 # IPSEC Fase 2 # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96 phase2alg = 3des-md5-96 # Antigo parametro &#39;esp&#39; que está obsoleto # Outras configurações pfs= no auto= start [/sourcecode] Agora crie o arquivo nomeado /etc/ipsec.d/vpn1.secret com o seguinte conteúdo [sourcecode language=&quot;shell&quot;]201.80.24.7 200.165.10.50: PSK &quot;123456&quot; [/sourcecode] Agora reinicie o serviço do ipsec com o seguinte comando [sourcecode language=&quot;shell&quot;]ipsec setup restart [/sourcecode] Caso deseje reiniciar somente um tunnel utilize os comandos abaixo [sourcecode language=&quot;shell&quot;]ipsec auto --down vpn1 ipsec auto --up vpn1 [/sourcecode] VPN Server Filial Nesta sessão veremos todas as configurações que devem serem realizadas no servidor de VPN da filial. Crie um arquivo nomeado /etc/ipsec.d/vpn1.conf e insira o seguinte conteúdo: [sourcecode language=&quot;shell&quot;]conn vpn1 # Nome da Conexão VPN type= tunnel authby= secret #Tipo de autenticação # Left security, (dados da Filial) left= 192.168.0.10 # IP real/físico do servidor na filial leftid= 201.80.24.7 # IP Externo (após o NAT) que o servidor sairá para conexão com a matriz leftsubnet= 10.0.1.0/24 # Rede interna na filial para qual será estabelecido a VPN leftnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial # Right security, (dados da Matriz) right= 200.165.10.50 # IP externo do servidor na matriz rightsubnet= 10.0.0.0/24 # Rede interna da matriz para qual será estabelecido a VPN rightnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial # Tipo de criptografia usada keyexchange=ike # IPSEC Fase 1 # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos # Formato de preenchimento &#39;cipher-hash;modpgroup, cipher-hash;modpgroup, ...&#39; # -&gt; Não é obrigatório o preenchimento do modpgroup # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5 # modpgroup disponíveis: modp1024, modp1536 e modp2048 ike= 3des-md5, 3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5 # IPSEC Fase 2 # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96 phase2alg = 3des-md5-96 # Antigo parametro &#39;esp&#39; que está obsoleto # Outras configurações pfs= no auto= start [/sourcecode] Agora crie o arquivo nomeado /etc/ipsec.d/vpn1.secret com o seguinte conteúdo [sourcecode language=&quot;shell&quot;]200.165.10.50 201.80.24.7: PSK &quot;123456&quot; [/sourcecode] Agora reinicie o serviço do ipsec com o seguinte comando [sourcecode language=&quot;shell&quot;]ipsec setup restart [/sourcecode] Caso deseje reiniciar somente um tunnel utilize os comandos abaixo [sourcecode language=&quot;shell&quot;]ipsec auto --down vpn1 ipsec auto --up vpn1 [/sourcecode] &nbsp; Verificando status e erros de configuração Após iniciar a configuração alguns passos podem ser feito para checar a configuração e correto carregamento da mesma, bem como erros no estabelecimento do tunnel. Verifique no arquivo de log /var/log/auth.log se estes 2 logs foram gerados, eles indicam que o arquivo de chaves da VPN foi carregado e que a vpn1 foi carregada e será iniciado o processo para estabelecer o tunnel [sourcecode language=&quot;shell&quot;]loading secrets from &quot;/etc/ipsec.d/vpn1.secret&quot; &quot;vpn1&quot; #1: initiating Main Mode [/sourcecode] E um dos logs mais legal de se ver é o que estabeleceu a SA, ou seja o tunnel está OK [sourcecode language=&quot;shell&quot;]&quot;vpn1&quot; #4: STATE_QUICK_I2: sent QI2, IPsec SA established tunnel mode {ESP=&gt;0xb71ffca5 [/sourcecode] Outro comando bem útil é o comando para verificar o status do ipsec [sourcecode language=&quot;shell&quot;]/usr/sbin/ipsec auto --status [/sourcecode] Este comando irá retornar uma saída parecida com essa. [sourcecode language=&quot;shell&quot;]000 using kernel interface: netkey 000 interface lo/lo ::1 000 interface lo/lo 127.0.0.1 000 interface lo/lo 127.0.0.1 000 interface eth0/eth0 10.0.0.1 000 interface eth0/eth0 10.0.0.1 000 interface eth1/eth1 200.165.10.50 000 interface eth1/eth1 200.165.10.50 000 %myid = (none) 000 debug none 000 000 virtual_private (%priv): 000 - allowed 1 subnet: 10.0.0.0/8 000 - disallowed 0 subnets: 000 WARNING: Disallowed subnets in virtual_private= is empty. If you have 000 private address space in internal use, it should be excluded! 000 000 algorithm ESP encrypt: id=2, name=ESP_DES, ivlen=8, keysizemin=64, keysizemax=64 000 algorithm ESP encrypt: id=3, name=ESP_3DES, ivlen=8, keysizemin=192, keysizemax=192 000 algorithm ESP encrypt: id=6, name=ESP_CAST, ivlen=8, keysizemin=40, keysizemax=128 000 algorithm ESP encrypt: id=7, name=ESP_BLOWFISH, ivlen=8, keysizemin=40, keysizemax=448 000 algorithm ESP encrypt: id=11, name=ESP_NULL, ivlen=0, keysizemin=0, keysizemax=0 000 algorithm ESP encrypt: id=12, name=ESP_AES, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=13, name=ESP_AES_CTR, ivlen=8, keysizemin=160, keysizemax=288 000 algorithm ESP encrypt: id=14, name=ESP_AES_CCM_A, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=15, name=ESP_AES_CCM_B, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=16, name=ESP_AES_CCM_C, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=18, name=ESP_AES_GCM_A, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=19, name=ESP_AES_GCM_B, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=20, name=ESP_AES_GCM_C, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=22, name=ESP_CAMELLIA, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=252, name=ESP_SERPENT, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP encrypt: id=253, name=ESP_TWOFISH, ivlen=8, keysizemin=128, keysizemax=256 000 algorithm ESP auth attr: id=1, name=AUTH_ALGORITHM_HMAC_MD5, keysizemin=128, keysizemax=128 000 algorithm ESP auth attr: id=2, name=AUTH_ALGORITHM_HMAC_SHA1, keysizemin=160, keysizemax=160 000 algorithm ESP auth attr: id=5, name=AUTH_ALGORITHM_HMAC_SHA2_256, keysizemin=256, keysizemax=256 000 algorithm ESP auth attr: id=6, name=AUTH_ALGORITHM_HMAC_SHA2_384, keysizemin=384, keysizemax=384 000 algorithm ESP auth attr: id=7, name=AUTH_ALGORITHM_HMAC_SHA2_512, keysizemin=512, keysizemax=512 000 algorithm ESP auth attr: id=8, name=AUTH_ALGORITHM_HMAC_RIPEMD, keysizemin=160, keysizemax=160 000 algorithm ESP auth attr: id=9, name=AUTH_ALGORITHM_AES_CBC, keysizemin=128, keysizemax=128 000 algorithm ESP auth attr: id=251, name=AUTH_ALGORITHM_NULL_KAME, keysizemin=0, keysizemax=0 000 000 algorithm IKE encrypt: id=0, name=(null), blocksize=16, keydeflen=131 000 algorithm IKE encrypt: id=5, name=OAKLEY_3DES_CBC, blocksize=8, keydeflen=192 000 algorithm IKE encrypt: id=7, name=OAKLEY_AES_CBC, blocksize=16, keydeflen=128 000 algorithm IKE hash: id=1, name=OAKLEY_MD5, hashsize=16 000 algorithm IKE hash: id=2, name=OAKLEY_SHA1, hashsize=20 000 algorithm IKE hash: id=4, name=OAKLEY_SHA2_256, hashsize=32 000 algorithm IKE hash: id=6, name=OAKLEY_SHA2_512, hashsize=64 000 algorithm IKE dh group: id=2, name=OAKLEY_GROUP_MODP1024, bits=1024 000 algorithm IKE dh group: id=5, name=OAKLEY_GROUP_MODP1536, bits=1536 000 algorithm IKE dh group: id=14, name=OAKLEY_GROUP_MODP2048, bits=2048 000 algorithm IKE dh group: id=15, name=OAKLEY_GROUP_MODP3072, bits=3072 000 algorithm IKE dh group: id=16, name=OAKLEY_GROUP_MODP4096, bits=4096 000 algorithm IKE dh group: id=17, name=OAKLEY_GROUP_MODP6144, bits=6144 000 algorithm IKE dh group: id=18, name=OAKLEY_GROUP_MODP8192, bits=8192 000 algorithm IKE dh group: id=22, name=OAKLEY_GROUP_DH22, bits=1024 000 algorithm IKE dh group: id=23, name=OAKLEY_GROUP_DH23, bits=2048 000 algorithm IKE dh group: id=24, name=OAKLEY_GROUP_DH24, bits=2048 000 000 stats db_ops: {curr_cnt, total_cnt, maxsz} :context={0,2,64} trans={0,2,3072} attrs={0,2,2048} 000 000 &quot;vpn1&quot;: 10.0.0.0/24===200.165.10.50---200.165.10.1...200.165.10.1---201.80.24.7===10.0.1.0/24; erouted; eroute owner: #4 000 &quot;vpn1&quot;: myip=unset; hisip=unset; 000 &quot;vpn1&quot;: ike_life: 14400s; ipsec_life: 1200s; rekey_margin: 540s; rekey_fuzz: 100%; keyingtries: 1 000 &quot;vpn1&quot;: policy: PSK+ENCRYPT+TUNNEL+UP+IKEv2ALLOW+SAREFTRACK; prio: 24,24; interface: eth1; 000 &quot;vpn1&quot;: newest ISAKMP SA: #1; newest IPsec SA: #4; 000 &quot;vpn1&quot;: IKE algorithm newest: AES_CBC_128-SHA1-MODP2048 000 &quot;vpn1&quot;: ESP algorithms wanted: 3DES(3)_000-MD5(1)_096; flags=-strict 000 &quot;vpn1&quot;: ESP algorithms loaded: 3DES(3)_192-MD5(1)_096 000 &quot;vpn1&quot;: ESP algorithm newest: 3DES_000-HMAC_MD5; pfsgroup=&lt;N/A&gt; 000 000 #3: &quot;vpn1&quot;:4500 STATE_QUICK_R2 (IPsec SA established); EVENT_SA_REPLACE in 727s; isakmp#2; idle; import:not set 000 #3: &quot;vpn1&quot; esp.a0dfaa1a@201.80.24.7 esp.bf6f0287@200.165.10.50 tun.0@201.80.24.7 tun.0@200.165.10.50 ref=0 refhim=4294901761 000 #2: &quot;vpn1&quot;:4500 STATE_MAIN_R3 (sent MR3, ISAKMP SA established); EVENT_SA_REPLACE in 13926s; lastdpd=-1s(seq in:0 out:0); idle; import:not set 000 #4: &quot;vpn1&quot;:4500 STATE_QUICK_I2 (sent QI2, IPsec SA established); EVENT_SA_REPLACE in 453s; newest IPSEC; eroute owner; isakmp#1; idle; import:admin initiate 000 #4: &quot;vpn1&quot; esp.b71ffca5@201.80.24.7 esp.25fdf05f@200.165.10.50 tun.0@201.80.24.7 tun.0@200.165.10.50 ref=0 refhim=4294901761 000 #1: &quot;vpn1&quot;:4500 STATE_MAIN_I4 (ISAKMP SA established); EVENT_SA_REPLACE in 13163s; newest ISAKMP; lastdpd=-1s(seq in:0 out:0); idle; import:admin initiate 000 [/sourcecode] Neste retorno há diversas informações, mas as mais importantes estão no final, onde mostram as SAs estabelecidas, ou seja, os tunneis IPSEC estabelecidos. Pronto, a primeira fase da configuração está ok e nosso tunnel VPN estabelecido. Agora iniciaremos o processo para configuração utilizando certificado digital. Gerando certificados digitais Antes de realizarmos a configuração do OpenSwan para utilizar os certificados digitais é necessário ter ou gerar os certificados. Como o objetivo deste post é ser o mais completo possível, realizaremos todo o processo de geração da autoridade certificadora e assinatura/geração dos certificados. Se você não entende muito bem como funciona esse negócio de autoridade certificadora, cadeia de certificação segue alguns posts para você dar uma olhada antes de continuar: Certificação digital Instalando CA Root com OpenSSL Instalando CA Root com Windows Verificando de um certificado é válido para atuar como CA Agora sim podemos continuar com a geração dos certificados. Neste post veremos 2 formas de gerar estes certificados, a primeira e a mais simples utilizando um aplicativo windows que criei para gerar os certificados e a segunda e mais complexa utilizando os comandos OpenSSL (que funcionam em windows e linux) Gerando certificados com o aplicativo BuildCert Conforme ja comentado este aplicativo foi desenvolvido por mim especificamente para geração de certificados digitais para utilização em sistemas de VPN IPSEC, muitos dos aplicativos que realizam VPN IPSEC pedem configurações específicas nos certificados que são bem chatas de fazer através do openssl via linha de comando. Este aplicativo basicamente utiliza as próprias bibliotecas do OpenSSL para gerar os certificados. Este aplicativo cria desde a CA até os certificados individuais de cada servidor de VPN. Todos compatíveis com qualquer sistema de autoridade de certificação. Outra funcionalidade interessante deste aplicativo é que pode ser utilizado com a sua autoridade de certificadora atual (caso ja tenha uma instalada). Utilizando a CA atual para assinar o certificado Para realizar este processo utilizando a sua CA atual será necessário ter o arquivo .pfx ou .p12 da sua CA. Caso sua CA seja windows e você não saiba como realizar este procedimento no post Instalando CA Root com Windows eu ensino como realiza-lo. Gerando certificado Realize o download do aplicativo BuildCert (clicando aqui) e descompacte em qualquer lugar em seu PC. O Aplicativo terá a seguinte estrutura de arquivos, por mais que pareça que há duplicados todos são necessários. Modo de utilização [sourcecode language=&quot;shell&quot;]BuildCert.exe [common_name_ca] [common_name_cert] [password_ca] [password_cert] [/sourcecode] Ao ser iniciado o aplicativo irá buscar dentro do diretório certs o arquivo com o common mane da CA + a extensão pfx ex.: ca.meudominio.pfx, caso o arquivo exista o aplicativo irá abri-lo com a senha definida e utiliza-lo para assinar os certificados gerados, caso contrário o aplicativo irá criar este pfx e utiliza-lo para assinar os certificados gerados. Vamos para a pratica, execute os comandos abaixo para gerar uma CA com nome cavpn.tutorial e os certificados matriz.tutorial e filial.tutorial. Ambos com a senha 123456 [sourcecode language=&quot;shell&quot;]BuildCert.exe cavpn.tutorial matriz.tutorial 123456 123456 BuildCert.exe cavpn.tutorial filial.tutorial 123456 123456 [/sourcecode] Após a execução dos comandos 3 arquivos por certificado serão criados: .cer: arquivo do certificado digital X509 .key: chave privada do certificado .pfx: arquivo PKCS#12 contendo o certificado X509 + a chave privada Segue os prints dos certificados [caption id=&quot;attachment_1112&quot; align=&quot;alignnone&quot; width=&quot;251&quot;] Certificado da CA (Autoassinado)[/caption] [caption id=&quot;attachment_1113&quot; align=&quot;alignnone&quot; width=&quot;251&quot;] Certificado da matriz assinado pela CA[/caption] [caption id=&quot;attachment_1114&quot; align=&quot;alignnone&quot; width=&quot;251&quot;] Certificado da filial assinado pela CA[/caption] Pronto, os certificados foram gerados e estão prontos para serem utilizados no OpenSwan Gerando certificados com o OpenSSL Outro modo de gerar os certificados é utilizando diretamente o OpenSSL. Se você ja gerou os certificados através dos passos anteriores (aplicativo BuildCert) pode pular estes passos e ir direto para configuração dos tunneis. Gerando certificado Antes de tudo vamos preparar o ambiente para o OpenSSL, realize uma cópia do arquivo de configuração padrão do OpenSSL para o seu ambiente [sourcecode language=&quot;shell&quot;]cp cp /etc/ssl/openssl.cnf /etc/ipsec.d/ [/sourcecode] Edite o arquivo de configuração alterando as seguintes linhas [sourcecode language=&quot;shell&quot;][ CA_default ] dir = /etc/ipsec.d certificate = $dir/cacerts/cavpn.tutorial.cer private_key = $dir/private/cavpn.tutorial.key [/sourcecode] E por fim vamos criar arquivos e diretórios necessários para o correto funcionamento do OpenSSL [sourcecode language=&quot;shell&quot;]mkdir newcerts touch index.txt echo &quot;00&quot; &gt; serial [/sourcecode] Agora vamos criar a nossa CA através do comando abaixo [sourcecode language=&quot;shell&quot;]cd /etc/ipsec.d openssl req -x509 -days 3650 -config /etc/ipsec.d/openssl.cnf -newkey rsa:2048 -keyout private/cavpn.tutorial.key -out cacerts/cavpn.tutorial.cer [/sourcecode] Na execução deste comando diversas informações serão solicitadas, porém 2 delas são importantes, 1 - Senha da CA, essa senha será solicitada para assinar os certificados da matriz e da filial; 2 - CommonName, ou seja o nome da CA. Preencha estes dados conforme desejado ou seguindo o exemplo abaixo Gere a requisição e assine o certificado da matriz [sourcecode language=&quot;shell&quot;]openssl req -config /etc/ipsec.d/openssl.cnf -newkey rsa:1024 -keyout private/matriz.tutorial.key -out certs/matriz.tutorial.req openssl ca -in certs/matriz.tutorial.req -config /etc/ipsec.d/openssl.cnf -days 730 -out certs/matriz.tutorial.cer -notext openssl rsa -in private/matriz.tutorial.key -out private/matriz.tutorial.key [/sourcecode] Diversas informações serão solicitadas porém a mais importante é o CommonName que precisa ser o matriz.tutorial para que os próximos scripts funcionem corretamente Gere a requisição e assine o certificado da filial [sourcecode language=&quot;shell&quot;]openssl req -config /etc/ipsec.d/openssl.cnf -newkey rsa:1024 -keyout private/filial.tutorial.key -out certs/filial.tutorial.req openssl ca -in certs/filial.tutorial.req -config /etc/ipsec.d/openssl.cnf -days 730 -out certs/filial.tutorial.cer -notext openssl rsa -in private/filial.tutorial.key -out private/filial.tutorial.key [/sourcecode] Diversas informações serão solicitadas porém a mais importante é o CommonName que precisa ser o filial.tutorial para que os próximos scripts funcionem corretamente Pronto, os certificados estão gerados e pronto para serem utilizados. Configurando os tunneis ipsec para utilizar os certificados digitais Agora que temos todos os certificados a mão podemos iniciar a configuração do OpenSwan para estabelecer a VPN utilizando os certificados digitais, estes passos são individuais para cada servidor. VPN Server Matriz Copie os arquivos necessários para os seus respectivos locais de utilização conforme indicado na tabela abaixo: /etc/ipsec.d/cacerts/cavpn.tutorial.cer /etc/ipsec.d/certs/filial.tutorial.cer /etc/ipsec.d/certs/matriz.tutorial.cer /etc/ipsec.d/private/matriz.tutorial.key Edite o arquivo /etc/ipsec.d/vpn1.conf para que o mesmo fique com o seguinte conteúdo [sourcecode language=&quot;shell&quot;]conn vpn1 # Nome da Conexão VPN type= tunnel authby= rsasig #Tipo de autenticação # Left security, (dados da Matriz) left= 200.165.10.50 # IP real/físico do servidor na matriz leftid=@matriz.tutorial # CommonName do certificado leftrsasigkey=%cert leftcert=matriz.tutorial.cer # Nome do arquivo do certificado leftsubnet= 10.0.0.0/24 # Rede interna na Matriz para qual será estabelecido a VPN leftnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz # Right security, (dados da Filial) right= %any # Está tag indica que a conexão pode vir de qualquer IP rightid= @filial.tutorial # CommonName do certificado rightrsasigkey=%cert rightcert=filial.tutorial.cer # Nome do arquivo do certificado rightca=%same rightsubnet= 10.0.1.0/24 # Rede interna da filial para qual será estabelecido a VPN rightnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz # Tipo de criptografia usada keyexchange=ike # IPSEC Fase 1 # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos # Formato de preenchimento &#39;cipher-hash;modpgroup, cipher-hash;modpgroup, ...&#39; # -&gt; Não é obrigatório o preenchimento do modpgroup # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5 # modpgroup disponíveis: modp1024, modp1536 e modp2048 ike= 3des-md5,3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5 ikelifetime=28800s # IPSEC Fase 2 # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96 phase2=esp phase2alg=3des-md5-96 # Antigo parametro &#39;esp&#39; que está obsoleto keylife=28800s # Outras configurações pfs= no auto= start [/sourcecode] Além das alterações dos certificados digitais há uma alteração no parâmetro right que antes detinha o IP externo do servidor de VPN da filial e agora detém a tag %any, que possibilita que o IP externo do servidor de VPN da Filial possa trocar de IP sem a necessidade de alterar a configuração. Edite o arquivo /etc/ipsec.d/vpn1.secret, remova a linha atual e adicione a seguinte linha [sourcecode language=&quot;shell&quot;]: RSA matriz.tutorial.key &quot;123456&quot; [/sourcecode] Reinicie o serviço do ipsec e verifique no arquivo de log /var/log/auth.log se as linhas abaixo foram exibidas, elas indicam que a chave foi lida com sucesso. [sourcecode language=&quot;shell&quot;]loading secrets from &quot;/etc/ipsec.d/vpn1.secret&quot; loaded private key file &#39;/etc/ipsec.d/private/matriz.tutorial.key&#39; (1675 bytes) loaded private key for keyid: PPK_RSA:AwEAAfL4J &quot;vpn1&quot; #1: initiating Main Mode [/sourcecode] VPN Server Filial Copie os arquivos necessários para os seus respectivos locais de utilização conforme indicado na tabela abaixo: /etc/ipsec.d/cacerts/cavpn.tutorial.cer /etc/ipsec.d/certs/filial.tutorial.cer /etc/ipsec.d/certs/matriz.tutorial.cer /etc/ipsec.d/private/filial.tutorial.key Edite o arquivo /etc/ipsec.d/vpn1.conf para que o mesmo fique com o seguinte conteúdo [sourcecode language=&quot;shell&quot;]conn vpn1 # Nome da Conexão VPN type= tunnel authby= rsasig #Tipo de autenticação # Left security, (dados da Filial) left= 192.168.0.10 # IP real/físico do servidor na filial leftid=@filial.tutorial # CommonName do certificado leftrsasigkey=%cert leftcert=filial.tutorial.cer # Nome do arquivo do certificado leftsubnet= 10.0.1.0/24 # Rede interna na filial para qual será estabelecido a VPN leftnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial # Right security, (dados da Matriz) right= 200.165.10.50 # IP externo do servidor na matriz rightid= @matriz.tutorial # CommonName do certificado rightrsasigkey=%cert rightcert=matriz.tutorial.cer # Nome do arquivo do certificado rightca=%same rightsubnet= 10.0.0.0/24 # Rede interna da matriz para qual será estabelecido a VPN rightnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial # Tipo de criptografia usada keyexchange=ike # IPSEC Fase 1 # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos # Formato de preenchimento &#39;cipher-hash;modpgroup, cipher-hash;modpgroup, ...&#39; # -&gt; Não é obrigatório o preenchimento do modpgroup # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5 # modpgroup disponíveis: modp1024, modp1536 e modp2048 ike= 3des-md5,3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5 ikelifetime=28800s # IPSEC Fase 2 # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96 phase2=esp phase2alg=3des-md5-96 # Antigo parametro &#39;esp&#39; que está obsoleto keylife=28800s # Outras configurações pfs= no auto= start [/sourcecode] Edite o arquivo /etc/ipsec.d/vpn1.secret, remova a linha atual e adicione a seguinte linha [sourcecode language=&quot;shell&quot;]: RSA filial.tutorial.key &quot;123456&quot; [/sourcecode] Reinicie o serviço do ipsec e verifique no arquivo de log /var/log/auth.log se as linhas abaixo foram exibidas, elas indicam que a chave foi lida com sucesso. [sourcecode language=&quot;shell&quot;]loading secrets from &quot;/etc/ipsec.d/vpn1.secret&quot; loaded private key file &#39;/etc/ipsec.d/private/filial.tutorial.key&#39; (1679 bytes) loaded private key for keyid: PPK_RSA:AwEAAdWyO [/sourcecode] Troubleshooting Caso seja necessário ter um numero maior de informações e log basta adicionar as linhas de log no arquivo /etc/ipsec.conf conforme abaixo [sourcecode language=&quot;shell&quot;]version 2.0 config setup ... plutodebug=all plutostderrlog=/var/log/openswan.log [/sourcecode] Considerações finais Neste post vimos como realizar todo o procedimento utilizando como servidor de VPN dois equipamentos com o OpensSwan, porém o procedimento é exatamente o mesmo para ambientes onde um dos equipamentos não é OpenSwan, como por exemplo, Cisco, Microsoft TMG, Aker, pfSense, Dlink entre outros. Como continuidade irei demonstrar como substituir o equipamento da matriz por outros sistemas. Assim que tiver um tempo elaborarei estes outros tutoriais e posto aqui no site. Caso você quera compartilhar a sua experiência substituindo uma das pontas por outro equipamento, me envie o passo a passo com prints, comandos e arquivos de configuração que posto no site com os seus créditos.","headline":"Estabelecendo VPN Site-to-site IPSEC com OpenSwan","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.helviojunior.com.br/it/security/estabelecendo-vpn-site-to-site-ipsec-natt-openswan/"},"url":"https://www.helviojunior.com.br/it/security/estabelecendo-vpn-site-to-site-ipsec-natt-openswan/"}</script><title>Estabelecendo VPN Site-to-site IPSEC com OpenSwan | Helvio Junior</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Helvio Junior"><meta name="application-name" content="Helvio Junior"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/m4v3r1ck.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Helvio Junior</a></div><div class="site-subtitle font-italic">Cyber security researcher, speaker, low level and binary exploitation entusiast. <br /><br />"I’m just a child who has never grown up. I still keep asking these 'how' & 'why' questions. Occasionally, I find an answer. Stephen Hawking"</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://www.linkedin.com/in/helviojunior" aria-label="linkedin" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.youtube.com/@Sec4US" aria-label="youtube" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-youtube"></i> </a> <a href="https://github.com/helviojunior" aria-label="github" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['helvio.junior','sec4us.com.br'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/it"> It </a> </span> <span> <a href="/security"> Security </a> </span> <span>Estabelecendo VPN Site-to-site IPSEC com OpenSwan</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Estabelecendo VPN Site-to-site IPSEC com OpenSwan</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Helvio Junior (m4v3r1ck) </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Oct 29, 2014, 11:54 PM -0200" prep="on" > Oct 29, 2014 <i class="unloaded">2014-10-29T23:54:57-02:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 17, 2023, 12:19 AM -0300" prefix="Updated " > Aug 17, 2023 <i class="unloaded">2023-08-17T00:19:29-03:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3742 words">20 min</span></div></div><div class="post-content"><p><span style="display: inline-block; width: 0px; overflow: hidden; line-height: 0;" data-mce-type="bookmark" class="mce_SELRES_start">﻿</span>Neste post veremos passo a passo como configurar o OpenSwan para estabelecer uma VPN Site-to-site (entre 2 redes)  utilizando segredo compartilhado ou certificado digital. No decorrer do post explicarei as diferenças quando um dos firewall está atrás de um equipamento realizando NAT-T.</p><p>A motivação da escrita deste post se deu na necessidade de realizar essa VPN em meu ambiente somado ao fato que não encontrei na internet nenhum tutorial que trouxesse de forma simples, completa e bem comentada cada um dos parâmetros para o correto funcionamento do OpenSwan no ambiente proposto. Achei sim, diversos tutoriais, que me ajudaram muito, mas somente informações fragmentadas e muitas vezes confusas, sendo assim resolvi agregar todas em um único post. Espero que ajude.</p><p></p><h2>Ambiente</h2><p>Antes de iniciar a configuração propriamente dita do OpenSwan e dos equipamentos é necessário entender bem todo o nosso ambiente.</p><p>Antes de mais nada é importante frisar que os IPs validos e inválidos deste ambiente são fictícios e escolhidos aleatoriamente, não representando qualquer ambiente real meu ou de cliente.</p><p>Para os dois servidores de VPN foi utilizado o Ubuntu 12.0.4, e o OpenSwan do repositório do ubuntu.</p><p>Esta imagem abaixo demonstra detalhadamente todo o nosso ambiente.</p><p><a href="/assets/2014/10/Lab.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 581 219'%3E%3C/svg%3E" data-src="/assets/2014/10/Lab.png" alt="Ambiente VPN site to site" width="581" height="219" class="lazyload" data-proofer-ignore></a></p><p>Nela podemos observar que há 2 servidores de VPN, um na matriz e um na filial, e que o servidor da filial está atrás de um Roteador que está fazendo NAT. Este é um ambiente bem comum quando a filial está utilizando uma internet de baixo custo onde a operadora fornece o modem (como por exemplo ADSL) e este modem é quem recebe o IP válido e distribui uma rede inválida (comumente 192.168.x.x) para as maquinas internas.</p><h2>Configuração de rede dos servidores de VPN</h2><p><span style="line-height: 1.5;">Segue abaixo a configuração de rede de cada um dos servidores VPN</span></p><p>[caption id="attachment_1074" align="alignnone" width="405"]<a href="/assets/2014/10/metwork-matriz.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 405 255'%3E%3C/svg%3E" class="lazyload wp-image-1074" data-src="/assets/2014/10/metwork-matriz.png" alt="metwork-matriz" width="405" height="255" data-proofer-ignore></a> Configuração de rede do servidor de VPN da Matriz[/caption]</p><p>[caption id="attachment_1075" align="alignnone" width="405"]<a href="/assets/2014/10/network-filial.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 405 255'%3E%3C/svg%3E" class="lazyload wp-image-1075" data-src="/assets/2014/10/network-filial.png" alt="network-filial" width="405" height="255" data-proofer-ignore></a> Configuração de rede do servidor de VPN da Filial[/caption]</p><h2>Instalando OpenSwan</h2><p>O processo de instalação do OpenSwan é o mesmo para os dois equipamentos, desta forma execute os passos abaixo nos 2.</p><p>Instalando o OpenSwan e OpenSSL</p><p>[sourcecode language="shell"]add-apt-repository ppa:openswan/ppa<br /> apt-get update<br /> apt-get install openssl openswan<br /> [/sourcecode]</p><p>Neste processo será questionado se deseja criar um certificado digital para este servidor. Pode selecionar a opção <strong>&lt;NO&gt;</strong><br /> <a href="/assets/2014/10/openswan-01.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 405 255'%3E%3C/svg%3E" data-src="/assets/2014/10/openswan-01.png" alt="openswan-01" width="405" height="255" class="lazyload" data-proofer-ignore></a></p><p>Edite o arquivo <strong>/etc/ipsec.conf</strong> (em ambos equipamentos) para que ele fique com o seguinte conteúdo:</p><p>[sourcecode language="shell"]version 2.0<br /> config setup<br /> dumpdir=/var/run/pluto/<br /> nat_traversal=yes<br /> virtual_private=%v4:10.0.0.0/8<br /> oe=off<br /> protostack=netkey</p><p>conn %default<br /> authby=rsasig<br /> leftrsasigkey=%cert<br /> rightrsasigkey=%cert<br /> keyingtries=1<br /> keylife=20m<br /> ikelifetime=240m</p><p>include /etc/ipsec.d/*.conf<br /> [/sourcecode]</p><p>Edite o arquivo <strong>/etc/ipsec.secrets</strong> para que ele fique com o seguinte conteúdo:</p><p>[sourcecode language="shell"]include /var/lib/openswan/ipsec.secrets.inc<br /> include /etc/ipsec.d/*.secret<br /> [/sourcecode]</p><p>Edite o arquivo <strong>/etc/sysctl.conf</strong> e altere ou insira a seguinte linha. Esta configuração tem por objetivo permitir que o kernel do linux faça roteamento dos pacotes de rede.</p><p>[sourcecode language="shell"]net.ipv4.ip_forward = 1<br /> [/sourcecode]</p><p>E depois execute o seguinte comando para aplicar essa configuração:</p><p>[sourcecode language="shell"]sysctl -p<br /> [/sourcecode]</p><p>Pronto as configurações gerais estão prontas, agora vamos para as configurações individuais de cada servidor de VPN.</p><h3>Um pouco sobre segredo compartilhado <em>versus</em> certificado digital</h3><p>Quando estamos configurando uma VPN com IPSEC há diversos fatores que podem influenciar e gerar problema no estabelecimento da conexão, desta forma sempre iniciamos a configuração de forma simples, e depois vamos incrementando opções e segurança. Seguindo esta lógica primeiro iremos configurar e estabelecer o tunnel VPN utilizando segredo compartilhado, para depois que o tunnel tiver OK possamos trocar para certificado digital.</p><p>Mas porque isso? Porque com certificado digital há diversos outros fatores que podem gerar problema como data de validade do certificado, common name, tipo do certificado, autoridade certificadora entre outros, então a forma mais simples de isolar os problemas é primeiro estabelecer o tunnel usando segredo compartilhado.</p><p>Por característica do protocolo IPSEC, para estabelecer um tunnel com segrede compartilhado é necessário saber o IP interno e externo de todos os envolvidos, não podendo ser nenhum dos 2 lados dinâmico, desta forma se em eu ambiente você utiliza uma internet com IP dinâmico, para estes primeiros passos descubra qual é o IP atualmente atribuido, faça a configuração com ele que nos próximos passos (depois de mudar o tunnel para usar certificado digital) iremos alterar para não precisar informar este IP na configuração.</p><h3>VPN Server Matriz</h3><p>Nesta sessão veremos todas as configurações que devem serem realizadas no servidor de VPN da matriz.</p><p><span style="line-height: 1.5;">Crie um arquivo nomeado </span><strong style="line-height: 1.5;">/etc/ipsec.d/vpn1.conf</strong><span style="line-height: 1.5;"> e insira o seguinte conteúdo:</span></p><p>[sourcecode language="shell"]conn vpn1 # Nome da Conexão VPN<br /> type= tunnel<br /> authby= secret #Tipo de autenticação</p><p> # Left security, (dados da Matriz)<br /> left= 200.165.10.50 # IP real/físico do servidor na matriz<br /> leftsubnet= 10.0.0.0/24 # Rede interna na Matriz para qual será estabelecido a VPN<br /> leftnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz</p><p> # Right security, (dados da Filial)<br /> right= 201.80.24.7 # IP Externo (após o NAT) que o servidor sairá para conexão com a matriz<br /> rightsubnet= 10.0.1.0/24 # Rede interna da filial para qual será estabelecido a VPN<br /> rightnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz</p><p> # Tipo de criptografia usada<br /> keyexchange=ike</p><p> # IPSEC Fase 1<br /> # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos<br /> # Formato de preenchimento 'cipher-hash;modpgroup, cipher-hash;modpgroup, ...'<br /> # -&gt; Não é obrigatório o preenchimento do modpgroup<br /> # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5<br /> # modpgroup disponíveis: modp1024, modp1536 e modp2048<br /> ike= 3des-md5, 3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5</p><p> # IPSEC Fase 2<br /> # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96<br /> phase2alg = 3des-md5-96 # Antigo parametro 'esp' que está obsoleto</p><p> # Outras configurações<br /> pfs= no<br /> auto= start<br /> [/sourcecode]</p><p>Agora crie o arquivo nomeado <strong>/etc/ipsec.d/vpn1.secret</strong> com o seguinte conteúdo</p><p>[sourcecode language="shell"]201.80.24.7 200.165.10.50: PSK &quot;123456&quot;<br /> [/sourcecode]</p><p>Agora reinicie o serviço do ipsec com o seguinte comando</p><p>[sourcecode language="shell"]ipsec setup restart<br /> [/sourcecode]</p><p>Caso deseje reiniciar somente um tunnel utilize os comandos abaixo</p><p>[sourcecode language="shell"]ipsec auto --down vpn1<br /> ipsec auto --up vpn1<br /> [/sourcecode]</p><h3>VPN Server Filial</h3><p>Nesta sessão veremos todas as configurações que devem serem realizadas no servidor de VPN da filial.</p><p>Crie um arquivo nomeado <strong>/etc/ipsec.d/vpn1.conf</strong> e insira o seguinte conteúdo:</p><p>[sourcecode language="shell"]conn vpn1 # Nome da Conexão VPN<br /> type= tunnel<br /> authby= secret #Tipo de autenticação</p><p> # Left security, (dados da Filial)<br /> left= 192.168.0.10 # IP real/físico do servidor na filial<br /> leftid= 201.80.24.7 # IP Externo (após o NAT) que o servidor sairá para conexão com a matriz<br /> leftsubnet= 10.0.1.0/24 # Rede interna na filial para qual será estabelecido a VPN<br /> leftnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial</p><p> # Right security, (dados da Matriz)<br /> right= 200.165.10.50 # IP externo do servidor na matriz<br /> rightsubnet= 10.0.0.0/24 # Rede interna da matriz para qual será estabelecido a VPN<br /> rightnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial</p><p> # Tipo de criptografia usada<br /> keyexchange=ike</p><p> # IPSEC Fase 1<br /> # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos<br /> # Formato de preenchimento 'cipher-hash;modpgroup, cipher-hash;modpgroup, ...'<br /> # -&gt; Não é obrigatório o preenchimento do modpgroup<br /> # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5<br /> # modpgroup disponíveis: modp1024, modp1536 e modp2048<br /> ike= 3des-md5, 3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5</p><p> # IPSEC Fase 2<br /> # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96<br /> phase2alg = 3des-md5-96 # Antigo parametro 'esp' que está obsoleto</p><p> # Outras configurações<br /> pfs= no<br /> auto= start<br /> [/sourcecode]</p><p>Agora crie o arquivo nomeado <strong>/etc/ipsec.d/vpn1.secret</strong> com o seguinte conteúdo</p><p>[sourcecode language="shell"]200.165.10.50 201.80.24.7: PSK &quot;123456&quot;<br /> [/sourcecode]</p><p>Agora reinicie o serviço do ipsec com o seguinte comando</p><p>[sourcecode language="shell"]ipsec setup restart<br /> [/sourcecode]</p><p>Caso deseje reiniciar somente um tunnel utilize os comandos abaixo</p><p>[sourcecode language="shell"]ipsec auto --down vpn1<br /> ipsec auto --up vpn1<br /> [/sourcecode]</p><p>&nbsp;</p><h3>Verificando status e erros de configuração</h3><p>Após iniciar a configuração alguns passos podem ser feito para checar a configuração e correto carregamento da mesma, bem como erros no estabelecimento do tunnel.</p><p>Verifique no arquivo de log <strong>/var/log/auth.log</strong> se estes 2 logs foram gerados, eles indicam que o arquivo de chaves da VPN foi carregado e que a vpn1 foi carregada e será iniciado o processo para estabelecer o tunnel</p><p>[sourcecode language="shell"]loading secrets from &quot;/etc/ipsec.d/vpn1.secret&quot;<br /> &quot;vpn1&quot; #1: initiating Main Mode<br /> [/sourcecode]</p><p>E um dos logs mais legal de se ver é o que estabeleceu a SA, ou seja o tunnel está OK</p><p>[sourcecode language="shell"]&quot;vpn1&quot; #4: STATE_QUICK_I2: sent QI2, IPsec SA established tunnel mode {ESP=&gt;0xb71ffca5 [/sourcecode]</p><p>Outro comando bem útil é o comando para verificar o status do ipsec</p><p>[sourcecode language="shell"]/usr/sbin/ipsec auto --status<br /> [/sourcecode]</p><p>Este comando irá retornar uma saída parecida com essa.</p><p>[sourcecode language="shell"]000 using kernel interface: netkey<br /> 000 interface lo/lo ::1<br /> 000 interface lo/lo 127.0.0.1<br /> 000 interface lo/lo 127.0.0.1<br /> 000 interface eth0/eth0 10.0.0.1<br /> 000 interface eth0/eth0 10.0.0.1<br /> 000 interface eth1/eth1 200.165.10.50<br /> 000 interface eth1/eth1 200.165.10.50<br /> 000 %myid = (none)<br /> 000 debug none<br /> 000<br /> 000 virtual_private (%priv):<br /> 000 - allowed 1 subnet: 10.0.0.0/8<br /> 000 - disallowed 0 subnets:<br /> 000 WARNING: Disallowed subnets in virtual_private= is empty. If you have<br /> 000 private address space in internal use, it should be excluded!<br /> 000<br /> 000 algorithm ESP encrypt: id=2, name=ESP_DES, ivlen=8, keysizemin=64, keysizemax=64<br /> 000 algorithm ESP encrypt: id=3, name=ESP_3DES, ivlen=8, keysizemin=192, keysizemax=192<br /> 000 algorithm ESP encrypt: id=6, name=ESP_CAST, ivlen=8, keysizemin=40, keysizemax=128<br /> 000 algorithm ESP encrypt: id=7, name=ESP_BLOWFISH, ivlen=8, keysizemin=40, keysizemax=448<br /> 000 algorithm ESP encrypt: id=11, name=ESP_NULL, ivlen=0, keysizemin=0, keysizemax=0<br /> 000 algorithm ESP encrypt: id=12, name=ESP_AES, ivlen=8, keysizemin=128, keysizemax=256<br /> 000 algorithm ESP encrypt: id=13, name=ESP_AES_CTR, ivlen=8, keysizemin=160, keysizemax=288<br /> 000 algorithm ESP encrypt: id=14, name=ESP_AES_CCM_A, ivlen=8, keysizemin=128, keysizemax=256<br /> 000 algorithm ESP encrypt: id=15, name=ESP_AES_CCM_B, ivlen=8, keysizemin=128, keysizemax=256<br /> 000 algorithm ESP encrypt: id=16, name=ESP_AES_CCM_C, ivlen=8, keysizemin=128, keysizemax=256<br /> 000 algorithm ESP encrypt: id=18, name=ESP_AES_GCM_A, ivlen=8, keysizemin=128, keysizemax=256<br /> 000 algorithm ESP encrypt: id=19, name=ESP_AES_GCM_B, ivlen=8, keysizemin=128, keysizemax=256<br /> 000 algorithm ESP encrypt: id=20, name=ESP_AES_GCM_C, ivlen=8, keysizemin=128, keysizemax=256<br /> 000 algorithm ESP encrypt: id=22, name=ESP_CAMELLIA, ivlen=8, keysizemin=128, keysizemax=256<br /> 000 algorithm ESP encrypt: id=252, name=ESP_SERPENT, ivlen=8, keysizemin=128, keysizemax=256<br /> 000 algorithm ESP encrypt: id=253, name=ESP_TWOFISH, ivlen=8, keysizemin=128, keysizemax=256<br /> 000 algorithm ESP auth attr: id=1, name=AUTH_ALGORITHM_HMAC_MD5, keysizemin=128, keysizemax=128<br /> 000 algorithm ESP auth attr: id=2, name=AUTH_ALGORITHM_HMAC_SHA1, keysizemin=160, keysizemax=160<br /> 000 algorithm ESP auth attr: id=5, name=AUTH_ALGORITHM_HMAC_SHA2_256, keysizemin=256, keysizemax=256<br /> 000 algorithm ESP auth attr: id=6, name=AUTH_ALGORITHM_HMAC_SHA2_384, keysizemin=384, keysizemax=384<br /> 000 algorithm ESP auth attr: id=7, name=AUTH_ALGORITHM_HMAC_SHA2_512, keysizemin=512, keysizemax=512<br /> 000 algorithm ESP auth attr: id=8, name=AUTH_ALGORITHM_HMAC_RIPEMD, keysizemin=160, keysizemax=160<br /> 000 algorithm ESP auth attr: id=9, name=AUTH_ALGORITHM_AES_CBC, keysizemin=128, keysizemax=128<br /> 000 algorithm ESP auth attr: id=251, name=AUTH_ALGORITHM_NULL_KAME, keysizemin=0, keysizemax=0<br /> 000<br /> 000 algorithm IKE encrypt: id=0, name=(null), blocksize=16, keydeflen=131<br /> 000 algorithm IKE encrypt: id=5, name=OAKLEY_3DES_CBC, blocksize=8, keydeflen=192<br /> 000 algorithm IKE encrypt: id=7, name=OAKLEY_AES_CBC, blocksize=16, keydeflen=128<br /> 000 algorithm IKE hash: id=1, name=OAKLEY_MD5, hashsize=16<br /> 000 algorithm IKE hash: id=2, name=OAKLEY_SHA1, hashsize=20<br /> 000 algorithm IKE hash: id=4, name=OAKLEY_SHA2_256, hashsize=32<br /> 000 algorithm IKE hash: id=6, name=OAKLEY_SHA2_512, hashsize=64<br /> 000 algorithm IKE dh group: id=2, name=OAKLEY_GROUP_MODP1024, bits=1024<br /> 000 algorithm IKE dh group: id=5, name=OAKLEY_GROUP_MODP1536, bits=1536<br /> 000 algorithm IKE dh group: id=14, name=OAKLEY_GROUP_MODP2048, bits=2048<br /> 000 algorithm IKE dh group: id=15, name=OAKLEY_GROUP_MODP3072, bits=3072<br /> 000 algorithm IKE dh group: id=16, name=OAKLEY_GROUP_MODP4096, bits=4096<br /> 000 algorithm IKE dh group: id=17, name=OAKLEY_GROUP_MODP6144, bits=6144<br /> 000 algorithm IKE dh group: id=18, name=OAKLEY_GROUP_MODP8192, bits=8192<br /> 000 algorithm IKE dh group: id=22, name=OAKLEY_GROUP_DH22, bits=1024<br /> 000 algorithm IKE dh group: id=23, name=OAKLEY_GROUP_DH23, bits=2048<br /> 000 algorithm IKE dh group: id=24, name=OAKLEY_GROUP_DH24, bits=2048<br /> 000<br /> 000 stats db_ops: {curr_cnt, total_cnt, maxsz} :context={0,2,64} trans={0,2,3072} attrs={0,2,2048}<br /> 000<br /> 000 &quot;vpn1&quot;: 10.0.0.0/24===200.165.10.50---200.165.10.1...200.165.10.1---201.80.24.7===10.0.1.0/24; erouted; eroute owner: #4<br /> 000 &quot;vpn1&quot;: myip=unset; hisip=unset;<br /> 000 &quot;vpn1&quot;: ike_life: 14400s; ipsec_life: 1200s; rekey_margin: 540s; rekey_fuzz: 100%; keyingtries: 1<br /> 000 &quot;vpn1&quot;: policy: PSK+ENCRYPT+TUNNEL+UP+IKEv2ALLOW+SAREFTRACK; prio: 24,24; interface: eth1;<br /> 000 &quot;vpn1&quot;: newest ISAKMP SA: #1; newest IPsec SA: #4;<br /> 000 &quot;vpn1&quot;: IKE algorithm newest: AES_CBC_128-SHA1-MODP2048<br /> 000 &quot;vpn1&quot;: ESP algorithms wanted: 3DES(3)_000-MD5(1)_096; flags=-strict<br /> 000 &quot;vpn1&quot;: ESP algorithms loaded: 3DES(3)_192-MD5(1)_096<br /> 000 &quot;vpn1&quot;: ESP algorithm newest: 3DES_000-HMAC_MD5; pfsgroup=&lt;N/A&gt;<br /> 000<br /> 000 #3: &quot;vpn1&quot;:4500 STATE_QUICK_R2 (IPsec SA established); EVENT_SA_REPLACE in 727s; isakmp#2; idle; import:not set<br /> 000 #3: &quot;vpn1&quot; esp.a0dfaa1a@201.80.24.7 esp.bf6f0287@200.165.10.50 tun.0@201.80.24.7 tun.0@200.165.10.50 ref=0 refhim=4294901761<br /> 000 #2: &quot;vpn1&quot;:4500 STATE_MAIN_R3 (sent MR3, ISAKMP SA established); EVENT_SA_REPLACE in 13926s; lastdpd=-1s(seq in:0 out:0); idle; import:not set<br /> 000 #4: &quot;vpn1&quot;:4500 STATE_QUICK_I2 (sent QI2, IPsec SA established); EVENT_SA_REPLACE in 453s; newest IPSEC; eroute owner; isakmp#1; idle; import:admin initiate<br /> 000 #4: &quot;vpn1&quot; esp.b71ffca5@201.80.24.7 esp.25fdf05f@200.165.10.50 tun.0@201.80.24.7 tun.0@200.165.10.50 ref=0 refhim=4294901761<br /> 000 #1: &quot;vpn1&quot;:4500 STATE_MAIN_I4 (ISAKMP SA established); EVENT_SA_REPLACE in 13163s; newest ISAKMP; lastdpd=-1s(seq in:0 out:0); idle; import:admin initiate<br /> 000<br /> [/sourcecode]</p><p>Neste retorno há diversas informações, mas as mais importantes estão no final, onde mostram as SAs estabelecidas, ou seja, os tunneis IPSEC estabelecidos.</p><p>Pronto, a primeira fase da configuração está ok e nosso tunnel VPN estabelecido. Agora iniciaremos o processo para configuração utilizando certificado digital.</p><h2><strong>Gerando certificados digitais</strong></h2><p>Antes de realizarmos a configuração do OpenSwan para utilizar os certificados digitais é necessário ter ou gerar os certificados. Como o objetivo deste post é ser o mais completo possível, realizaremos todo o processo de geração da autoridade certificadora e assinatura/geração dos certificados.</p><p>Se você não entende muito bem como funciona esse negócio de autoridade certificadora, cadeia de certificação segue alguns posts para você dar uma olhada antes de continuar:</p><ul><li><a title="Certificação digital" href="http://www.helviojunior.com.br/it/security/certificacao-digital/" target="_blank" rel="noopener">Certificação digital</a><li><a title="Instalando autoridade certificadora raiz (CA Root) com OpenSSL" href="http://www.helviojunior.com.br/it/security/instalando-autoridade-certificadora-raiz-ca-root-com-openssl/" target="_blank" rel="noopener">Instalando CA Root com OpenSSL</a><li><a title="Instalando autoridade certificadora raiz (CA Root) com windows" href="http://www.helviojunior.com.br/it/security/instalando-autoridade-certificadora-raiz-ca-root-com-windows/" target="_blank" rel="noopener">Instalando CA Root com Windows</a><li><a title="Verificando se um certificado é valido para atuar como uma autoridade certificadora (CA)" href="http://www.helviojunior.com.br/it/security/verificando-se-um-certificado-e-valido-para-atuar-como-uma-ca/" target="_blank" rel="noopener">Verificando de um certificado é válido para atuar como CA</a></ul><p>Agora sim podemos continuar com a geração dos certificados. Neste post veremos 2 formas de gerar estes certificados, a primeira e a mais simples utilizando um aplicativo windows que criei para gerar os certificados e a segunda e mais complexa utilizando os comandos OpenSSL (que funcionam em windows e linux)</p><h3>Gerando certificados com o aplicativo BuildCert</h3><p>Conforme ja comentado este aplicativo foi desenvolvido por mim especificamente para geração de certificados digitais para utilização em sistemas de VPN IPSEC, muitos dos aplicativos que realizam VPN IPSEC pedem configurações específicas nos certificados que são bem chatas de fazer através do openssl via linha de comando. Este aplicativo basicamente utiliza as próprias bibliotecas do OpenSSL para gerar os certificados.</p><p>Este aplicativo cria desde a CA até os certificados individuais de cada servidor de VPN. Todos compatíveis com qualquer sistema de autoridade de certificação. Outra funcionalidade interessante deste aplicativo é que pode ser utilizado com a sua autoridade de certificadora atual (caso ja tenha uma instalada).</p><p><strong>Utilizando a CA atual para assinar o certificado</strong></p><p>Para realizar este processo utilizando a sua CA atual será necessário ter o arquivo <strong>.pfx</strong> ou <strong>.p12</strong> da sua CA. Caso sua CA seja windows e você não saiba como realizar este procedimento no post <a title="Instalando autoridade certificadora raiz (CA Root) com windows" href="http://www.helviojunior.com.br/it/security/instalando-autoridade-certificadora-raiz-ca-root-com-windows/"><strong>Instalando CA Root com Windows</strong></a> eu ensino como realiza-lo.</p><p><strong>Gerando certificado</strong></p><p>Realize o download do aplicativo BuildCert (<a href="/assets/2014/10/BuildCert.zip" target="_blank" rel="noopener">clicando aqui</a>) e descompacte em qualquer lugar em seu PC. O Aplicativo terá a seguinte estrutura de arquivos, por mais que pareça que há duplicados todos são necessários.</p><p><a href="/assets/2014/10/BuildCertTree.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 131 209'%3E%3C/svg%3E" data-src="/assets/2014/10/BuildCertTree.png" alt="BuildCertTree" width="131" height="209" class="lazyload" data-proofer-ignore></a></p><p>Modo de utilização</p><p>[sourcecode language="shell"]BuildCert.exe [common_name_ca] [common_name_cert] [password_ca] [password_cert]<br /> [/sourcecode]</p><p>Ao ser iniciado o aplicativo irá buscar dentro do diretório certs o arquivo com o common mane da CA + a extensão pfx ex.: ca.meudominio.pfx, caso o arquivo exista o aplicativo irá abri-lo com a senha definida e utiliza-lo para assinar os certificados gerados, caso contrário o aplicativo irá criar este pfx e utiliza-lo para assinar os certificados gerados.</p><p>Vamos para a pratica, execute os comandos abaixo para gerar uma CA com nome <strong>cavpn.tutorial</strong> e os certificados <strong>matriz.tutorial</strong> e <strong>filial.tutorial. </strong>Ambos com a senha 123456</p><p>[sourcecode language="shell"]BuildCert.exe cavpn.tutorial matriz.tutorial 123456 123456<br /> BuildCert.exe cavpn.tutorial filial.tutorial 123456 123456<br /> [/sourcecode]</p><p>Após a execução dos comandos 3 arquivos por certificado serão criados:</p><ol><li><strong>.cer:</strong> arquivo do certificado digital X509<li><strong>.key:</strong> chave privada do certificado<li><strong>.pfx:</strong> arquivo PKCS#12 contendo o certificado X509 + a chave privada</ol><p><a style="line-height: 1.5;" href="/assets/2014/10/certs.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 168 193'%3E%3C/svg%3E" data-src="/assets/2014/10/certs.png" alt="certs" width="168" height="193" class="lazyload" data-proofer-ignore></a></p><p>Segue os prints dos certificados</p><p>[caption id="attachment_1112" align="alignnone" width="251"]<a href="/assets/2014/10/ca1.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 251 313'%3E%3C/svg%3E" class="lazyload wp-image-1112" data-src="/assets/2014/10/ca1.png" alt="ca1" width="251" height="313" data-proofer-ignore></a> Certificado da CA (Autoassinado)[/caption]</p><p>[caption id="attachment_1113" align="alignnone" width="251"]<a href="/assets/2014/10/ca2.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 251 313'%3E%3C/svg%3E" class="lazyload wp-image-1113" data-src="/assets/2014/10/ca2.png" alt="ca2" width="251" height="313" data-proofer-ignore></a> Certificado da matriz assinado pela CA[/caption]</p><p>[caption id="attachment_1114" align="alignnone" width="251"]<a href="/assets/2014/10/ca3.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 251 313'%3E%3C/svg%3E" class="lazyload wp-image-1114" data-src="/assets/2014/10/ca3.png" alt="ca3" width="251" height="313" data-proofer-ignore></a> Certificado da filial assinado pela CA[/caption]</p><p>Pronto, os certificados foram gerados e estão prontos para serem utilizados no OpenSwan</p><h3>Gerando certificados com o OpenSSL</h3><p>Outro modo de gerar os certificados é utilizando diretamente o OpenSSL.</p><p>Se você ja gerou os certificados através dos passos anteriores (aplicativo BuildCert) pode pular estes passos e ir direto para configuração dos tunneis.</p><p><strong style="line-height: 1.5;">Gerando certificado</strong></p><p>Antes de tudo vamos preparar o ambiente para o OpenSSL, realize uma cópia do arquivo de configuração padrão do OpenSSL para o seu ambiente</p><p>[sourcecode language="shell"]cp cp /etc/ssl/openssl.cnf /etc/ipsec.d/<br /> [/sourcecode]</p><p>Edite o arquivo de configuração alterando as seguintes linhas</p><p>[sourcecode language="shell"][ CA_default ]</p><p>dir = /etc/ipsec.d<br /> certificate = $dir/cacerts/cavpn.tutorial.cer</p><p>private_key = $dir/private/cavpn.tutorial.key<br /> [/sourcecode]</p><p>E por fim vamos criar arquivos e diretórios necessários para o correto funcionamento do OpenSSL</p><p>[sourcecode language="shell"]mkdir newcerts<br /> touch index.txt<br /> echo &quot;00&quot; &gt; serial<br /> [/sourcecode]</p><p>Agora vamos criar a nossa CA através do comando abaixo</p><p>[sourcecode language="shell"]cd /etc/ipsec.d<br /> openssl req -x509 -days 3650 -config /etc/ipsec.d/openssl.cnf -newkey rsa:2048 -keyout private/cavpn.tutorial.key -out cacerts/cavpn.tutorial.cer<br /> [/sourcecode]</p><p>Na execução deste comando diversas informações serão solicitadas, porém 2 delas são importantes, 1 - Senha da CA, essa senha será solicitada para assinar os certificados da matriz e da filial; 2 - CommonName, ou seja o nome da CA. Preencha estes dados conforme desejado ou seguindo o exemplo abaixo</p><p><a href="/assets/2014/10/cert1.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 540 391'%3E%3C/svg%3E" data-src="/assets/2014/10/cert1.png" alt="cert1" width="540" height="391" class="lazyload" data-proofer-ignore></a></p><p>Gere a requisição e assine o certificado da matriz</p><p>[sourcecode language="shell"]openssl req -config /etc/ipsec.d/openssl.cnf -newkey rsa:1024 -keyout private/matriz.tutorial.key -out certs/matriz.tutorial.req<br /> openssl ca -in certs/matriz.tutorial.req -config /etc/ipsec.d/openssl.cnf -days 730 -out certs/matriz.tutorial.cer -notext<br /> openssl rsa -in private/matriz.tutorial.key -out private/matriz.tutorial.key<br /> [/sourcecode]</p><p>Diversas informações serão solicitadas porém a mais importante é o CommonName que precisa ser o <strong>matriz.tutorial</strong> para que os próximos scripts funcionem corretamente<br /> <a href="/assets/2014/10/cert-matriz.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 540 404'%3E%3C/svg%3E" data-src="/assets/2014/10/cert-matriz.png" alt="cert-matriz" width="540" height="404" class="lazyload" data-proofer-ignore></a></p><p>Gere a requisição e assine o certificado da filial</p><p>[sourcecode language="shell"]openssl req -config /etc/ipsec.d/openssl.cnf -newkey rsa:1024 -keyout private/filial.tutorial.key -out certs/filial.tutorial.req<br /> openssl ca -in certs/filial.tutorial.req -config /etc/ipsec.d/openssl.cnf -days 730 -out certs/filial.tutorial.cer -notext<br /> openssl rsa -in private/filial.tutorial.key -out private/filial.tutorial.key<br /> [/sourcecode]</p><p>Diversas informações serão solicitadas porém a mais importante é o CommonName que precisa ser o <strong>filial.tutorial</strong> para que os próximos scripts funcionem corretamente<br /> <a href="/assets/2014/10/cert-filial.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 540 391'%3E%3C/svg%3E" data-src="/assets/2014/10/cert-filial.png" alt="cert-filial" width="540" height="391" class="lazyload" data-proofer-ignore></a></p><p>Pronto, os certificados estão gerados e pronto para serem utilizados.</p><h2>Configurando os tunneis ipsec para utilizar os certificados digitais</h2><p>Agora que temos todos os certificados a mão podemos iniciar a configuração do OpenSwan para estabelecer a VPN utilizando os certificados digitais, estes passos são individuais para cada servidor.</p><h3>VPN Server Matriz</h3><p>Copie os arquivos necessários para os seus respectivos locais de utilização conforme indicado na tabela abaixo:</p><ul><li>/etc/ipsec.d/cacerts/cavpn.tutorial.cer<li>/etc/ipsec.d/certs/filial.tutorial.cer<li>/etc/ipsec.d/certs/matriz.tutorial.cer<li>/etc/ipsec.d/private/matriz.tutorial.key</ul><p>Edite o arquivo <strong>/etc/ipsec.d/vpn1.conf</strong> para que o mesmo fique com o seguinte conteúdo</p><p>[sourcecode language="shell"]conn vpn1 # Nome da Conexão VPN<br /> type= tunnel<br /> authby= rsasig #Tipo de autenticação</p><p> # Left security, (dados da Matriz)<br /> left= 200.165.10.50 # IP real/físico do servidor na matriz<br /> leftid=@matriz.tutorial # CommonName do certificado<br /> leftrsasigkey=%cert<br /> leftcert=matriz.tutorial.cer # Nome do arquivo do certificado<br /> leftsubnet= 10.0.0.0/24 # Rede interna na Matriz para qual será estabelecido a VPN<br /> leftnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz</p><p> # Right security, (dados da Filial)<br /> right= %any # Está tag indica que a conexão pode vir de qualquer IP<br /> rightid= @filial.tutorial # CommonName do certificado<br /> rightrsasigkey=%cert<br /> rightcert=filial.tutorial.cer # Nome do arquivo do certificado<br /> rightca=%same<br /> rightsubnet= 10.0.1.0/24 # Rede interna da filial para qual será estabelecido a VPN<br /> rightnexthop= 200.165.10.1 # IP real do Gateway do servidor de VPN da Matriz</p><p> # Tipo de criptografia usada<br /> keyexchange=ike</p><p> # IPSEC Fase 1<br /> # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos<br /> # Formato de preenchimento 'cipher-hash;modpgroup, cipher-hash;modpgroup, ...'<br /> # -&gt; Não é obrigatório o preenchimento do modpgroup<br /> # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5<br /> # modpgroup disponíveis: modp1024, modp1536 e modp2048<br /> ike= 3des-md5,3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5<br /> ikelifetime=28800s</p><p> # IPSEC Fase 2<br /> # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96<br /> phase2=esp<br /> phase2alg=3des-md5-96 # Antigo parametro 'esp' que está obsoleto<br /> keylife=28800s</p><p> # Outras configurações<br /> pfs= no<br /> auto= start<br /> [/sourcecode]</p><p>Além das alterações dos certificados digitais há uma alteração no parâmetro <strong>right</strong> que antes detinha o IP externo do servidor de VPN da filial e agora detém a tag <strong>%any</strong>, que possibilita que o IP externo do servidor de VPN da Filial possa trocar de IP sem a necessidade de alterar a configuração.</p><p>Edite o arquivo <strong>/etc/ipsec.d/vpn1.secret</strong>, remova a linha atual e adicione a seguinte linha</p><p>[sourcecode language="shell"]: RSA matriz.tutorial.key &quot;123456&quot;<br /> [/sourcecode]</p><p>Reinicie o serviço do ipsec e verifique no arquivo de log <strong>/var/log/auth.log</strong> se as linhas abaixo foram exibidas, elas indicam que a chave foi lida com sucesso.</p><p>[sourcecode language="shell"]loading secrets from &quot;/etc/ipsec.d/vpn1.secret&quot;<br /> loaded private key file '/etc/ipsec.d/private/matriz.tutorial.key' (1675 bytes)<br /> loaded private key for keyid: PPK_RSA:AwEAAfL4J<br /> &quot;vpn1&quot; #1: initiating Main Mode<br /> [/sourcecode]</p><h3>VPN Server Filial</h3><p>Copie os arquivos necessários para os seus respectivos locais de utilização conforme indicado na tabela abaixo:</p><ul><li>/etc/ipsec.d/cacerts/cavpn.tutorial.cer<li>/etc/ipsec.d/certs/filial.tutorial.cer<li>/etc/ipsec.d/certs/matriz.tutorial.cer<li>/etc/ipsec.d/private/filial.tutorial.key</ul><p>Edite o arquivo <strong>/etc/ipsec.d/vpn1.conf</strong> para que o mesmo fique com o seguinte conteúdo</p><p>[sourcecode language="shell"]conn vpn1 # Nome da Conexão VPN<br /> type= tunnel<br /> authby= rsasig #Tipo de autenticação</p><p> # Left security, (dados da Filial)<br /> left= 192.168.0.10 # IP real/físico do servidor na filial<br /> leftid=@filial.tutorial # CommonName do certificado<br /> leftrsasigkey=%cert<br /> leftcert=filial.tutorial.cer # Nome do arquivo do certificado<br /> leftsubnet= 10.0.1.0/24 # Rede interna na filial para qual será estabelecido a VPN<br /> leftnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial</p><p> # Right security, (dados da Matriz)<br /> right= 200.165.10.50 # IP externo do servidor na matriz<br /> rightid= @matriz.tutorial # CommonName do certificado<br /> rightrsasigkey=%cert<br /> rightcert=matriz.tutorial.cer # Nome do arquivo do certificado<br /> rightca=%same<br /> rightsubnet= 10.0.0.0/24 # Rede interna da matriz para qual será estabelecido a VPN<br /> rightnexthop= 192.168.0.1 # IP real do Gateway do servidor de VPN da filial</p><p> # Tipo de criptografia usada<br /> keyexchange=ike</p><p> # IPSEC Fase 1<br /> # Não é obrigatório o preenchimento, caso preenchido será restrito a estes protocolos preenchidos<br /> # Formato de preenchimento 'cipher-hash;modpgroup, cipher-hash;modpgroup, ...'<br /> # -&gt; Não é obrigatório o preenchimento do modpgroup<br /> # cipher-hash disponíveis: 3des-sha1, 3des-md5, aes-sha1, aes-md5, aes128-sha1 e aes128-md5<br /> # modpgroup disponíveis: modp1024, modp1536 e modp2048<br /> ike= 3des-md5,3des-sha1,aes-sha1,aes-md5,aes128-sha1,aes128-md5<br /> ikelifetime=28800s</p><p> # IPSEC Fase 2<br /> # cipher-hash disponíveis: 3des, 3des-md5-96, 3des-sha1-96<br /> phase2=esp<br /> phase2alg=3des-md5-96 # Antigo parametro 'esp' que está obsoleto<br /> keylife=28800s</p><p> # Outras configurações<br /> pfs= no<br /> auto= start<br /> [/sourcecode]</p><p>Edite o arquivo <strong>/etc/ipsec.d/vpn1.secret</strong>, remova a linha atual e adicione a seguinte linha</p><p>[sourcecode language="shell"]: RSA filial.tutorial.key &quot;123456&quot;<br /> [/sourcecode]</p><p>Reinicie o serviço do ipsec e verifique no arquivo de log <strong>/var/log/auth.log</strong> se as linhas abaixo foram exibidas, elas indicam que a chave foi lida com sucesso.</p><p>[sourcecode language="shell"]loading secrets from &quot;/etc/ipsec.d/vpn1.secret&quot;<br /> loaded private key file '/etc/ipsec.d/private/filial.tutorial.key' (1679 bytes)<br /> loaded private key for keyid: PPK_RSA:AwEAAdWyO<br /> [/sourcecode]</p><h2>Troubleshooting</h2><p>Caso seja necessário ter um numero maior de informações e log basta adicionar as linhas de log no arquivo <strong>/etc/ipsec.conf</strong> conforme abaixo<br /> [sourcecode language="shell"]version 2.0<br /> config setup<br /> ...<br /> plutodebug=all<br /> plutostderrlog=/var/log/openswan.log</p><p>[/sourcecode]</p><h2>Considerações finais</h2><p>Neste post vimos como realizar todo o procedimento utilizando como servidor de VPN dois equipamentos com o OpensSwan, porém o procedimento é exatamente o mesmo para ambientes onde um dos equipamentos não é OpenSwan, como por exemplo, Cisco, Microsoft TMG, Aker, pfSense, Dlink entre outros.</p><p>Como continuidade irei demonstrar como substituir o equipamento da matriz por outros sistemas. Assim que tiver um tempo elaborarei estes outros tutoriais e posto aqui no site.</p><p>Caso você quera compartilhar a sua experiência substituindo uma das pontas por outro equipamento, me envie o passo a passo com prints, comandos e arquivos de configuração que posto no site com os seus créditos.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/it/'>IT</a>, <a href='/categories/linux/'>Linux</a>, <a href='/categories/seguran%C3%A7a-da-informa%C3%A7%C3%A3o/'>Segurança da Informação</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Estabelecendo VPN Site-to-site IPSEC com OpenSwan - Helvio Junior&url=https://www.helviojunior.com.br/it/security/estabelecendo-vpn-site-to-site-ipsec-natt-openswan/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Estabelecendo VPN Site-to-site IPSEC com OpenSwan - Helvio Junior&u=https://www.helviojunior.com.br/it/security/estabelecendo-vpn-site-to-site-ipsec-natt-openswan/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Estabelecendo VPN Site-to-site IPSEC com OpenSwan - Helvio Junior&url=https://www.helviojunior.com.br/it/security/estabelecendo-vpn-site-to-site-ipsec-natt-openswan/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.helviojunior.com.br/it/security/estabelecendo-vpn-site-to-site-ipsec-natt-openswan/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/security/osint/localizando-ips-que-respondem-para-uma-url/">Localizando IPs que respondem para uma URL</a><li><a href="/security/osint/locating-url-ips-bypass-waf/">Locating IPs that respond to a URL</a><li><a href="/security/edr/instalando-elasticsearch-edr/">Instalando Elasticsearch EDR</a><li><a href="/it/instalando-openvpn-com-autenticacao-em-mysql/">Instalando OpenVPN com autenticação em MySQL</a><li><a href="/it/osce-osed-e-ecxd-certificacoes-de-desenvolvimento-de-exploits/">OSCE, OSED e eCXD: Certificações de desenvolvimento de Exploits</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/offensive-security/">Offensive Security</a> <a class="post-tag" href="/tags/pentest/">Pentest</a> <a class="post-tag" href="/tags/autoridade-certificadora/">autoridade certificadora</a> <a class="post-tag" href="/tags/ca/">ca</a> <a class="post-tag" href="/tags/certificate-authority/">certificate authority</a> <a class="post-tag" href="/tags/openssl/">openssl</a> <a class="post-tag" href="/tags/osce3/">OSCE3</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/osed/">OSED</a> <a class="post-tag" href="/tags/osee/">OSEE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/it/backup-com-dd-dd-backup-without-empty-space/"><div class="card-body"> <span class="timeago small" > Jun 28, 2013 <i class="unloaded">2013-06-28T14:43:10-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Backup com dd (dd backup without empty space)</h3><div class="text-muted small"><p> Com a utilização do Raspberry tive a necessidade de preparar uma imagem base para clonar em outros dispositivos ou até mesmo para fins de backup. A melhor ferramenta para realizar essa operação é o...</p></div></div></a></div><div class="card"> <a href="/it/criando-um-nas-network-attached-storage/"><div class="card-body"> <span class="timeago small" > Jul 7, 2014 <i class="unloaded">2014-07-07T21:06:04-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Criando um NAS (Network-Attached Storage) e DLNA</h3><div class="text-muted small"><p> O Objetivo deste post é demonstrar passo a passo como configurar um Raspberry Pi para servir como servidor de arquivos/NAS. Com poucas alterações este mesmo procedimento poderá ser utilizado para c...</p></div></div></a></div><div class="card"> <a href="/it/como-montar-um-volume-linux-lvm-no-linux/"><div class="card-body"> <span class="timeago small" > Aug 6, 2014 <i class="unloaded">2014-08-06T09:04:57-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Como montar um volume Linux LVM no Linux</h3><div class="text-muted small"><p> Em muitos casos é necessário montar um volume LVM em um linux, como um HD externo, por exemplo. Segue o procedimento de identificação e montagem do volume LVM. Listando os discos e partições [sour...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/it/monitoramento/integracao-safeid-zabbix/" class="btn btn-outline-primary" prompt="Older"><p>Integração SafeId + Zabbix</p></a> <a href="/video/utilizando-ffmpeg-para-converter-videos-e-audio/" class="btn btn-outline-primary" prompt="Newer"><p>Utilizando FFmpeg para converter vídeos e audio</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Estabelecendo VPN Site-to-site IPSEC com OpenSwan'; this.page.url = 'https://www.helviojunior.com.br/it/security/estabelecendo-vpn-site-to-site-ipsec-natt-openswan/'; this.page.identifier = '/it/security/estabelecendo-vpn-site-to-site-ipsec-natt-openswan/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/helviojunior">Helvio junior (aka M4v3r1ck)</a>. <span data-toggle="tooltip" data-placement="top" title="Some rights reserved.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/offensive-security/">Offensive Security</a> <a class="post-tag" href="/tags/pentest/">Pentest</a> <a class="post-tag" href="/tags/autoridade-certificadora/">autoridade certificadora</a> <a class="post-tag" href="/tags/ca/">ca</a> <a class="post-tag" href="/tags/certificate-authority/">certificate authority</a> <a class="post-tag" href="/tags/openssl/">openssl</a> <a class="post-tag" href="/tags/osce3/">OSCE3</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/osed/">OSED</a> <a class="post-tag" href="/tags/osee/">OSEE</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.helviojunior.com.br{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
