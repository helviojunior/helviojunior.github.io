<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Tratando código CNL para ligações conurbadas no Asterisk e FreePBX" /><meta name="author" content="Helvio Junior (m4v3r1ck)" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introdução e contextualização Antes de qualquer coisa vamos direto ao problema que pretendemos resolver neste post. O sistema de telefonia fixa no Brasil adota um padrão de separação das localidades e uma subordinação político-administrativa (isso será explicado um pouco mais a frente com mais detalhes). Basicamente com essa separação poderemos ter 2 municípios com o mesmo DDD onde para realizar ligações um deles não é necessário adicionar o código de DDD, e para outro sim. Exemplo: Moro na cidade de Curitiba (cujo DDD é 41), temos diversos municípios de Curitiba e região metropolitana como Curitiba, Lapa, São José dos Pinhais, Colombo e etc... Quando em Curitiba não necessito utilizar o DDD para efetuar uma ligação a estes municípios, porém quando ligamos para Paranaguá, uma cidade a +- 100 Km de Curitiba, que utiliza o mesmo DDD, ja é necessário utilizar o DDD para realizar ligações. Sendo assim surge o nosso problema, se o DDD não é quem difere se devo ou não colocar o DDD ao realizar uma chamada, como podemos realizar essa distinção? A resposta esta na base de dados CNL. Mas ai surge a pergunta o que é CNL? CNL é o acronimo de &quot;Cadastro Nacional de Localidades&quot;, que tem como definição legal no Inciso III do art. 3º do anexo da Resolução da Anatel nº 83, de 30/12/1998 como &quot;Conjunto de informações relativo às disponibilidades de serviços de telecomunicações em localidades do território nacional.&quot;. Na pratica o Cadastro de Localidades Brasileira, fornece os nomes, a subordinação político-administrativa (a que grande região, estado, meso ou microrregião pertencem), as coordenadas (latitudes e longitudes) e altitudes médias das sedes de localidades como municípios, vilas, assentamentos rurais e aldeias indígenas, entre outras. Agora que conhecemos um pouco mais da estruturação da telefonia podemos entrar no detalhamento da base de dados CNL, para posteriormente entender como poderemos distinguir se nossa ligação deve ou não utilizar DDD. Atualizações 2017-05-15 Alteração da biblioteca de download do arquivo para usar CURL; Correção de erro SSL no download do site da Anatel; Correção de erro HTTP 100-Continue; Alteração para usar HTTPS ao invés de HTTP. 2017-09-30 Corrigido bug de parse no PHP 5.3; Incluído padronização para utilização em FreePBX Entendendo o arquivo CNL A base CNL pode ser baixada a qualquer momento através do link http://sistemas.anatel.gov.br/areaarea/N_Download/Tela.asp?varMod=Publico&amp;SISQSmodulo=7179 selecionando como tipo de arquivo Central CNL, tipo de central Fixo e sigla UF Todas conforme a imagem abaixo: Este processo realizará o download de um arquivo ZIP e detro deste conterá 2 arquivos: Um documento com o layout do arquivo texto, e o arquivo texto contendo a base de dados CNL completa. Abrindo o arquivo DOC temos o seguinte conteúdo [sourcecode language=&quot;text&quot;]----------------------------------------------------------- ANATEL - AGENCIA NACIONAL DE TELECOMUNICACOES LAY-OUT DO ARQUIVO CE_F_HHMMSS.TXT ----------------------------------------------------------- ID NOME DO CAMPO TIPO TAMANHO -- ---------------------------------- ---- ------- 01 Sigla UF char 02 02 Sigla CNL char 04 03 Codigo CNL char 05 04 Nome da Localidade char 50 05 Nome do Municipio char 50 06 Cod. da Area Tarifacao char 05 07 Prefixo char 07 08 Prestadora char 30 09 Num. da Faixa Inicial char 04 10 Num. da Faixa Final char 04 11 Latitude char 08 (*) 12 Hemisferio char 05 13 Longitude char 08 (*) 14 Sigla CNL da Área Local char 04 OBSERVAÇÕES: 1) Os campos marcados com (*), Latitude e Longitude foram alterados para o formato GGMMSSCC, onde: GG = Grau, MM = Minuto, SS = Segundo e CC = Centésimos de Segundo [/sourcecode] Agora abrindo o arquivo texto com a base CNL, extrai 3 linhas para exemplificar e ilustrar como poderemos identificar se devemos ou não colocar DDD em nossas ligações. As linhas são: [sourcecode language=&quot;text&quot;]PRCTA 41000CURITIBA CURITIBA 412 412027 Aerotech 0 999 25254692S 49161884CTA PRSJP 41585SÃO JOSÉ DOS PINHAIS SÃO JOSÉ DOS PINHAIS 412 412094 INTELIG TELECOM 0 999 25315268S 49121115CTA PRPNG 41464PARANAGUÁ PARANAGUÁ 414 412152 CLARO S.A. 0 999 25305796S 48312100PNG [/sourcecode] Para o nosso propósito vou extrair alguns trechos das nossas linhas conforme abaixo: Linha 1: Campo 05 (Município): Curitiba Campo 07 (Prefixo): 412027 Campo 15 (Sigla CNL da Área Local): CTA Linha 2: Campo 05 (Município): São José dos Pinhais Campo 07 (Prefixo): 412094 Campo 15 (Sigla CNL da Área Local): CTA Linha 3: Campo 05 (Município): Paranaguá Campo 07 (Prefixo): 412152 Campo 15 (Sigla CNL da Área Local): PNG Observem que as 3 linhas detêm no prefixo o mesmo DDD (41), porém Paranaguá detêm uma Sigla CNL da Área Local diferente de Curitiba e São José dos Pinhais, isso indica que qualquer ligação vinda de Curitiba para Paranaguá (ou vice versa) deve conter o DDD, ja entre Curitiba e São José dos Pinhais não se faz necessário a utilização do DDD. Sendo assim teremos que analisar não somente o DDD mas o prefixo completo para poder diagnosticar de que cidade é o número que desejamos discar. Pré-requisitos PHP cli v5.5.9 MySQL v5.5.47 Caso desje segue abaixo os comandos de instalação dos pré-requisitos MySQL v5.7 + PHP v.7.0 [sourcecode language=&quot;shell&quot;]sudo apt-get install mysql-client-5.7 mysql-server-5.7 sudo apt-get install php7.0-cli php7.0-mysql php7.0-zip php7.0-mbstring php7.0-xml [/sourcecode] Versões anteriores Caso deseje outra versão do MySQL utilize este procedimento (http://www.helviojunior.com.br/it/mysql/instalando-e-otimizando-mysql-para-alto-trafego-de-dados/) [sourcecode language=&quot;shell&quot;]sudo apt-get install php5-cli php5-mysql libxml2-dev [/sourcecode] Os scripts abaixo foram testados no Ubuntu 14.04 com PHP cli v5.5.9 e MySQL v5.5.47 bem como no Ubuntu 16.02 com PHP cli v7.0.4 e MySQL v5.7.12 &nbsp; Criando estrutura de base de dados e importação Agora que temos todo o conhecimento do arquivo da base vamos as operações técnicas. Desenvolvi um script PHP que realiza o Download, tratamento e importação dessas informações CNL para uma base de dados MySQL. Sendo assim o primeiro passo é criarmos as tabelas na base de dados no MySQL utilizando o script abaixo. Como o objetivo deste post não é ensinar como utilizar o MySQL entende-se que você detém este conhecimento e sabe como executar este script dentro da sua base de dados existente. [sourcecode language=&quot;sql&quot;]-- Criando estrutura para tabela cnl CREATE TABLE IF NOT EXISTS `cnl` ( `cod_cnl` int(11) NOT NULL, `cod_cnl_local` int(11) NOT NULL DEFAULT &#39;0&#39;, `sigla_cnl` varchar(5) NOT NULL, `uf` varchar(2) NOT NULL, `ddd` varchar(2) NOT NULL, `localidade` varchar(200) NOT NULL, `municipio` varchar(200) NOT NULL, PRIMARY KEY (`cod_cnl`), UNIQUE KEY `sigla_cnl` (`sigla_cnl`) )COLLATE=&#39;utf8_general_ci&#39;; -- Criando estrutura para tabela cnl_tarifacao CREATE TABLE IF NOT EXISTS `cnl_tarifacao` ( `cod_cnl` int(11) NOT NULL, `cod_area_tarifacao` varchar(5) NOT NULL, `ddd` varchar(2) NOT NULL, `prefixo` varchar(5) NOT NULL, `prestadora` varchar(60) NOT NULL, `faixa_inicial` int(11) NOT NULL, `faixa_final` int(11) NOT NULL, PRIMARY KEY (`cod_cnl`,`ddd`,`prefixo`,`faixa_inicial`,`faixa_final`), KEY `ddd_prefixo` (`ddd`,`prefixo`), CONSTRAINT `FK_cnl_tarifacao_cnl` FOREIGN KEY (`cod_cnl`) REFERENCES `cnl` (`cod_cnl`) ON DELETE CASCADE ON UPDATE CASCADE )COLLATE=&#39;utf8_general_ci&#39;; [/sourcecode] &nbsp; Agora que criamos as tabelas na base de dados vamos criar o script PHP que irá realizar o download e importação dos dados. Copie o conteúdo abaixo em um script PHP (em nosso exemplo colocarei em /usr/local/bin/importacnl.php). [sourcecode language=&quot;php&quot;]#!/usr/bin/php -q &lt;?php //-------------------------------------------------------------------+ // Autor : Helvio Junior (helvio_junior@hotmail.com) | // Data : 2016-06-02 | // Atualizado : 2017-09-30 | // Versão : 1.2 | // Finalidade : Realizar download e tratamento | // da base CNL para o MySQL | // | // Atualizacoes : * Incluido checagem da config do FreePBX | // * Corrigido BUG de parse do PHP 5.3 | //-------------------------------------------------------------------+ //================ &lt; Variaveis &gt; =================================== $dbhost=&#39;127.0.0.1&#39;; $dbname=&#39;cnldb&#39;; $dbuser=&#39;root&#39;; $dbpass=&#39;cnlpwd&#39;; $freepbx_configfile=&#39;/etc/amportal.conf&#39;; //================ &lt; Funções &gt; =================================== // Funcao utilizada em caso do servidor ser um FreePBX, para carregas as configs do mesmo function parse_amportal_conf($filename) { $conf = array(); /* defaults * This defines defaults and formatting to assure consistency across the system so that * components don&#39;t have to keep being &#39;gun shy&#39; about these variables. * * we will read these settings out of the db, but only when $filename is writeable * otherwise, we read the $filename */ // If conf file is not writable, then we use it as the master so parse it. $file = file($filename); if (is_array($file)) { $write_back = false; foreach ($file as $line) { if (preg_match(&quot;/^\s*([a-zA-Z0-9_]+)=([a-zA-Z0-9 .&amp;-@=_!&lt;&gt;\&quot;\&#39;]+)\s*$/&quot;,$line,$matches)) { // overrite anything that was initialized from the db with the conf file authoritative source // if different from the db value then let&#39;s write it back to the db // TODO: massage any data we read from the conf file with _preapre_conf_value since it is // written back to the DB here if different from the DB. // if (!isset($conf[$matches[1]]) || $conf[$matches[1]] != $matches[2]) { $conf[$matches[1]] = $matches[2]; } } } } else { die_freepbx(sprintf(_(&quot;Missing or unreadable config file [%s]...cannot continue&quot;), $filename)); } // Need to handle transitionary period where modules are adding new settings. So once we parsed the file // we still go read from the database and add anything that isn&#39;t there from the conf file. // $convert = array( &#39;astetcdir&#39; =&gt; &#39;ASTETCDIR&#39;, &#39;astmoddir&#39; =&gt; &#39;ASTMODDIR&#39;, &#39;astvarlibdir&#39; =&gt; &#39;ASTVARLIBDIR&#39;, &#39;astagidir&#39; =&gt; &#39;ASTAGIDIR&#39;, &#39;astspooldir&#39; =&gt; &#39;ASTSPOOLDIR&#39;, &#39;astrundir&#39; =&gt; &#39;ASTRUNDIR&#39;, &#39;astlogdir&#39; =&gt; &#39;ASTLOGDIR&#39; ); $file = file($conf[&#39;ASTETCDIR&#39;].&#39;/asterisk.conf&#39;); foreach ($file as $line) { if (preg_match(&quot;/^\s*([a-zA-Z0-9]+)\s* =&gt; \s*(.*)\s*([;#].*)?/&quot;,$line,$matches)) { $this-&gt;asterisk_conf[ $matches[1] ] = rtrim($matches[2],&quot;/ \t&quot;); } } // Now that we parsed asterisk.conf, we need to make sure $amp_conf is consistent // so just set it to what we found, since this is what asterisk will use anyhow. // foreach ($convert as $ast_conf_key =&gt; $amp_conf_key) { if (isset($conf[$ast_conf_key])) { $conf[$amp_conf_key] = $this-&gt;asterisk_conf[$ast_conf_key]; } } return $conf; } //Função responsável por realizar o explode da linha em uma array function pc_fixed_width_substr($fields,$data) { $r = array(); $line_pos = 0; foreach($fields as $field_name =&gt; $field_length) { //Identifica se os primeiros caracteres são espaço $tmp_data = substr($data,$line_pos,$field_length); if (strlen($tmp_data) != strlen(ltrim($tmp_data))) $line_pos += strlen($tmp_data) - strlen(ltrim($tmp_data)); $r[$field_name] = utf8_encode(trim(substr($data,$line_pos,$field_length))); $line_pos += $field_length; } return $r; } //Em caso do servidor ser um FreePbx, carrega as informações do DB com base na config do FreePBX if (file_exists($freepbx_configfile)){} $amp_conf = parse_amportal_conf($freepbx_configfile); $dbhost=$amp_conf[&#39;AMPDBHOST&#39;]; $dbname=$amp_conf[&#39;AMPDBNAME&#39;]; $dbuser=$amp_conf[&#39;AMPDBUSER&#39;]; $dbpass=$amp_conf[&#39;AMPDBPASS&#39;]; } //================ &lt; Inicio &gt; ===================================== $info = pathinfo(__FILE__); openlog($info[&#39;basename&#39;], LOG_PID | LOG_PERROR, LOG_LOCAL0); date_default_timezone_set(&#39;America/Sao_Paulo&#39;); //Cria a conexão com a base de dados $conn = new PDO(&quot;mysql:host=$dbhost;dbname=$dbname;charset=utf8&quot;, $dbuser, $dbpass); $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION); //Realiza o download do arquivo da Anatel echo &quot;Realizando download do arquivo (Telefone Fixo)...\n&quot;; $filename=&#39;/tmp/anatel-&#39;.date(&quot;YmdHis&quot;).&#39;.zip&#39;; $filename2=&#39;/tmp/anatel-&#39;.date(&quot;YmdHis&quot;).&#39;.txt&#39;; $filename3=&#39;/tmp/anatel-&#39;.date(&quot;YmdHis&quot;).&#39;-converted.txt&#39;; $options = array( CURLOPT_RETURNTRANSFER =&gt; true, // return web page CURLOPT_HEADER =&gt; false, // do not return headers CURLOPT_FOLLOWLOCATION =&gt; true, // follow redirects CURLOPT_USERAGENT =&gt; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:53.0) Gecko/20100101 Firefox/53.0&quot;, // who am i CURLOPT_AUTOREFERER =&gt; true, // set referer on redirect CURLOPT_CONNECTTIMEOUT =&gt; 120, // timeout on connect CURLOPT_TIMEOUT =&gt; 120, // timeout on response CURLOPT_MAXREDIRS =&gt; 10, // stop after 10 redirects CURLOPT_POST =&gt; true, // POST CURLOPT_SSL_VERIFYHOST =&gt; false, CURLOPT_SSL_VERIFYPEER =&gt; false, CURLOPT_URL =&gt; &#39;https://sistemas.anatel.gov.br/areaarea/N_Download/Tela.asp&#39;, CURLOPT_POSTFIELDS =&gt; &#39;varTIPO=CentralCNL&amp;varPRESTADORA=&amp;varCENTRAL=F&amp;varUF=&amp;varPERIODO=&amp;acao=c&amp;cmd=&amp;varMOD=Publico&#39;, CURLOPT_HTTPHEADER =&gt; array( &#39;Content-type: application/x-www-form-urlencoded&#39;, &#39;Expect:&#39; ) ); $ch = curl_init( ); curl_setopt_array( $ch, $options ); $content = curl_exec( $ch ); $err = curl_errno( $ch ); $errmsg = curl_error( $ch ); curl_close( $ch ); $zipFile = fopen($filename, &quot;w&quot;) or die(&quot;Unable to open file!&quot;); fwrite($zipFile, $content); fclose($zipFile); if (!file_exists($filename)) die(&quot;Erro realizando download do arquivo&quot;); //Descompacta o arquivo texto com os dados echo &quot;Descompactando arquivo...\n&quot;; $zip = new ZipArchive; if ($zip-&gt;open($filename) === true) { for($i = 0; $i &lt; $zip-&gt;numFiles; $i++) { $file = $zip-&gt;getNameIndex($i); $fileinfo = pathinfo($file); if (strcasecmp($fileinfo[&#39;extension&#39;], &quot;txt&quot;) == 0) { copy(&quot;zip://&quot;.$filename.&quot;#&quot;.$file, $filename2); } } $zip-&gt;close(); } //Processa o arquivo if (!file_exists($filename2)) die(&quot;Erro descompactando o arquivo&quot;); $fields = array(&#39;uf&#39; =&gt; 2, &#39;sigla_cnl&#39; =&gt; 4, &#39;cod_cnl&#39; =&gt; 5, &#39;localidade&#39; =&gt; 50, &#39;municipio&#39; =&gt; 50, &#39;cod_area_tarifacao&#39; =&gt; 5, &#39;ddd&#39; =&gt; 2, &#39;prefixo&#39; =&gt; 5, &#39;prestadora&#39; =&gt; 30, &#39;faixa_inicial&#39; =&gt; 4, &#39;faixa_final&#39; =&gt; 4, &#39;latitude&#39; =&gt; 8, &#39;hemisferio&#39; =&gt; 5, &#39;longitude&#39; =&gt; 8, &#39;cnl_local&#39; =&gt; 4); //Converte o arquivo echo &quot;Convertendo arquivo...\n&quot;; exec(&quot;iconv -f iso-8859-1 -t UTF-8 $filename2 | sed &#39;y/áÁàÀãÃâÂéÉêÊíÍóÓõÕôÔúÚçÇ/aAaAaAaAeEeEiIoOoOoOuUcC/&#39; &gt; $filename3&quot;); //Processa o arquivo if (!file_exists($filename3)) die(&quot;Erro convertendo o arquivo&quot;); //Realiza a primeira leitura do arquivo, para cadastrar todos os CNLs //Depois realizará uma segunda leitura para cadastrar as tarifas //Isso é necessário pois na tarida existe vínculo com o CNL da área echo &quot;Inserindo CNL...\n&quot;; $handle = fopen($filename3, &quot;r&quot;); if ($handle) { while (($line = fgets($handle)) !== false) { //$line = trim(mb_convert_encoding($line, &quot;UTF-8&quot;, &quot;Windows-1252&quot;)); $line = trim($line); $data = pc_fixed_width_substr($fields,$line); //Executa a inserção try{ $stmt = $conn-&gt;prepare( &quot;INSERT INTO cnl (`cod_cnl`, `sigla_cnl`, `uf`, `ddd`, `localidade`, `municipio`) VALUES(:cod_cnl, :sigla_cnl, :uf, :ddd, :localidade, :municipio) ON DUPLICATE KEY UPDATE uf=VALUES(uf), ddd=VALUES(ddd), localidade=VALUES(localidade), municipio=VALUES(municipio)&quot; ); $stmt-&gt;bindValue(&#39;:cod_cnl&#39;, $data[&#39;cod_cnl&#39;]); $stmt-&gt;bindValue(&#39;:sigla_cnl&#39;, $data[&#39;sigla_cnl&#39;]); $stmt-&gt;bindValue(&#39;:uf&#39;, $data[&#39;uf&#39;]); $stmt-&gt;bindValue(&#39;:ddd&#39;, $data[&#39;ddd&#39;]); $stmt-&gt;bindValue(&#39;:localidade&#39;, $data[&#39;localidade&#39;]); $stmt-&gt;bindValue(&#39;:municipio&#39;, $data[&#39;municipio&#39;]); $stmt-&gt;execute(); $stmt = $conn-&gt;prepare( &quot;INSERT INTO cnl_tarifacao (`cod_cnl`, `cod_area_tarifacao`, `ddd`, `prefixo`, `prestadora`, `faixa_inicial`, `faixa_final`) VALUES(:cod_cnl, :cod_area_tarifacao, :ddd, :prefixo, :prestadora, :faixa_inicial, :faixa_final) ON DUPLICATE KEY UPDATE cod_area_tarifacao=VALUES(cod_area_tarifacao),prestadora=VALUES(prestadora)&quot; ); $stmt-&gt;bindValue(&#39;:cod_cnl&#39;, $data[&#39;cod_cnl&#39;]); $stmt-&gt;bindValue(&#39;:cod_area_tarifacao&#39;, $data[&#39;cod_area_tarifacao&#39;]); $stmt-&gt;bindValue(&#39;:ddd&#39;, $data[&#39;ddd&#39;]); $stmt-&gt;bindValue(&#39;:prefixo&#39;, $data[&#39;prefixo&#39;]); $stmt-&gt;bindValue(&#39;:prestadora&#39;, substr($data[&#39;prestadora&#39;],0,50)); $stmt-&gt;bindValue(&#39;:faixa_inicial&#39;, intval($data[&#39;faixa_inicial&#39;])); $stmt-&gt;bindValue(&#39;:faixa_final&#39;, intval($data[&#39;faixa_final&#39;])); $stmt-&gt;execute(); } catch (Exception $ex) { syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); $debug = var_export($data, true); syslog(LOG_SYSLOG, $debug); die(&quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); } if (empty($data[&#39;ddd&#39;])){ var_dump($line); var_dump($data); die(); } } fclose($handle); } else { syslog(LOG_SYSLOG,&quot;Erro abrindo o arquivo&quot;); die(&quot;Erro abrindo o arquivo&quot;); } //Realiza a releitura do arquivo //Para atualizar a hierarquia de CNL echo &quot;Atualizando hierarquia de CNL, Passo 1...\n&quot;; $handle = fopen($filename3, &quot;r&quot;); if ($handle) { while (($line = fgets($handle)) !== false) { //$line = trim(mb_convert_encoding($line, &quot;UTF-8&quot;, &quot;Windows-1252&quot;)); $line = trim($line); $data = pc_fixed_width_substr($fields,$line); $cod_cnl_local = -1; //Resgata o cód da CNL local //Em diversos casos a informação &#39;CNL local&#39; vem em branco //estes casos serão tratados no passo 2 if (!empty($data[&#39;cnl_local&#39;])) { $stmt = $conn-&gt;prepare(&#39;SELECT cod_cnl from cnl WHERE sigla_cnl = :sigla_cnl&#39;); $stmt-&gt;bindValue(&#39;:sigla_cnl&#39;, $data[&#39;cnl_local&#39;]); $stmt-&gt;execute(); if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){ $cod_cnl_local = $row[&quot;cod_cnl&quot;]; } } if ($cod_cnl_local != -1){ try{ $stmt = $conn-&gt;prepare( &quot;UPDATE cnl SET cod_cnl_local = :cod_cnl_local where cod_cnl = :cod_cnl&quot; ); $stmt-&gt;bindValue(&#39;:cod_cnl&#39;, $data[&#39;cod_cnl&#39;]); $stmt-&gt;bindValue(&#39;:cod_cnl_local&#39;, $cod_cnl_local); $stmt-&gt;execute(); } catch (Exception $ex) { syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); $debug = var_export($data, true); syslog(LOG_SYSLOG, $debug); die(&quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); } } } fclose($handle); } else { syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); die(&quot;Erro abrindo o arquivo&quot;); } //Realiza a releitura do arquivo //Para atualizar a hierarquia de CNL echo &quot;Atualizando hierarquia de CNL, Passo 2...\n&quot;; try{ $stmt = $conn-&gt;prepare( &quot;select * from cnl where cod_cnl_local = 0&quot; ); $stmt-&gt;execute(); while ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)) { $cod_cnl_local = -1; $track = &quot;&quot;; $ddd = $row[&#39;ddd&#39;]; //Resgata o cód da CNL local //Em diversos casos a informação &#39;CNL local&#39; vem em branco //Nestes casos verificar qual é a CNL mais expressiva a partir do DDD e usa-la if (!empty($data[&#39;cnl_local&#39;])) continue; //Em diversos casos a informação &#39;CNL local&#39; vem em branco //Nestes casos verificar qual é a CNL mais expressiva a partir do DDD e usa-la $track = &quot;$track cnl = -1\n&quot;; $s1 = $conn-&gt;prepare(&#39;select * ,(select count(*) from cnl c1 where c1.cod_cnl_local = c.cod_cnl) as `chields` from cnl c where c.cod_cnl != c.cod_cnl_local and ddd = :ddd order by c.ddd, 8 desc limit 1&#39;); $s1-&gt;bindValue(&#39;:ddd&#39;, $ddd); $s1-&gt;execute(); $debug = var_export($s1, true); $track = &quot;$track $debug\n&quot;; $track = &quot;$track :ddd = $ddd\n&quot;; $r1 = $s1-&gt;fetch(PDO::FETCH_ASSOC); $debug = var_export($r1, true); $track = &quot;$track $debug\n&quot;; if ($r1){ $cod_cnl_local = $r1[&quot;cod_cnl&quot;]; $track = &quot;$track cod_cnl = $cod_cnl_local\n&quot;; } if ($cod_cnl_local != -1){ try{ $s1 = $conn-&gt;prepare( &quot;UPDATE cnl SET cod_cnl_local = :cod_cnl_local where cod_cnl = :cod_cnl&quot; ); $s1-&gt;bindValue(&#39;:cod_cnl&#39;, $row[&#39;cod_cnl&#39;]); $s1-&gt;bindValue(&#39;:cod_cnl_local&#39;, $cod_cnl_local); $s1-&gt;execute(); } catch (Exception $ex) { syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); $debug = var_export($row, true); syslog(LOG_SYSLOG, $debug); die(&quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); } }else{ $debug = var_export($row, true); syslog(LOG_SYSLOG, &quot;CNL Local não identificado: $track $debug&quot;); } } } catch (Exception $ex) { syslog(LOG_SYSLOG, &quot;Erro processando: &quot;. $ex-&gt;getMessage()); die(); } //Exclui os arquivos echo &quot;Excluindo arquivos temporários...\n&quot;; unlink($filename3); unlink($filename2); unlink($filename); closelog(); //================ &lt; Fim &gt;==================================== [/sourcecode] Edite as variáveis ($dbhost, $dbname, $dbuser e $dbpass) para representar as informações do seu ambiente. Execute o comando abaixo para liberar execução deste arquivo. Obs.: Em caso de utilização no FreePBX, não se faz necessário editar as variáveis ($dbhost, $dbname, $dbuser e $dbpass), pois o script resgata essas informações automaticamente da configuração do seu FreePBX. [sourcecode language=&quot;shell&quot;] chmod +x /usr/local/bin/importacnl.php [/sourcecode] Por fim execute o script para realizar a importação. E aproveite para dar uma navegada em outros posts aqui do site, curta, compartilhe, ou quem sabe vá tomar um café, energético, suco, ler um livro, pois este processo deve demorar alguns minutos para executar. O interessante é colocar este script para executar uma vez por semana (usando crontab), para manter essa base sempre atualizada. &nbsp; Configurando o asterisk *** ATENÇÃO!!! Em caso de utilização em FreePBX, recomendo utilizar o script específico para ele que se encontra mais abaixo neste post. Enfim chegamos ao asterisk, nesta sessão iremos criar o nosso script AGI bem como configurar nosso plano de discagem do asterisk para consultar essa base de dados e decidir se devemos ou não inserir o DDD nas ligações. Para nosso script AGI utilizaremos a biblioteca PHPAGI disponível em (http://phpagi.sourceforge.net/), mas pode ficar despreocupado colocarei aqui um arquivo zip com todo o conteúdo do AGI + a biblioteca phpagi. Crie um arquivo /var/lib/asterisk/agi-bin/consultacnl.php com o conteúdo abaixo [sourcecode language=&quot;shell&quot;]#!/usr/bin/php -q &lt;?php //-----------------------------------------------------------------+ // Autor : Helvio Junior (helvio_junior@hotmail.com) | // Data : 2016-06-02 | // Versão : 1.0 | // Finalidade : Consulta a base CNL | //-----------------------------------------------------------------+ //================ &lt; Includes &gt; =================================== require_once __DIR__.&#39;/phpagi-2.20/phpagi.php&#39;; //================ &lt; Variaveis &gt; =================================== $dbhost=&#39;127.0.0.1&#39;; $dbname=&#39;cnldb&#39;; $dbuser=&#39;cnluser&#39;; $dbpass=&#39;cnlpwd&#39;; //================ &lt; Inicio &gt; ===================================== $agi = new AGI(); $exten = &#39;&#39;; $uniqueId = $agi-&gt;request[&#39;agi_uniqueid&#39;]; if ((isset($agi-&gt;request[&#39;agi_extension&#39;])) &amp;&amp; ($agi-&gt;request[&#39;agi_extension&#39;] != &#39;&#39;)) $exten = $agi-&gt;request[&#39;agi_extension&#39;]; if (empty($uniqueId) || empty($exten)) { $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;Exten não fornecidos&quot; 3&#39;); die(); } try{ $ddd=substr($exten,0,2); $prefixo=substr($exten,2,4); $sufixo=substr($exten,6,4); $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;Consultando CNL para &#39;.$exten.&#39; (&#39;.$ddd.&#39;) &#39;.$prefixo.&#39;-&#39;.$sufixo.&#39;&quot; 4&#39;); //Cria a conexão com a base de dados $conn = new PDO(&quot;mysql:host=$dbhost;dbname=$dbname;charset=utf8&quot;, $dbuser, $dbpass); $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION); $stmt = $conn-&gt;prepare(&#39;select p.* from cnl c inner join cnl_tarifacao t on c.cod_cnl = t.cod_cnl inner join cnl p on c.cod_cnl_local = p.cod_cnl where t.ddd = :ddd and t.prefixo = :prefixo and :sufixo between t.faixa_inicial and t.faixa_final&#39;); $stmt-&gt;bindValue(&#39;:ddd&#39;, $ddd); $stmt-&gt;bindValue(&#39;:prefixo&#39;, $prefixo); $stmt-&gt;bindValue(&#39;:sufixo&#39;, $sufixo); $stmt-&gt;execute(); $cnl=&quot;&quot;; if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){ $cnl = $row[&quot;sigla_cnl&quot;]; $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;CNL encontrado para &#39;.$exten.&#39; -&gt; &#39;.$cnl.&#39;&quot; 4&#39;); } //Define o cnl $agi-&gt;exec(&#39;SET&#39;,&quot;cnl=$cnl&quot;); return 0; } catch (Exception $e) { $agi-&gt;exec(&quot;NOOP&quot;, &#39;&quot;&#39;.$e-&gt;getMessage().&#39;&quot;&#39;); } [/sourcecode] Igualmente ao script anterior edite as variáveis ($dbhost, $dbname, $dbuser e $dbpass) para representar as informações do seu ambiente. Ajuste a permissão de execução do seu script [sourcecode language=&quot;shell&quot;] chmod +x /var/lib/asterisk/agi-bin/consultacnl.php [/sourcecode] No arquivo /etc/asterisk/extensions.conf edite o seu contexto da ligação conforme o exemplo abaixo [sourcecode language=&quot;shell&quot;][trunk_out] ; Local exten = _XXXXXXXX,1,Goto(041${EXTEN},1) ; LDN exten = _0ZZ[2-6]XXXXXXX,1,Goto(${EXTEN:1},1) exten = _0ZZ[2-6]XXXXXXXX,1,Goto(${EXTEN:1},1) ;Normalizado exten = _ZZXXXXXXX.,1,AGI(consultacnl.php) exten = _ZZXXXXXXX.,n,ExecIf($[&quot;${cnl}&quot; = &quot;CTA&quot;]?Set(number=${EXTEN:2})) exten = _ZZXXXXXXX.,n,Dial(SIP/trunk_sip/${number},90,TtXx) [/sourcecode] Lembrando que neste exemplo considero como origem da ligação o DDD 41 e CNL CTA. &nbsp; Configurando o FreePBX *** ATENÇÃO!!! Este script foi desenvolvido para utilização no padrão do FreePBX, em caso de utilização em outra plataforma, pode ser necessário realização de alterações. Enfim chegamos ao FreePBX, nesta sessão iremos criar o nosso script AGI bem como configurar nosso plano de discagem do FreePBX para consultar essa base de dados e decidir se devemos ou não inserir/excluir o DDD nas ligações. Para nosso script AGI utilizaremos a biblioteca PHPAGI disponível em (http://phpagi.sourceforge.net/), mas pode ficar despreocupado colocarei aqui um arquivo zip com todo o conteúdo do AGI + a biblioteca phpagi. Crie um arquivo /var/lib/asterisk/agi-bin/alteracnl.php com o conteúdo abaixo [sourcecode language=&quot;shell&quot;]#!/usr/bin/php -q &lt;?php //--------------------------------------------------------------------+ // Autor : Helvio Junior (helvio_junior@hotmail.com) | // Data : 2016-06-02 | // Atualizado : 2017-09-30 | // Versão : 1.2 | // Finalidade : Consulta a base CNL e corrige o numero para FreePBX | // *** Utilizar este script preferencialmente no FreePBX | //--------------------------------------------------------------------+ //================ &lt; Includes &gt; =================================== require_once __DIR__.&#39;/phpagi-2.20/phpagi.php&#39;; //================ &lt; Variaveis &gt; =================================== $configfile=&#39;/etc/amportal.conf&#39;; //================ &lt; Funções &gt; =================================== function parse_amportal_conf($filename) { $conf = array(); /* defaults * This defines defaults and formatting to assure consistency across the system so that * components don&#39;t have to keep being &#39;gun shy&#39; about these variables. * * we will read these settings out of the db, but only when $filename is writeable * otherwise, we read the $filename */ // If conf file is not writable, then we use it as the master so parse it. $file = file($filename); if (is_array($file)) { $write_back = false; foreach ($file as $line) { if (preg_match(&quot;/^\s*([a-zA-Z0-9_]+)=([a-zA-Z0-9 .&amp;-@=_!&lt;&gt;\&quot;\&#39;]+)\s*$/&quot;,$line,$matches)) { // overrite anything that was initialized from the db with the conf file authoritative source // if different from the db value then let&#39;s write it back to the db // TODO: massage any data we read from the conf file with _preapre_conf_value since it is // written back to the DB here if different from the DB. // if (!isset($conf[$matches[1]]) || $conf[$matches[1]] != $matches[2]) { $conf[$matches[1]] = $matches[2]; } } } } else { die_freepbx(sprintf(_(&quot;Missing or unreadable config file [%s]...cannot continue&quot;), $filename)); } // Need to handle transitionary period where modules are adding new settings. So once we parsed the file // we still go read from the database and add anything that isn&#39;t there from the conf file. // $convert = array( &#39;astetcdir&#39; =&gt; &#39;ASTETCDIR&#39;, &#39;astmoddir&#39; =&gt; &#39;ASTMODDIR&#39;, &#39;astvarlibdir&#39; =&gt; &#39;ASTVARLIBDIR&#39;, &#39;astagidir&#39; =&gt; &#39;ASTAGIDIR&#39;, &#39;astspooldir&#39; =&gt; &#39;ASTSPOOLDIR&#39;, &#39;astrundir&#39; =&gt; &#39;ASTRUNDIR&#39;, &#39;astlogdir&#39; =&gt; &#39;ASTLOGDIR&#39; ); $file = file($conf[&#39;ASTETCDIR&#39;].&#39;/asterisk.conf&#39;); foreach ($file as $line) { if (preg_match(&quot;/^\s*([a-zA-Z0-9]+)\s* =&gt; \s*(.*)\s*([;#].*)?/&quot;,$line,$matches)) { $this-&gt;asterisk_conf[ $matches[1] ] = rtrim($matches[2],&quot;/ \t&quot;); } } // Now that we parsed asterisk.conf, we need to make sure $amp_conf is consistent // so just set it to what we found, since this is what asterisk will use anyhow. // foreach ($convert as $ast_conf_key =&gt; $amp_conf_key) { if (isset($conf[$ast_conf_key])) { $conf[$amp_conf_key] = $this-&gt;asterisk_conf[$ast_conf_key]; } } return $conf; } //Carrega as informações do DB com base na config do FrePBX $amp_conf = parse_amportal_conf($configfile); $dbhost=$amp_conf[&#39;AMPDBHOST&#39;]; $dbname=$amp_conf[&#39;AMPDBNAME&#39;]; $dbuser=$amp_conf[&#39;AMPDBUSER&#39;]; $dbpass=$amp_conf[&#39;AMPDBPASS&#39;]; //================ &lt; Inicio &gt; ===================================== $agi = new AGI(); $dialnumber = &#39;&#39;; $uniqueId = $agi-&gt;request[&#39;agi_uniqueid&#39;]; $dialnumber = &#39;&#39;; $cnllocal = &#39;&#39;; $tmp = $agi-&gt;get_variable(&quot;OUTNUM&quot;); if (isset($tmp[&#39;data&#39;]) &amp;&amp; !empty($tmp[&#39;data&#39;])){ $dialnumber = $tmp[&#39;data&#39;]; } $tmp = $agi-&gt;get_variable(&quot;agi_arg_1&quot;); if (isset($agi-&gt;request[&#39;agi_arg_1&#39;]) &amp;&amp; !empty($agi-&gt;request[&#39;agi_arg_1&#39;])){ $cnllocal = $agi-&gt;request[&#39;agi_arg_1&#39;]; } if (empty($uniqueId) || empty($dialnumber) || empty($cnllocal)) { $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;DialNumber e CNL Local não fornecidos&quot; 3&#39;); die(); } try{ //Cria a conexão com a base de dados $conn = new PDO(&quot;mysql:host=$dbhost;dbname=$dbname;charset=utf8&quot;, $dbuser, $dbpass); $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION); //Em caso do numero discado ter 8 digitos //Inclui o DDD da mesma CNL do usuário, para posteriormente checar se os numeros fazem parte da mesma CNL //Pois o usuário intuitivamente não digita o numero com DDD quando é o mesmo DDD que ele faz parte if (strlen($dialnumber) == 8){ $stmt = $conn-&gt;prepare(&#39;select c.* from cnl c where c.sigla_cnl = :sigla_cnl&#39;); $stmt-&gt;bindValue(&#39;:sigla_cnl&#39;, $cnllocal); $stmt-&gt;execute(); if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){ $ddd = $row[&quot;ddd&quot;]; $old = $dialnumber; $dialnumber = $ddd . $dialnumber; $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;Numero com 8 digitos. Incluindo DDD para consulta. Old: &#39;.$old.&#39; New: &#39;.$dialnumber.&#39;&quot; 4&#39;); $agi-&gt;exec(&#39;SET&#39;,&#39;OUTNUM=0&#39;.$dialnumber); $agi-&gt;exec(&#39;SET&#39;,&#39;DIAL_NUMBER=0&#39;.$dialnumber); } } //Remove o &quot;zero&quot; como primeiro digito, caso seja if (substr($dialnumber,0,1) == &#39;0&#39;) $dialnumber = substr($dialnumber,1); $ddd=substr($dialnumber,0,2); $prefixo=substr($dialnumber,2,4); $sufixo=substr($dialnumber,6,4); $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;Consultando CNL para &#39;.$dialnumber.&#39; (&#39;.$ddd.&#39;) &#39;.$prefixo.&#39;-&#39;.$sufixo.&#39;&quot; 4&#39;); $stmt = $conn-&gt;prepare(&#39;select p.* from cnl c inner join cnl_tarifacao t on c.cod_cnl = t.cod_cnl inner join cnl p on c.cod_cnl_local = p.cod_cnl where t.ddd = :ddd and t.prefixo = :prefixo and :sufixo between t.faixa_inicial and t.faixa_final&#39;); $stmt-&gt;bindValue(&#39;:ddd&#39;, $ddd); $stmt-&gt;bindValue(&#39;:prefixo&#39;, $prefixo); $stmt-&gt;bindValue(&#39;:sufixo&#39;, $sufixo); $stmt-&gt;execute(); $cnl=&quot;&quot;; if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){ $cnl = $row[&quot;sigla_cnl&quot;]; $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;CNL encontrado para &#39;.$dialnumber.&#39; -&gt; &#39;.$cnl.&#39;&quot; 4&#39;); } //Caso seja o mesmo CNL, remove o DDD do número a ser discado if ($cnllocal == $cnl){ $agi-&gt;exec(&#39;SET&#39;,&#39;OUTNUM=&#39;.$prefixo.$sufixo); $agi-&gt;exec(&#39;SET&#39;,&#39;DIAL_NUMBER=&#39;.$prefixo.$sufixo); } return 0; } catch (Exception $e) { $agi-&gt;exec(&quot;NOOP&quot;, &#39;&quot;&#39;.$e-&gt;getMessage().&#39;&quot;&#39;); } [/sourcecode] Neste script não se faz necessário alterar as variáveis ($dbhost, $dbname, $dbuser e $dbpass) pois o script pega as informações da configuração do seu FreePBX. Ajuste a permissão de execução do seu script [sourcecode language=&quot;shell&quot;] chmod +x /var/lib/asterisk/agi-bin/alteracnl.php [/sourcecode] No arquivo /etc/asterisk/extensions_custom.conf edite o seu contexto da ligação conforme o exemplo abaixo [sourcecode language=&quot;shell&quot;][macro-dialout-trunk-predial-hook] exten =&gt; s,1,Agi(alteracnl.php,CTA) [/sourcecode] Lembrando que neste exemplo considero como origem da ligação o DDD 41 e CNL CTA. &nbsp; Considerações finais Segue o link (CNL) para download do zip com todos os arquivos deste ambiente. Espero ter ajudado. Caso tenha dúvidas, sugestões fique a vontade para comentar, mandar e-mail e etc..." /><meta property="og:description" content="Introdução e contextualização Antes de qualquer coisa vamos direto ao problema que pretendemos resolver neste post. O sistema de telefonia fixa no Brasil adota um padrão de separação das localidades e uma subordinação político-administrativa (isso será explicado um pouco mais a frente com mais detalhes). Basicamente com essa separação poderemos ter 2 municípios com o mesmo DDD onde para realizar ligações um deles não é necessário adicionar o código de DDD, e para outro sim. Exemplo: Moro na cidade de Curitiba (cujo DDD é 41), temos diversos municípios de Curitiba e região metropolitana como Curitiba, Lapa, São José dos Pinhais, Colombo e etc... Quando em Curitiba não necessito utilizar o DDD para efetuar uma ligação a estes municípios, porém quando ligamos para Paranaguá, uma cidade a +- 100 Km de Curitiba, que utiliza o mesmo DDD, ja é necessário utilizar o DDD para realizar ligações. Sendo assim surge o nosso problema, se o DDD não é quem difere se devo ou não colocar o DDD ao realizar uma chamada, como podemos realizar essa distinção? A resposta esta na base de dados CNL. Mas ai surge a pergunta o que é CNL? CNL é o acronimo de &quot;Cadastro Nacional de Localidades&quot;, que tem como definição legal no Inciso III do art. 3º do anexo da Resolução da Anatel nº 83, de 30/12/1998 como &quot;Conjunto de informações relativo às disponibilidades de serviços de telecomunicações em localidades do território nacional.&quot;. Na pratica o Cadastro de Localidades Brasileira, fornece os nomes, a subordinação político-administrativa (a que grande região, estado, meso ou microrregião pertencem), as coordenadas (latitudes e longitudes) e altitudes médias das sedes de localidades como municípios, vilas, assentamentos rurais e aldeias indígenas, entre outras. Agora que conhecemos um pouco mais da estruturação da telefonia podemos entrar no detalhamento da base de dados CNL, para posteriormente entender como poderemos distinguir se nossa ligação deve ou não utilizar DDD. Atualizações 2017-05-15 Alteração da biblioteca de download do arquivo para usar CURL; Correção de erro SSL no download do site da Anatel; Correção de erro HTTP 100-Continue; Alteração para usar HTTPS ao invés de HTTP. 2017-09-30 Corrigido bug de parse no PHP 5.3; Incluído padronização para utilização em FreePBX Entendendo o arquivo CNL A base CNL pode ser baixada a qualquer momento através do link http://sistemas.anatel.gov.br/areaarea/N_Download/Tela.asp?varMod=Publico&amp;SISQSmodulo=7179 selecionando como tipo de arquivo Central CNL, tipo de central Fixo e sigla UF Todas conforme a imagem abaixo: Este processo realizará o download de um arquivo ZIP e detro deste conterá 2 arquivos: Um documento com o layout do arquivo texto, e o arquivo texto contendo a base de dados CNL completa. Abrindo o arquivo DOC temos o seguinte conteúdo [sourcecode language=&quot;text&quot;]----------------------------------------------------------- ANATEL - AGENCIA NACIONAL DE TELECOMUNICACOES LAY-OUT DO ARQUIVO CE_F_HHMMSS.TXT ----------------------------------------------------------- ID NOME DO CAMPO TIPO TAMANHO -- ---------------------------------- ---- ------- 01 Sigla UF char 02 02 Sigla CNL char 04 03 Codigo CNL char 05 04 Nome da Localidade char 50 05 Nome do Municipio char 50 06 Cod. da Area Tarifacao char 05 07 Prefixo char 07 08 Prestadora char 30 09 Num. da Faixa Inicial char 04 10 Num. da Faixa Final char 04 11 Latitude char 08 (*) 12 Hemisferio char 05 13 Longitude char 08 (*) 14 Sigla CNL da Área Local char 04 OBSERVAÇÕES: 1) Os campos marcados com (*), Latitude e Longitude foram alterados para o formato GGMMSSCC, onde: GG = Grau, MM = Minuto, SS = Segundo e CC = Centésimos de Segundo [/sourcecode] Agora abrindo o arquivo texto com a base CNL, extrai 3 linhas para exemplificar e ilustrar como poderemos identificar se devemos ou não colocar DDD em nossas ligações. As linhas são: [sourcecode language=&quot;text&quot;]PRCTA 41000CURITIBA CURITIBA 412 412027 Aerotech 0 999 25254692S 49161884CTA PRSJP 41585SÃO JOSÉ DOS PINHAIS SÃO JOSÉ DOS PINHAIS 412 412094 INTELIG TELECOM 0 999 25315268S 49121115CTA PRPNG 41464PARANAGUÁ PARANAGUÁ 414 412152 CLARO S.A. 0 999 25305796S 48312100PNG [/sourcecode] Para o nosso propósito vou extrair alguns trechos das nossas linhas conforme abaixo: Linha 1: Campo 05 (Município): Curitiba Campo 07 (Prefixo): 412027 Campo 15 (Sigla CNL da Área Local): CTA Linha 2: Campo 05 (Município): São José dos Pinhais Campo 07 (Prefixo): 412094 Campo 15 (Sigla CNL da Área Local): CTA Linha 3: Campo 05 (Município): Paranaguá Campo 07 (Prefixo): 412152 Campo 15 (Sigla CNL da Área Local): PNG Observem que as 3 linhas detêm no prefixo o mesmo DDD (41), porém Paranaguá detêm uma Sigla CNL da Área Local diferente de Curitiba e São José dos Pinhais, isso indica que qualquer ligação vinda de Curitiba para Paranaguá (ou vice versa) deve conter o DDD, ja entre Curitiba e São José dos Pinhais não se faz necessário a utilização do DDD. Sendo assim teremos que analisar não somente o DDD mas o prefixo completo para poder diagnosticar de que cidade é o número que desejamos discar. Pré-requisitos PHP cli v5.5.9 MySQL v5.5.47 Caso desje segue abaixo os comandos de instalação dos pré-requisitos MySQL v5.7 + PHP v.7.0 [sourcecode language=&quot;shell&quot;]sudo apt-get install mysql-client-5.7 mysql-server-5.7 sudo apt-get install php7.0-cli php7.0-mysql php7.0-zip php7.0-mbstring php7.0-xml [/sourcecode] Versões anteriores Caso deseje outra versão do MySQL utilize este procedimento (http://www.helviojunior.com.br/it/mysql/instalando-e-otimizando-mysql-para-alto-trafego-de-dados/) [sourcecode language=&quot;shell&quot;]sudo apt-get install php5-cli php5-mysql libxml2-dev [/sourcecode] Os scripts abaixo foram testados no Ubuntu 14.04 com PHP cli v5.5.9 e MySQL v5.5.47 bem como no Ubuntu 16.02 com PHP cli v7.0.4 e MySQL v5.7.12 &nbsp; Criando estrutura de base de dados e importação Agora que temos todo o conhecimento do arquivo da base vamos as operações técnicas. Desenvolvi um script PHP que realiza o Download, tratamento e importação dessas informações CNL para uma base de dados MySQL. Sendo assim o primeiro passo é criarmos as tabelas na base de dados no MySQL utilizando o script abaixo. Como o objetivo deste post não é ensinar como utilizar o MySQL entende-se que você detém este conhecimento e sabe como executar este script dentro da sua base de dados existente. [sourcecode language=&quot;sql&quot;]-- Criando estrutura para tabela cnl CREATE TABLE IF NOT EXISTS `cnl` ( `cod_cnl` int(11) NOT NULL, `cod_cnl_local` int(11) NOT NULL DEFAULT &#39;0&#39;, `sigla_cnl` varchar(5) NOT NULL, `uf` varchar(2) NOT NULL, `ddd` varchar(2) NOT NULL, `localidade` varchar(200) NOT NULL, `municipio` varchar(200) NOT NULL, PRIMARY KEY (`cod_cnl`), UNIQUE KEY `sigla_cnl` (`sigla_cnl`) )COLLATE=&#39;utf8_general_ci&#39;; -- Criando estrutura para tabela cnl_tarifacao CREATE TABLE IF NOT EXISTS `cnl_tarifacao` ( `cod_cnl` int(11) NOT NULL, `cod_area_tarifacao` varchar(5) NOT NULL, `ddd` varchar(2) NOT NULL, `prefixo` varchar(5) NOT NULL, `prestadora` varchar(60) NOT NULL, `faixa_inicial` int(11) NOT NULL, `faixa_final` int(11) NOT NULL, PRIMARY KEY (`cod_cnl`,`ddd`,`prefixo`,`faixa_inicial`,`faixa_final`), KEY `ddd_prefixo` (`ddd`,`prefixo`), CONSTRAINT `FK_cnl_tarifacao_cnl` FOREIGN KEY (`cod_cnl`) REFERENCES `cnl` (`cod_cnl`) ON DELETE CASCADE ON UPDATE CASCADE )COLLATE=&#39;utf8_general_ci&#39;; [/sourcecode] &nbsp; Agora que criamos as tabelas na base de dados vamos criar o script PHP que irá realizar o download e importação dos dados. Copie o conteúdo abaixo em um script PHP (em nosso exemplo colocarei em /usr/local/bin/importacnl.php). [sourcecode language=&quot;php&quot;]#!/usr/bin/php -q &lt;?php //-------------------------------------------------------------------+ // Autor : Helvio Junior (helvio_junior@hotmail.com) | // Data : 2016-06-02 | // Atualizado : 2017-09-30 | // Versão : 1.2 | // Finalidade : Realizar download e tratamento | // da base CNL para o MySQL | // | // Atualizacoes : * Incluido checagem da config do FreePBX | // * Corrigido BUG de parse do PHP 5.3 | //-------------------------------------------------------------------+ //================ &lt; Variaveis &gt; =================================== $dbhost=&#39;127.0.0.1&#39;; $dbname=&#39;cnldb&#39;; $dbuser=&#39;root&#39;; $dbpass=&#39;cnlpwd&#39;; $freepbx_configfile=&#39;/etc/amportal.conf&#39;; //================ &lt; Funções &gt; =================================== // Funcao utilizada em caso do servidor ser um FreePBX, para carregas as configs do mesmo function parse_amportal_conf($filename) { $conf = array(); /* defaults * This defines defaults and formatting to assure consistency across the system so that * components don&#39;t have to keep being &#39;gun shy&#39; about these variables. * * we will read these settings out of the db, but only when $filename is writeable * otherwise, we read the $filename */ // If conf file is not writable, then we use it as the master so parse it. $file = file($filename); if (is_array($file)) { $write_back = false; foreach ($file as $line) { if (preg_match(&quot;/^\s*([a-zA-Z0-9_]+)=([a-zA-Z0-9 .&amp;-@=_!&lt;&gt;\&quot;\&#39;]+)\s*$/&quot;,$line,$matches)) { // overrite anything that was initialized from the db with the conf file authoritative source // if different from the db value then let&#39;s write it back to the db // TODO: massage any data we read from the conf file with _preapre_conf_value since it is // written back to the DB here if different from the DB. // if (!isset($conf[$matches[1]]) || $conf[$matches[1]] != $matches[2]) { $conf[$matches[1]] = $matches[2]; } } } } else { die_freepbx(sprintf(_(&quot;Missing or unreadable config file [%s]...cannot continue&quot;), $filename)); } // Need to handle transitionary period where modules are adding new settings. So once we parsed the file // we still go read from the database and add anything that isn&#39;t there from the conf file. // $convert = array( &#39;astetcdir&#39; =&gt; &#39;ASTETCDIR&#39;, &#39;astmoddir&#39; =&gt; &#39;ASTMODDIR&#39;, &#39;astvarlibdir&#39; =&gt; &#39;ASTVARLIBDIR&#39;, &#39;astagidir&#39; =&gt; &#39;ASTAGIDIR&#39;, &#39;astspooldir&#39; =&gt; &#39;ASTSPOOLDIR&#39;, &#39;astrundir&#39; =&gt; &#39;ASTRUNDIR&#39;, &#39;astlogdir&#39; =&gt; &#39;ASTLOGDIR&#39; ); $file = file($conf[&#39;ASTETCDIR&#39;].&#39;/asterisk.conf&#39;); foreach ($file as $line) { if (preg_match(&quot;/^\s*([a-zA-Z0-9]+)\s* =&gt; \s*(.*)\s*([;#].*)?/&quot;,$line,$matches)) { $this-&gt;asterisk_conf[ $matches[1] ] = rtrim($matches[2],&quot;/ \t&quot;); } } // Now that we parsed asterisk.conf, we need to make sure $amp_conf is consistent // so just set it to what we found, since this is what asterisk will use anyhow. // foreach ($convert as $ast_conf_key =&gt; $amp_conf_key) { if (isset($conf[$ast_conf_key])) { $conf[$amp_conf_key] = $this-&gt;asterisk_conf[$ast_conf_key]; } } return $conf; } //Função responsável por realizar o explode da linha em uma array function pc_fixed_width_substr($fields,$data) { $r = array(); $line_pos = 0; foreach($fields as $field_name =&gt; $field_length) { //Identifica se os primeiros caracteres são espaço $tmp_data = substr($data,$line_pos,$field_length); if (strlen($tmp_data) != strlen(ltrim($tmp_data))) $line_pos += strlen($tmp_data) - strlen(ltrim($tmp_data)); $r[$field_name] = utf8_encode(trim(substr($data,$line_pos,$field_length))); $line_pos += $field_length; } return $r; } //Em caso do servidor ser um FreePbx, carrega as informações do DB com base na config do FreePBX if (file_exists($freepbx_configfile)){} $amp_conf = parse_amportal_conf($freepbx_configfile); $dbhost=$amp_conf[&#39;AMPDBHOST&#39;]; $dbname=$amp_conf[&#39;AMPDBNAME&#39;]; $dbuser=$amp_conf[&#39;AMPDBUSER&#39;]; $dbpass=$amp_conf[&#39;AMPDBPASS&#39;]; } //================ &lt; Inicio &gt; ===================================== $info = pathinfo(__FILE__); openlog($info[&#39;basename&#39;], LOG_PID | LOG_PERROR, LOG_LOCAL0); date_default_timezone_set(&#39;America/Sao_Paulo&#39;); //Cria a conexão com a base de dados $conn = new PDO(&quot;mysql:host=$dbhost;dbname=$dbname;charset=utf8&quot;, $dbuser, $dbpass); $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION); //Realiza o download do arquivo da Anatel echo &quot;Realizando download do arquivo (Telefone Fixo)...\n&quot;; $filename=&#39;/tmp/anatel-&#39;.date(&quot;YmdHis&quot;).&#39;.zip&#39;; $filename2=&#39;/tmp/anatel-&#39;.date(&quot;YmdHis&quot;).&#39;.txt&#39;; $filename3=&#39;/tmp/anatel-&#39;.date(&quot;YmdHis&quot;).&#39;-converted.txt&#39;; $options = array( CURLOPT_RETURNTRANSFER =&gt; true, // return web page CURLOPT_HEADER =&gt; false, // do not return headers CURLOPT_FOLLOWLOCATION =&gt; true, // follow redirects CURLOPT_USERAGENT =&gt; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:53.0) Gecko/20100101 Firefox/53.0&quot;, // who am i CURLOPT_AUTOREFERER =&gt; true, // set referer on redirect CURLOPT_CONNECTTIMEOUT =&gt; 120, // timeout on connect CURLOPT_TIMEOUT =&gt; 120, // timeout on response CURLOPT_MAXREDIRS =&gt; 10, // stop after 10 redirects CURLOPT_POST =&gt; true, // POST CURLOPT_SSL_VERIFYHOST =&gt; false, CURLOPT_SSL_VERIFYPEER =&gt; false, CURLOPT_URL =&gt; &#39;https://sistemas.anatel.gov.br/areaarea/N_Download/Tela.asp&#39;, CURLOPT_POSTFIELDS =&gt; &#39;varTIPO=CentralCNL&amp;varPRESTADORA=&amp;varCENTRAL=F&amp;varUF=&amp;varPERIODO=&amp;acao=c&amp;cmd=&amp;varMOD=Publico&#39;, CURLOPT_HTTPHEADER =&gt; array( &#39;Content-type: application/x-www-form-urlencoded&#39;, &#39;Expect:&#39; ) ); $ch = curl_init( ); curl_setopt_array( $ch, $options ); $content = curl_exec( $ch ); $err = curl_errno( $ch ); $errmsg = curl_error( $ch ); curl_close( $ch ); $zipFile = fopen($filename, &quot;w&quot;) or die(&quot;Unable to open file!&quot;); fwrite($zipFile, $content); fclose($zipFile); if (!file_exists($filename)) die(&quot;Erro realizando download do arquivo&quot;); //Descompacta o arquivo texto com os dados echo &quot;Descompactando arquivo...\n&quot;; $zip = new ZipArchive; if ($zip-&gt;open($filename) === true) { for($i = 0; $i &lt; $zip-&gt;numFiles; $i++) { $file = $zip-&gt;getNameIndex($i); $fileinfo = pathinfo($file); if (strcasecmp($fileinfo[&#39;extension&#39;], &quot;txt&quot;) == 0) { copy(&quot;zip://&quot;.$filename.&quot;#&quot;.$file, $filename2); } } $zip-&gt;close(); } //Processa o arquivo if (!file_exists($filename2)) die(&quot;Erro descompactando o arquivo&quot;); $fields = array(&#39;uf&#39; =&gt; 2, &#39;sigla_cnl&#39; =&gt; 4, &#39;cod_cnl&#39; =&gt; 5, &#39;localidade&#39; =&gt; 50, &#39;municipio&#39; =&gt; 50, &#39;cod_area_tarifacao&#39; =&gt; 5, &#39;ddd&#39; =&gt; 2, &#39;prefixo&#39; =&gt; 5, &#39;prestadora&#39; =&gt; 30, &#39;faixa_inicial&#39; =&gt; 4, &#39;faixa_final&#39; =&gt; 4, &#39;latitude&#39; =&gt; 8, &#39;hemisferio&#39; =&gt; 5, &#39;longitude&#39; =&gt; 8, &#39;cnl_local&#39; =&gt; 4); //Converte o arquivo echo &quot;Convertendo arquivo...\n&quot;; exec(&quot;iconv -f iso-8859-1 -t UTF-8 $filename2 | sed &#39;y/áÁàÀãÃâÂéÉêÊíÍóÓõÕôÔúÚçÇ/aAaAaAaAeEeEiIoOoOoOuUcC/&#39; &gt; $filename3&quot;); //Processa o arquivo if (!file_exists($filename3)) die(&quot;Erro convertendo o arquivo&quot;); //Realiza a primeira leitura do arquivo, para cadastrar todos os CNLs //Depois realizará uma segunda leitura para cadastrar as tarifas //Isso é necessário pois na tarida existe vínculo com o CNL da área echo &quot;Inserindo CNL...\n&quot;; $handle = fopen($filename3, &quot;r&quot;); if ($handle) { while (($line = fgets($handle)) !== false) { //$line = trim(mb_convert_encoding($line, &quot;UTF-8&quot;, &quot;Windows-1252&quot;)); $line = trim($line); $data = pc_fixed_width_substr($fields,$line); //Executa a inserção try{ $stmt = $conn-&gt;prepare( &quot;INSERT INTO cnl (`cod_cnl`, `sigla_cnl`, `uf`, `ddd`, `localidade`, `municipio`) VALUES(:cod_cnl, :sigla_cnl, :uf, :ddd, :localidade, :municipio) ON DUPLICATE KEY UPDATE uf=VALUES(uf), ddd=VALUES(ddd), localidade=VALUES(localidade), municipio=VALUES(municipio)&quot; ); $stmt-&gt;bindValue(&#39;:cod_cnl&#39;, $data[&#39;cod_cnl&#39;]); $stmt-&gt;bindValue(&#39;:sigla_cnl&#39;, $data[&#39;sigla_cnl&#39;]); $stmt-&gt;bindValue(&#39;:uf&#39;, $data[&#39;uf&#39;]); $stmt-&gt;bindValue(&#39;:ddd&#39;, $data[&#39;ddd&#39;]); $stmt-&gt;bindValue(&#39;:localidade&#39;, $data[&#39;localidade&#39;]); $stmt-&gt;bindValue(&#39;:municipio&#39;, $data[&#39;municipio&#39;]); $stmt-&gt;execute(); $stmt = $conn-&gt;prepare( &quot;INSERT INTO cnl_tarifacao (`cod_cnl`, `cod_area_tarifacao`, `ddd`, `prefixo`, `prestadora`, `faixa_inicial`, `faixa_final`) VALUES(:cod_cnl, :cod_area_tarifacao, :ddd, :prefixo, :prestadora, :faixa_inicial, :faixa_final) ON DUPLICATE KEY UPDATE cod_area_tarifacao=VALUES(cod_area_tarifacao),prestadora=VALUES(prestadora)&quot; ); $stmt-&gt;bindValue(&#39;:cod_cnl&#39;, $data[&#39;cod_cnl&#39;]); $stmt-&gt;bindValue(&#39;:cod_area_tarifacao&#39;, $data[&#39;cod_area_tarifacao&#39;]); $stmt-&gt;bindValue(&#39;:ddd&#39;, $data[&#39;ddd&#39;]); $stmt-&gt;bindValue(&#39;:prefixo&#39;, $data[&#39;prefixo&#39;]); $stmt-&gt;bindValue(&#39;:prestadora&#39;, substr($data[&#39;prestadora&#39;],0,50)); $stmt-&gt;bindValue(&#39;:faixa_inicial&#39;, intval($data[&#39;faixa_inicial&#39;])); $stmt-&gt;bindValue(&#39;:faixa_final&#39;, intval($data[&#39;faixa_final&#39;])); $stmt-&gt;execute(); } catch (Exception $ex) { syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); $debug = var_export($data, true); syslog(LOG_SYSLOG, $debug); die(&quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); } if (empty($data[&#39;ddd&#39;])){ var_dump($line); var_dump($data); die(); } } fclose($handle); } else { syslog(LOG_SYSLOG,&quot;Erro abrindo o arquivo&quot;); die(&quot;Erro abrindo o arquivo&quot;); } //Realiza a releitura do arquivo //Para atualizar a hierarquia de CNL echo &quot;Atualizando hierarquia de CNL, Passo 1...\n&quot;; $handle = fopen($filename3, &quot;r&quot;); if ($handle) { while (($line = fgets($handle)) !== false) { //$line = trim(mb_convert_encoding($line, &quot;UTF-8&quot;, &quot;Windows-1252&quot;)); $line = trim($line); $data = pc_fixed_width_substr($fields,$line); $cod_cnl_local = -1; //Resgata o cód da CNL local //Em diversos casos a informação &#39;CNL local&#39; vem em branco //estes casos serão tratados no passo 2 if (!empty($data[&#39;cnl_local&#39;])) { $stmt = $conn-&gt;prepare(&#39;SELECT cod_cnl from cnl WHERE sigla_cnl = :sigla_cnl&#39;); $stmt-&gt;bindValue(&#39;:sigla_cnl&#39;, $data[&#39;cnl_local&#39;]); $stmt-&gt;execute(); if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){ $cod_cnl_local = $row[&quot;cod_cnl&quot;]; } } if ($cod_cnl_local != -1){ try{ $stmt = $conn-&gt;prepare( &quot;UPDATE cnl SET cod_cnl_local = :cod_cnl_local where cod_cnl = :cod_cnl&quot; ); $stmt-&gt;bindValue(&#39;:cod_cnl&#39;, $data[&#39;cod_cnl&#39;]); $stmt-&gt;bindValue(&#39;:cod_cnl_local&#39;, $cod_cnl_local); $stmt-&gt;execute(); } catch (Exception $ex) { syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); $debug = var_export($data, true); syslog(LOG_SYSLOG, $debug); die(&quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); } } } fclose($handle); } else { syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); die(&quot;Erro abrindo o arquivo&quot;); } //Realiza a releitura do arquivo //Para atualizar a hierarquia de CNL echo &quot;Atualizando hierarquia de CNL, Passo 2...\n&quot;; try{ $stmt = $conn-&gt;prepare( &quot;select * from cnl where cod_cnl_local = 0&quot; ); $stmt-&gt;execute(); while ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)) { $cod_cnl_local = -1; $track = &quot;&quot;; $ddd = $row[&#39;ddd&#39;]; //Resgata o cód da CNL local //Em diversos casos a informação &#39;CNL local&#39; vem em branco //Nestes casos verificar qual é a CNL mais expressiva a partir do DDD e usa-la if (!empty($data[&#39;cnl_local&#39;])) continue; //Em diversos casos a informação &#39;CNL local&#39; vem em branco //Nestes casos verificar qual é a CNL mais expressiva a partir do DDD e usa-la $track = &quot;$track cnl = -1\n&quot;; $s1 = $conn-&gt;prepare(&#39;select * ,(select count(*) from cnl c1 where c1.cod_cnl_local = c.cod_cnl) as `chields` from cnl c where c.cod_cnl != c.cod_cnl_local and ddd = :ddd order by c.ddd, 8 desc limit 1&#39;); $s1-&gt;bindValue(&#39;:ddd&#39;, $ddd); $s1-&gt;execute(); $debug = var_export($s1, true); $track = &quot;$track $debug\n&quot;; $track = &quot;$track :ddd = $ddd\n&quot;; $r1 = $s1-&gt;fetch(PDO::FETCH_ASSOC); $debug = var_export($r1, true); $track = &quot;$track $debug\n&quot;; if ($r1){ $cod_cnl_local = $r1[&quot;cod_cnl&quot;]; $track = &quot;$track cod_cnl = $cod_cnl_local\n&quot;; } if ($cod_cnl_local != -1){ try{ $s1 = $conn-&gt;prepare( &quot;UPDATE cnl SET cod_cnl_local = :cod_cnl_local where cod_cnl = :cod_cnl&quot; ); $s1-&gt;bindValue(&#39;:cod_cnl&#39;, $row[&#39;cod_cnl&#39;]); $s1-&gt;bindValue(&#39;:cod_cnl_local&#39;, $cod_cnl_local); $s1-&gt;execute(); } catch (Exception $ex) { syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); $debug = var_export($row, true); syslog(LOG_SYSLOG, $debug); die(&quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); } }else{ $debug = var_export($row, true); syslog(LOG_SYSLOG, &quot;CNL Local não identificado: $track $debug&quot;); } } } catch (Exception $ex) { syslog(LOG_SYSLOG, &quot;Erro processando: &quot;. $ex-&gt;getMessage()); die(); } //Exclui os arquivos echo &quot;Excluindo arquivos temporários...\n&quot;; unlink($filename3); unlink($filename2); unlink($filename); closelog(); //================ &lt; Fim &gt;==================================== [/sourcecode] Edite as variáveis ($dbhost, $dbname, $dbuser e $dbpass) para representar as informações do seu ambiente. Execute o comando abaixo para liberar execução deste arquivo. Obs.: Em caso de utilização no FreePBX, não se faz necessário editar as variáveis ($dbhost, $dbname, $dbuser e $dbpass), pois o script resgata essas informações automaticamente da configuração do seu FreePBX. [sourcecode language=&quot;shell&quot;] chmod +x /usr/local/bin/importacnl.php [/sourcecode] Por fim execute o script para realizar a importação. E aproveite para dar uma navegada em outros posts aqui do site, curta, compartilhe, ou quem sabe vá tomar um café, energético, suco, ler um livro, pois este processo deve demorar alguns minutos para executar. O interessante é colocar este script para executar uma vez por semana (usando crontab), para manter essa base sempre atualizada. &nbsp; Configurando o asterisk *** ATENÇÃO!!! Em caso de utilização em FreePBX, recomendo utilizar o script específico para ele que se encontra mais abaixo neste post. Enfim chegamos ao asterisk, nesta sessão iremos criar o nosso script AGI bem como configurar nosso plano de discagem do asterisk para consultar essa base de dados e decidir se devemos ou não inserir o DDD nas ligações. Para nosso script AGI utilizaremos a biblioteca PHPAGI disponível em (http://phpagi.sourceforge.net/), mas pode ficar despreocupado colocarei aqui um arquivo zip com todo o conteúdo do AGI + a biblioteca phpagi. Crie um arquivo /var/lib/asterisk/agi-bin/consultacnl.php com o conteúdo abaixo [sourcecode language=&quot;shell&quot;]#!/usr/bin/php -q &lt;?php //-----------------------------------------------------------------+ // Autor : Helvio Junior (helvio_junior@hotmail.com) | // Data : 2016-06-02 | // Versão : 1.0 | // Finalidade : Consulta a base CNL | //-----------------------------------------------------------------+ //================ &lt; Includes &gt; =================================== require_once __DIR__.&#39;/phpagi-2.20/phpagi.php&#39;; //================ &lt; Variaveis &gt; =================================== $dbhost=&#39;127.0.0.1&#39;; $dbname=&#39;cnldb&#39;; $dbuser=&#39;cnluser&#39;; $dbpass=&#39;cnlpwd&#39;; //================ &lt; Inicio &gt; ===================================== $agi = new AGI(); $exten = &#39;&#39;; $uniqueId = $agi-&gt;request[&#39;agi_uniqueid&#39;]; if ((isset($agi-&gt;request[&#39;agi_extension&#39;])) &amp;&amp; ($agi-&gt;request[&#39;agi_extension&#39;] != &#39;&#39;)) $exten = $agi-&gt;request[&#39;agi_extension&#39;]; if (empty($uniqueId) || empty($exten)) { $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;Exten não fornecidos&quot; 3&#39;); die(); } try{ $ddd=substr($exten,0,2); $prefixo=substr($exten,2,4); $sufixo=substr($exten,6,4); $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;Consultando CNL para &#39;.$exten.&#39; (&#39;.$ddd.&#39;) &#39;.$prefixo.&#39;-&#39;.$sufixo.&#39;&quot; 4&#39;); //Cria a conexão com a base de dados $conn = new PDO(&quot;mysql:host=$dbhost;dbname=$dbname;charset=utf8&quot;, $dbuser, $dbpass); $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION); $stmt = $conn-&gt;prepare(&#39;select p.* from cnl c inner join cnl_tarifacao t on c.cod_cnl = t.cod_cnl inner join cnl p on c.cod_cnl_local = p.cod_cnl where t.ddd = :ddd and t.prefixo = :prefixo and :sufixo between t.faixa_inicial and t.faixa_final&#39;); $stmt-&gt;bindValue(&#39;:ddd&#39;, $ddd); $stmt-&gt;bindValue(&#39;:prefixo&#39;, $prefixo); $stmt-&gt;bindValue(&#39;:sufixo&#39;, $sufixo); $stmt-&gt;execute(); $cnl=&quot;&quot;; if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){ $cnl = $row[&quot;sigla_cnl&quot;]; $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;CNL encontrado para &#39;.$exten.&#39; -&gt; &#39;.$cnl.&#39;&quot; 4&#39;); } //Define o cnl $agi-&gt;exec(&#39;SET&#39;,&quot;cnl=$cnl&quot;); return 0; } catch (Exception $e) { $agi-&gt;exec(&quot;NOOP&quot;, &#39;&quot;&#39;.$e-&gt;getMessage().&#39;&quot;&#39;); } [/sourcecode] Igualmente ao script anterior edite as variáveis ($dbhost, $dbname, $dbuser e $dbpass) para representar as informações do seu ambiente. Ajuste a permissão de execução do seu script [sourcecode language=&quot;shell&quot;] chmod +x /var/lib/asterisk/agi-bin/consultacnl.php [/sourcecode] No arquivo /etc/asterisk/extensions.conf edite o seu contexto da ligação conforme o exemplo abaixo [sourcecode language=&quot;shell&quot;][trunk_out] ; Local exten = _XXXXXXXX,1,Goto(041${EXTEN},1) ; LDN exten = _0ZZ[2-6]XXXXXXX,1,Goto(${EXTEN:1},1) exten = _0ZZ[2-6]XXXXXXXX,1,Goto(${EXTEN:1},1) ;Normalizado exten = _ZZXXXXXXX.,1,AGI(consultacnl.php) exten = _ZZXXXXXXX.,n,ExecIf($[&quot;${cnl}&quot; = &quot;CTA&quot;]?Set(number=${EXTEN:2})) exten = _ZZXXXXXXX.,n,Dial(SIP/trunk_sip/${number},90,TtXx) [/sourcecode] Lembrando que neste exemplo considero como origem da ligação o DDD 41 e CNL CTA. &nbsp; Configurando o FreePBX *** ATENÇÃO!!! Este script foi desenvolvido para utilização no padrão do FreePBX, em caso de utilização em outra plataforma, pode ser necessário realização de alterações. Enfim chegamos ao FreePBX, nesta sessão iremos criar o nosso script AGI bem como configurar nosso plano de discagem do FreePBX para consultar essa base de dados e decidir se devemos ou não inserir/excluir o DDD nas ligações. Para nosso script AGI utilizaremos a biblioteca PHPAGI disponível em (http://phpagi.sourceforge.net/), mas pode ficar despreocupado colocarei aqui um arquivo zip com todo o conteúdo do AGI + a biblioteca phpagi. Crie um arquivo /var/lib/asterisk/agi-bin/alteracnl.php com o conteúdo abaixo [sourcecode language=&quot;shell&quot;]#!/usr/bin/php -q &lt;?php //--------------------------------------------------------------------+ // Autor : Helvio Junior (helvio_junior@hotmail.com) | // Data : 2016-06-02 | // Atualizado : 2017-09-30 | // Versão : 1.2 | // Finalidade : Consulta a base CNL e corrige o numero para FreePBX | // *** Utilizar este script preferencialmente no FreePBX | //--------------------------------------------------------------------+ //================ &lt; Includes &gt; =================================== require_once __DIR__.&#39;/phpagi-2.20/phpagi.php&#39;; //================ &lt; Variaveis &gt; =================================== $configfile=&#39;/etc/amportal.conf&#39;; //================ &lt; Funções &gt; =================================== function parse_amportal_conf($filename) { $conf = array(); /* defaults * This defines defaults and formatting to assure consistency across the system so that * components don&#39;t have to keep being &#39;gun shy&#39; about these variables. * * we will read these settings out of the db, but only when $filename is writeable * otherwise, we read the $filename */ // If conf file is not writable, then we use it as the master so parse it. $file = file($filename); if (is_array($file)) { $write_back = false; foreach ($file as $line) { if (preg_match(&quot;/^\s*([a-zA-Z0-9_]+)=([a-zA-Z0-9 .&amp;-@=_!&lt;&gt;\&quot;\&#39;]+)\s*$/&quot;,$line,$matches)) { // overrite anything that was initialized from the db with the conf file authoritative source // if different from the db value then let&#39;s write it back to the db // TODO: massage any data we read from the conf file with _preapre_conf_value since it is // written back to the DB here if different from the DB. // if (!isset($conf[$matches[1]]) || $conf[$matches[1]] != $matches[2]) { $conf[$matches[1]] = $matches[2]; } } } } else { die_freepbx(sprintf(_(&quot;Missing or unreadable config file [%s]...cannot continue&quot;), $filename)); } // Need to handle transitionary period where modules are adding new settings. So once we parsed the file // we still go read from the database and add anything that isn&#39;t there from the conf file. // $convert = array( &#39;astetcdir&#39; =&gt; &#39;ASTETCDIR&#39;, &#39;astmoddir&#39; =&gt; &#39;ASTMODDIR&#39;, &#39;astvarlibdir&#39; =&gt; &#39;ASTVARLIBDIR&#39;, &#39;astagidir&#39; =&gt; &#39;ASTAGIDIR&#39;, &#39;astspooldir&#39; =&gt; &#39;ASTSPOOLDIR&#39;, &#39;astrundir&#39; =&gt; &#39;ASTRUNDIR&#39;, &#39;astlogdir&#39; =&gt; &#39;ASTLOGDIR&#39; ); $file = file($conf[&#39;ASTETCDIR&#39;].&#39;/asterisk.conf&#39;); foreach ($file as $line) { if (preg_match(&quot;/^\s*([a-zA-Z0-9]+)\s* =&gt; \s*(.*)\s*([;#].*)?/&quot;,$line,$matches)) { $this-&gt;asterisk_conf[ $matches[1] ] = rtrim($matches[2],&quot;/ \t&quot;); } } // Now that we parsed asterisk.conf, we need to make sure $amp_conf is consistent // so just set it to what we found, since this is what asterisk will use anyhow. // foreach ($convert as $ast_conf_key =&gt; $amp_conf_key) { if (isset($conf[$ast_conf_key])) { $conf[$amp_conf_key] = $this-&gt;asterisk_conf[$ast_conf_key]; } } return $conf; } //Carrega as informações do DB com base na config do FrePBX $amp_conf = parse_amportal_conf($configfile); $dbhost=$amp_conf[&#39;AMPDBHOST&#39;]; $dbname=$amp_conf[&#39;AMPDBNAME&#39;]; $dbuser=$amp_conf[&#39;AMPDBUSER&#39;]; $dbpass=$amp_conf[&#39;AMPDBPASS&#39;]; //================ &lt; Inicio &gt; ===================================== $agi = new AGI(); $dialnumber = &#39;&#39;; $uniqueId = $agi-&gt;request[&#39;agi_uniqueid&#39;]; $dialnumber = &#39;&#39;; $cnllocal = &#39;&#39;; $tmp = $agi-&gt;get_variable(&quot;OUTNUM&quot;); if (isset($tmp[&#39;data&#39;]) &amp;&amp; !empty($tmp[&#39;data&#39;])){ $dialnumber = $tmp[&#39;data&#39;]; } $tmp = $agi-&gt;get_variable(&quot;agi_arg_1&quot;); if (isset($agi-&gt;request[&#39;agi_arg_1&#39;]) &amp;&amp; !empty($agi-&gt;request[&#39;agi_arg_1&#39;])){ $cnllocal = $agi-&gt;request[&#39;agi_arg_1&#39;]; } if (empty($uniqueId) || empty($dialnumber) || empty($cnllocal)) { $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;DialNumber e CNL Local não fornecidos&quot; 3&#39;); die(); } try{ //Cria a conexão com a base de dados $conn = new PDO(&quot;mysql:host=$dbhost;dbname=$dbname;charset=utf8&quot;, $dbuser, $dbpass); $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION); //Em caso do numero discado ter 8 digitos //Inclui o DDD da mesma CNL do usuário, para posteriormente checar se os numeros fazem parte da mesma CNL //Pois o usuário intuitivamente não digita o numero com DDD quando é o mesmo DDD que ele faz parte if (strlen($dialnumber) == 8){ $stmt = $conn-&gt;prepare(&#39;select c.* from cnl c where c.sigla_cnl = :sigla_cnl&#39;); $stmt-&gt;bindValue(&#39;:sigla_cnl&#39;, $cnllocal); $stmt-&gt;execute(); if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){ $ddd = $row[&quot;ddd&quot;]; $old = $dialnumber; $dialnumber = $ddd . $dialnumber; $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;Numero com 8 digitos. Incluindo DDD para consulta. Old: &#39;.$old.&#39; New: &#39;.$dialnumber.&#39;&quot; 4&#39;); $agi-&gt;exec(&#39;SET&#39;,&#39;OUTNUM=0&#39;.$dialnumber); $agi-&gt;exec(&#39;SET&#39;,&#39;DIAL_NUMBER=0&#39;.$dialnumber); } } //Remove o &quot;zero&quot; como primeiro digito, caso seja if (substr($dialnumber,0,1) == &#39;0&#39;) $dialnumber = substr($dialnumber,1); $ddd=substr($dialnumber,0,2); $prefixo=substr($dialnumber,2,4); $sufixo=substr($dialnumber,6,4); $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;Consultando CNL para &#39;.$dialnumber.&#39; (&#39;.$ddd.&#39;) &#39;.$prefixo.&#39;-&#39;.$sufixo.&#39;&quot; 4&#39;); $stmt = $conn-&gt;prepare(&#39;select p.* from cnl c inner join cnl_tarifacao t on c.cod_cnl = t.cod_cnl inner join cnl p on c.cod_cnl_local = p.cod_cnl where t.ddd = :ddd and t.prefixo = :prefixo and :sufixo between t.faixa_inicial and t.faixa_final&#39;); $stmt-&gt;bindValue(&#39;:ddd&#39;, $ddd); $stmt-&gt;bindValue(&#39;:prefixo&#39;, $prefixo); $stmt-&gt;bindValue(&#39;:sufixo&#39;, $sufixo); $stmt-&gt;execute(); $cnl=&quot;&quot;; if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){ $cnl = $row[&quot;sigla_cnl&quot;]; $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;CNL encontrado para &#39;.$dialnumber.&#39; -&gt; &#39;.$cnl.&#39;&quot; 4&#39;); } //Caso seja o mesmo CNL, remove o DDD do número a ser discado if ($cnllocal == $cnl){ $agi-&gt;exec(&#39;SET&#39;,&#39;OUTNUM=&#39;.$prefixo.$sufixo); $agi-&gt;exec(&#39;SET&#39;,&#39;DIAL_NUMBER=&#39;.$prefixo.$sufixo); } return 0; } catch (Exception $e) { $agi-&gt;exec(&quot;NOOP&quot;, &#39;&quot;&#39;.$e-&gt;getMessage().&#39;&quot;&#39;); } [/sourcecode] Neste script não se faz necessário alterar as variáveis ($dbhost, $dbname, $dbuser e $dbpass) pois o script pega as informações da configuração do seu FreePBX. Ajuste a permissão de execução do seu script [sourcecode language=&quot;shell&quot;] chmod +x /var/lib/asterisk/agi-bin/alteracnl.php [/sourcecode] No arquivo /etc/asterisk/extensions_custom.conf edite o seu contexto da ligação conforme o exemplo abaixo [sourcecode language=&quot;shell&quot;][macro-dialout-trunk-predial-hook] exten =&gt; s,1,Agi(alteracnl.php,CTA) [/sourcecode] Lembrando que neste exemplo considero como origem da ligação o DDD 41 e CNL CTA. &nbsp; Considerações finais Segue o link (CNL) para download do zip com todos os arquivos deste ambiente. Espero ter ajudado. Caso tenha dúvidas, sugestões fique a vontade para comentar, mandar e-mail e etc..." /><link rel="canonical" href="https://www.helviojunior.com.br/voip/asterisk/tratando-codigo-cnl-para-ligacoes-no-asterisk/" /><meta property="og:url" content="https://www.helviojunior.com.br/voip/asterisk/tratando-codigo-cnl-para-ligacoes-no-asterisk/" /><meta property="og:site_name" content="Helvio Junior" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2016-07-02T09:55:54-03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Tratando código CNL para ligações conurbadas no Asterisk e FreePBX" /><meta name="twitter:site" content="@helvioju" /><meta name="twitter:creator" content="@Helvio Junior (m4v3r1ck)" /><meta name="google-site-verification" content="JR4IIP9jfvOwxn2ybV_Qn0SrtDPlTrKomdPWgBuP55k"" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Helvio Junior (m4v3r1ck)"},"dateModified":"2023-08-17T00:19:29-03:00","datePublished":"2016-07-02T09:55:54-03:00","description":"Introdução e contextualização Antes de qualquer coisa vamos direto ao problema que pretendemos resolver neste post. O sistema de telefonia fixa no Brasil adota um padrão de separação das localidades e uma subordinação político-administrativa (isso será explicado um pouco mais a frente com mais detalhes). Basicamente com essa separação poderemos ter 2 municípios com o mesmo DDD onde para realizar ligações um deles não é necessário adicionar o código de DDD, e para outro sim. Exemplo: Moro na cidade de Curitiba (cujo DDD é 41), temos diversos municípios de Curitiba e região metropolitana como Curitiba, Lapa, São José dos Pinhais, Colombo e etc... Quando em Curitiba não necessito utilizar o DDD para efetuar uma ligação a estes municípios, porém quando ligamos para Paranaguá, uma cidade a +- 100 Km de Curitiba, que utiliza o mesmo DDD, ja é necessário utilizar o DDD para realizar ligações. Sendo assim surge o nosso problema, se o DDD não é quem difere se devo ou não colocar o DDD ao realizar uma chamada, como podemos realizar essa distinção? A resposta esta na base de dados CNL. Mas ai surge a pergunta o que é CNL? CNL é o acronimo de &quot;Cadastro Nacional de Localidades&quot;, que tem como definição legal no Inciso III do art. 3º do anexo da Resolução da Anatel nº 83, de 30/12/1998 como &quot;Conjunto de informações relativo às disponibilidades de serviços de telecomunicações em localidades do território nacional.&quot;. Na pratica o Cadastro de Localidades Brasileira, fornece os nomes, a subordinação político-administrativa (a que grande região, estado, meso ou microrregião pertencem), as coordenadas (latitudes e longitudes) e altitudes médias das sedes de localidades como municípios, vilas, assentamentos rurais e aldeias indígenas, entre outras. Agora que conhecemos um pouco mais da estruturação da telefonia podemos entrar no detalhamento da base de dados CNL, para posteriormente entender como poderemos distinguir se nossa ligação deve ou não utilizar DDD. Atualizações 2017-05-15 Alteração da biblioteca de download do arquivo para usar CURL; Correção de erro SSL no download do site da Anatel; Correção de erro HTTP 100-Continue; Alteração para usar HTTPS ao invés de HTTP. 2017-09-30 Corrigido bug de parse no PHP 5.3; Incluído padronização para utilização em FreePBX Entendendo o arquivo CNL A base CNL pode ser baixada a qualquer momento através do link http://sistemas.anatel.gov.br/areaarea/N_Download/Tela.asp?varMod=Publico&amp;SISQSmodulo=7179 selecionando como tipo de arquivo Central CNL, tipo de central Fixo e sigla UF Todas conforme a imagem abaixo: Este processo realizará o download de um arquivo ZIP e detro deste conterá 2 arquivos: Um documento com o layout do arquivo texto, e o arquivo texto contendo a base de dados CNL completa. Abrindo o arquivo DOC temos o seguinte conteúdo [sourcecode language=&quot;text&quot;]----------------------------------------------------------- ANATEL - AGENCIA NACIONAL DE TELECOMUNICACOES LAY-OUT DO ARQUIVO CE_F_HHMMSS.TXT ----------------------------------------------------------- ID NOME DO CAMPO TIPO TAMANHO -- ---------------------------------- ---- ------- 01 Sigla UF char 02 02 Sigla CNL char 04 03 Codigo CNL char 05 04 Nome da Localidade char 50 05 Nome do Municipio char 50 06 Cod. da Area Tarifacao char 05 07 Prefixo char 07 08 Prestadora char 30 09 Num. da Faixa Inicial char 04 10 Num. da Faixa Final char 04 11 Latitude char 08 (*) 12 Hemisferio char 05 13 Longitude char 08 (*) 14 Sigla CNL da Área Local char 04 OBSERVAÇÕES: 1) Os campos marcados com (*), Latitude e Longitude foram alterados para o formato GGMMSSCC, onde: GG = Grau, MM = Minuto, SS = Segundo e CC = Centésimos de Segundo [/sourcecode] Agora abrindo o arquivo texto com a base CNL, extrai 3 linhas para exemplificar e ilustrar como poderemos identificar se devemos ou não colocar DDD em nossas ligações. As linhas são: [sourcecode language=&quot;text&quot;]PRCTA 41000CURITIBA CURITIBA 412 412027 Aerotech 0 999 25254692S 49161884CTA PRSJP 41585SÃO JOSÉ DOS PINHAIS SÃO JOSÉ DOS PINHAIS 412 412094 INTELIG TELECOM 0 999 25315268S 49121115CTA PRPNG 41464PARANAGUÁ PARANAGUÁ 414 412152 CLARO S.A. 0 999 25305796S 48312100PNG [/sourcecode] Para o nosso propósito vou extrair alguns trechos das nossas linhas conforme abaixo: Linha 1: Campo 05 (Município): Curitiba Campo 07 (Prefixo): 412027 Campo 15 (Sigla CNL da Área Local): CTA Linha 2: Campo 05 (Município): São José dos Pinhais Campo 07 (Prefixo): 412094 Campo 15 (Sigla CNL da Área Local): CTA Linha 3: Campo 05 (Município): Paranaguá Campo 07 (Prefixo): 412152 Campo 15 (Sigla CNL da Área Local): PNG Observem que as 3 linhas detêm no prefixo o mesmo DDD (41), porém Paranaguá detêm uma Sigla CNL da Área Local diferente de Curitiba e São José dos Pinhais, isso indica que qualquer ligação vinda de Curitiba para Paranaguá (ou vice versa) deve conter o DDD, ja entre Curitiba e São José dos Pinhais não se faz necessário a utilização do DDD. Sendo assim teremos que analisar não somente o DDD mas o prefixo completo para poder diagnosticar de que cidade é o número que desejamos discar. Pré-requisitos PHP cli v5.5.9 MySQL v5.5.47 Caso desje segue abaixo os comandos de instalação dos pré-requisitos MySQL v5.7 + PHP v.7.0 [sourcecode language=&quot;shell&quot;]sudo apt-get install mysql-client-5.7 mysql-server-5.7 sudo apt-get install php7.0-cli php7.0-mysql php7.0-zip php7.0-mbstring php7.0-xml [/sourcecode] Versões anteriores Caso deseje outra versão do MySQL utilize este procedimento (http://www.helviojunior.com.br/it/mysql/instalando-e-otimizando-mysql-para-alto-trafego-de-dados/) [sourcecode language=&quot;shell&quot;]sudo apt-get install php5-cli php5-mysql libxml2-dev [/sourcecode] Os scripts abaixo foram testados no Ubuntu 14.04 com PHP cli v5.5.9 e MySQL v5.5.47 bem como no Ubuntu 16.02 com PHP cli v7.0.4 e MySQL v5.7.12 &nbsp; Criando estrutura de base de dados e importação Agora que temos todo o conhecimento do arquivo da base vamos as operações técnicas. Desenvolvi um script PHP que realiza o Download, tratamento e importação dessas informações CNL para uma base de dados MySQL. Sendo assim o primeiro passo é criarmos as tabelas na base de dados no MySQL utilizando o script abaixo. Como o objetivo deste post não é ensinar como utilizar o MySQL entende-se que você detém este conhecimento e sabe como executar este script dentro da sua base de dados existente. [sourcecode language=&quot;sql&quot;]-- Criando estrutura para tabela cnl CREATE TABLE IF NOT EXISTS `cnl` ( `cod_cnl` int(11) NOT NULL, `cod_cnl_local` int(11) NOT NULL DEFAULT &#39;0&#39;, `sigla_cnl` varchar(5) NOT NULL, `uf` varchar(2) NOT NULL, `ddd` varchar(2) NOT NULL, `localidade` varchar(200) NOT NULL, `municipio` varchar(200) NOT NULL, PRIMARY KEY (`cod_cnl`), UNIQUE KEY `sigla_cnl` (`sigla_cnl`) )COLLATE=&#39;utf8_general_ci&#39;; -- Criando estrutura para tabela cnl_tarifacao CREATE TABLE IF NOT EXISTS `cnl_tarifacao` ( `cod_cnl` int(11) NOT NULL, `cod_area_tarifacao` varchar(5) NOT NULL, `ddd` varchar(2) NOT NULL, `prefixo` varchar(5) NOT NULL, `prestadora` varchar(60) NOT NULL, `faixa_inicial` int(11) NOT NULL, `faixa_final` int(11) NOT NULL, PRIMARY KEY (`cod_cnl`,`ddd`,`prefixo`,`faixa_inicial`,`faixa_final`), KEY `ddd_prefixo` (`ddd`,`prefixo`), CONSTRAINT `FK_cnl_tarifacao_cnl` FOREIGN KEY (`cod_cnl`) REFERENCES `cnl` (`cod_cnl`) ON DELETE CASCADE ON UPDATE CASCADE )COLLATE=&#39;utf8_general_ci&#39;; [/sourcecode] &nbsp; Agora que criamos as tabelas na base de dados vamos criar o script PHP que irá realizar o download e importação dos dados. Copie o conteúdo abaixo em um script PHP (em nosso exemplo colocarei em /usr/local/bin/importacnl.php). [sourcecode language=&quot;php&quot;]#!/usr/bin/php -q &lt;?php //-------------------------------------------------------------------+ // Autor : Helvio Junior (helvio_junior@hotmail.com) | // Data : 2016-06-02 | // Atualizado : 2017-09-30 | // Versão : 1.2 | // Finalidade : Realizar download e tratamento | // da base CNL para o MySQL | // | // Atualizacoes : * Incluido checagem da config do FreePBX | // * Corrigido BUG de parse do PHP 5.3 | //-------------------------------------------------------------------+ //================ &lt; Variaveis &gt; =================================== $dbhost=&#39;127.0.0.1&#39;; $dbname=&#39;cnldb&#39;; $dbuser=&#39;root&#39;; $dbpass=&#39;cnlpwd&#39;; $freepbx_configfile=&#39;/etc/amportal.conf&#39;; //================ &lt; Funções &gt; =================================== // Funcao utilizada em caso do servidor ser um FreePBX, para carregas as configs do mesmo function parse_amportal_conf($filename) { $conf = array(); /* defaults * This defines defaults and formatting to assure consistency across the system so that * components don&#39;t have to keep being &#39;gun shy&#39; about these variables. * * we will read these settings out of the db, but only when $filename is writeable * otherwise, we read the $filename */ // If conf file is not writable, then we use it as the master so parse it. $file = file($filename); if (is_array($file)) { $write_back = false; foreach ($file as $line) { if (preg_match(&quot;/^\\s*([a-zA-Z0-9_]+)=([a-zA-Z0-9 .&amp;-@=_!&lt;&gt;\\&quot;\\&#39;]+)\\s*$/&quot;,$line,$matches)) { // overrite anything that was initialized from the db with the conf file authoritative source // if different from the db value then let&#39;s write it back to the db // TODO: massage any data we read from the conf file with _preapre_conf_value since it is // written back to the DB here if different from the DB. // if (!isset($conf[$matches[1]]) || $conf[$matches[1]] != $matches[2]) { $conf[$matches[1]] = $matches[2]; } } } } else { die_freepbx(sprintf(_(&quot;Missing or unreadable config file [%s]...cannot continue&quot;), $filename)); } // Need to handle transitionary period where modules are adding new settings. So once we parsed the file // we still go read from the database and add anything that isn&#39;t there from the conf file. // $convert = array( &#39;astetcdir&#39; =&gt; &#39;ASTETCDIR&#39;, &#39;astmoddir&#39; =&gt; &#39;ASTMODDIR&#39;, &#39;astvarlibdir&#39; =&gt; &#39;ASTVARLIBDIR&#39;, &#39;astagidir&#39; =&gt; &#39;ASTAGIDIR&#39;, &#39;astspooldir&#39; =&gt; &#39;ASTSPOOLDIR&#39;, &#39;astrundir&#39; =&gt; &#39;ASTRUNDIR&#39;, &#39;astlogdir&#39; =&gt; &#39;ASTLOGDIR&#39; ); $file = file($conf[&#39;ASTETCDIR&#39;].&#39;/asterisk.conf&#39;); foreach ($file as $line) { if (preg_match(&quot;/^\\s*([a-zA-Z0-9]+)\\s* =&gt; \\s*(.*)\\s*([;#].*)?/&quot;,$line,$matches)) { $this-&gt;asterisk_conf[ $matches[1] ] = rtrim($matches[2],&quot;/ \\t&quot;); } } // Now that we parsed asterisk.conf, we need to make sure $amp_conf is consistent // so just set it to what we found, since this is what asterisk will use anyhow. // foreach ($convert as $ast_conf_key =&gt; $amp_conf_key) { if (isset($conf[$ast_conf_key])) { $conf[$amp_conf_key] = $this-&gt;asterisk_conf[$ast_conf_key]; } } return $conf; } //Função responsável por realizar o explode da linha em uma array function pc_fixed_width_substr($fields,$data) { $r = array(); $line_pos = 0; foreach($fields as $field_name =&gt; $field_length) { //Identifica se os primeiros caracteres são espaço $tmp_data = substr($data,$line_pos,$field_length); if (strlen($tmp_data) != strlen(ltrim($tmp_data))) $line_pos += strlen($tmp_data) - strlen(ltrim($tmp_data)); $r[$field_name] = utf8_encode(trim(substr($data,$line_pos,$field_length))); $line_pos += $field_length; } return $r; } //Em caso do servidor ser um FreePbx, carrega as informações do DB com base na config do FreePBX if (file_exists($freepbx_configfile)){} $amp_conf = parse_amportal_conf($freepbx_configfile); $dbhost=$amp_conf[&#39;AMPDBHOST&#39;]; $dbname=$amp_conf[&#39;AMPDBNAME&#39;]; $dbuser=$amp_conf[&#39;AMPDBUSER&#39;]; $dbpass=$amp_conf[&#39;AMPDBPASS&#39;]; } //================ &lt; Inicio &gt; ===================================== $info = pathinfo(__FILE__); openlog($info[&#39;basename&#39;], LOG_PID | LOG_PERROR, LOG_LOCAL0); date_default_timezone_set(&#39;America/Sao_Paulo&#39;); //Cria a conexão com a base de dados $conn = new PDO(&quot;mysql:host=$dbhost;dbname=$dbname;charset=utf8&quot;, $dbuser, $dbpass); $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION); //Realiza o download do arquivo da Anatel echo &quot;Realizando download do arquivo (Telefone Fixo)...\\n&quot;; $filename=&#39;/tmp/anatel-&#39;.date(&quot;YmdHis&quot;).&#39;.zip&#39;; $filename2=&#39;/tmp/anatel-&#39;.date(&quot;YmdHis&quot;).&#39;.txt&#39;; $filename3=&#39;/tmp/anatel-&#39;.date(&quot;YmdHis&quot;).&#39;-converted.txt&#39;; $options = array( CURLOPT_RETURNTRANSFER =&gt; true, // return web page CURLOPT_HEADER =&gt; false, // do not return headers CURLOPT_FOLLOWLOCATION =&gt; true, // follow redirects CURLOPT_USERAGENT =&gt; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:53.0) Gecko/20100101 Firefox/53.0&quot;, // who am i CURLOPT_AUTOREFERER =&gt; true, // set referer on redirect CURLOPT_CONNECTTIMEOUT =&gt; 120, // timeout on connect CURLOPT_TIMEOUT =&gt; 120, // timeout on response CURLOPT_MAXREDIRS =&gt; 10, // stop after 10 redirects CURLOPT_POST =&gt; true, // POST CURLOPT_SSL_VERIFYHOST =&gt; false, CURLOPT_SSL_VERIFYPEER =&gt; false, CURLOPT_URL =&gt; &#39;https://sistemas.anatel.gov.br/areaarea/N_Download/Tela.asp&#39;, CURLOPT_POSTFIELDS =&gt; &#39;varTIPO=CentralCNL&amp;varPRESTADORA=&amp;varCENTRAL=F&amp;varUF=&amp;varPERIODO=&amp;acao=c&amp;cmd=&amp;varMOD=Publico&#39;, CURLOPT_HTTPHEADER =&gt; array( &#39;Content-type: application/x-www-form-urlencoded&#39;, &#39;Expect:&#39; ) ); $ch = curl_init( ); curl_setopt_array( $ch, $options ); $content = curl_exec( $ch ); $err = curl_errno( $ch ); $errmsg = curl_error( $ch ); curl_close( $ch ); $zipFile = fopen($filename, &quot;w&quot;) or die(&quot;Unable to open file!&quot;); fwrite($zipFile, $content); fclose($zipFile); if (!file_exists($filename)) die(&quot;Erro realizando download do arquivo&quot;); //Descompacta o arquivo texto com os dados echo &quot;Descompactando arquivo...\\n&quot;; $zip = new ZipArchive; if ($zip-&gt;open($filename) === true) { for($i = 0; $i &lt; $zip-&gt;numFiles; $i++) { $file = $zip-&gt;getNameIndex($i); $fileinfo = pathinfo($file); if (strcasecmp($fileinfo[&#39;extension&#39;], &quot;txt&quot;) == 0) { copy(&quot;zip://&quot;.$filename.&quot;#&quot;.$file, $filename2); } } $zip-&gt;close(); } //Processa o arquivo if (!file_exists($filename2)) die(&quot;Erro descompactando o arquivo&quot;); $fields = array(&#39;uf&#39; =&gt; 2, &#39;sigla_cnl&#39; =&gt; 4, &#39;cod_cnl&#39; =&gt; 5, &#39;localidade&#39; =&gt; 50, &#39;municipio&#39; =&gt; 50, &#39;cod_area_tarifacao&#39; =&gt; 5, &#39;ddd&#39; =&gt; 2, &#39;prefixo&#39; =&gt; 5, &#39;prestadora&#39; =&gt; 30, &#39;faixa_inicial&#39; =&gt; 4, &#39;faixa_final&#39; =&gt; 4, &#39;latitude&#39; =&gt; 8, &#39;hemisferio&#39; =&gt; 5, &#39;longitude&#39; =&gt; 8, &#39;cnl_local&#39; =&gt; 4); //Converte o arquivo echo &quot;Convertendo arquivo...\\n&quot;; exec(&quot;iconv -f iso-8859-1 -t UTF-8 $filename2 | sed &#39;y/áÁàÀãÃâÂéÉêÊíÍóÓõÕôÔúÚçÇ/aAaAaAaAeEeEiIoOoOoOuUcC/&#39; &gt; $filename3&quot;); //Processa o arquivo if (!file_exists($filename3)) die(&quot;Erro convertendo o arquivo&quot;); //Realiza a primeira leitura do arquivo, para cadastrar todos os CNLs //Depois realizará uma segunda leitura para cadastrar as tarifas //Isso é necessário pois na tarida existe vínculo com o CNL da área echo &quot;Inserindo CNL...\\n&quot;; $handle = fopen($filename3, &quot;r&quot;); if ($handle) { while (($line = fgets($handle)) !== false) { //$line = trim(mb_convert_encoding($line, &quot;UTF-8&quot;, &quot;Windows-1252&quot;)); $line = trim($line); $data = pc_fixed_width_substr($fields,$line); //Executa a inserção try{ $stmt = $conn-&gt;prepare( &quot;INSERT INTO cnl (`cod_cnl`, `sigla_cnl`, `uf`, `ddd`, `localidade`, `municipio`) VALUES(:cod_cnl, :sigla_cnl, :uf, :ddd, :localidade, :municipio) ON DUPLICATE KEY UPDATE uf=VALUES(uf), ddd=VALUES(ddd), localidade=VALUES(localidade), municipio=VALUES(municipio)&quot; ); $stmt-&gt;bindValue(&#39;:cod_cnl&#39;, $data[&#39;cod_cnl&#39;]); $stmt-&gt;bindValue(&#39;:sigla_cnl&#39;, $data[&#39;sigla_cnl&#39;]); $stmt-&gt;bindValue(&#39;:uf&#39;, $data[&#39;uf&#39;]); $stmt-&gt;bindValue(&#39;:ddd&#39;, $data[&#39;ddd&#39;]); $stmt-&gt;bindValue(&#39;:localidade&#39;, $data[&#39;localidade&#39;]); $stmt-&gt;bindValue(&#39;:municipio&#39;, $data[&#39;municipio&#39;]); $stmt-&gt;execute(); $stmt = $conn-&gt;prepare( &quot;INSERT INTO cnl_tarifacao (`cod_cnl`, `cod_area_tarifacao`, `ddd`, `prefixo`, `prestadora`, `faixa_inicial`, `faixa_final`) VALUES(:cod_cnl, :cod_area_tarifacao, :ddd, :prefixo, :prestadora, :faixa_inicial, :faixa_final) ON DUPLICATE KEY UPDATE cod_area_tarifacao=VALUES(cod_area_tarifacao),prestadora=VALUES(prestadora)&quot; ); $stmt-&gt;bindValue(&#39;:cod_cnl&#39;, $data[&#39;cod_cnl&#39;]); $stmt-&gt;bindValue(&#39;:cod_area_tarifacao&#39;, $data[&#39;cod_area_tarifacao&#39;]); $stmt-&gt;bindValue(&#39;:ddd&#39;, $data[&#39;ddd&#39;]); $stmt-&gt;bindValue(&#39;:prefixo&#39;, $data[&#39;prefixo&#39;]); $stmt-&gt;bindValue(&#39;:prestadora&#39;, substr($data[&#39;prestadora&#39;],0,50)); $stmt-&gt;bindValue(&#39;:faixa_inicial&#39;, intval($data[&#39;faixa_inicial&#39;])); $stmt-&gt;bindValue(&#39;:faixa_final&#39;, intval($data[&#39;faixa_final&#39;])); $stmt-&gt;execute(); } catch (Exception $ex) { syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); $debug = var_export($data, true); syslog(LOG_SYSLOG, $debug); die(&quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); } if (empty($data[&#39;ddd&#39;])){ var_dump($line); var_dump($data); die(); } } fclose($handle); } else { syslog(LOG_SYSLOG,&quot;Erro abrindo o arquivo&quot;); die(&quot;Erro abrindo o arquivo&quot;); } //Realiza a releitura do arquivo //Para atualizar a hierarquia de CNL echo &quot;Atualizando hierarquia de CNL, Passo 1...\\n&quot;; $handle = fopen($filename3, &quot;r&quot;); if ($handle) { while (($line = fgets($handle)) !== false) { //$line = trim(mb_convert_encoding($line, &quot;UTF-8&quot;, &quot;Windows-1252&quot;)); $line = trim($line); $data = pc_fixed_width_substr($fields,$line); $cod_cnl_local = -1; //Resgata o cód da CNL local //Em diversos casos a informação &#39;CNL local&#39; vem em branco //estes casos serão tratados no passo 2 if (!empty($data[&#39;cnl_local&#39;])) { $stmt = $conn-&gt;prepare(&#39;SELECT cod_cnl from cnl WHERE sigla_cnl = :sigla_cnl&#39;); $stmt-&gt;bindValue(&#39;:sigla_cnl&#39;, $data[&#39;cnl_local&#39;]); $stmt-&gt;execute(); if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){ $cod_cnl_local = $row[&quot;cod_cnl&quot;]; } } if ($cod_cnl_local != -1){ try{ $stmt = $conn-&gt;prepare( &quot;UPDATE cnl SET cod_cnl_local = :cod_cnl_local where cod_cnl = :cod_cnl&quot; ); $stmt-&gt;bindValue(&#39;:cod_cnl&#39;, $data[&#39;cod_cnl&#39;]); $stmt-&gt;bindValue(&#39;:cod_cnl_local&#39;, $cod_cnl_local); $stmt-&gt;execute(); } catch (Exception $ex) { syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); $debug = var_export($data, true); syslog(LOG_SYSLOG, $debug); die(&quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); } } } fclose($handle); } else { syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); die(&quot;Erro abrindo o arquivo&quot;); } //Realiza a releitura do arquivo //Para atualizar a hierarquia de CNL echo &quot;Atualizando hierarquia de CNL, Passo 2...\\n&quot;; try{ $stmt = $conn-&gt;prepare( &quot;select * from cnl where cod_cnl_local = 0&quot; ); $stmt-&gt;execute(); while ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)) { $cod_cnl_local = -1; $track = &quot;&quot;; $ddd = $row[&#39;ddd&#39;]; //Resgata o cód da CNL local //Em diversos casos a informação &#39;CNL local&#39; vem em branco //Nestes casos verificar qual é a CNL mais expressiva a partir do DDD e usa-la if (!empty($data[&#39;cnl_local&#39;])) continue; //Em diversos casos a informação &#39;CNL local&#39; vem em branco //Nestes casos verificar qual é a CNL mais expressiva a partir do DDD e usa-la $track = &quot;$track cnl = -1\\n&quot;; $s1 = $conn-&gt;prepare(&#39;select * ,(select count(*) from cnl c1 where c1.cod_cnl_local = c.cod_cnl) as `chields` from cnl c where c.cod_cnl != c.cod_cnl_local and ddd = :ddd order by c.ddd, 8 desc limit 1&#39;); $s1-&gt;bindValue(&#39;:ddd&#39;, $ddd); $s1-&gt;execute(); $debug = var_export($s1, true); $track = &quot;$track $debug\\n&quot;; $track = &quot;$track :ddd = $ddd\\n&quot;; $r1 = $s1-&gt;fetch(PDO::FETCH_ASSOC); $debug = var_export($r1, true); $track = &quot;$track $debug\\n&quot;; if ($r1){ $cod_cnl_local = $r1[&quot;cod_cnl&quot;]; $track = &quot;$track cod_cnl = $cod_cnl_local\\n&quot;; } if ($cod_cnl_local != -1){ try{ $s1 = $conn-&gt;prepare( &quot;UPDATE cnl SET cod_cnl_local = :cod_cnl_local where cod_cnl = :cod_cnl&quot; ); $s1-&gt;bindValue(&#39;:cod_cnl&#39;, $row[&#39;cod_cnl&#39;]); $s1-&gt;bindValue(&#39;:cod_cnl_local&#39;, $cod_cnl_local); $s1-&gt;execute(); } catch (Exception $ex) { syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); $debug = var_export($row, true); syslog(LOG_SYSLOG, $debug); die(&quot;Erro na linha $line: &quot;. $ex-&gt;getMessage()); } }else{ $debug = var_export($row, true); syslog(LOG_SYSLOG, &quot;CNL Local não identificado: $track $debug&quot;); } } } catch (Exception $ex) { syslog(LOG_SYSLOG, &quot;Erro processando: &quot;. $ex-&gt;getMessage()); die(); } //Exclui os arquivos echo &quot;Excluindo arquivos temporários...\\n&quot;; unlink($filename3); unlink($filename2); unlink($filename); closelog(); //================ &lt; Fim &gt;==================================== [/sourcecode] Edite as variáveis ($dbhost, $dbname, $dbuser e $dbpass) para representar as informações do seu ambiente. Execute o comando abaixo para liberar execução deste arquivo. Obs.: Em caso de utilização no FreePBX, não se faz necessário editar as variáveis ($dbhost, $dbname, $dbuser e $dbpass), pois o script resgata essas informações automaticamente da configuração do seu FreePBX. [sourcecode language=&quot;shell&quot;] chmod +x /usr/local/bin/importacnl.php [/sourcecode] Por fim execute o script para realizar a importação. E aproveite para dar uma navegada em outros posts aqui do site, curta, compartilhe, ou quem sabe vá tomar um café, energético, suco, ler um livro, pois este processo deve demorar alguns minutos para executar. O interessante é colocar este script para executar uma vez por semana (usando crontab), para manter essa base sempre atualizada. &nbsp; Configurando o asterisk *** ATENÇÃO!!! Em caso de utilização em FreePBX, recomendo utilizar o script específico para ele que se encontra mais abaixo neste post. Enfim chegamos ao asterisk, nesta sessão iremos criar o nosso script AGI bem como configurar nosso plano de discagem do asterisk para consultar essa base de dados e decidir se devemos ou não inserir o DDD nas ligações. Para nosso script AGI utilizaremos a biblioteca PHPAGI disponível em (http://phpagi.sourceforge.net/), mas pode ficar despreocupado colocarei aqui um arquivo zip com todo o conteúdo do AGI + a biblioteca phpagi. Crie um arquivo /var/lib/asterisk/agi-bin/consultacnl.php com o conteúdo abaixo [sourcecode language=&quot;shell&quot;]#!/usr/bin/php -q &lt;?php //-----------------------------------------------------------------+ // Autor : Helvio Junior (helvio_junior@hotmail.com) | // Data : 2016-06-02 | // Versão : 1.0 | // Finalidade : Consulta a base CNL | //-----------------------------------------------------------------+ //================ &lt; Includes &gt; =================================== require_once __DIR__.&#39;/phpagi-2.20/phpagi.php&#39;; //================ &lt; Variaveis &gt; =================================== $dbhost=&#39;127.0.0.1&#39;; $dbname=&#39;cnldb&#39;; $dbuser=&#39;cnluser&#39;; $dbpass=&#39;cnlpwd&#39;; //================ &lt; Inicio &gt; ===================================== $agi = new AGI(); $exten = &#39;&#39;; $uniqueId = $agi-&gt;request[&#39;agi_uniqueid&#39;]; if ((isset($agi-&gt;request[&#39;agi_extension&#39;])) &amp;&amp; ($agi-&gt;request[&#39;agi_extension&#39;] != &#39;&#39;)) $exten = $agi-&gt;request[&#39;agi_extension&#39;]; if (empty($uniqueId) || empty($exten)) { $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;Exten não fornecidos&quot; 3&#39;); die(); } try{ $ddd=substr($exten,0,2); $prefixo=substr($exten,2,4); $sufixo=substr($exten,6,4); $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;Consultando CNL para &#39;.$exten.&#39; (&#39;.$ddd.&#39;) &#39;.$prefixo.&#39;-&#39;.$sufixo.&#39;&quot; 4&#39;); //Cria a conexão com a base de dados $conn = new PDO(&quot;mysql:host=$dbhost;dbname=$dbname;charset=utf8&quot;, $dbuser, $dbpass); $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION); $stmt = $conn-&gt;prepare(&#39;select p.* from cnl c inner join cnl_tarifacao t on c.cod_cnl = t.cod_cnl inner join cnl p on c.cod_cnl_local = p.cod_cnl where t.ddd = :ddd and t.prefixo = :prefixo and :sufixo between t.faixa_inicial and t.faixa_final&#39;); $stmt-&gt;bindValue(&#39;:ddd&#39;, $ddd); $stmt-&gt;bindValue(&#39;:prefixo&#39;, $prefixo); $stmt-&gt;bindValue(&#39;:sufixo&#39;, $sufixo); $stmt-&gt;execute(); $cnl=&quot;&quot;; if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){ $cnl = $row[&quot;sigla_cnl&quot;]; $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;CNL encontrado para &#39;.$exten.&#39; -&gt; &#39;.$cnl.&#39;&quot; 4&#39;); } //Define o cnl $agi-&gt;exec(&#39;SET&#39;,&quot;cnl=$cnl&quot;); return 0; } catch (Exception $e) { $agi-&gt;exec(&quot;NOOP&quot;, &#39;&quot;&#39;.$e-&gt;getMessage().&#39;&quot;&#39;); } [/sourcecode] Igualmente ao script anterior edite as variáveis ($dbhost, $dbname, $dbuser e $dbpass) para representar as informações do seu ambiente. Ajuste a permissão de execução do seu script [sourcecode language=&quot;shell&quot;] chmod +x /var/lib/asterisk/agi-bin/consultacnl.php [/sourcecode] No arquivo /etc/asterisk/extensions.conf edite o seu contexto da ligação conforme o exemplo abaixo [sourcecode language=&quot;shell&quot;][trunk_out] ; Local exten = _XXXXXXXX,1,Goto(041${EXTEN},1) ; LDN exten = _0ZZ[2-6]XXXXXXX,1,Goto(${EXTEN:1},1) exten = _0ZZ[2-6]XXXXXXXX,1,Goto(${EXTEN:1},1) ;Normalizado exten = _ZZXXXXXXX.,1,AGI(consultacnl.php) exten = _ZZXXXXXXX.,n,ExecIf($[&quot;${cnl}&quot; = &quot;CTA&quot;]?Set(number=${EXTEN:2})) exten = _ZZXXXXXXX.,n,Dial(SIP/trunk_sip/${number},90,TtXx) [/sourcecode] Lembrando que neste exemplo considero como origem da ligação o DDD 41 e CNL CTA. &nbsp; Configurando o FreePBX *** ATENÇÃO!!! Este script foi desenvolvido para utilização no padrão do FreePBX, em caso de utilização em outra plataforma, pode ser necessário realização de alterações. Enfim chegamos ao FreePBX, nesta sessão iremos criar o nosso script AGI bem como configurar nosso plano de discagem do FreePBX para consultar essa base de dados e decidir se devemos ou não inserir/excluir o DDD nas ligações. Para nosso script AGI utilizaremos a biblioteca PHPAGI disponível em (http://phpagi.sourceforge.net/), mas pode ficar despreocupado colocarei aqui um arquivo zip com todo o conteúdo do AGI + a biblioteca phpagi. Crie um arquivo /var/lib/asterisk/agi-bin/alteracnl.php com o conteúdo abaixo [sourcecode language=&quot;shell&quot;]#!/usr/bin/php -q &lt;?php //--------------------------------------------------------------------+ // Autor : Helvio Junior (helvio_junior@hotmail.com) | // Data : 2016-06-02 | // Atualizado : 2017-09-30 | // Versão : 1.2 | // Finalidade : Consulta a base CNL e corrige o numero para FreePBX | // *** Utilizar este script preferencialmente no FreePBX | //--------------------------------------------------------------------+ //================ &lt; Includes &gt; =================================== require_once __DIR__.&#39;/phpagi-2.20/phpagi.php&#39;; //================ &lt; Variaveis &gt; =================================== $configfile=&#39;/etc/amportal.conf&#39;; //================ &lt; Funções &gt; =================================== function parse_amportal_conf($filename) { $conf = array(); /* defaults * This defines defaults and formatting to assure consistency across the system so that * components don&#39;t have to keep being &#39;gun shy&#39; about these variables. * * we will read these settings out of the db, but only when $filename is writeable * otherwise, we read the $filename */ // If conf file is not writable, then we use it as the master so parse it. $file = file($filename); if (is_array($file)) { $write_back = false; foreach ($file as $line) { if (preg_match(&quot;/^\\s*([a-zA-Z0-9_]+)=([a-zA-Z0-9 .&amp;-@=_!&lt;&gt;\\&quot;\\&#39;]+)\\s*$/&quot;,$line,$matches)) { // overrite anything that was initialized from the db with the conf file authoritative source // if different from the db value then let&#39;s write it back to the db // TODO: massage any data we read from the conf file with _preapre_conf_value since it is // written back to the DB here if different from the DB. // if (!isset($conf[$matches[1]]) || $conf[$matches[1]] != $matches[2]) { $conf[$matches[1]] = $matches[2]; } } } } else { die_freepbx(sprintf(_(&quot;Missing or unreadable config file [%s]...cannot continue&quot;), $filename)); } // Need to handle transitionary period where modules are adding new settings. So once we parsed the file // we still go read from the database and add anything that isn&#39;t there from the conf file. // $convert = array( &#39;astetcdir&#39; =&gt; &#39;ASTETCDIR&#39;, &#39;astmoddir&#39; =&gt; &#39;ASTMODDIR&#39;, &#39;astvarlibdir&#39; =&gt; &#39;ASTVARLIBDIR&#39;, &#39;astagidir&#39; =&gt; &#39;ASTAGIDIR&#39;, &#39;astspooldir&#39; =&gt; &#39;ASTSPOOLDIR&#39;, &#39;astrundir&#39; =&gt; &#39;ASTRUNDIR&#39;, &#39;astlogdir&#39; =&gt; &#39;ASTLOGDIR&#39; ); $file = file($conf[&#39;ASTETCDIR&#39;].&#39;/asterisk.conf&#39;); foreach ($file as $line) { if (preg_match(&quot;/^\\s*([a-zA-Z0-9]+)\\s* =&gt; \\s*(.*)\\s*([;#].*)?/&quot;,$line,$matches)) { $this-&gt;asterisk_conf[ $matches[1] ] = rtrim($matches[2],&quot;/ \\t&quot;); } } // Now that we parsed asterisk.conf, we need to make sure $amp_conf is consistent // so just set it to what we found, since this is what asterisk will use anyhow. // foreach ($convert as $ast_conf_key =&gt; $amp_conf_key) { if (isset($conf[$ast_conf_key])) { $conf[$amp_conf_key] = $this-&gt;asterisk_conf[$ast_conf_key]; } } return $conf; } //Carrega as informações do DB com base na config do FrePBX $amp_conf = parse_amportal_conf($configfile); $dbhost=$amp_conf[&#39;AMPDBHOST&#39;]; $dbname=$amp_conf[&#39;AMPDBNAME&#39;]; $dbuser=$amp_conf[&#39;AMPDBUSER&#39;]; $dbpass=$amp_conf[&#39;AMPDBPASS&#39;]; //================ &lt; Inicio &gt; ===================================== $agi = new AGI(); $dialnumber = &#39;&#39;; $uniqueId = $agi-&gt;request[&#39;agi_uniqueid&#39;]; $dialnumber = &#39;&#39;; $cnllocal = &#39;&#39;; $tmp = $agi-&gt;get_variable(&quot;OUTNUM&quot;); if (isset($tmp[&#39;data&#39;]) &amp;&amp; !empty($tmp[&#39;data&#39;])){ $dialnumber = $tmp[&#39;data&#39;]; } $tmp = $agi-&gt;get_variable(&quot;agi_arg_1&quot;); if (isset($agi-&gt;request[&#39;agi_arg_1&#39;]) &amp;&amp; !empty($agi-&gt;request[&#39;agi_arg_1&#39;])){ $cnllocal = $agi-&gt;request[&#39;agi_arg_1&#39;]; } if (empty($uniqueId) || empty($dialnumber) || empty($cnllocal)) { $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;DialNumber e CNL Local não fornecidos&quot; 3&#39;); die(); } try{ //Cria a conexão com a base de dados $conn = new PDO(&quot;mysql:host=$dbhost;dbname=$dbname;charset=utf8&quot;, $dbuser, $dbpass); $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION); //Em caso do numero discado ter 8 digitos //Inclui o DDD da mesma CNL do usuário, para posteriormente checar se os numeros fazem parte da mesma CNL //Pois o usuário intuitivamente não digita o numero com DDD quando é o mesmo DDD que ele faz parte if (strlen($dialnumber) == 8){ $stmt = $conn-&gt;prepare(&#39;select c.* from cnl c where c.sigla_cnl = :sigla_cnl&#39;); $stmt-&gt;bindValue(&#39;:sigla_cnl&#39;, $cnllocal); $stmt-&gt;execute(); if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){ $ddd = $row[&quot;ddd&quot;]; $old = $dialnumber; $dialnumber = $ddd . $dialnumber; $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;Numero com 8 digitos. Incluindo DDD para consulta. Old: &#39;.$old.&#39; New: &#39;.$dialnumber.&#39;&quot; 4&#39;); $agi-&gt;exec(&#39;SET&#39;,&#39;OUTNUM=0&#39;.$dialnumber); $agi-&gt;exec(&#39;SET&#39;,&#39;DIAL_NUMBER=0&#39;.$dialnumber); } } //Remove o &quot;zero&quot; como primeiro digito, caso seja if (substr($dialnumber,0,1) == &#39;0&#39;) $dialnumber = substr($dialnumber,1); $ddd=substr($dialnumber,0,2); $prefixo=substr($dialnumber,2,4); $sufixo=substr($dialnumber,6,4); $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;Consultando CNL para &#39;.$dialnumber.&#39; (&#39;.$ddd.&#39;) &#39;.$prefixo.&#39;-&#39;.$sufixo.&#39;&quot; 4&#39;); $stmt = $conn-&gt;prepare(&#39;select p.* from cnl c inner join cnl_tarifacao t on c.cod_cnl = t.cod_cnl inner join cnl p on c.cod_cnl_local = p.cod_cnl where t.ddd = :ddd and t.prefixo = :prefixo and :sufixo between t.faixa_inicial and t.faixa_final&#39;); $stmt-&gt;bindValue(&#39;:ddd&#39;, $ddd); $stmt-&gt;bindValue(&#39;:prefixo&#39;, $prefixo); $stmt-&gt;bindValue(&#39;:sufixo&#39;, $sufixo); $stmt-&gt;execute(); $cnl=&quot;&quot;; if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){ $cnl = $row[&quot;sigla_cnl&quot;]; $agi-&gt;exec(&#39;VERBOSE&#39;,&#39;&quot;CNL encontrado para &#39;.$dialnumber.&#39; -&gt; &#39;.$cnl.&#39;&quot; 4&#39;); } //Caso seja o mesmo CNL, remove o DDD do número a ser discado if ($cnllocal == $cnl){ $agi-&gt;exec(&#39;SET&#39;,&#39;OUTNUM=&#39;.$prefixo.$sufixo); $agi-&gt;exec(&#39;SET&#39;,&#39;DIAL_NUMBER=&#39;.$prefixo.$sufixo); } return 0; } catch (Exception $e) { $agi-&gt;exec(&quot;NOOP&quot;, &#39;&quot;&#39;.$e-&gt;getMessage().&#39;&quot;&#39;); } [/sourcecode] Neste script não se faz necessário alterar as variáveis ($dbhost, $dbname, $dbuser e $dbpass) pois o script pega as informações da configuração do seu FreePBX. Ajuste a permissão de execução do seu script [sourcecode language=&quot;shell&quot;] chmod +x /var/lib/asterisk/agi-bin/alteracnl.php [/sourcecode] No arquivo /etc/asterisk/extensions_custom.conf edite o seu contexto da ligação conforme o exemplo abaixo [sourcecode language=&quot;shell&quot;][macro-dialout-trunk-predial-hook] exten =&gt; s,1,Agi(alteracnl.php,CTA) [/sourcecode] Lembrando que neste exemplo considero como origem da ligação o DDD 41 e CNL CTA. &nbsp; Considerações finais Segue o link (CNL) para download do zip com todos os arquivos deste ambiente. Espero ter ajudado. Caso tenha dúvidas, sugestões fique a vontade para comentar, mandar e-mail e etc...","headline":"Tratando código CNL para ligações conurbadas no Asterisk e FreePBX","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.helviojunior.com.br/voip/asterisk/tratando-codigo-cnl-para-ligacoes-no-asterisk/"},"url":"https://www.helviojunior.com.br/voip/asterisk/tratando-codigo-cnl-para-ligacoes-no-asterisk/"}</script><title>Tratando código CNL para ligações conurbadas no Asterisk e FreePBX | Helvio Junior</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Helvio Junior"><meta name="application-name" content="Helvio Junior"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/m4v3r1ck.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Helvio Junior</a></div><div class="site-subtitle font-italic">Cyber security researcher, speaker, low level and binary exploitation entusiast. <br /><br />"I’m just a child who has never grown up. I still keep asking these 'how' & 'why' questions. Occasionally, I find an answer. Stephen Hawking"</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://www.linkedin.com/in/helviojunior" aria-label="linkedin" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://www.youtube.com/@Sec4US" aria-label="youtube" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-youtube"></i> </a> <a href="https://github.com/helviojunior" aria-label="github" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['helvio.junior','sec4us.com.br'].join('@')" aria-label="email" class="order-6" > <i class="fas fa-envelope"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/voip"> Voip </a> </span> <span> <a href="/asterisk"> Asterisk </a> </span> <span>Tratando código CNL para ligações conurbadas no Asterisk e FreePBX</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Tratando código CNL para ligações conurbadas no Asterisk e FreePBX</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Helvio Junior (m4v3r1ck) </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Jul 2, 2016, 9:55 AM -0300" prep="on" > Jul 2, 2016 <i class="unloaded">2016-07-02T09:55:54-03:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 17, 2023, 12:19 AM -0300" prefix="Updated " > Aug 17, 2023 <i class="unloaded">2023-08-17T00:19:29-03:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3958 words">21 min</span></div></div><div class="post-content"><h2>Introdução e contextualização</h2><p>Antes de qualquer coisa vamos direto ao problema que pretendemos resolver neste post. O sistema de telefonia fixa no Brasil adota um padrão de separação das localidades e uma subordinação político-administrativa (isso será explicado um pouco mais a frente com mais detalhes). Basicamente com essa separação poderemos ter 2 municípios com o mesmo DDD onde para realizar ligações um deles não é necessário adicionar o código de DDD, e para outro sim.</p><p>Exemplo: Moro na cidade de Curitiba (cujo DDD é 41), temos diversos municípios de Curitiba e região metropolitana como Curitiba, Lapa, São José dos Pinhais, Colombo e etc... Quando em Curitiba não necessito utilizar o DDD para efetuar uma ligação a estes municípios, porém quando ligamos para Paranaguá, uma cidade a +- 100 Km de Curitiba, que utiliza o mesmo DDD, ja é necessário utilizar o DDD para realizar ligações.</p><p>Sendo assim surge o nosso problema, se o DDD não é quem difere se devo ou não colocar o DDD ao realizar uma chamada, como podemos realizar essa distinção? A resposta esta na base de dados CNL.</p><p></p><p>Mas ai surge a pergunta o que é CNL? CNL é o acronimo de "Cadastro Nacional de Localidades", que tem como definição legal no Inciso III do art. 3º do anexo da Resolução da Anatel nº 83, de 30/12/1998 como "Conjunto de informações relativo às disponibilidades de serviços de telecomunicações em localidades do território nacional.".</p><p>Na pratica o Cadastro de Localidades Brasileira, fornece os nomes, a subordinação político-administrativa (a que grande região, estado, meso ou microrregião pertencem), as coordenadas (latitudes e longitudes) e altitudes médias das sedes de localidades como municípios, vilas, assentamentos rurais e aldeias indígenas, entre outras.</p><p>Agora que conhecemos um pouco mais da estruturação da telefonia podemos entrar no detalhamento da base de dados CNL, para posteriormente entender como poderemos distinguir se nossa ligação deve ou não utilizar DDD.</p><h2>Atualizações</h2><ul><li>2017-05-15<ul><li>Alteração da biblioteca de download do arquivo para usar CURL;<li>Correção de erro SSL no download do site da Anatel;<li>Correção de erro HTTP 100-Continue;<li>Alteração para usar HTTPS ao invés de HTTP.</ul><li>2017-09-30<ul><li>Corrigido bug de parse no PHP 5.3;<li>Incluído padronização para utilização em FreePBX</ul></ul><h2>Entendendo o arquivo CNL</h2><p>A base CNL pode ser baixada a qualquer momento através do link <a href="http://sistemas.anatel.gov.br/areaarea/N_Download/Tela.asp?varMod=Publico&amp;SISQSmodulo=7179" target="_blank">http://sistemas.anatel.gov.br/areaarea/N_Download/Tela.asp?varMod=Publico&amp;SISQSmodulo=7179</a> selecionando como tipo de arquivo Central CNL, tipo de central Fixo e sigla UF Todas conforme a imagem abaixo:</p><p><a href="/assets/2016/07/asterisk_cnl_001.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 215'%3E%3C/svg%3E" data-src="/assets/2016/07/asterisk_cnl_001-300x215.png" alt="asterisk_cnl_001" width="300" height="215" class="lazyload" data-proofer-ignore></a></p><p>Este processo realizará o download de um arquivo ZIP e detro deste conterá 2 arquivos: Um documento com o layout do arquivo texto, e o arquivo texto contendo a base de dados CNL completa.</p><p><a href="/assets/2016/07/asterisk_cnl_002.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 582 64'%3E%3C/svg%3E" data-src="/assets/2016/07/asterisk_cnl_002.png" alt="asterisk_cnl_002" width="582" height="64" class="lazyload" data-proofer-ignore></a></p><p>Abrindo o arquivo DOC temos o seguinte conteúdo</p><p>[sourcecode language="text"]-----------------------------------------------------------<br /> ANATEL - AGENCIA NACIONAL DE TELECOMUNICACOES<br /> LAY-OUT DO ARQUIVO CE_F_HHMMSS.TXT<br /> -----------------------------------------------------------<br /> ID NOME DO CAMPO TIPO TAMANHO<br /> -- ---------------------------------- ---- -------<br /> 01 Sigla UF char 02<br /> 02 Sigla CNL char 04<br /> 03 Codigo CNL char 05<br /> 04 Nome da Localidade char 50<br /> 05 Nome do Municipio char 50<br /> 06 Cod. da Area Tarifacao char 05<br /> 07 Prefixo char 07<br /> 08 Prestadora char 30<br /> 09 Num. da Faixa Inicial char 04<br /> 10 Num. da Faixa Final char 04<br /> 11 Latitude char 08 (*)<br /> 12 Hemisferio char 05<br /> 13 Longitude char 08 (*)<br /> 14 Sigla CNL da Área Local char 04</p><p>OBSERVAÇÕES:<br /> 1) Os campos marcados com (*), Latitude e Longitude foram<br /> alterados para o formato GGMMSSCC,<br /> onde:<br /> GG = Grau,<br /> MM = Minuto,<br /> SS = Segundo e<br /> CC = Centésimos de Segundo<br /> [/sourcecode]</p><p>Agora abrindo o arquivo texto com a base CNL, extrai 3 linhas para exemplificar e ilustrar como poderemos identificar se devemos ou não colocar DDD em nossas ligações.</p><p>As linhas são:</p><p>[sourcecode language="text"]PRCTA 41000CURITIBA CURITIBA 412 412027 Aerotech 0 999 25254692S 49161884CTA<br /> PRSJP 41585SÃO JOSÉ DOS PINHAIS SÃO JOSÉ DOS PINHAIS 412 412094 INTELIG TELECOM 0 999 25315268S 49121115CTA<br /> PRPNG 41464PARANAGUÁ PARANAGUÁ 414 412152 CLARO S.A. 0 999 25305796S 48312100PNG<br /> [/sourcecode]</p><p>Para o nosso propósito vou extrair alguns trechos das nossas linhas conforme abaixo:</p><ul><li>Linha 1:<ul><li>Campo 05 (Município): Curitiba<li>Campo 07 (Prefixo): 412027<li>Campo 15 (Sigla CNL da Área Local): CTA</ul><li>Linha 2:<ul><li>Campo 05 (Município): São José dos Pinhais<li>Campo 07 (Prefixo): 412094<li>Campo 15 (Sigla CNL da Área Local): CTA</ul><li>Linha 3:<ul><li>Campo 05 (Município): Paranaguá<li>Campo 07 (Prefixo): 412152<li>Campo 15 (Sigla CNL da Área Local): PNG</ul></ul><p>Observem que as 3 linhas detêm no prefixo o mesmo DDD (41), porém Paranaguá detêm uma Sigla CNL da Área Local diferente de Curitiba e São José dos Pinhais, isso indica que qualquer ligação vinda de Curitiba para Paranaguá (ou vice versa) deve conter o DDD, ja entre Curitiba e São José dos Pinhais não se faz necessário a utilização do DDD. Sendo assim teremos que analisar não somente o DDD mas o prefixo completo para poder diagnosticar de que cidade é o número que desejamos discar.</p><h2>Pré-requisitos</h2><ul><li>PHP cli v5.5.9<li>MySQL v5.5.47</ul><p>Caso desje segue abaixo os comandos de instalação dos pré-requisitos</p><p><strong>MySQL v5.7 + PHP v.7.0</strong></p><p>[sourcecode language="shell"]sudo apt-get install mysql-client-5.7 mysql-server-5.7<br /> sudo apt-get install php7.0-cli php7.0-mysql php7.0-zip php7.0-mbstring php7.0-xml<br /> [/sourcecode]</p><p><strong>Versões anteriores</strong><br /> Caso deseje outra versão do MySQL utilize este procedimento (<a href="http://www.helviojunior.com.br/it/mysql/instalando-e-otimizando-mysql-para-alto-trafego-de-dados/" target="_blank">http://www.helviojunior.com.br/it/mysql/instalando-e-otimizando-mysql-para-alto-trafego-de-dados/</a>)</p><p>[sourcecode language="shell"]sudo apt-get install php5-cli php5-mysql libxml2-dev<br /> [/sourcecode]</p><p>Os scripts abaixo foram testados no Ubuntu 14.04 com PHP cli v5.5.9 e MySQL v5.5.47 bem como no Ubuntu 16.02 com PHP cli v7.0.4 e MySQL v5.7.12</p><p>&nbsp;</p><h2>Criando estrutura de base de dados e importação</h2><p>Agora que temos todo o conhecimento do arquivo da base vamos as operações técnicas. Desenvolvi um script PHP que realiza o Download, tratamento e importação dessas informações CNL para uma base de dados MySQL.</p><p>Sendo assim o primeiro passo é criarmos as tabelas na base de dados no MySQL utilizando o script abaixo. Como o objetivo deste post não é ensinar como utilizar o MySQL entende-se que você detém este conhecimento e sabe como executar este script dentro da sua base de dados existente.</p><p>[sourcecode language="sql"]-- Criando estrutura para tabela cnl<br /> CREATE TABLE IF NOT EXISTS `cnl` (<br /> `cod_cnl` int(11) NOT NULL,<br /> `cod_cnl_local` int(11) NOT NULL DEFAULT '0',<br /> `sigla_cnl` varchar(5) NOT NULL,<br /> `uf` varchar(2) NOT NULL,<br /> `ddd` varchar(2) NOT NULL,<br /> `localidade` varchar(200) NOT NULL,<br /> `municipio` varchar(200) NOT NULL,<br /> PRIMARY KEY (`cod_cnl`),<br /> UNIQUE KEY `sigla_cnl` (`sigla_cnl`)<br /> )COLLATE='utf8_general_ci';</p><p>-- Criando estrutura para tabela cnl_tarifacao<br /> CREATE TABLE IF NOT EXISTS `cnl_tarifacao` (<br /> `cod_cnl` int(11) NOT NULL,<br /> `cod_area_tarifacao` varchar(5) NOT NULL,<br /> `ddd` varchar(2) NOT NULL,<br /> `prefixo` varchar(5) NOT NULL,<br /> `prestadora` varchar(60) NOT NULL,<br /> `faixa_inicial` int(11) NOT NULL,<br /> `faixa_final` int(11) NOT NULL,<br /> PRIMARY KEY (`cod_cnl`,`ddd`,`prefixo`,`faixa_inicial`,`faixa_final`),<br /> KEY `ddd_prefixo` (`ddd`,`prefixo`),<br /> CONSTRAINT `FK_cnl_tarifacao_cnl` FOREIGN KEY (`cod_cnl`) REFERENCES `cnl` (`cod_cnl`) ON DELETE CASCADE ON UPDATE CASCADE<br /> )COLLATE='utf8_general_ci';<br /> [/sourcecode]</p><p>&nbsp;</p><p>Agora que criamos as tabelas na base de dados vamos criar o script PHP que irá realizar o download e importação dos dados. Copie o conteúdo abaixo em um script PHP (em nosso exemplo colocarei em <strong>/usr/local/bin/importacnl.php</strong>).</p><p>[sourcecode language="php"]#!/usr/bin/php -q<br /> &lt;?php<br /> //-------------------------------------------------------------------+<br /> // Autor : Helvio Junior (helvio_junior@hotmail.com) |<br /> // Data : 2016-06-02 |<br /> // Atualizado : 2017-09-30 |<br /> // Versão : 1.2 |<br /> // Finalidade : Realizar download e tratamento |<br /> // da base CNL para o MySQL |<br /> // |<br /> // Atualizacoes : * Incluido checagem da config do FreePBX |<br /> // * Corrigido BUG de parse do PHP 5.3 |<br /> //-------------------------------------------------------------------+</p><p>//================ &lt; Variaveis &gt; ===================================<br /> $dbhost='127.0.0.1';<br /> $dbname='cnldb';<br /> $dbuser='root';<br /> $dbpass='cnlpwd';<br /> $freepbx_configfile='/etc/amportal.conf';</p><p>//================ &lt; Funções &gt; ===================================</p><p>// Funcao utilizada em caso do servidor ser um FreePBX, para carregas as configs do mesmo<br /> function parse_amportal_conf($filename) {<br /> $conf = array();</p><p> /* defaults<br /> * This defines defaults and formatting to assure consistency across the system so that<br /> * components don't have to keep being 'gun shy' about these variables.<br /> *<br /> * we will read these settings out of the db, but only when $filename is writeable<br /> * otherwise, we read the $filename<br /> */<br /> // If conf file is not writable, then we use it as the master so parse it.<br /> $file = file($filename);<br /> if (is_array($file)) {<br /> $write_back = false;<br /> foreach ($file as $line) {<br /> if (preg_match(&quot;/^\s*([a-zA-Z0-9_]+)=([a-zA-Z0-9 .&amp;-@=_!&lt;&gt;\&quot;\']+)\s*$/&quot;,$line,$matches)) {<br /> // overrite anything that was initialized from the db with the conf file authoritative source<br /> // if different from the db value then let's write it back to the db<br /> // TODO: massage any data we read from the conf file with _preapre_conf_value since it is<br /> // written back to the DB here if different from the DB.<br /> //<br /> if (!isset($conf[$matches[1]]) || $conf[$matches[1]] != $matches[2]) {<br /> $conf[$matches[1]] = $matches[2];<br /> }<br /> }<br /> }<br /> } else {<br /> die_freepbx(sprintf(_(&quot;Missing or unreadable config file [%s]...cannot continue&quot;), $filename));<br /> }<br /> // Need to handle transitionary period where modules are adding new settings. So once we parsed the file<br /> // we still go read from the database and add anything that isn't there from the conf file.<br /> //</p><p> $convert = array(<br /> 'astetcdir' =&gt; 'ASTETCDIR',<br /> 'astmoddir' =&gt; 'ASTMODDIR',<br /> 'astvarlibdir' =&gt; 'ASTVARLIBDIR',<br /> 'astagidir' =&gt; 'ASTAGIDIR',<br /> 'astspooldir' =&gt; 'ASTSPOOLDIR',<br /> 'astrundir' =&gt; 'ASTRUNDIR',<br /> 'astlogdir' =&gt; 'ASTLOGDIR'<br /> );</p><p> $file = file($conf['ASTETCDIR'].'/asterisk.conf');<br /> foreach ($file as $line) {<br /> if (preg_match(&quot;/^\s*([a-zA-Z0-9]+)\s* =&gt; \s*(.*)\s*([;#].*)?/&quot;,$line,$matches)) {<br /> $this-&gt;asterisk_conf[ $matches[1] ] = rtrim($matches[2],&quot;/ \t&quot;);<br /> }<br /> }</p><p> // Now that we parsed asterisk.conf, we need to make sure $amp_conf is consistent<br /> // so just set it to what we found, since this is what asterisk will use anyhow.<br /> //<br /> foreach ($convert as $ast_conf_key =&gt; $amp_conf_key) {<br /> if (isset($conf[$ast_conf_key])) {<br /> $conf[$amp_conf_key] = $this-&gt;asterisk_conf[$ast_conf_key];<br /> }<br /> }</p><p> return $conf;<br /> }</p><p>//Função responsável por realizar o explode da linha em uma array<br /> function pc_fixed_width_substr($fields,$data) {<br /> $r = array();<br /> $line_pos = 0;<br /> foreach($fields as $field_name =&gt; $field_length) {<br /> //Identifica se os primeiros caracteres são espaço<br /> $tmp_data = substr($data,$line_pos,$field_length);<br /> if (strlen($tmp_data) != strlen(ltrim($tmp_data)))<br /> $line_pos += strlen($tmp_data) - strlen(ltrim($tmp_data));<br /> $r[$field_name] = utf8_encode(trim(substr($data,$line_pos,$field_length)));<br /> $line_pos += $field_length;<br /> }</p><p> return $r;<br /> }</p><p>//Em caso do servidor ser um FreePbx, carrega as informações do DB com base na config do FreePBX<br /> if (file_exists($freepbx_configfile)){}<br /> $amp_conf = parse_amportal_conf($freepbx_configfile);</p><p> $dbhost=$amp_conf['AMPDBHOST'];<br /> $dbname=$amp_conf['AMPDBNAME'];<br /> $dbuser=$amp_conf['AMPDBUSER'];<br /> $dbpass=$amp_conf['AMPDBPASS'];<br /> }</p><p>//================ &lt; Inicio &gt; =====================================</p><p>$info = pathinfo(__FILE__);<br /> openlog($info['basename'], LOG_PID | LOG_PERROR, LOG_LOCAL0);</p><p>date_default_timezone_set('America/Sao_Paulo');</p><p>//Cria a conexão com a base de dados<br /> $conn = new PDO(&quot;mysql:host=$dbhost;dbname=$dbname;charset=utf8&quot;, $dbuser, $dbpass);<br /> $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);</p><p>//Realiza o download do arquivo da Anatel<br /> echo &quot;Realizando download do arquivo (Telefone Fixo)...\n&quot;;<br /> $filename='/tmp/anatel-'.date(&quot;YmdHis&quot;).'.zip';<br /> $filename2='/tmp/anatel-'.date(&quot;YmdHis&quot;).'.txt';<br /> $filename3='/tmp/anatel-'.date(&quot;YmdHis&quot;).'-converted.txt';</p><p>$options = array(<br /> CURLOPT_RETURNTRANSFER =&gt; true, // return web page<br /> CURLOPT_HEADER =&gt; false, // do not return headers<br /> CURLOPT_FOLLOWLOCATION =&gt; true, // follow redirects<br /> CURLOPT_USERAGENT =&gt; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:53.0) Gecko/20100101 Firefox/53.0&quot;, // who am i<br /> CURLOPT_AUTOREFERER =&gt; true, // set referer on redirect<br /> CURLOPT_CONNECTTIMEOUT =&gt; 120, // timeout on connect<br /> CURLOPT_TIMEOUT =&gt; 120, // timeout on response<br /> CURLOPT_MAXREDIRS =&gt; 10, // stop after 10 redirects<br /> CURLOPT_POST =&gt; true, // POST<br /> CURLOPT_SSL_VERIFYHOST =&gt; false,<br /> CURLOPT_SSL_VERIFYPEER =&gt; false,<br /> CURLOPT_URL =&gt; 'https://sistemas.anatel.gov.br/areaarea/N_Download/Tela.asp',<br /> CURLOPT_POSTFIELDS =&gt; 'varTIPO=CentralCNL&amp;varPRESTADORA=&amp;varCENTRAL=F&amp;varUF=&amp;varPERIODO=&amp;acao=c&amp;cmd=&amp;varMOD=Publico',<br /> CURLOPT_HTTPHEADER =&gt; array(<br /> 'Content-type: application/x-www-form-urlencoded',<br /> 'Expect:'<br /> )<br /> );</p><p>$ch = curl_init( );<br /> curl_setopt_array( $ch, $options );<br /> $content = curl_exec( $ch );<br /> $err = curl_errno( $ch );<br /> $errmsg = curl_error( $ch );</p><p>curl_close( $ch );</p><p>$zipFile = fopen($filename, &quot;w&quot;) or die(&quot;Unable to open file!&quot;);<br /> fwrite($zipFile, $content);<br /> fclose($zipFile);</p><p>if (!file_exists($filename)) die(&quot;Erro realizando download do arquivo&quot;);</p><p>//Descompacta o arquivo texto com os dados<br /> echo &quot;Descompactando arquivo...\n&quot;;<br /> $zip = new ZipArchive;<br /> if ($zip-&gt;open($filename) === true) {<br /> for($i = 0; $i &lt; $zip-&gt;numFiles; $i++) {<br /> $file = $zip-&gt;getNameIndex($i);<br /> $fileinfo = pathinfo($file);<br /> if (strcasecmp($fileinfo['extension'], &quot;txt&quot;) == 0) {<br /> copy(&quot;zip://&quot;.$filename.&quot;#&quot;.$file, $filename2);<br /> }</p><p> }<br /> $zip-&gt;close();<br /> }</p><p>//Processa o arquivo<br /> if (!file_exists($filename2)) die(&quot;Erro descompactando o arquivo&quot;);</p><p>$fields = array('uf' =&gt; 2,<br /> 'sigla_cnl' =&gt; 4,<br /> 'cod_cnl' =&gt; 5,<br /> 'localidade' =&gt; 50,<br /> 'municipio' =&gt; 50,<br /> 'cod_area_tarifacao' =&gt; 5,<br /> 'ddd' =&gt; 2,<br /> 'prefixo' =&gt; 5,<br /> 'prestadora' =&gt; 30,<br /> 'faixa_inicial' =&gt; 4,<br /> 'faixa_final' =&gt; 4,<br /> 'latitude' =&gt; 8,<br /> 'hemisferio' =&gt; 5,<br /> 'longitude' =&gt; 8,<br /> 'cnl_local' =&gt; 4);</p><p>//Converte o arquivo<br /> echo &quot;Convertendo arquivo...\n&quot;;<br /> exec(&quot;iconv -f iso-8859-1 -t UTF-8 $filename2 | sed 'y/áÁàÀãÃâÂéÉêÊíÍóÓõÕôÔúÚçÇ/aAaAaAaAeEeEiIoOoOoOuUcC/' &gt; $filename3&quot;);</p><p>//Processa o arquivo<br /> if (!file_exists($filename3)) die(&quot;Erro convertendo o arquivo&quot;);</p><p>//Realiza a primeira leitura do arquivo, para cadastrar todos os CNLs<br /> //Depois realizará uma segunda leitura para cadastrar as tarifas<br /> //Isso é necessário pois na tarida existe vínculo com o CNL da área<br /> echo &quot;Inserindo CNL...\n&quot;;<br /> $handle = fopen($filename3, &quot;r&quot;);<br /> if ($handle) {<br /> while (($line = fgets($handle)) !== false) {</p><p> //$line = trim(mb_convert_encoding($line, &quot;UTF-8&quot;, &quot;Windows-1252&quot;));<br /> $line = trim($line);<br /> $data = pc_fixed_width_substr($fields,$line);</p><p> //Executa a inserção<br /> try{<br /> $stmt = $conn-&gt;prepare( &quot;INSERT INTO cnl (`cod_cnl`, `sigla_cnl`, `uf`, `ddd`, `localidade`, `municipio`) VALUES(:cod_cnl, :sigla_cnl, :uf, :ddd, :localidade, :municipio) ON DUPLICATE KEY UPDATE uf=VALUES(uf), ddd=VALUES(ddd), localidade=VALUES(localidade), municipio=VALUES(municipio)&quot; );<br /> $stmt-&gt;bindValue(':cod_cnl', $data['cod_cnl']);<br /> $stmt-&gt;bindValue(':sigla_cnl', $data['sigla_cnl']);<br /> $stmt-&gt;bindValue(':uf', $data['uf']);<br /> $stmt-&gt;bindValue(':ddd', $data['ddd']);<br /> $stmt-&gt;bindValue(':localidade', $data['localidade']);<br /> $stmt-&gt;bindValue(':municipio', $data['municipio']);<br /> $stmt-&gt;execute();</p><p> $stmt = $conn-&gt;prepare( &quot;INSERT INTO cnl_tarifacao (`cod_cnl`, `cod_area_tarifacao`, `ddd`, `prefixo`, `prestadora`, `faixa_inicial`, `faixa_final`) VALUES(:cod_cnl, :cod_area_tarifacao, :ddd, :prefixo, :prestadora, :faixa_inicial, :faixa_final) ON DUPLICATE KEY UPDATE cod_area_tarifacao=VALUES(cod_area_tarifacao),prestadora=VALUES(prestadora)&quot; );<br /> $stmt-&gt;bindValue(':cod_cnl', $data['cod_cnl']);<br /> $stmt-&gt;bindValue(':cod_area_tarifacao', $data['cod_area_tarifacao']);<br /> $stmt-&gt;bindValue(':ddd', $data['ddd']);<br /> $stmt-&gt;bindValue(':prefixo', $data['prefixo']);<br /> $stmt-&gt;bindValue(':prestadora', substr($data['prestadora'],0,50));<br /> $stmt-&gt;bindValue(':faixa_inicial', intval($data['faixa_inicial']));<br /> $stmt-&gt;bindValue(':faixa_final', intval($data['faixa_final']));<br /> $stmt-&gt;execute();</p><p> } catch (Exception $ex) {<br /> syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage());<br /> $debug = var_export($data, true);<br /> syslog(LOG_SYSLOG, $debug);<br /> die(&quot;Erro na linha $line: &quot;. $ex-&gt;getMessage());<br /> }</p><p> if (empty($data['ddd'])){<br /> var_dump($line);<br /> var_dump($data);<br /> die();<br /> }</p><p> }</p><p> fclose($handle);<br /> } else {<br /> syslog(LOG_SYSLOG,&quot;Erro abrindo o arquivo&quot;);<br /> die(&quot;Erro abrindo o arquivo&quot;);<br /> }</p><p>//Realiza a releitura do arquivo<br /> //Para atualizar a hierarquia de CNL<br /> echo &quot;Atualizando hierarquia de CNL, Passo 1...\n&quot;;<br /> $handle = fopen($filename3, &quot;r&quot;);<br /> if ($handle) {<br /> while (($line = fgets($handle)) !== false)<br /> {</p><p> //$line = trim(mb_convert_encoding($line, &quot;UTF-8&quot;, &quot;Windows-1252&quot;));<br /> $line = trim($line);<br /> $data = pc_fixed_width_substr($fields,$line);<br /> $cod_cnl_local = -1;</p><p> //Resgata o cód da CNL local<br /> //Em diversos casos a informação 'CNL local' vem em branco<br /> //estes casos serão tratados no passo 2<br /> if (!empty($data['cnl_local']))<br /> {<br /> $stmt = $conn-&gt;prepare('SELECT cod_cnl from cnl WHERE sigla_cnl = :sigla_cnl');<br /> $stmt-&gt;bindValue(':sigla_cnl', $data['cnl_local']);<br /> $stmt-&gt;execute();</p><p> if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){<br /> $cod_cnl_local = $row[&quot;cod_cnl&quot;];<br /> }<br /> }</p><p> if ($cod_cnl_local != -1){<br /> try{</p><p> $stmt = $conn-&gt;prepare( &quot;UPDATE cnl SET cod_cnl_local = :cod_cnl_local where cod_cnl = :cod_cnl&quot; );<br /> $stmt-&gt;bindValue(':cod_cnl', $data['cod_cnl']);<br /> $stmt-&gt;bindValue(':cod_cnl_local', $cod_cnl_local);<br /> $stmt-&gt;execute();</p><p> } catch (Exception $ex) {<br /> syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage());<br /> $debug = var_export($data, true);<br /> syslog(LOG_SYSLOG, $debug);<br /> die(&quot;Erro na linha $line: &quot;. $ex-&gt;getMessage());<br /> }<br /> }</p><p> }</p><p> fclose($handle);<br /> } else {<br /> syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage());<br /> die(&quot;Erro abrindo o arquivo&quot;);<br /> }</p><p>//Realiza a releitura do arquivo<br /> //Para atualizar a hierarquia de CNL<br /> echo &quot;Atualizando hierarquia de CNL, Passo 2...\n&quot;;<br /> try{<br /> $stmt = $conn-&gt;prepare( &quot;select * from cnl where cod_cnl_local = 0&quot; );<br /> $stmt-&gt;execute();</p><p> while ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC))<br /> {<br /> $cod_cnl_local = -1;<br /> $track = &quot;&quot;;<br /> $ddd = $row['ddd'];</p><p> //Resgata o cód da CNL local<br /> //Em diversos casos a informação 'CNL local' vem em branco<br /> //Nestes casos verificar qual é a CNL mais expressiva a partir do DDD e usa-la<br /> if (!empty($data['cnl_local']))<br /> continue;</p><p> //Em diversos casos a informação 'CNL local' vem em branco<br /> //Nestes casos verificar qual é a CNL mais expressiva a partir do DDD e usa-la<br /> $track = &quot;$track cnl = -1\n&quot;;</p><p> $s1 = $conn-&gt;prepare('select * ,(select count(*) from cnl c1 where c1.cod_cnl_local = c.cod_cnl) as `chields` from cnl c where c.cod_cnl != c.cod_cnl_local and ddd = :ddd order by c.ddd, 8 desc limit 1');<br /> $s1-&gt;bindValue(':ddd', $ddd);<br /> $s1-&gt;execute();</p><p> $debug = var_export($s1, true);<br /> $track = &quot;$track $debug\n&quot;;</p><p> $track = &quot;$track :ddd = $ddd\n&quot;;</p><p> $r1 = $s1-&gt;fetch(PDO::FETCH_ASSOC);</p><p> $debug = var_export($r1, true);<br /> $track = &quot;$track $debug\n&quot;;</p><p> if ($r1){<br /> $cod_cnl_local = $r1[&quot;cod_cnl&quot;];<br /> $track = &quot;$track cod_cnl = $cod_cnl_local\n&quot;;<br /> }</p><p> if ($cod_cnl_local != -1){<br /> try{</p><p> $s1 = $conn-&gt;prepare( &quot;UPDATE cnl SET cod_cnl_local = :cod_cnl_local where cod_cnl = :cod_cnl&quot; );<br /> $s1-&gt;bindValue(':cod_cnl', $row['cod_cnl']);<br /> $s1-&gt;bindValue(':cod_cnl_local', $cod_cnl_local);<br /> $s1-&gt;execute();</p><p> } catch (Exception $ex) {<br /> syslog(LOG_SYSLOG, &quot;Erro na linha $line: &quot;. $ex-&gt;getMessage());<br /> $debug = var_export($row, true);<br /> syslog(LOG_SYSLOG, $debug);<br /> die(&quot;Erro na linha $line: &quot;. $ex-&gt;getMessage());<br /> }<br /> }else{<br /> $debug = var_export($row, true);<br /> syslog(LOG_SYSLOG, &quot;CNL Local não identificado: $track $debug&quot;);<br /> }</p><p> }</p><p>} catch (Exception $ex) {<br /> syslog(LOG_SYSLOG, &quot;Erro processando: &quot;. $ex-&gt;getMessage());<br /> die();<br /> }</p><p>//Exclui os arquivos<br /> echo &quot;Excluindo arquivos temporários...\n&quot;;<br /> unlink($filename3);<br /> unlink($filename2);<br /> unlink($filename);</p><p>closelog();<br /> //================ &lt; Fim &gt;====================================</p><p>[/sourcecode]</p><p>Edite as variáveis ($dbhost, $dbname, $dbuser e $dbpass) para representar as informações do seu ambiente. Execute o comando abaixo para liberar execução deste arquivo.</p><p>Obs.: Em caso de utilização no FreePBX, não se faz necessário editar as variáveis ($dbhost, $dbname, $dbuser e $dbpass), pois o script resgata essas informações automaticamente da configuração do seu FreePBX.</p><p>[sourcecode language="shell"] chmod +x /usr/local/bin/importacnl.php<br /> [/sourcecode]</p><p>Por fim execute o script para realizar a importação. E aproveite para dar uma navegada em outros posts aqui do site, curta, compartilhe, ou quem sabe vá tomar um café, energético, suco, ler um livro, pois este processo deve demorar alguns minutos para executar.</p><p><a href="/assets/2016/07/asterisk_cnl_003.png" class="img-link shimmer" ><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 486 131'%3E%3C/svg%3E" data-src="/assets/2016/07/asterisk_cnl_003.png" alt="asterisk_cnl_003" width="486" height="131" class="lazyload" data-proofer-ignore></a></p><p>O interessante é colocar este script para executar uma vez por semana (usando crontab), para manter essa base sempre atualizada.</p><p>&nbsp;</p><h2>Configurando o asterisk</h2><p><span style="color: #ff0000;">*** ATENÇÃO!!! Em caso de utilização em FreePBX, recomendo utilizar o script específico para ele que se encontra mais abaixo neste post.</span></p><p>Enfim chegamos ao asterisk, nesta sessão iremos criar o nosso script AGI bem como configurar nosso plano de discagem do asterisk para consultar essa base de dados e decidir se devemos ou não inserir o DDD nas ligações.</p><p>Para nosso script AGI utilizaremos a biblioteca PHPAGI disponível em (<a href="http://phpagi.sourceforge.net/" target="_blank">http://phpagi.sourceforge.net/</a>), mas pode ficar despreocupado colocarei aqui um arquivo zip com todo o conteúdo do AGI + a biblioteca phpagi.</p><p>Crie um arquivo <strong>/var/lib/asterisk/agi-bin/consultacnl.php</strong> com o conteúdo abaixo</p><p>[sourcecode language="shell"]#!/usr/bin/php -q<br /> &lt;?php<br /> //-----------------------------------------------------------------+<br /> // Autor : Helvio Junior (helvio_junior@hotmail.com) |<br /> // Data : 2016-06-02 |<br /> // Versão : 1.0 |<br /> // Finalidade : Consulta a base CNL |<br /> //-----------------------------------------------------------------+</p><p>//================ &lt; Includes &gt; ===================================<br /> require_once __DIR__.'/phpagi-2.20/phpagi.php';</p><p>//================ &lt; Variaveis &gt; ===================================<br /> $dbhost='127.0.0.1';<br /> $dbname='cnldb';<br /> $dbuser='cnluser';<br /> $dbpass='cnlpwd';</p><p>//================ &lt; Inicio &gt; =====================================<br /> $agi = new AGI();</p><p>$exten = '';</p><p>$uniqueId = $agi-&gt;request['agi_uniqueid'];</p><p>if ((isset($agi-&gt;request['agi_extension'])) &amp;&amp; ($agi-&gt;request['agi_extension'] != ''))<br /> $exten = $agi-&gt;request['agi_extension'];</p><p>if (empty($uniqueId) || empty($exten))<br /> {<br /> $agi-&gt;exec('VERBOSE','&quot;Exten não fornecidos&quot; 3');<br /> die();<br /> }</p><p>try{</p><p> $ddd=substr($exten,0,2);<br /> $prefixo=substr($exten,2,4);<br /> $sufixo=substr($exten,6,4);</p><p> $agi-&gt;exec('VERBOSE','&quot;Consultando CNL para '.$exten.' ('.$ddd.') '.$prefixo.'-'.$sufixo.'&quot; 4');</p><p> //Cria a conexão com a base de dados<br /> $conn = new PDO(&quot;mysql:host=$dbhost;dbname=$dbname;charset=utf8&quot;, $dbuser, $dbpass);<br /> $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);</p><p> $stmt = $conn-&gt;prepare('select p.* from cnl c inner join cnl_tarifacao t on c.cod_cnl = t.cod_cnl inner join cnl p on c.cod_cnl_local = p.cod_cnl where t.ddd = :ddd and t.prefixo = :prefixo and :sufixo between t.faixa_inicial and t.faixa_final');<br /> $stmt-&gt;bindValue(':ddd', $ddd);<br /> $stmt-&gt;bindValue(':prefixo', $prefixo);<br /> $stmt-&gt;bindValue(':sufixo', $sufixo);<br /> $stmt-&gt;execute();</p><p> $cnl=&quot;&quot;;<br /> if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){<br /> $cnl = $row[&quot;sigla_cnl&quot;];<br /> $agi-&gt;exec('VERBOSE','&quot;CNL encontrado para '.$exten.' -&gt; '.$cnl.'&quot; 4');<br /> }</p><p> //Define o cnl<br /> $agi-&gt;exec('SET',&quot;cnl=$cnl&quot;);</p><p> return 0;</p><p>} catch (Exception $e) {<br /> $agi-&gt;exec(&quot;NOOP&quot;, '&quot;'.$e-&gt;getMessage().'&quot;');<br /> }<br /> [/sourcecode]</p><p>Igualmente ao script anterior edite as variáveis ($dbhost, $dbname, $dbuser e $dbpass) para representar as informações do seu ambiente.</p><p>Ajuste a permissão de execução do seu script</p><p>[sourcecode language="shell"] chmod +x /var/lib/asterisk/agi-bin/consultacnl.php<br /> [/sourcecode]</p><p>No arquivo <strong>/etc/asterisk/extensions.conf</strong> edite o seu contexto da ligação conforme o exemplo abaixo</p><p>[sourcecode language="shell"][trunk_out]<br /> ; Local<br /> exten = _XXXXXXXX,1,Goto(041${EXTEN},1)<br /> ; LDN<br /> exten = _0ZZ[2-6]XXXXXXX,1,Goto(${EXTEN:1},1)<br /> exten = _0ZZ[2-6]XXXXXXXX,1,Goto(${EXTEN:1},1)</p><p>;Normalizado<br /> exten = _ZZXXXXXXX.,1,AGI(consultacnl.php)<br /> exten = _ZZXXXXXXX.,n,ExecIf($[&quot;${cnl}&quot; = &quot;CTA&quot;]?Set(number=${EXTEN:2}))<br /> exten = _ZZXXXXXXX.,n,Dial(SIP/trunk_sip/${number},90,TtXx)<br /> [/sourcecode]</p><p>Lembrando que neste exemplo considero como origem da ligação o DDD 41 e CNL CTA.</p><p>&nbsp;</p><h2>Configurando o FreePBX</h2><p><span style="color: #ff0000;">*** ATENÇÃO!!! Este script foi desenvolvido para utilização no padrão do FreePBX, em caso de utilização em outra plataforma, pode ser necessário realização de alterações.</span></p><p>Enfim chegamos ao FreePBX, nesta sessão iremos criar o nosso script AGI bem como configurar nosso plano de discagem do FreePBX para consultar essa base de dados e decidir se devemos ou não inserir/excluir o DDD nas ligações.</p><p>Para nosso script AGI utilizaremos a biblioteca PHPAGI disponível em (<a href="http://phpagi.sourceforge.net/" target="_blank">http://phpagi.sourceforge.net/</a>), mas pode ficar despreocupado colocarei aqui um arquivo zip com todo o conteúdo do AGI + a biblioteca phpagi.</p><p>Crie um arquivo <strong>/var/lib/asterisk/agi-bin/alteracnl.php</strong> com o conteúdo abaixo</p><p>[sourcecode language="shell"]#!/usr/bin/php -q<br /> &lt;?php<br /> //--------------------------------------------------------------------+<br /> // Autor : Helvio Junior (helvio_junior@hotmail.com) |<br /> // Data : 2016-06-02 |<br /> // Atualizado : 2017-09-30 |<br /> // Versão : 1.2 |<br /> // Finalidade : Consulta a base CNL e corrige o numero para FreePBX |<br /> // *** Utilizar este script preferencialmente no FreePBX |<br /> //--------------------------------------------------------------------+</p><p>//================ &lt; Includes &gt; ===================================<br /> require_once __DIR__.'/phpagi-2.20/phpagi.php';</p><p>//================ &lt; Variaveis &gt; ===================================<br /> $configfile='/etc/amportal.conf';</p><p>//================ &lt; Funções &gt; ===================================</p><p>function parse_amportal_conf($filename) {<br /> $conf = array();</p><p> /* defaults<br /> * This defines defaults and formatting to assure consistency across the system so that<br /> * components don't have to keep being 'gun shy' about these variables.<br /> *<br /> * we will read these settings out of the db, but only when $filename is writeable<br /> * otherwise, we read the $filename<br /> */<br /> // If conf file is not writable, then we use it as the master so parse it.<br /> $file = file($filename);<br /> if (is_array($file)) {<br /> $write_back = false;<br /> foreach ($file as $line) {<br /> if (preg_match(&quot;/^\s*([a-zA-Z0-9_]+)=([a-zA-Z0-9 .&amp;-@=_!&lt;&gt;\&quot;\']+)\s*$/&quot;,$line,$matches)) {<br /> // overrite anything that was initialized from the db with the conf file authoritative source<br /> // if different from the db value then let's write it back to the db<br /> // TODO: massage any data we read from the conf file with _preapre_conf_value since it is<br /> // written back to the DB here if different from the DB.<br /> //<br /> if (!isset($conf[$matches[1]]) || $conf[$matches[1]] != $matches[2]) {<br /> $conf[$matches[1]] = $matches[2];<br /> }<br /> }<br /> }<br /> } else {<br /> die_freepbx(sprintf(_(&quot;Missing or unreadable config file [%s]...cannot continue&quot;), $filename));<br /> }<br /> // Need to handle transitionary period where modules are adding new settings. So once we parsed the file<br /> // we still go read from the database and add anything that isn't there from the conf file.<br /> //</p><p> $convert = array(<br /> 'astetcdir' =&gt; 'ASTETCDIR',<br /> 'astmoddir' =&gt; 'ASTMODDIR',<br /> 'astvarlibdir' =&gt; 'ASTVARLIBDIR',<br /> 'astagidir' =&gt; 'ASTAGIDIR',<br /> 'astspooldir' =&gt; 'ASTSPOOLDIR',<br /> 'astrundir' =&gt; 'ASTRUNDIR',<br /> 'astlogdir' =&gt; 'ASTLOGDIR'<br /> );</p><p> $file = file($conf['ASTETCDIR'].'/asterisk.conf');<br /> foreach ($file as $line) {<br /> if (preg_match(&quot;/^\s*([a-zA-Z0-9]+)\s* =&gt; \s*(.*)\s*([;#].*)?/&quot;,$line,$matches)) {<br /> $this-&gt;asterisk_conf[ $matches[1] ] = rtrim($matches[2],&quot;/ \t&quot;);<br /> }<br /> }</p><p> // Now that we parsed asterisk.conf, we need to make sure $amp_conf is consistent<br /> // so just set it to what we found, since this is what asterisk will use anyhow.<br /> //<br /> foreach ($convert as $ast_conf_key =&gt; $amp_conf_key) {<br /> if (isset($conf[$ast_conf_key])) {<br /> $conf[$amp_conf_key] = $this-&gt;asterisk_conf[$ast_conf_key];<br /> }<br /> }</p><p> return $conf;<br /> }</p><p>//Carrega as informações do DB com base na config do FrePBX<br /> $amp_conf = parse_amportal_conf($configfile);</p><p>$dbhost=$amp_conf['AMPDBHOST'];<br /> $dbname=$amp_conf['AMPDBNAME'];<br /> $dbuser=$amp_conf['AMPDBUSER'];<br /> $dbpass=$amp_conf['AMPDBPASS'];</p><p>//================ &lt; Inicio &gt; =====================================<br /> $agi = new AGI();</p><p>$dialnumber = '';</p><p>$uniqueId = $agi-&gt;request['agi_uniqueid'];</p><p>$dialnumber = '';<br /> $cnllocal = '';</p><p>$tmp = $agi-&gt;get_variable(&quot;OUTNUM&quot;);<br /> if (isset($tmp['data']) &amp;&amp; !empty($tmp['data'])){<br /> $dialnumber = $tmp['data'];<br /> }</p><p>$tmp = $agi-&gt;get_variable(&quot;agi_arg_1&quot;);<br /> if (isset($agi-&gt;request['agi_arg_1']) &amp;&amp; !empty($agi-&gt;request['agi_arg_1'])){<br /> $cnllocal = $agi-&gt;request['agi_arg_1'];<br /> }</p><p>if (empty($uniqueId) || empty($dialnumber) || empty($cnllocal))<br /> {<br /> $agi-&gt;exec('VERBOSE','&quot;DialNumber e CNL Local não fornecidos&quot; 3');<br /> die();<br /> }</p><p>try{</p><p> //Cria a conexão com a base de dados<br /> $conn = new PDO(&quot;mysql:host=$dbhost;dbname=$dbname;charset=utf8&quot;, $dbuser, $dbpass);<br /> $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);</p><p> //Em caso do numero discado ter 8 digitos<br /> //Inclui o DDD da mesma CNL do usuário, para posteriormente checar se os numeros fazem parte da mesma CNL<br /> //Pois o usuário intuitivamente não digita o numero com DDD quando é o mesmo DDD que ele faz parte<br /> if (strlen($dialnumber) == 8){</p><p> $stmt = $conn-&gt;prepare('select c.* from cnl c where c.sigla_cnl = :sigla_cnl');<br /> $stmt-&gt;bindValue(':sigla_cnl', $cnllocal);<br /> $stmt-&gt;execute();<br /> if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){<br /> $ddd = $row[&quot;ddd&quot;];</p><p> $old = $dialnumber;<br /> $dialnumber = $ddd . $dialnumber;<br /> $agi-&gt;exec('VERBOSE','&quot;Numero com 8 digitos. Incluindo DDD para consulta. Old: '.$old.' New: '.$dialnumber.'&quot; 4');</p><p> $agi-&gt;exec('SET','OUTNUM=0'.$dialnumber);<br /> $agi-&gt;exec('SET','DIAL_NUMBER=0'.$dialnumber);<br /> }</p><p> }</p><p> //Remove o &quot;zero&quot; como primeiro digito, caso seja<br /> if (substr($dialnumber,0,1) == '0')<br /> $dialnumber = substr($dialnumber,1);</p><p> $ddd=substr($dialnumber,0,2);<br /> $prefixo=substr($dialnumber,2,4);<br /> $sufixo=substr($dialnumber,6,4);</p><p> $agi-&gt;exec('VERBOSE','&quot;Consultando CNL para '.$dialnumber.' ('.$ddd.') '.$prefixo.'-'.$sufixo.'&quot; 4');</p><p> $stmt = $conn-&gt;prepare('select p.* from cnl c inner join cnl_tarifacao t on c.cod_cnl = t.cod_cnl inner join cnl p on c.cod_cnl_local = p.cod_cnl where t.ddd = :ddd and t.prefixo = :prefixo and :sufixo between t.faixa_inicial and t.faixa_final');<br /> $stmt-&gt;bindValue(':ddd', $ddd);<br /> $stmt-&gt;bindValue(':prefixo', $prefixo);<br /> $stmt-&gt;bindValue(':sufixo', $sufixo);<br /> $stmt-&gt;execute();</p><p> $cnl=&quot;&quot;;<br /> if ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){<br /> $cnl = $row[&quot;sigla_cnl&quot;];<br /> $agi-&gt;exec('VERBOSE','&quot;CNL encontrado para '.$dialnumber.' -&gt; '.$cnl.'&quot; 4');<br /> }</p><p> //Caso seja o mesmo CNL, remove o DDD do número a ser discado<br /> if ($cnllocal == $cnl){<br /> $agi-&gt;exec('SET','OUTNUM='.$prefixo.$sufixo);<br /> $agi-&gt;exec('SET','DIAL_NUMBER='.$prefixo.$sufixo);<br /> }</p><p> return 0;</p><p>} catch (Exception $e) {<br /> $agi-&gt;exec(&quot;NOOP&quot;, '&quot;'.$e-&gt;getMessage().'&quot;');<br /> }</p><p>[/sourcecode]</p><p>Neste script não se faz necessário alterar as variáveis ($dbhost, $dbname, $dbuser e $dbpass) pois o script pega as informações da configuração do seu FreePBX.</p><p>Ajuste a permissão de execução do seu script</p><p>[sourcecode language="shell"] chmod +x /var/lib/asterisk/agi-bin/alteracnl.php<br /> [/sourcecode]</p><p>No arquivo <strong>/etc/asterisk/extensions_custom.conf</strong> edite o seu contexto da ligação conforme o exemplo abaixo</p><p>[sourcecode language="shell"][macro-dialout-trunk-predial-hook]<br /> exten =&gt; s,1,Agi(alteracnl.php,CTA)<br /> [/sourcecode]</p><p>Lembrando que neste exemplo considero como origem da ligação o DDD 41 e CNL CTA.</p><p>&nbsp;</p><h2>Considerações finais</h2><p>Segue o link (<a href="/assets/2016/07/CNL1.zip">CNL</a>) para download do zip com todos os arquivos deste ambiente.</p><p>Espero ter ajudado. Caso tenha dúvidas, sugestões fique a vontade para comentar, mandar e-mail e etc...</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/asterisk/'>Asterisk</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Tratando código CNL para ligações conurbadas no Asterisk e FreePBX - Helvio Junior&url=https://www.helviojunior.com.br/voip/asterisk/tratando-codigo-cnl-para-ligacoes-no-asterisk/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Tratando código CNL para ligações conurbadas no Asterisk e FreePBX - Helvio Junior&u=https://www.helviojunior.com.br/voip/asterisk/tratando-codigo-cnl-para-ligacoes-no-asterisk/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Tratando código CNL para ligações conurbadas no Asterisk e FreePBX - Helvio Junior&url=https://www.helviojunior.com.br/voip/asterisk/tratando-codigo-cnl-para-ligacoes-no-asterisk/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.helviojunior.com.br/voip/asterisk/tratando-codigo-cnl-para-ligacoes-no-asterisk/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/security/osint/localizando-ips-que-respondem-para-uma-url/">Localizando IPs que respondem para uma URL</a><li><a href="/security/osint/locating-url-ips-bypass-waf/">Locating IPs that respond to a URL</a><li><a href="/security/edr/instalando-elasticsearch-edr/">Instalando Elasticsearch EDR</a><li><a href="/it/instalando-openvpn-com-autenticacao-em-mysql/">Instalando OpenVPN com autenticação em MySQL</a><li><a href="/it/osce-osed-e-ecxd-certificacoes-de-desenvolvimento-de-exploits/">OSCE, OSED e eCXD: Certificações de desenvolvimento de Exploits</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/offensive-security/">Offensive Security</a> <a class="post-tag" href="/tags/pentest/">Pentest</a> <a class="post-tag" href="/tags/autoridade-certificadora/">autoridade certificadora</a> <a class="post-tag" href="/tags/ca/">ca</a> <a class="post-tag" href="/tags/certificate-authority/">certificate authority</a> <a class="post-tag" href="/tags/openssl/">openssl</a> <a class="post-tag" href="/tags/osce3/">OSCE3</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/osed/">OSED</a> <a class="post-tag" href="/tags/osee/">OSEE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/voip/installing-asterisk/"><div class="card-body"> <span class="timeago small" > Mar 30, 2015 <i class="unloaded">2015-03-30T20:47:13-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Instalando o Asterisk 1.8</h3><div class="text-muted small"><p> O Asterisk é um poderoso software de PBX (central telefônica), free, que possibilita realizar interconexões entre o mundo analógico, digital e possibilita aplicações e recursos que quando vistos em...</p></div></div></a></div><div class="card"> <a href="/voip/installing-x100p-asterisk/"><div class="card-body"> <span class="timeago small" > Mar 30, 2015 <i class="unloaded">2015-03-30T20:48:01-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Instalando placa X100P no Asterisk</h3><div class="text-muted small"><p> Introdução Este post demonstra a minha primeira experiência na instalação de placas Intel X100P original (e X100P clone), esta é uma placa FXO (Foreign eXchange Office) para permitir realizar e rec...</p></div></div></a></div><div class="card"> <a href="/voip/asterisk-callerid-netfone-oi/"><div class="card-body"> <span class="timeago small" > Mar 31, 2015 <i class="unloaded">2015-03-31T14:46:54-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Asterisk - CallerID</h3><div class="text-muted small"><p> Este post tem por objetivo demonstrar como realizar a identificação de chamadas através do Asterisk usando uma placa analógica FXO. A maioria das operadoras no Brasil utiliza sinalização Padrão do ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/it/instalando-zabbix-3-0-no-ubuntu/" class="btn btn-outline-primary" prompt="Older"><p>Instalando Zabbix 3.4 no Ubuntu</p></a> <a href="/it/devel/git-push-error-rpc-failed-result56-http-code-0/" class="btn btn-outline-primary" prompt="Newer"><p>git push error: RPC failed; result=56, HTTP code = 0</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Tratando código CNL para ligações conurbadas no Asterisk e FreePBX'; this.page.url = 'https://www.helviojunior.com.br/voip/asterisk/tratando-codigo-cnl-para-ligacoes-no-asterisk/'; this.page.identifier = '/voip/asterisk/tratando-codigo-cnl-para-ligacoes-no-asterisk/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/helviojunior">Helvio junior (aka M4v3r1ck)</a>. <span data-toggle="tooltip" data-placement="top" title="Some rights reserved.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/offensive-security/">Offensive Security</a> <a class="post-tag" href="/tags/pentest/">Pentest</a> <a class="post-tag" href="/tags/autoridade-certificadora/">autoridade certificadora</a> <a class="post-tag" href="/tags/ca/">ca</a> <a class="post-tag" href="/tags/certificate-authority/">certificate authority</a> <a class="post-tag" href="/tags/openssl/">openssl</a> <a class="post-tag" href="/tags/osce3/">OSCE3</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/osed/">OSED</a> <a class="post-tag" href="/tags/osee/">OSEE</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.helviojunior.com.br{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
