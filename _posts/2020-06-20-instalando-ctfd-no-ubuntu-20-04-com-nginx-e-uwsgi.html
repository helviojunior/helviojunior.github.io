---
layout: post
title: Instalando CTFd no Ubuntu 20.04 com Nginx e uWSGI
date: 2020-06-20 00:06:44.000000000 -03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- IT
tags: []
meta:
  _edit_last: '1'
  _syntaxhighlighter_encoded: '1'
  _yoast_wpseo_content_score: '30'
  _aviaLayoutBuilder_active: ''
  _aviaLayoutBuilderCleanData: ''
  layout: ''
  sidebar: ''
  footer: ''
  header_title_bar: ''
  header_transparency: ''
  _avia_hide_featured_image: '0'
  _av_alb_posts_elements_state: a:0:{}
  _av_el_mgr_version: '1.0'
  _av_alb_element_mgr_version: 1.0.1
  _av_css_styles: a:6:{s:7:"post_id";i:2150;s:8:"css_file";s:13:"post-2150.css";s:9:"timestamp";s:0:"";s:6:"status";s:6:"no_css";s:13:"processed_ids";a:0:{}s:13:"include_posts";a:0:{}}
author: Helvio Junior (m4v3r1ck)







permalink: "/it/instalando-ctfd-no-ubuntu-20-04-com-nginx-e-uwsgi/"
---
<p>CTFd é uma plataforma desenvolvida em Python para organização de jogos no estilo Capture sua Bandeira (Capture The Flag) muito comum em ambientes controlados de Segurança Ofensiva e Defensiva. Segue a url do fabricante (<a href="https://ctfd.io/" target="_blank" rel="noopener noreferrer">https://ctfd.io/</a>)</p>
<p>Como demorei para encontrar tutoriais completos e atualizados resolvi juntar tudo em um só e funcional para vocês. Até a versão 18.04 do Ubuntu há um tutorial funcional utilizando a aplicação gunicorn, porém como este pacote foi descontinuado na versão 20.04 do Ubuntu tive que buscar uma forma de fazer e é este trabalho que trago para vocês de forma organizada e comando por comando.</p>
<p><!--more--></p>
<h2>Instalando pacotes e dependências</h2>
<p>Antes de mais nada se faz necessário realizar a instalação de todas as dependências necessárias para o correto funcionamento do ambiente.</p>
<p>Adicionando repositório do nginx no ambiente</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# echo deb http://nginx.org/packages/mainline/ubuntu/ `lsb_release --codename --short` nginx &gt; /etc/apt/sources.list.d/nginx.list<br />
root@M4v3r1ck:~# curl -s http://nginx.org/keys/nginx_signing.key | apt-key add -<br />
[/sourcecode]</p>
<p>Atualizando o ambiente</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# apt-get update &amp;&amp; apt-get -y upgrade<br />
[/sourcecode]</p>
<p>Instalando pacotes e dependências</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# apt install nginx python3 python3-pip python3-dev build-essential libssl-dev libffi-dev python3-setuptools python3-venv<br />
[/sourcecode]</p>
<h2>Pré-configurando o NGINX</h2>
<p>Como utilizaremos o NGINX como um proxy reverso para expor o CTFd para a internet, então vamos realizar uma pré-configuração do mesmo, para posteriormente ajustar para a configuração final. Estamos fazendo isso neste ponto pois logo a frente iremos realizar um teste inicial de acesso ao CTFd, e para isso precisaremos que essa comunicação já seja realizada via NGINX.</p>
<p>Edite o arquivo <strong>/etc/nginx/nginx.conf</strong> para que o mesmo fique exatamente conforme abaixo:</p>
<p>[sourcecode language="shell"]user  nginx;<br />
worker_processes  1;</p>
<p>error_log  /var/log/nginx/error.log warn;<br />
pid        /var/run/nginx.pid;</p>
<p>events {<br />
    worker_connections  1024;<br />
}</p>
<p>http {<br />
    include       /etc/nginx/mime.types;<br />
    default_type  application/octet-stream;</p>
<p>    limit_conn_zone $binary_remote_addr zone=addr:10m;<br />
    server_names_hash_bucket_size  256;</p>
<p>    client_max_body_size 10m;</p>
<p>    log_format log_standard '$remote_addr, $http_x_forwarded_for - $remote_user [$time_local] &quot;$request_method $scheme://$host$request_uri $server_protocol&quot; $status $body_bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot; to: $upstream_addr';</p>
<p>    access_log /var/log/nginx/access.log log_standard;<br />
    error_log /var/log/nginx/error.log;</p>
<p>    sendfile        on;<br />
    #tcp_nopush     on;</p>
<p>    keepalive_timeout  65;</p>
<p>    #gzip  on;</p>
<p>    include /etc/nginx/conf.d/*.conf;<br />
}<br />
[/sourcecode]</p>
<p>Edite o arquivo <strong>/etc/nginx/conf.d/default.conf</strong> de forma que o mesmo fique com o conteúdo abaixo:</p>
<p>[sourcecode language="shell"]server {<br />
    listen      80;<br />
    server_name _;</p>
<p>    location / {</p>
<p>        proxy_pass http://127.0.0.1:8080;<br />
        #include uwsgi_params;<br />
        #uwsgi_pass unix:/home/ctfd/CTFd/ctfd.sock;</p>
<p>    }</p>
<p>}<br />
[/sourcecode]</p>
<p>Reinicie o nginx</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# /etc/init.d/nginx restart<br />
[/sourcecode]</p>
<h2>Instalando e configurando o CTFd</h2>
<p>Agora que temos o nginx ja funcional podemos instalar o CTFd e suas dependências.</p>
<p>Adicione o usuário e grupo conforme abaixo</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# groupadd ctfd<br />
root@M4v3r1ck:~# adduser --disabled-password --ingroup ctfd ctfd<br />
[/sourcecode]</p>
<p>Altere para o contexto do usuário</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# su - ctfd<br />
[/sourcecode]</p>
<p>Realize o download do CTFd. Note que o comandos está sendo executado com o usuário ctfd e dentro do seu diretório home (/home/ctfd)</p>
<p>[sourcecode language="shell"]ctfd@M4v3r1ck:~$ git clone https://github.com/CTFd/CTFd.git<br />
[/sourcecode]</p>
<p>Agora vamos criar um ambiente virtual para isolar o nosso ambiente de outras aplicações python.</p>
<p>[sourcecode language="shell"]ctfd@M4v3r1ck:~$ python3 -m venv CTFd<br />
[/sourcecode]</p>
<p>Isso instalará uma cópia local do Python e do pip para um diretório chamado CTFd.</p>
<p>Antes de instalar aplicativos no ambiente virtual, você precisa ativá-lo. Faça isso digitando:</p>
<p>[sourcecode language="shell"]ctfd@M4v3r1ck:~$ source CTFd/bin/activate<br />
[/sourcecode]</p>
<p>Seu prompt mudará para indicar que você agora está operando no ambiente virtual. Ele se parecerá com isso (CTFd) ctfd@M4v3r1ck:~$.</p>
<p>Agora vamos instalar todas as dependencias python necessárias para o ctfd.<br />
<strong>NOTA: Independente da versão do Python neste ponto usar o pip ao invés do pip3 (pois ja estamos dentro de um ambiente python3)</strong></p>
<p>Primeiramente, vamos instalar o wheel com a instância local do pip para garantir que nossos pacotes serão instalados mesmo se estiverem faltando arquivos wheel:</p>
<p>[sourcecode language="shell"](CTFd) ctfd@M4v3r1ck:~$ pip install wheel<br />
[/sourcecode]</p>
<p>Posteriormente iremos instalar o uwsgi, flask e as dependências</p>
<p>[sourcecode language="shell"](CTFd) ctfd@M4v3r1ck:~$ pip install uwsgi flask testresources werkzeug==0.16.0<br />
(CTFd) ctfd@M4v3r1ck:~$ pip install -r CTFd/requirements.txt<br />
[/sourcecode]</p>
<p>Agora podemos testar o sistema</p>
<p>[sourcecode language="shell"](CTFd) ctfd@M4v3r1ck:~$ cd CTFd<br />
(CTFd) ctfd@M4v3r1ck:~/CTFd$ uwsgi --socket 0.0.0.0:8080 --protocol=http -w wsgi:app<br />
[/sourcecode]</p>
<p>Abra o seu navegador e acesso o IP do seu servidor http://[IP], a imagem igual abaixo deve ser exibida</p>
<p><a href="http://www.helviojunior.com.br/wp-content/uploads/2020/06/Xnip2020-06-20_00-37-23.jpg"><img class="alignnone size-full wp-image-2159" src="{{ site.baseurl }}/assets/2020/06/Xnip2020-06-20_00-37-23.jpg" alt="" width="2880" height="720" /></a></p>
<p>Quando você tiver confirmado que ele está funcionando corretamente, pressione CTRL-C na janela do seu terminal.</p>
<p>Acabamos agora o nosso ambiente virtual, para que possamos desativá-lo:</p>
<p>[sourcecode language="shell"](CTFd) ctfd@M4v3r1ck:~$ deactivate<br />
[/sourcecode]</p>
<p>Agora, qualquer comando Python voltará a usar o ambiente do sistema Python.</p>
<p>Criar arquivo ctfd.ini<br />
Note que neste arquivo iremos definir o modo de conexão (entre o nginx e o wsgi) como sendo um socket unix que é mais rápido e seguro.</p>
<p>[sourcecode language="shell"][uwsgi]<br />
module = wsgi:app</p>
<p>master = true<br />
processes = 5</p>
<p>pidfile = ctfd.pid<br />
socket = ctfd.sock<br />
chmod-socket = 660<br />
vacuum = true</p>
<p>die-on-term = true</p>
<p>logto = /var/log/ctfd/%n.log<br />
[/sourcecode]</p>
<p>Volte ao acesso como root</p>
<p>[sourcecode language="shell"]ctfd@M4v3r1ck:~$ exit<br />
[/sourcecode]</p>
<p>Os comandos agora são executados como <strong>root</strong>.</p>
<p>Crie o diretório de logs e defina sua permissão</p>
<p>[sourcecode language="shell"]ctfd@M4v3r1ck:~# mkdir /var/log/ctfd<br />
ctfd@M4v3r1ck:~# chown ctfd:adm /var/log/ctfd/<br />
[/sourcecode]</p>
<p>Crie o arquivo para logrotate com nome <strong>/etc/logrotate.d/ctfd</strong> com o seguinte conteúdo: </p>
<p>[sourcecode language="shell"]/var/log/ctfd/*.log {<br />
        daily<br />
        missingok<br />
        rotate 365<br />
        compress<br />
        datetext<br />
        delaycompress<br />
        notifempty<br />
        create 640 ctfd adm<br />
        sharedscripts<br />
        postrotate<br />
                if [ -f /home/ctfd/CTFd/ctfd.pid ]; then<br />
                        kill -HUP `cat /home/ctfd/CTFd/ctfd.pid`<br />
                fi<br />
        endscript<br />
}<br />
[/sourcecode]</p>
<p>Crie o arquivo <strong>/etc/systemd/system/ctfd.service</strong></p>
<p>[sourcecode language="shell"][Unit]<br />
Description=CTFd Service<br />
After=network.target</p>
<p>[Service]<br />
User = ctfd<br />
Group = nginx<br />
WorkingDirectory=/home/ctfd/CTFd<br />
Environment=&quot;PATH=/home/ctfd/CTFd/bin&quot;<br />
ExecStart=/home/ctfd/CTFd/bin/uwsgi --ini ctfd.ini</p>
<p>[Install]<br />
WantedBy=multi-user.target<br />
[/sourcecode]</p>
<p>Podemos agora iniciar o serviço uWSGI que criamos e habilitá-lo para que ele seja iniciado na inicialização:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# systemctl daemon-reload<br />
root@M4v3r1ck:~# systemctl enable ctfd<br />
root@M4v3r1ck:~# systemctl start ctfd<br />
[/sourcecode]</p>
<p>Verifique o status</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# systemctl status ctfd<br />
[/sourcecode]</p>
<p>Você deve ver um resultado como este:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# systemctl status ctfd<br />
● ctfd.service - CTFd Service<br />
     Loaded: loaded (/etc/systemd/system/ctfd.service; enabled; vendor preset: enabled)<br />
     Active: active (running) since Sat 2020-06-20 03:51:28 UTC; 8s ago<br />
   Main PID: 27730 (uwsgi)<br />
      Tasks: 6 (limit: 2249)<br />
     Memory: 59.2M<br />
     CGroup: /system.slice/ctfd.service<br />
             ├─27730 /home/ctfd/CTFd/bin/uwsgi --ini ctfd.ini<br />
             ├─27740 /home/ctfd/CTFd/bin/uwsgi --ini ctfd.ini<br />
             ├─27741 /home/ctfd/CTFd/bin/uwsgi --ini ctfd.ini<br />
             ├─27742 /home/ctfd/CTFd/bin/uwsgi --ini ctfd.ini<br />
             ├─27743 /home/ctfd/CTFd/bin/uwsgi --ini ctfd.ini<br />
             └─27744 /home/ctfd/CTFd/bin/uwsgi --ini ctfd.ini</p>
<p>Jun 20 03:51:29 ctfd uwsgi[27730]:  * Loaded module, &lt;module 'CTFd.plugins.dynamic_challenges' from './CTFd/plugins/dynamic_challenges/__init__.py'&gt;<br />
Jun 20 03:51:29 ctfd uwsgi[27730]:  * Loaded module, &lt;module 'CTFd.plugins.flags' from './CTFd/plugins/flags/__init__.py'&gt;<br />
Jun 20 03:51:29 ctfd uwsgi[27730]: WSGI app 0 (mountpoint='') ready in 1 seconds on interpreter 0x56237be7f2c0 pid: 27730 (default app)<br />
Jun 20 03:51:29 ctfd uwsgi[27730]: *** uWSGI is running in multiple interpreter mode ***<br />
Jun 20 03:51:29 ctfd uwsgi[27730]: spawned uWSGI master process (pid: 27730)<br />
Jun 20 03:51:29 ctfd uwsgi[27730]: spawned uWSGI worker 1 (pid: 27740, cores: 1)<br />
Jun 20 03:51:29 ctfd uwsgi[27730]: spawned uWSGI worker 2 (pid: 27741, cores: 1)<br />
[/sourcecode]</p>
<p>Estando tudo correto agora vamos editar o nginx para se conectar ao wsgi através do socket unix que criamos.</p>
<p>Altere o arquivo <strong>/etc/nginx/conf.d/default.conf</strong> para:</p>
<p>[sourcecode language="shell"]server {<br />
    listen      80;<br />
    server_name _;</p>
<p>    location / {</p>
<p>        uwsgi_param   Host                 $host;<br />
        uwsgi_param   X-Real-IP            $remote_addr;<br />
        uwsgi_param   X-Forwarded-For      $proxy_add_x_forwarded_for;<br />
        uwsgi_param   X-Forwarded-Proto    $http_x_forwarded_proto;</p>
<p>        proxy_read_timeout 600;<br />
        proxy_connect_timeout 1d;<br />
        proxy_max_temp_file_size 5024m;<br />
        proxy_send_timeout 600;<br />
        uwsgi_read_timeout 600;<br />
        uwsgi_send_timeout 600;<br />
        include uwsgi_params;</p>
<p>        uwsgi_pass unix:/home/ctfd/CTFd/ctfd.sock;</p>
<p>    }</p>
<p>}<br />
[/sourcecode]</p>
<p>Recarregue a configuração do nginx</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# nginx -s reload<br />
[/sourcecode]</p>
<p>Realize o teste de acesso ao CTFd através da URL http://[IP]</p>
<p>Agora você tem o CTFd rodando na porta 80 do seu servidor, basta o teste de acesso ao CTFd através da URL http://[IP].</p>
<p>Fontes:</p>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-uswgi-and-nginx-on-ubuntu-18-04-pt" target="_blank" rel="noopener noreferrer">https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-uswgi-and-nginx-on-ubuntu-18-04-pt</a></li>
<li><a href="https://ev1z.be/2018/10/23/ctfd-on-ubuntu-18-04/" target="_blank" rel="noopener noreferrer">https://ev1z.be/2018/10/23/ctfd-on-ubuntu-18-04/</a></li>
</ul>
