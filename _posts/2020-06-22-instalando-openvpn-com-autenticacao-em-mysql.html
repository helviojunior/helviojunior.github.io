---
layout: post
title: Instalando OpenVPN com autenticação em MySQL
date: 2020-06-22 16:38:05.000000000 -03:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- IT
tags: []
meta:
  _edit_last: '1'
  _syntaxhighlighter_encoded: '1'
  _yoast_wpseo_content_score: '30'
  _yoast_wpseo_primary_category: '25'
  _aviaLayoutBuilder_active: ''
  _aviaLayoutBuilderCleanData: ''
  layout: ''
  sidebar: ''
  footer: ''
  header_title_bar: ''
  header_transparency: ''
  _avia_hide_featured_image: '0'
  _oembed_7c9fbdcc8f915d736f5c17936423e265: "{{unknown}}"
  _oembed_577510448266ce9859994ebe7aa42371: "{{unknown}}"
  _av_alb_posts_elements_state: a:0:{}
  _av_el_mgr_version: '1.0'
  _av_alb_element_mgr_version: 1.0.1
  _av_css_styles: a:6:{s:7:"post_id";i:2166;s:8:"css_file";s:13:"post-2166.css";s:9:"timestamp";s:0:"";s:6:"status";s:6:"no_css";s:13:"processed_ids";a:0:{}s:13:"include_posts";a:0:{}}
author: Helvio Junior (m4v3r1ck)







permalink: "/it/instalando-openvpn-com-autenticacao-em-mysql/"
---
<p>OpenVPN é um software Linux utilizado para criação de tuneis VPN. Neste artigo demonstrarei passo-a-passo como instalar o OpenVPN com os seguintes pré-requisitos:</p>
<ul>
<li>Versão atualizada do próprio repositório do OpenVPN;</li>
<li>Utilização de Certificado digital;</li>
<li>Autenticação via banco de dados MySQL;</li>
<li>Scripts em python para atualização dos dados em tempo real (usuário conectado, usuário desconectado e dados trafegados)</li>
</ul>
<p>Maiores informações e documentação do OpenVPN pode ser obtida neste endereço: <a href="https://openvpn.net/" target="_blank" rel="noopener noreferrer">https://openvpn.net/</a></p>
<p><!--more--></p>
<h2>Instalando pacotes e dependências</h2>
<p>Antes de mais nada se faz necessário realizar a instalação de todas as dependências necessárias para o correto funcionamento do ambiente.</p>
<p>Adicionando repositório do OpenVPN no ambiente</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# echo &quot;deb http://build.openvpn.net/debian/openvpn/stable `lsb_release --codename --short` main&quot; &gt; /etc/apt/sources.list.d/openvpn-aptrepo.list<br />
root@M4v3r1ck:~# curl -s https://swupdate.openvpn.net/repos/repo-public.gpg | apt-key add -<br />
[/sourcecode]</p>
<p><strong>Nota:</strong> No momento que criei este tutorial, a instalação do mesmo foi em um Ubuntu 20.04, mas o repositório do OpenVPN ainda não estava aceitando o seu codename 'focal' sendo assim eu utilizei o repositório do Ubuntu 18.04, ficando como abaixo a minha linha de comando:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# echo &quot;deb http://build.openvpn.net/debian/openvpn/stable bionic main&quot; &gt; /etc/apt/sources.list.d/openvpn-aptrepo.list<br />
[/sourcecode]</p>
<p>Atualizando o ambiente</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# apt-get update &amp;&amp; apt-get -y upgrade<br />
[/sourcecode]</p>
<p>Instalando pacotes e dependências</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# apt install -y openvpn easy-rsa libpam-mysql python python3 python3-pip libmariadb-dev python3-dev mariadb-client mariadb-server iptables-persistent<br />
root@M4v3r1ck:~# pip3 install mysqlclient<br />
[/sourcecode]</p>
<h2>Configurando a Autoridade Certificadora (CA)</h2>
<p>O OpenVPN é uma VPN TLS/SSL. Isso significa que ele utiliza certificados para criptografar o tráfego entre o servidor e os clientes. Para emitir certificados confiáveis, precisaremos configurar nossa própria autoridade de certificação (CA) simples.</p>
<p>Antes de iniciar os comandos propriamente dito creio ser bem importante entendermos o que estamos fazendo, e como esse assunto de autoridade certificadora é algo complexo recomendo a leitura deste artigo que escrevi sobre o assunto (<a href="https://www.helviojunior.com.br/it/security/introducao-criptografia/" target="_blank" rel="noopener noreferrer">https://www.helviojunior.com.br/it/security/introducao-criptografia/</a>). Para ilustrar o que iremos realizar em termos de autoridade de certificação (CA) observe a imagem abaixo:</p>
<p><a href="http://www.helviojunior.com.br/wp-content/uploads/2020/06/Certificados.png"><img class="size-full wp-image-2186 aligncenter" src="{{ site.baseurl }}/assets/2020/06/Certificados.png" alt="" width="438" height="164" /></a></p>
<p>Observe que na imagem ilustramos 4 certificados:</p>
<ol>
<li><strong>Root CA</strong>: Este é a autoridade máxima nessa nossa estrutura, é a partir dela que todos os outros certificados são gerados, sendo assim será o primeiro certificado a ser gerado, e o mais importante, portando no momento que formos criar uma senha para suas chaves provadas, crie uma senha complexa e a guarde com carinho;</li>
<li><strong>Servidor</strong>: Este será o segundo certificado a ser gerado, ele é utilizado exclusivamente no servidor e tem a função de que os clientes (OpenVPN) possam confiar em seu servidor;</li>
<li><strong>Cliente n</strong>: Os certificados de cliente são para que o servidor possa confiar e ter a certeza que o cliente foi autorizado por você a conectar no seu ambiente. O recomendado é que tenha um certificado para cada cliente, mas dependendo da criticidade do seu ambiente você pode utilizar um único certificado para todos os clientes uma vez que a autenticação (neste nosso caso) se dará através de usuário e senha. Com a utilização de um certificado por cliente você terá na prática dois fatores de autenticação (um deles o certificado e outro o usuário/senha);</li>
</ol>
<p>Para começar, podemos copiar o diretório modelo easy-rsa em nosso diretório home com o comando make-cadir:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# make-cadir ~/openvpn-ca<br />
[/sourcecode]</p>
<p>Vamos para o diretório recém-criado para começar a configuração do CA:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# cd ~/openvpn-ca<br />
[/sourcecode]</p>
<p>Para configurar os valores que nossa CA irá utilizar, precisamos editar o arquivo <strong>var</strong> dentro do diretório. Abra esse arquivo (<strong>~/openvpn-ca/vars</strong>) agora em seu editor de textos.</p>
<p>Dentro, você encontrará algumas variáveis que podem ser ajustadas para determinar como os seus certificados serão criados. Somente precisamos nos preocupar com algumas delas.</p>
<p>Na parte inferior do arquivo, localize as configurações que definem padrões de campo para novos certificados. Deve ser algo como isto:</p>
<p>[sourcecode language="shell"]...</p>
<p>#set_var EASYRSA_REQ_COUNTRY    &quot;US&quot;<br />
#set_var EASYRSA_REQ_PROVINCE   &quot;California&quot;<br />
#set_var EASYRSA_REQ_CITY       &quot;San Francisco&quot;<br />
#set_var EASYRSA_REQ_ORG        &quot;Copyleft Certificate Co&quot;<br />
#set_var EASYRSA_REQ_EMAIL      &quot;me@example.net&quot;<br />
#set_var EASYRSA_REQ_OU         &quot;My Organizational Unit&quot;</p>
<p>...<br />
[/sourcecode]</p>
<p>Edite os valores para o que você preferir, mas não os deixe em branco:</p>
<p>[sourcecode language="shell"]...</p>
<p>set_var EASYRSA_REQ_COUNTRY    &quot;BR&quot;<br />
set_var EASYRSA_REQ_PROVINCE   &quot;SP&quot;<br />
set_var EASYRSA_REQ_CITY       &quot;Sao Paulo&quot;<br />
set_var EASYRSA_REQ_ORG        &quot;Helvio Junior&quot;<br />
set_var EASYRSA_REQ_EMAIL      &quot;contato@helviojunior.com.br&quot;<br />
set_var EASYRSA_REQ_OU         &quot;Helvio Junior Treinamentos&quot;</p>
<p>...<br />
[/sourcecode]</p>
<p>Quando tiver terminado, salve e feche o arquivo.</p>
<h2>Construindo a autoridade certificadora Raiz (Root-CA)</h2>
<p>Agora, podemos utilizar as variáveis que definimos e os utilitários easy-rsa para construir nossa autoridade de certificação.</p>
<p>Assegure-se de estar em seu diretório CA, e então crie sua estrutira de PKI e CA:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# cd ~/openvpn-ca<br />
root@M4v3r1ck:~/openvpn-ca# ./easyrsa init-pki<br />
root@M4v3r1ck:~/openvpn-ca# ./easyrsa build-ca<br />
[/sourcecode]</p>
<p>Neste ponto é solicitado uma senha para as chaves da sua CA, bem como o nome da sua CA.</p>
<p>[sourcecode language="shell"]<br />
Note: using Easy-RSA configuration from: ./vars</p>
<p>Using SSL: openssl OpenSSL 1.1.1f  31 Mar 2020</p>
<p>Enter New CA Key Passphrase:<br />
Re-Enter New CA Key Passphrase:<br />
Generating RSA private key, 2048 bit long modulus (2 primes)<br />
......................................................+++++<br />
..................+++++<br />
e is 65537 (0x010001)<br />
Can't load /root/openvpn-ca/pki/.rnd into RNG<br />
140290726450496:error:2406F079:random number generator:RAND_load_file:Cannot open file:../crypto/rand/randfile.c:98:Filename=/root/openvpn-ca/pki/.rnd<br />
You are about to be asked to enter information that will be incorporated<br />
into your certificate request.<br />
What you are about to enter is what is called a Distinguished Name or a DN.<br />
There are quite a few fields but you can leave some blank<br />
For some fields there will be a default value,<br />
If you enter '.', the field will be left blank.<br />
-----<br />
Common Name (eg: your user, host, or server name) [Easy-RSA CA]:Helvio Junior CA</p>
<p>CA creation complete and you may now import and sign cert requests.<br />
Your new CA certificate file for publishing is at:<br />
/root/openvpn-ca/pki/ca.crt<br />
[/sourcecode]</p>
<p>Ao final deste processo temos o certificado público da nossa CA (Chave pública dentro de um certificado X509) dentro do arquivo<br />
<strong>~/openvpn-ca/pki/ca.crt</strong> e a sua respectiva chave privada no arquivo <strong>~/openvpn-ca/pki/private/ca.key</strong>. Futuramente, no momento em que formos criar o arquivo de configuração do nosso cliente OpenVPN iremos utilizar o conteúdo deste arquivo do certificado X509 (~/openvpn-ca/pki/ca.crt).</p>
<h2>Criando chave e arquivos de criptografia</h2>
<p>A seguir, vamos gerar alguns arquivos adicionais utilizados durante o processo de criptografia.</p>
<p>Primeiro vamos gerar alguns outros itens. Podemos gerar chaves fortes Diffie-Hellman para usar durante a troca de chaves digitando:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~/openvpn-ca# ./easyrsa gen-dh<br />
[/sourcecode]</p>
<p>Posteriormente, podemos gerar uma assinatura HMAC para fortalecer os recursos de verificação de integridade TLS do servidor:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~/openvpn-ca# openvpn --genkey --secret ~/openvpn-ca/pki/private/ta.key<br />
[/sourcecode]</p>
<p>Este processo irá gerar como resultado o arquivo <strong>~/openvpn-ca/pki/private/ta.key</strong> no qual também o utilizaremos no momento que formos gerar a configuração do cliente OpenVPN.</p>
<h2>Criando o certificado do servidor</h2>
<p>A seguir, vamos gerar nosso certificado de servidor e sua respectiva chave privada.</p>
<p><strong>Nota:</strong> Se você escolher um nome diferente de server aqui, você terá que ajustar algumas das instruções abaixo. Por exemplo, quando copiar os arquivos gerados para o diretório /etc/openvpn, você terá que substituir os nomes corretos. Você também terá que modificar o arquivo <strong>/etc/openvpn/server.conf</strong> depois para apontar para os arquivos <strong>.crt</strong> e <strong>.key</strong> corretos.</p>
<p>Comece gerando o certificado do servidor OpenVPN e o par de chaves. Podemos fazer isso digitando:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~/openvpn-ca# ./easyrsa build-server-full server nopass<br />
[/sourcecode]</p>
<p>Este processo gerou 2 arquivos <strong>~/openvpn-ca/pki/issued/server.crt</strong> e <strong>~/openvpn-ca/pki/private/server.key</strong>.</p>
<p><strong>Nota:</strong> Observer que neste comando passamos o parâmetro <strong>nopass</strong> que irá deixar a chave privada do nosso servidor sem senha, isso tem um certo risco de segurança mas se faz necessário pois caso essa chave tenha senha a cada reboot do servidor ou restart do ser serviço OpenVPN você teria que digitar a senha na console o que poderia ocasionar um falha no serviço.</p>
<h2>Criando o certificado do cliente</h2>
<p>A seguir, vamos gerar nosso certificado de cliente e sua respectiva chave privada. Conforme comentado anteriormente você tem 2 modelos de <em>deploy</em> de clientes, o primeiro deles menos seguro onde você gera somente 1 certificado para todos os clientes, e outro mais seguro onde você gera um certificado para cada cliente, cada modelo tem suas vantagens e desvantagens, segue algumas abaixo:</p>
<ul>
<li>Um certificado para TODOS os clientes:
<ol>
<li>Baixo custo de criação de novos clientes, pois basta adicionar no banco de dados (pois o arquivo de configuração é o mesmo para todos);</li>
<li>Caso outras pessoas não autorizadas tenham acesso ao arquivo de configuração, poderão realizar um ataque de força bruta no usuário e senha de forma que não há como ter rastreabilidade qual cliente que vazou a configuração;</li>
<li>Muito em alinhamento que o item acima, caso necessite revogar o certificado digital de cliente, terá que reenviar a configuração para todos os clientes;</li>
</ol>
</li>
<li>Um certificado para CADA cliente:
<ol>
<li>Custo médio de criação de novos clientes, pois para cada cliente novo se faz necessário gerar o certificado digital, chave privada e gerar um novo arquivo de configuração com esse certificado e chave;</li>
<li>Fácil rastreabilidade em caso de vazamento de configuração pois o certificado é único para cada cliente;</li>
<li>Fácil revogação do certificado digital, pois a regeração da configuração é para somente um cliente, sem impactar nos demais.</li>
</ol>
</li>
</ul>
<p>&nbsp;</p>
<p>Desta forma o procedimento técnico para geração de novos clientes sempre será o mesmo, bastando alterar o nome cliente nos comandos a seguir.</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~/openvpn-ca# ./easyrsa build-client-full cliente1 nopass<br />
[/sourcecode]</p>
<p>Este processo gerou 2 arquivos <strong>~/openvpn-ca/pki/issued/cliente1.crt</strong> e <strong>~/openvpn-ca/pki/private/cliente1.key</strong>. Estes dois arquivos serão utilizados futuramente no momento da criação do arquivo de configuração do cliente OpenVPN.</p>
<h2>Configurando o serviço do OpenVPN</h2>
<p>Enfim, podemos começar a configuração do serviço OpenVPN utilizando as credenciais e arquivos que geramos.</p>
<h3>Copiar os Arquivos para o Diretório OpenVPN</h3>
<p>Para começar, precisamos copiar os arquivos que necessitamos para o diretório de configuração /etc/openvpn.</p>
<p>Podemos começar com todos os arquivos que acabamos de gerar. Eles foram colocados dentro do diretório ~/openvpn-ca/pki/ quando foram criados. Precisamos copiar o certificado e chave de nossa CA, o certificado e chave de nosso servidor, a assinatura HMAC, e o arquivo Diffie-Hellman.</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# cd ~/openvpn-ca/pki<br />
root@M4v3r1ck:~/openvpn-ca/pki# cp ca.crt private/ca.key issued/server.crt private/server.key private/ta.key dh.pem /etc/openvpn<br />
[/sourcecode]</p>
<h3>Configuração OpenVPN Server</h3>
<p>Agora que nossos arquivos estão no lugar, podemos criar o arquivo de configuração do servidor. Crie o arquivo <strong>/etc/openvpn/server.conf</strong> com o conteúdo abaixo:</p>
<p>[sourcecode language="shell"]##Configuracoes gerais<br />
port 4321<br />
proto udp<br />
dev tun<br />
sndbuf 0<br />
rcvbuf 0<br />
topology subnet<br />
duplicate-cn<br />
status-version 2<br />
keepalive 10 120<br />
persist-key<br />
persist-tun<br />
verb 3<br />
comp-lzo no</p>
<p>##Chaves<br />
ca ca.crt<br />
cert server.crt<br />
key server.key<br />
dh dh.pem<br />
tls-auth ta.key 0</p>
<p>##Rede<br />
server 192.168.50.0 255.255.255.0<br />
ifconfig-pool-persist ipp_server.txt<br />
#push &quot;redirect-gateway def1 bypass-dhcp&quot; # Opcional para redirecionar todo tráfego de rede pela VPN<br />
#push &quot;route 192.168.1.0 255.255.252.0&quot; # rotas adicionais</p>
<p>##Autenticacao<br />
cipher AES-128-CBC<br />
ncp-ciphers AES-256-GCM:AES-128-GCM<br />
auth SHA1<br />
user nobody<br />
group nogroup<br />
client-to-client<br />
username-as-common-name</p>
<p>##user/pass auth from mysql<br />
plugin /usr/lib/openvpn/openvpn-auth-pam.so openvpn</p>
<p>##script connect-disconnect (opcional)<br />
script-security 2<br />
client-connect /etc/openvpn/connected.py<br />
client-disconnect /etc/openvpn/disconnected.py</p>
<p>##Configuracoes especificas para cada cliente (opcional)<br />
#client-config-dir /etc/openvpn/static_clients_server</p>
<p>##Arquivo de status de usuarios conectados (opcional)<br />
status openvpn-status.log<br />
[/sourcecode]</p>
<p>Verifique o local do plugin openvpn-auth-pam.so para ter certeza que o caminho apontado na configuração acima está correto.</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# find / -name &quot;*pam*&quot; | grep -ioE &quot;.*openvpn.*so&quot;<br />
[/sourcecode]</p>
<p>Em meu ambiente o arquivo foi localizado em <strong>/usr/lib/x86_64-linux-gnu/openvpn/plugins/openvpn-plugin-auth-pam.so</strong> sendo assim vamos criar um link simbólico para o local da configuração</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# mkdir /usr/lib/openvpn/<br />
root@M4v3r1ck:~# ln -s /usr/lib/x86_64-linux-gnu/openvpn/plugins/openvpn-plugin-auth-pam.so /usr/lib/openvpn/openvpn-auth-pam.so<br />
[/sourcecode]</p>
<h2>Criando a base de dados e configurando o conector do PAM para o MySQL</h2>
<p>Para que o módulo do PAM possa se colectar e autenticar os usuários é necessária a criação da base de dados onde os usuários e senhas serão salvos bem como um arquivo de confguração do conector. Desta forma crie a base de dados conforme o script abaixo:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# mysql -u root</p>
<p>CREATE DATABASE openvpn;<br />
USE openvpn;</p>
<p>CREATE USER 'openvpn'@'localhost' IDENTIFIED BY 'MinhaS3nhASuperSegura';<br />
GRANT ALL PRIVILEGES ON `openvpn`.* TO 'openvpn'@'localhost';<br />
FLUSH PRIVILEGES;</p>
<p>CREATE TABLE IF NOT EXISTS `users` (<br />
    `user_id` varchar(32) COLLATE utf8_unicode_ci NOT NULL,<br />
    `user_pass` varchar(32) COLLATE utf8_unicode_ci NOT NULL,<br />
    `user_mail` varchar(64) COLLATE utf8_unicode_ci DEFAULT NULL,<br />
    `user_start_date` date NOT NULL,<br />
    `user_end_date` date NOT NULL,<br />
    `user_online` enum('yes','no') NOT NULL DEFAULT 'no',<br />
    `user_enable` enum('yes','no') NOT NULL DEFAULT 'yes',<br />
PRIMARY KEY (`user_id`),<br />
KEY `user_pass` (`user_pass`)<br />
) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;</p>
<p>CREATE TABLE IF NOT EXISTS `log` (<br />
    `log_id` int(10) unsigned NOT NULL AUTO_INCREMENT,<br />
    `user_id` varchar(32) COLLATE utf8_unicode_ci NOT NULL,<br />
    `log_trusted_ip` varchar(32) COLLATE utf8_unicode_ci DEFAULT NULL,<br />
    `log_trusted_port` varchar(16) COLLATE utf8_unicode_ci DEFAULT NULL,<br />
    `log_remote_ip` varchar(32) COLLATE utf8_unicode_ci DEFAULT NULL,<br />
    `log_remote_port` varchar(16) COLLATE utf8_unicode_ci DEFAULT NULL,<br />
    `log_start_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,<br />
    `log_end_time` timestamp NULL,<br />
    `log_received` float NOT NULL DEFAULT '0',<br />
    `log_send` float NOT NULL DEFAULT '0',<br />
PRIMARY KEY (`log_id`),<br />
KEY `user_id` (`user_id`)<br />
) ENGINE=MyISAM  DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;<br />
[/sourcecode]</p>
<p>Caso deseje criar um usuário de teste execute os comandos abaixo:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# mysql -u root<br />
mysql&gt; use openvpn;<br />
Database changed<br />
mysql&gt; INSERT INTO users (user_id, user_pass, user_start_date, user_end_date) VALUES ('helvio_junior','@Pass123', '2020-05-27', '2021-05-27');<br />
Query OK, 1 row affected (0.00 sec)<br />
[/sourcecode]</p>
<p>Crie o arquivo de configuração do PAM <strong>/etc/pam.d/openvpn</strong> com o seguinte conteúdo:</p>
<p>[sourcecode language="shell"]auth sufficient pam_mysql.so user=openvpn passwd=MinhaS3nhASuperSegura host=localhost db=openvpn [table=users] usercolumn=users.user_id passwdcolumn=users.user_pass [where=users.user_enable=1 AND users.user_start_date!=users.user_end_date AND TO_DAYS(now()) &gt;= TO_DAYS(users.user_start_date) AND (TO_DAYS(now()) &lt;= TO_DAYS(users.user_end_date))] sqllog=0 crypt=0</p>
<p>account required pam_mysql.so user=openvpn passwd=MinhaS3nhASuperSegura host=localhost db=openvpn [table=users] usercolumn=users.user_id passwdcolumn=users.user_pass [where=users.user_enable=1 AND users.user_start_date!=users.user_end_date AND TO_DAYS(now()) &gt;= TO_DAYS(users.user_start_date) AND (TO_DAYS(now()) &lt;= TO_DAYS(users.user_end_date))] sqllog=0 crypt=0<br />
[/sourcecode]</p>
<p>&nbsp;</p>
<h2>Scripts de status</h2>
<p>Temos 2 scripts que tem por responsabilidade atualizar os status do usuário logo após a sua conexão e desconexão.</p>
<p>Crie o arquivo <strong>/etc/openvpn/connected.py</strong> com o conteúdo abaixo:</p>
<p>[sourcecode language="python"]#!/usr/bin/env python3<br />
# -*- coding: UTF-8 -*-</p>
<p>import MySQLdb,posix,time;<br />
import logging<br />
import logging.handlers<br />
import sys,datetime,os</p>
<p>my_logger = logging.getLogger('MyLogger')<br />
my_logger.setLevel(logging.DEBUG)</p>
<p>handler = logging.handlers.SysLogHandler(address = '/dev/log')</p>
<p>my_logger.addHandler(handler)</p>
<p>now = time.time()<br />
ts = int(now)<br />
timestamp = datetime.datetime.fromtimestamp(ts).strftime('%Y-%m-%d %H:%M:%S')</p>
<p>try:</p>
<p>    db=MySQLdb.connect(host=&quot;localhost&quot;,<br />
                user=&quot;openvpn&quot;,<br />
                passwd=&quot;MinhaS3nhASuperSegura&quot;,<br />
                db=&quot;openvpn&quot;)<br />
    c = db.cursor()</p>
<p>    for i in posix.environ:<br />
        my_logger.debug(&quot;%s ==&gt; %s&quot; % (i, posix.environ[i].decode(&quot;utf-8&quot;) ))</p>
<p>    c.execute(&quot;UPDATE users SET user_online = 'yes' WHERE user_id = %s&quot;,(posix.environ[b'username'].decode(&quot;utf-8&quot;),))<br />
    c.execute(&quot;INSERT INTO log (user_id, log_trusted_ip, log_trusted_port, log_remote_ip, log_remote_port) VALUES (%s, %s, %s, %s, %s)&quot;,(posix.environ[b'username'].decode(&quot;utf-8&quot;),posix.environ[b'trusted_ip'].decode(&quot;utf-8&quot;),posix.environ[b'trusted_port'].decode(&quot;utf-8&quot;),posix.environ[b'ifconfig_pool_remote_ip'].decode(&quot;utf-8&quot;),posix.environ[b'remote_port_1'].decode(&quot;utf-8&quot;),))</p>
<p>    db.commit()</p>
<p>except MySQLdb.Error as e:<br />
        try:<br />
            my_logger.critical(&quot;MySQL Error [%d]: %s&quot; % (e.args[0], e.args[1]))<br />
        except IndexError:<br />
            my_logger.critical(&quot;MySQL Error: %s&quot; % str(e))<br />
except TypeError as e:<br />
    my_logger.critical(e)<br />
except ValueError as e:<br />
        my_logger.critical(e)<br />
except Exception as e:<br />
        my_logger.critical(str(e))<br />
        my_logger.critical(str(sys.exc_info()[0]))<br />
[/sourcecode]</p>
<p>Crie também o arquivo <strong>/etc/openvpn/disconnected.py</strong> com o conteúdo abaixo:</p>
<p>[sourcecode language="python"]#!/usr/bin/env python3</p>
<p>import MySQLdb,posix,time;<br />
import logging<br />
import logging.handlers<br />
import sys,datetime</p>
<p>my_logger = logging.getLogger('MyLogger')<br />
my_logger.setLevel(logging.DEBUG)</p>
<p>handler = logging.handlers.SysLogHandler(address = '/dev/log')</p>
<p>my_logger.addHandler(handler)</p>
<p>now = time.time()<br />
time = int(now)<br />
timestamp = datetime.datetime.fromtimestamp(time).strftime('%Y-%m-%d %H:%M:%S')</p>
<p>try:<br />
        db=MySQLdb.connect(host=&quot;localhost&quot;,<br />
                user=&quot;openvpn&quot;,<br />
                passwd=&quot;MinhaS3nhASuperSegura&quot;,<br />
                db=&quot;openvpn&quot;)<br />
        c = db.cursor()</p>
<p>        for i in posix.environ:<br />
            my_logger.debug(&quot;%s ==&gt; %s&quot; % (i, posix.environ[i].decode(&quot;utf-8&quot;)))</p>
<p>        c.execute(&quot;UPDATE users SET user_online = 'no' WHERE user_id = %s&quot;,(posix.environ[b'username'].decode(&quot;utf-8&quot;),))</p>
<p>        c.execute(&quot;UPDATE log set log_end_time = CURRENT_TIMESTAMP, log_send = %s, log_received = %s WHERE log_end_time is null and user_id = %s and log_trusted_ip = %s and log_trusted_port = %s&quot;,(posix.environ[b'bytes_sent'],posix.environ[b'bytes_received'],posix.environ[b'username'].decode(&quot;utf-8&quot;),posix.environ[b'trusted_ip'].decode(&quot;utf-8&quot;),posix.environ[b'trusted_port'].decode(&quot;utf-8&quot;),))</p>
<p>        db.commit()</p>
<p>except MySQLdb.Error as e:<br />
        try:<br />
            my_logger.critical(&quot;MySQL Error [%d]: %s&quot; % (e.args[0], e.args[1]))<br />
        except IndexError:<br />
            my_logger.critical(&quot;MySQL Error: %s&quot; % str(e))<br />
except TypeError as e:<br />
        my_logger.critical(e)<br />
except ValueError as e:<br />
        my_logger.critical(e)<br />
except Exception as e:<br />
    my_logger.critical('Error: %s' % str(e))</p>
<p>    my_logger.critical('Full stack trace below')<br />
    from traceback import format_exc<br />
    err = format_exc().strip()<br />
    err = err.replace('  File', 'File')<br />
    err = err.replace('  Exception: ', 'Exception: ')<br />
    my_logger.critical(err)<br />
[/sourcecode]</p>
<p>Ajuste a permissão dos 2 arquivos:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# cd /etc/openvpn/<br />
root@M4v3r1ck:~# chmod +x *.py<br />
[/sourcecode]</p>
<h2>Ajustando a configuração de rede</h2>
<p>A seguir, precisamos ajustar alguns aspectos da rede do servidor para que o OpenVPN possa rotear o tráfego corretamente.</p>
<h3>Permitir o Encaminhamento IP</h3>
<p>Primeiro, percisamos permitir ao servidor encaminhar o tráfego. Isso é essencial para a funcionalidade que queremos que nosso servidor de VPN forneça.</p>
<p>Podemos ajustar essa configuração modificando o arquivo <strong>/etc/sysctl.conf</strong> dentro dele, procure a linha que define net.ipv4.ip_forward. Remova o caractere “#” do início da linha para descomentar/habilitar essa configuração, ficando conforme abaixo:</p>
<p>[sourcecode language="shell"]...</p>
<p>net.ipv4.ip_forward=1</p>
<p>...<br />
[/sourcecode]</p>
<p>Salve e feche o arquivo quando tiver terminado.</p>
<p>Para ler o arquivo e ajustar os valores para a sessão atual, digite:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# sudo sysctl -p<br />
[/sourcecode]</p>
<h3>Regras de firewall</h3>
<p>Agora precisaremos ajustar as nossas regras de firewall para permitir somente o tráfego desejado do tunel.</p>
<p>Mas antes de abrir o arquivo de configuração temos de identificar qual é o nome da nossa interface de rede, para isso execute o comando abaixo:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# ip route | grep default<br />
[/sourcecode]</p>
<p>Você terá um resutado parecido com o abaixo, onde no meu ambiente o nome da minha interface de rede pública é ens33. Geralmente é o nome que está entre o texto "dev" e o texto "proto"</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# default via 192.168.255.2 dev ens33 proto dhcp src 192.168.255.81 metric 100<br />
[/sourcecode]</p>
<p>Edite/crie o arquivo de configuração do Iptables <strong>/etc/iptables/rules.v4</strong> com o seguinte conteúdo:</p>
<p>[sourcecode language="shell"]# Generated by Helvio Junior M4v3r1ck<br />
*mangle<br />
:PREROUTING ACCEPT [89:22829]<br />
:INPUT ACCEPT [89:22829]<br />
:FORWARD ACCEPT [0:0]<br />
:OUTPUT ACCEPT [88:24171]<br />
:POSTROUTING ACCEPT [88:24171]<br />
COMMIT<br />
#<br />
*nat<br />
:PREROUTING ACCEPT [0:0]<br />
:INPUT ACCEPT [0:0]<br />
:OUTPUT ACCEPT [15:1119]<br />
:POSTROUTING ACCEPT [15:1119]<br />
-A POSTROUTING -o ens33 -j MASQUERADE<br />
COMMIT<br />
#<br />
*filter<br />
:INPUT DROP [0:0]<br />
:FORWARD DROP [0:0]<br />
:OUTPUT ACCEPT [0:0]<br />
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT<br />
-A INPUT -i lo -j ACCEPT<br />
-A INPUT -p udp -m udp --sport 1024:65535 --dport 4321 -j ACCEPT<br />
-A INPUT -p tcp -m tcp --sport 1024:65535 --dport 22 -j ACCEPT<br />
-A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT<br />
-A FORWARD -d 192.168.50.0/24 -i tun+ -j DROP<br />
-A FORWARD -d 192.168.1.0/24 -i tun+ -j ACCEPT<br />
-A FORWARD -i tun+ -j DROP<br />
-A OUTPUT -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT<br />
COMMIT<br />
[/sourcecode]</p>
<p>Salve o arquivo de configuração do Iptables e o carregue no sistema com o comando abaixo:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# iptables-restore &lt; /etc/iptables/rules.v4<br />
[/sourcecode]</p>
<h2>Habilitando e iniciando o OpenVPN</h2>
<p>Estamos finalmente prontos para iniciar o serviço OpenVPN em nosso servidor. Podemos fazer isso usando o systemd.</p>
<p>Precisamos iniciar o servidor OpenVPN especificando o nome do nosso arquivo de configuração como uma variável de instância após o nome do arquivo de unidade systemd. Nosso arquivo de configuração para nosso servidor é chamado /etc/openvpn/server.conf, assim vamos adicionar @server ao final de nosso arquivo de unidade ao chamá-lo:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# systemctl enable openvpn@server<br />
root@M4v3r1ck:~# systemctl start openvpn@server<br />
[/sourcecode]</p>
<p>Verifique novamente se o serviço foi iniciado com êxito, digitando:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# systemctl status openvpn@server<br />
[/sourcecode]</p>
<p>Se tudo correu bem, sua saída deve ser algo parecido com isso:</p>
<p>[sourcecode language="shell"]● openvpn@server.service - OpenVPN connection to server<br />
     Loaded: loaded (/lib/systemd/system/openvpn@.service; enabled; vendor preset: enabled)<br />
     Active: active (running) since Tue 2020-06-23 01:46:46 UTC; 2min 14s ago<br />
       Docs: man:openvpn(8)<br />
             https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage<br />
             https://community.openvpn.net/openvpn/wiki/HOWTO<br />
   Main PID: 1395 (openvpn)<br />
     Status: &quot;Initialization Sequence Completed&quot;<br />
      Tasks: 2 (limit: 2266)<br />
     Memory: 1.6M<br />
     CGroup: /system.slice/system-openvpn.slice/openvpn@server.service<br />
             ├─1395 /usr/sbin/openvpn --daemon ovpn-server --status /run/openvpn/server.status 10 --cd /etc/openvpn --script-security 2 --config /etc/openvpn/server.conf --writepid /run/openvpn/server.pid<br />
             └─1403 /usr/sbin/openvpn --daemon ovpn-server --status /run/openvpn/server.status 10 --cd /etc/openvpn --script-security 2 --config /etc/openvpn/server.conf --writepid /run/openvpn/server.pid</p>
<p>Jun 23 01:46:46 gateway ovpn-server[1395]: Could not determine IPv4/IPv6 protocol. Using AF_INET<br />
Jun 23 01:46:46 gateway ovpn-server[1395]: Socket Buffers: R=[212992-&gt;212992] S=[212992-&gt;212992]<br />
Jun 23 01:46:46 gateway ovpn-server[1395]: UDPv4 link local (bound): [AF_INET][undef]:4321<br />
Jun 23 01:46:46 gateway ovpn-server[1395]: UDPv4 link remote: [AF_UNSPEC]<br />
Jun 23 01:46:46 gateway ovpn-server[1395]: GID set to nogroup<br />
Jun 23 01:46:46 gateway ovpn-server[1395]: UID set to nobody<br />
Jun 23 01:46:46 gateway ovpn-server[1395]: MULTI: multi_init called, r=256 v=256<br />
[/sourcecode]</p>
<p>Você também pode verfificar que a interface OpenVPN tun0 está disponível digitando:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# ip addr show tun0<br />
[/sourcecode]</p>
<p>Você deve ver uma interface configurada:</p>
<p>[sourcecode language="shell"]4: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 100<br />
    link/none<br />
    inet 192.168.50.1/24 brd 192.168.50.255 scope global tun0<br />
       valid_lft forever preferred_lft forever<br />
    inet6 fe80::c80f:a8ef:a4ea:f460/64 scope link stable-privacy<br />
       valid_lft forever preferred_lft forever<br />
[/sourcecode]</p>
<h2>Criar Infraestrutura de Configuração de Cliente</h2>
<p>A seguir, precisamos configurar um sistema que nos permitirá criar arquivos de configuração de cliente facilmente.</p>
<h3>Criando a Estrutura de Diretório de Configuração do Cliente</h3>
<p>Crie uma estrutura de diretório dentro do seu diretório home para armazenar os arquivos:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# mkdir -p ~/client-configs/files<br />
[/sourcecode]</p>
<p>Como nossos arquivos de configuração de cliente terão as chaves de cliente embutidas, devemos bloquear as permissões em nosso diretório interno:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# chmod 700 ~/client-configs/files<br />
[/sourcecode]</p>
<h3>Criando uma Configuração Básica</h3>
<p>Em seguida, vamos copiar um exemplo de configuração de cliente em nosso diretório para usar como nossa configuração base com nome <strong>~/client-configs/base.conf</strong> com o seguinte conteúdo:</p>
<p>[sourcecode language="shell"]dev tun<br />
persist-tun<br />
persist-key<br />
cipher AES-128-CBC<br />
ncp-ciphers AES-256-GCM:AES-128-GCM<br />
auth SHA1<br />
tls-client<br />
client<br />
resolv-retry infinite<br />
remote 10.10.10.10 4321 udp<br />
verify-x509-name &quot;server&quot; name<br />
auth-user-pass<br />
remote-cert-tls server<br />
comp-lzo no<br />
key-direction 1<br />
[/sourcecode]</p>
<p><strong>Nota: </strong>Altere na linha remote o ip 10.10.10.10 para o endereço IP externo do seu servidor e altere na linha verify-x509-name onde está server para o nome do certificado digital do seu servidor, caso tenha colocado diferente.</p>
<h3>Criando um Script de Geração de Configuração</h3>
<p>A seguir, vamos criar um script simples para compilar nossa configuração básica com o certificado relevante, chave, e arquivos de criptografia. Ele irá colocar os arquivos de configuração gerados no diretório ~/client-configs/files.</p>
<p>Crie e abra um arquivo chamado <strong>make_config.sh</strong> dentro do diretório <strong>~/client-configs</strong> com o seguinte conteúdo:</p>
<p>[sourcecode language="shell"]#!/bin/bash<br />
# First argument: Client identifier</p>
<p>KEY_DIR=~/openvpn-ca/pki<br />
OUTPUT_DIR=~/client-configs/files<br />
BASE_CONFIG=~/client-configs/base.conf</p>
<p>cat ${BASE_CONFIG} \<br />
    &lt;(echo -e '\n&lt;ca&gt;') \<br />
    ${KEY_DIR}/ca.crt \<br />
    &lt;(echo -e '&lt;/ca&gt;\n&lt;cert&gt;') \<br />
    ${KEY_DIR}/issued/${1}.crt \<br />
    &lt;(echo -e '&lt;/cert&gt;\n&lt;key&gt;') \<br />
    ${KEY_DIR}/private/${1}.key \<br />
    &lt;(echo -e '&lt;/key&gt;\n&lt;tls-auth&gt;') \<br />
    ${KEY_DIR}/private/ta.key \<br />
    &lt;(echo -e '&lt;/tls-auth&gt;') \<br />
    &gt; ${OUTPUT_DIR}/${1}.ovpn<br />
[/sourcecode]</p>
<p>Salve e feche o arquivo quando tiver terminado.</p>
<p>Marque o arquivo como executável digitando:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# chmod 700 ~/client-configs/make_config.sh<br />
[/sourcecode]</p>
<h2>Gerando a configuração do cliente</h2>
<p>Agora, podemos gerar facilmente arquivos de configuração de cliente.</p>
<p>Se você acompanhou o guia, você criou um certificado de cliente e uma chave chamados client1.crt e client1.key respectivamente executando o comando ./build-key client1 no passo <strong>"Criando certificado do cliente"</strong>. Podemos gerar uma configuração para essas credenciais movendo-as para dentro de nosso diretório ~/client-configs e utilizando o script que fizemos:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# cd ~/client-configs<br />
root@M4v3r1ck:~# ./make_config.sh cliente1<br />
[/sourcecode]</p>
<p>Se tudo correu bem, devemos ter um arquivo client1.ovpn em nosso diretório ~/client-configs/files:</p>
<p>[sourcecode language="shell"]root@M4v3r1ck:~# ls ~/client-configs/files<br />
cliente1.ovpn<br />
[/sourcecode]</p>
<p>Pronto! Agora basta enviar o arquivo cliente1.ovpn de forma segura ao seu cliente.</p>
<p>Fontes:</p>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/como-configurar-um-servidor-openvpn-no-ubuntu-16-04-pt" target="_blank" rel="noopener noreferrer">https://www.digitalocean.com/community/tutorials/como-configurar-um-servidor-openvpn-no-ubuntu-16-04-pt</a></li>
<li><a href="https://sysadmin.compxtreme.ro/how-to-install-a-openvpn-system-based-on-userpassword-authentication-with-mysql-day-control-libpam-mysql/" target="_blank" rel="noopener noreferrer">https://sysadmin.compxtreme.ro/how-to-install-a-openvpn-system-based-on-userpassword-authentication-with-mysql-day-control-libpam-mysql/</a></li>
<li><a href="https://github.com/OpenVPN/easy-rsa/blob/master/README.quickstart.md" target="_blank" rel="noopener noreferrer">https://github.com/OpenVPN/easy-rsa/blob/master/README.quickstart.md</a></li>
</ul>
